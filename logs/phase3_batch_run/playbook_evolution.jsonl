{"timestamp": "2026-02-05T17:56:29.492306", "step": 10, "playbook_before_length": 38622, "playbook_after_length": 42640, "lines_before": 138, "lines_after": 155, "added_lines": 16, "removed_lines": 0, "operations_count": 1, "operations": [{"type": "ADD", "section": "context_clues_and_indicators", "content": "Atomic lexical-first heuristic: Distinguish 'GrantsInPeriod' vs 'NonvestedNumber' for share-based compensation counts.\n- Purpose: Prevent inferring 'nonvested' from mentions of vesting/performance conditions when the text explicitly states a grant count for a reporting period.\n- Exact grant lexical cues (case-insensitive regexes; match within same sentence): /\\b(grants?\\s+(for|during|issued\\s+(during|in))|granted\\s+(during|for)|included\\s+in\\s+the\\s+rsu\\s+grants|included\\s+in\\s+the\\s+grants)\\b/i and variants (e.g., 'awards granted during', 'grants for the [period]', 'granted during the [period]'). When such a pattern occurs and a numeric token is within ±8 tokens of the matched phrase, assign ShareBasedCompensationArrangementByShareBasedPaymentAwardEquityInstrumentsOtherThanOptionsGrantsInPeriod.\n- Exact nonvested lexical cues (case-insensitive regexes): /\\b(non-?vested|unvested|awards?\\s+(?:outstanding\\s+and\\s+unvested|outstanding and unvested|outstanding,? unvested)|shares?\\s+unvested)\\b/i. Only assign ShareBasedCompensationArrangementByShareBasedPaymentAwardEquityInstrumentsOtherThanOptionsNonvestedNumber when one of these cues occurs and the numeric token is within ±8 tokens of the nonvested cue.\n- Vesting/performance-criteria safeguard: phrases mentioning 'performance criteria', 'vesting conditions', 'three-year service criteria', 'will vest' etc. (regex examples: /\\b(performance\\s+criteria|vesting|vest|service\\s+criteria)\\b/i) must NOT by themselves trigger NonvestedNumber. Treat these as neutral modifiers unless explicit nonvested/unvested language appears close to the numeric. Do NOT map to NonvestedNumber solely because vesting conditions are described.\n- Token-distance & precedence tie-breaker (apply in order):\n  1) If both a grant-cue and a nonvested-cue are present in the sentence, compute token-distance from numeric to each cue span. Assign the tag associated with the nearest cue.\n  2) If distances are equal or ambiguous, prefer explicit 'grants' mapping (GrantsInPeriod) over NonvestedNumber unless the nonvested phrase is an explicit outstanding/unvested anchor (e.g., 'outstanding and unvested X RSUs').\n  3) If only vesting/performance cues exist (no explicit 'grants' or 'nonvested' cues in ±8 tokens), map to GrantsInPeriod only if an explicit grant-verb phrase exists elsewhere in same clause/sentence (±1 clause). Otherwise flag as 'ambiguous-grant-vs-nonvested' for human review rather than auto-assign NonvestedNumber.\n- Association window & antecedent resolution: allow antecedent grant-anchor ('the RSU grants' / 'the Plan') in previous sentence (±1 sentence) when anaphoric referent is used, but require antecedent span <= 40 tokens and the numeric must still be within ±16 tokens of the antecedent mention to auto-map. If antecedent resolution confidence is low, flag for review.\n- Unit-tests (atomic examples to add):\n  • \"Included in the RSU grants for the nine months ended September 30, 2018, are approximately 71,000 RSUs\" -> 71,000 = GrantsInPeriod.\n  • \"Approximately 71,000 RSUs were granted during the year\" -> 71,000 = GrantsInPeriod.\n  • \"Approximately 71,000 RSUs remain unvested and outstanding\" -> 71,000 = NonvestedNumber.\n  • \"Included in the grants are performance-vesting RSUs totaling 71,000\" -> 71,000 = GrantsInPeriod (do not infer NonvestedNumber from 'performance-vesting').\n- Logging & QA: when a mapping decision involves both grant- and vesting-related cues, log the numeric span, grant-cue span, vesting-cue span, chosen tag, and token-distance scores. Add any auto-mapped cases where only vesting/performance cues existed and mapping was attempted to a 'ambiguous-grant-vs-nonvested' queue for human review and model retraining.\n- Implementation note: apply this heuristic before any semantic-classifier fallback that infers outstanding/nonvested counts from vesting language. Explicit lexical matches for 'grants' must win unless a stronger explicit nonvested anchor is nearer to the numeric."}], "added_content": ["[ctx-00001] helpful=0 harmful=0 :: Atomic lexical-first heuristic: Distinguish 'GrantsInPeriod' vs 'NonvestedNumber' for share-based compensation counts.", "- Purpose: Prevent inferring 'nonvested' from mentions of vesting/performance conditions when the text explicitly states a grant count for a reporting period.", "- Exact grant lexical cues (case-insensitive regexes; match within same sentence): /\\b(grants?\\s+(for|during|issued\\s+(during|in))|granted\\s+(during|for)|included\\s+in\\s+the\\s+rsu\\s+grants|included\\s+in\\s+the\\s+grants)\\b/i and variants (e.g., 'awards granted during', 'grants for the [period]', 'granted during the [period]'). When such a pattern occurs and a numeric token is within ±8 tokens of the matched phrase, assign ShareBasedCompensationArrangementByShareBasedPaymentAwardEquityInstrumentsOtherThanOptionsGrantsInPeriod.", "- Exact nonvested lexical cues (case-insensitive regexes): /\\b(non-?vested|unvested|awards?\\s+(?:outstanding\\s+and\\s+unvested|outstanding and unvested|outstanding,? unvested)|shares?\\s+unvested)\\b/i. Only assign ShareBasedCompensationArrangementByShareBasedPaymentAwardEquityInstrumentsOtherThanOptionsNonvestedNumber when one of these cues occurs and the numeric token is within ±8 tokens of the nonvested cue.", "- Vesting/performance-criteria safeguard: phrases mentioning 'performance criteria', 'vesting conditions', 'three-year service criteria', 'will vest' etc. (regex examples: /\\b(performance\\s+criteria|vesting|vest|service\\s+criteria)\\b/i) must NOT by themselves trigger NonvestedNumber. Treat these as neutral modifiers unless explicit nonvested/unvested language appears close to the numeric. Do NOT map to NonvestedNumber solely because vesting conditions are described."], "removed_content": []}
{"timestamp": "2026-02-05T17:58:50.469311", "step": 11, "playbook_before_length": 42640, "playbook_after_length": 47489, "lines_before": 155, "lines_after": 156, "added_lines": 1, "removed_lines": 0, "operations_count": 1, "operations": [{"type": "ADD", "section": "context_clues_and_indicators", "content": "Measurement-term precedence (subject/predicative mapping) -- atomic heuristic: 1) Purpose: when multiple monetary nouns (e.g., 'fair value', 'carrying amount', 'carrying value', 'face amount', 'principal', 'par value') appear in the same clause, map the numeric to the measurement term that is the grammatical subject or the clause-level predicated measurement (the quantity the sentence is asserting), NOT simply to the nearest monetary noun. 2) Measurement-term lexicon (case-insensitive): fair value, market value, carrying amount, carrying value, carrying value of, face amount, principal amount, par value, book value, carrying balance, net book value. Map these lexicon entries to corresponding US GAAP tags (e.g., 'fair value' -> LongTermDebtFairValue when instrument anchor = long-term debt; 'carrying amount'/'carrying value' -> DebtInstrumentCarryingAmount). 3) Dependency-parse rule (preferred): if dependency parse available, locate the numeric token's clause; find the noun phrase that is the subject (nsubj) of the main verb (copula or verb like approximated/amounted/was/is/represented/totaled). If that subject noun phrase contains a measurement-term from the lexicon, assign numeric -> that measurement-term's tag. 4) Verb cue list (match within same clause): was|is|were|are|approximated|approximates|approximated to|equaled|equals|amounted to|amounts to|represented|totaled|comprised|included|reported|measured at. Use these to identify predicative constructions. 5) Regex fallback patterns (use when no parse): a) Pattern A (subject-predicate): /\\b(the|its|our|their)\\s+(fair value|market value|carrying amount|carrying value|book value|net book value)\\s+(was|is|approximated|approximates|amounted to|equaled|totaled|represented)\\s+(?:the\\s+)?(?:carrying\\s+amount\\s+of\\s+)?\\$?([0-9]{1,3}[\\d,]*(?:\\.\\d+)?)/i => map captured $ to measurement-term in subject (fair value wins). Example: 'The fair value of our debt obligations approximated the carrying amount of $73,000' => numeric maps to fair value. b) Pattern B (X approximated the carrying amount of $Y): /\\b(fair value|market value|book value)\\b[^\\.\\,]{0,60}?\\bapproximat(?:e|ed|es)\\b[^\\.\\,]{0,60}?\\bcarrying amount of\\s*\\$?([0-9,\\.]+)/i => map $ to first captured measurement (fair value). c) Pattern C (predicate is measurement term): /\\b(the\\s+carrying amount|the\\s+carrying value|the\\s+fair value|the\\s+face amount|par value)\\s+of\\s+[^,\\.]+\\s+(was|is|amounted to|totaled|equaled)\\s*\\$?([0-9,\\.]+)/i => if subject exists and differs (e.g., subject = 'fair value' approximated 'carrying amount of $X') apply subject precedence rule to map $ to subject's measurement-term when subject measurement-term present earlier in sentence. 6) Fallback tie-breakers (apply only if neither parse nor regex matches): a) If numeric is inside a prepositional 'of' phrase modifying a monetary noun (e.g., 'carrying amount of $X') but the sentence contains a different measurement-term that is the grammatical subject or occurs before the verb with a verb-cue (e.g., 'fair value approximated ...'), prefer the earlier-measured subject term. b) If no subject/predicate measurement-term is found, fall back to nearest monetary noun as before but flag the mapping with tag 'measurement-term-ambiguous' for human review. 7) Token/window policy: when using regex or heuristic windows, limit context to the same sentence; allow antecedent resolution to previous sentence only when anaphoric referents ('the fair value', 'that amount') clearly refer to instrument and antecedent span <= 40 tokens. 8) Instrument linking: after resolving measurement-term, ensure instrument anchor (debt/long-term debt) is detected in clause or prior sentence; map 'fair value' to LongTermDebtFairValue only when instrument context indicates long-term debt; otherwise map to generic fair-value tag for the asset/liability type and flag for review if ambiguous. 9) Logging & QA: when this rule overrides a nearest-noun heuristic, tag the mapping record with 'measurement-term-precedence' plus spans of subject-measurement-term, predicate-verb, and numeric token. Add failing-sentence unit-test(s): - 'At December 31, 2016, the fair value of our debt obligations approximated the carrying amount of $73,000.' -> $73,000 = LongTermDebtFairValue. - 'The fair value of the available-for-sale securities was $5,000.' -> $5,000 = FairValueForAvailableForSaleSecurities (appropriate fair-value tag). - 'The carrying amount was $10,000.' -> $10,000 = DebtInstrumentCarryingAmount (explicit carrying amount subject). 10) Implementation note: apply this measurement-term precedence before lexical nearest-match fallbacks and before any instrument-specific tie-breaker. Add all mapped examples that used nearest-noun before this rule to a retraining queue labeled 'measurement-term-conflict'."}], "added_content": ["[ctx-00002] helpful=0 harmful=0 :: Measurement-term precedence (subject/predicative mapping) -- atomic heuristic: 1) Purpose: when multiple monetary nouns (e.g., 'fair value', 'carrying amount', 'carrying value', 'face amount', 'principal', 'par value') appear in the same clause, map the numeric to the measurement term that is the grammatical subject or the clause-level predicated measurement (the quantity the sentence is asserting), NOT simply to the nearest monetary noun. 2) Measurement-term lexicon (case-insensitive): fair value, market value, carrying amount, carrying value, carrying value of, face amount, principal amount, par value, book value, carrying balance, net book value. Map these lexicon entries to corresponding US GAAP tags (e.g., 'fair value' -> LongTermDebtFairValue when instrument anchor = long-term debt; 'carrying amount'/'carrying value' -> DebtInstrumentCarryingAmount). 3) Dependency-parse rule (preferred): if dependency parse available, locate the numeric token's clause; find the noun phrase that is the subject (nsubj) of the main verb (copula or verb like approximated/amounted/was/is/represented/totaled). If that subject noun phrase contains a measurement-term from the lexicon, assign numeric -> that measurement-term's tag. 4) Verb cue list (match within same clause): was|is|were|are|approximated|approximates|approximated to|equaled|equals|amounted to|amounts to|represented|totaled|comprised|included|reported|measured at. Use these to identify predicative constructions. 5) Regex fallback patterns (use when no parse): a) Pattern A (subject-predicate): /\\b(the|its|our|their)\\s+(fair value|market value|carrying amount|carrying value|book value|net book value)\\s+(was|is|approximated|approximates|amounted to|equaled|totaled|represented)\\s+(?:the\\s+)?(?:carrying\\s+amount\\s+of\\s+)?\\$?([0-9]{1,3}[\\d,]*(?:\\.\\d+)?)/i => map captured $ to measurement-term in subject (fair value wins). Example: 'The fair value of our debt obligations approximated the carrying amount of $73,000' => numeric maps to fair value. b) Pattern B (X approximated the carrying amount of $Y): /\\b(fair value|market value|book value)\\b[^\\.\\,]{0,60}?\\bapproximat(?:e|ed|es)\\b[^\\.\\,]{0,60}?\\bcarrying amount of\\s*\\$?([0-9,\\.]+)/i => map $ to first captured measurement (fair value). c) Pattern C (predicate is measurement term): /\\b(the\\s+carrying amount|the\\s+carrying value|the\\s+fair value|the\\s+face amount|par value)\\s+of\\s+[^,\\.]+\\s+(was|is|amounted to|totaled|equaled)\\s*\\$?([0-9,\\.]+)/i => if subject exists and differs (e.g., subject = 'fair value' approximated 'carrying amount of $X') apply subject precedence rule to map $ to subject's measurement-term when subject measurement-term present earlier in sentence. 6) Fallback tie-breakers (apply only if neither parse nor regex matches): a) If numeric is inside a prepositional 'of' phrase modifying a monetary noun (e.g., 'carrying amount of $X') but the sentence contains a different measurement-term that is the grammatical subject or occurs before the verb with a verb-cue (e.g., 'fair value approximated ...'), prefer the earlier-measured subject term. b) If no subject/predicate measurement-term is found, fall back to nearest monetary noun as before but flag the mapping with tag 'measurement-term-ambiguous' for human review. 7) Token/window policy: when using regex or heuristic windows, limit context to the same sentence; allow antecedent resolution to previous sentence only when anaphoric referents ('the fair value', 'that amount') clearly refer to instrument and antecedent span <= 40 tokens. 8) Instrument linking: after resolving measurement-term, ensure instrument anchor (debt/long-term debt) is detected in clause or prior sentence; map 'fair value' to LongTermDebtFairValue only when instrument context indicates long-term debt; otherwise map to generic fair-value tag for the asset/liability type and flag for review if ambiguous. 9) Logging & QA: when this rule overrides a nearest-noun heuristic, tag the mapping record with 'measurement-term-precedence' plus spans of subject-measurement-term, predicate-verb, and numeric token. Add failing-sentence unit-test(s): - 'At December 31, 2016, the fair value of our debt obligations approximated the carrying amount of $73,000.' -> $73,000 = LongTermDebtFairValue. - 'The fair value of the available-for-sale securities was $5,000.' -> $5,000 = FairValueForAvailableForSaleSecurities (appropriate fair-value tag). - 'The carrying amount was $10,000.' -> $10,000 = DebtInstrumentCarryingAmount (explicit carrying amount subject). 10) Implementation note: apply this measurement-term precedence before lexical nearest-match fallbacks and before any instrument-specific tie-breaker. Add all mapped examples that used nearest-noun before this rule to a retraining queue labeled 'measurement-term-conflict'."], "removed_content": []}
{"timestamp": "2026-02-05T18:00:09.683273", "step": 12, "playbook_before_length": 47489, "playbook_after_length": 50943, "lines_before": 156, "lines_after": 158, "added_lines": 2, "removed_lines": 0, "operations_count": 2, "operations": [{"type": "ADD", "section": "context_clues_and_indicators", "content": "Tax-rate statutory mapping (atomic): - Purpose: deterministically map percentage tokens explicitly labeled as statutory/federal income tax rates to EffectiveIncomeTaxRateReconciliationAtFederalStatutoryIncomeTaxRate. - Exact lexical cues (case-insensitive regex examples): /\\b(statutor(y|ily)|statutory\\s+rate)\\b/, /\\b(U\\.?S\\.?|US|United\\s+States)\\s+(statutor(y|ily)|statutory)\\b/, /\\b(federal\\s+statutory|corporate\\s+federal\\s+income\\s+tax\\s+rate|U\\.S\\.\\s+statutory\\s+rate|statutory\\s+federal\\s+income\\s+tax\\s+rate)\\b/, /\\b(U\\.S\\.\\s+statutory\\s+rate)\\b/, /\\b(statutory\\s+income\\s+tax\\s+rate)\\b/. - Association window: require the percentage token (e.g., 35%, 21%) to appear within the same noun phrase or within ±4 tokens of any of the cues above, or anywhere in the same sentence when the cue and percentage clearly form the same measurement phrase (e.g., 'a statutory federal income tax rate of 35%'). - Precedence: when matched, assign EffectiveIncomeTaxRateReconciliationAtFederalStatutoryIncomeTaxRate and override generic effective-tax tags or other percentage-tag candidates. - Conflict rule: if multiple tax-rate tags exist (statutory vs. effective vs. state/local), prefer the reconciliation/statutory tag when 'statutory'/'federal'/'U.S.' lexical cue is present; if the sentence additionally includes 'state', 'local', or separate jurisdiction cues, prefer jurisdiction-specific statutory tag if available and log multi-jurisdiction ambiguity. - Unit-tests (atomic examples): - 'the U.S. statutory rate of 35%' -> 35% = EffectiveIncomeTaxRateReconciliationAtFederalStatutoryIncomeTaxRate. - 'a corporate federal income tax rate of 21%' -> 21% = EffectiveIncomeTaxRateReconciliationAtFederalStatutoryIncomeTaxRate. - 'the statutory federal income tax rate was 35%' -> 35% = EffectiveIncomeTaxRateReconciliationAtFederalStatutoryIncomeTaxRate. - Logging: record cue span and percentage span and label mapping as 'statutory-tax-rate-mapped' for QA/training. - Implementation note: apply this mapping before generic percentage-to-tag fallbacks and before any nearest-lexical-match tie-breaker."}, {"type": "ADD", "section": "problem-solving_heuristics", "content": "Tax-rate decision-flow delta (atomic): - Insert as a first-order step for percentage tokens: 1) For each percentage token, first scan for tax-rate measurement-terms in the same sentence or immediate noun phrase: lexical cues include 'statutory', 'federal', 'U.S.', 'corporate federal income tax rate', 'statutory income tax rate'. 2) If any statutory/federal tax cue matches within ±4 tokens (or forms a grammatical 'rate of X%' phrase), assign EffectiveIncomeTaxRateReconciliationAtFederalStatutoryIncomeTaxRate and stop further percentage-tag heuristics. 3) If multiple percentage tags remain plausible (e.g., 'effective tax rate' vs 'statutory rate'), prefer the most specific reconciliation/statutory tag when the statutory/federal cue is present. 4) If jurisdiction qualifiers exist (state/local/foreign) prefer the jurisdiction-specific statutory tag if available; otherwise flag as 'jurisdictional-tax-ambiguous' for review. 5) If no statutory/federal cue is found, continue the existing percentage mapping flow. 6) Add a unit-test batch to assert that any percent explicitly labeled 'statutory'/'U.S. statutory'/'federal statutory' is consistently mapped to EffectiveIncomeTaxRateReconciliationAtFederalStatutoryIncomeTaxRate and logged when multiple jurisdiction cues exist."}], "added_content": ["[ph-00004] helpful=0 harmful=0 :: Tax-rate decision-flow delta (atomic): - Insert as a first-order step for percentage tokens: 1) For each percentage token, first scan for tax-rate measurement-terms in the same sentence or immediate noun phrase: lexical cues include 'statutory', 'federal', 'U.S.', 'corporate federal income tax rate', 'statutory income tax rate'. 2) If any statutory/federal tax cue matches within ±4 tokens (or forms a grammatical 'rate of X%' phrase), assign EffectiveIncomeTaxRateReconciliationAtFederalStatutoryIncomeTaxRate and stop further percentage-tag heuristics. 3) If multiple percentage tags remain plausible (e.g., 'effective tax rate' vs 'statutory rate'), prefer the most specific reconciliation/statutory tag when the statutory/federal cue is present. 4) If jurisdiction qualifiers exist (state/local/foreign) prefer the jurisdiction-specific statutory tag if available; otherwise flag as 'jurisdictional-tax-ambiguous' for review. 5) If no statutory/federal cue is found, continue the existing percentage mapping flow. 6) Add a unit-test batch to assert that any percent explicitly labeled 'statutory'/'U.S. statutory'/'federal statutory' is consistently mapped to EffectiveIncomeTaxRateReconciliationAtFederalStatutoryIncomeTaxRate and logged when multiple jurisdiction cues exist.", "[ctx-00003] helpful=0 harmful=0 :: Tax-rate statutory mapping (atomic): - Purpose: deterministically map percentage tokens explicitly labeled as statutory/federal income tax rates to EffectiveIncomeTaxRateReconciliationAtFederalStatutoryIncomeTaxRate. - Exact lexical cues (case-insensitive regex examples): /\\b(statutor(y|ily)|statutory\\s+rate)\\b/, /\\b(U\\.?S\\.?|US|United\\s+States)\\s+(statutor(y|ily)|statutory)\\b/, /\\b(federal\\s+statutory|corporate\\s+federal\\s+income\\s+tax\\s+rate|U\\.S\\.\\s+statutory\\s+rate|statutory\\s+federal\\s+income\\s+tax\\s+rate)\\b/, /\\b(U\\.S\\.\\s+statutory\\s+rate)\\b/, /\\b(statutory\\s+income\\s+tax\\s+rate)\\b/. - Association window: require the percentage token (e.g., 35%, 21%) to appear within the same noun phrase or within ±4 tokens of any of the cues above, or anywhere in the same sentence when the cue and percentage clearly form the same measurement phrase (e.g., 'a statutory federal income tax rate of 35%'). - Precedence: when matched, assign EffectiveIncomeTaxRateReconciliationAtFederalStatutoryIncomeTaxRate and override generic effective-tax tags or other percentage-tag candidates. - Conflict rule: if multiple tax-rate tags exist (statutory vs. effective vs. state/local), prefer the reconciliation/statutory tag when 'statutory'/'federal'/'U.S.' lexical cue is present; if the sentence additionally includes 'state', 'local', or separate jurisdiction cues, prefer jurisdiction-specific statutory tag if available and log multi-jurisdiction ambiguity. - Unit-tests (atomic examples): - 'the U.S. statutory rate of 35%' -> 35% = EffectiveIncomeTaxRateReconciliationAtFederalStatutoryIncomeTaxRate. - 'a corporate federal income tax rate of 21%' -> 21% = EffectiveIncomeTaxRateReconciliationAtFederalStatutoryIncomeTaxRate. - 'the statutory federal income tax rate was 35%' -> 35% = EffectiveIncomeTaxRateReconciliationAtFederalStatutoryIncomeTaxRate. - Logging: record cue span and percentage span and label mapping as 'statutory-tax-rate-mapped' for QA/training. - Implementation note: apply this mapping before generic percentage-to-tag fallbacks and before any nearest-lexical-match tie-breaker."], "removed_content": []}
{"timestamp": "2026-02-05T18:00:16.977992", "step": 12, "playbook_before_length": 38622, "playbook_after_length": 42583, "lines_before": 138, "lines_after": 146, "added_lines": 8, "removed_lines": 0, "operations_count": 2, "operations": [{"type": "ADD", "section": "context_clues_and_indicators", "content": "Atomic lexical-to-tag rule: Map any percentage explicitly described as the federal (U.S.) statutory income tax rate in an effective-tax-rate reconciliation to EffectiveIncomeTaxRateReconciliationAtFederalStatutoryIncomeTaxRate.\n- Exact lexical cues (case-insensitive regexes): /federal\\s+(?:statutory\\s+)?income\\s+tax\\s+rate\\b/, /U\\.S\\.?\\s+statutory\\s+tax\\s+rate\\b/, /U\\.S\\.?\\s+federal\\s+statutory\\s+rate\\b/, /statutory\\s+tax\\s+rate\\b/ when co-occurring with 'federal' or 'U.S.'; also accept phrase variants that include 'used in reconciliation', 'used in the effective tax-rate reconciliation', or 'effective tax-rate reconciliation'.\n- Association window: require the percentage token to appear in the same sentence as the cue or within ±8 tokens of the cue; if 'reconciliation' or 'effective tax-rate' appears in the immediately preceding sentence (±1 sentence), allow antecedent resolution and link the percent to the cue across the sentence boundary (span <= 40 tokens).\n- Precedence: If this cue is detected, assign EffectiveIncomeTaxRateReconciliationAtFederalStatutoryIncomeTaxRate and override any generic percentage tags (e.g., InterestRate, ConcentrationRiskPercentage1) or ambiguous percent heuristics.\n- Ambiguity handling: If multiple percentage tokens and only one explicit 'federal statutory income tax rate' cue exists, map the percent nearest the cue; if no percent is within window, flag 'statutory-rate-no-percent' for review.\n- Unit-tests/examples: 'The federal statutory income tax rate was 35%.' -> 35% = EffectiveIncomeTaxRateReconciliationAtFederalStatutoryIncomeTaxRate; 'The U.S. statutory tax rate of 21% was used in the effective tax-rate reconciliation.' -> 21% = EffectiveIncomeTaxRateReconciliationAtFederalStatutoryIncomeTaxRate.\n- Logging: record numeric-token span and cue span ('federal statutory income tax rate' and 'reconciliation' if present) for QA traceability."}, {"type": "ADD", "section": "problem-solving_heuristics", "content": "Delta decision flow for tax-rate-percentage mapping (apply for each percentage token): 1) Sentence-level scan: detect tax-reconciliation anchors ('effective tax-rate reconciliation', 'reconciliation of effective tax rate', 'reconciled to') anywhere in the sentence or immediately preceding sentence (±1). 2) Detect statutory-rate cues (use lexical rule above). 3) If BOTH (a) reconciliation anchor present AND (b) 'federal'/'U.S.'/'statutory' tax-rate cue present within allowed windows -> deterministically assign EffectiveIncomeTaxRateReconciliationAtFederalStatutoryIncomeTaxRate to the nearest percentage token. 4) Tie-breaker: if more than one statutory-like cue exists, prefer the percent whose token-distance to the phrase 'federal statutory' is smallest; if equal, prefer the percent that co-occurs with the word 'rate' or the explicit phrase 'statutory'. 5) If reconciliation anchor is present but 'federal' qualifier is missing, prefer tag only when textual context explicitly references 'statutory' and jurisdiction 'U.S.'; otherwise flag as 'tax-rate-ambiguous-jurisdiction' and queue for human review (do not auto-map to federal statutory tag). 6) If other percentage-mapping heuristics (e.g., spreads, concentration) are also triggered, enforce precedence: statutory-reconciliation mapping > concentration/customer mapping > spread/basis mapping > generic percentage mapping. 7) Unit-tests to add: - 'Reconciled to the federal statutory income tax rate of 35%.' -> 35% = EffectiveIncomeTaxRateReconciliationAtFederalStatutoryIncomeTaxRate. - 'For the year ended, the U.S. statutory rate used in the reconciliation was 21%.' -> 21% = EffectiveIncomeTaxRateReconciliationAtFederalStatutoryIncomeTaxRate. - 'The statutory tax rate used in reconciliation was 25% (no jurisdiction specified)' -> flagged as 'tax-rate-ambiguous-jurisdiction'. 8) Logging: Always record reconciliation-anchor span, statutory-cue span, chosen numeric span, and applied tag for audit and retraining."}], "added_content": ["[ph-00002] helpful=0 harmful=0 :: Delta decision flow for tax-rate-percentage mapping (apply for each percentage token): 1) Sentence-level scan: detect tax-reconciliation anchors ('effective tax-rate reconciliation', 'reconciliation of effective tax rate', 'reconciled to') anywhere in the sentence or immediately preceding sentence (±1). 2) Detect statutory-rate cues (use lexical rule above). 3) If BOTH (a) reconciliation anchor present AND (b) 'federal'/'U.S.'/'statutory' tax-rate cue present within allowed windows -> deterministically assign EffectiveIncomeTaxRateReconciliationAtFederalStatutoryIncomeTaxRate to the nearest percentage token. 4) Tie-breaker: if more than one statutory-like cue exists, prefer the percent whose token-distance to the phrase 'federal statutory' is smallest; if equal, prefer the percent that co-occurs with the word 'rate' or the explicit phrase 'statutory'. 5) If reconciliation anchor is present but 'federal' qualifier is missing, prefer tag only when textual context explicitly references 'statutory' and jurisdiction 'U.S.'; otherwise flag as 'tax-rate-ambiguous-jurisdiction' and queue for human review (do not auto-map to federal statutory tag). 6) If other percentage-mapping heuristics (e.g., spreads, concentration) are also triggered, enforce precedence: statutory-reconciliation mapping > concentration/customer mapping > spread/basis mapping > generic percentage mapping. 7) Unit-tests to add: - 'Reconciled to the federal statutory income tax rate of 35%.' -> 35% = EffectiveIncomeTaxRateReconciliationAtFederalStatutoryIncomeTaxRate. - 'For the year ended, the U.S. statutory rate used in the reconciliation was 21%.' -> 21% = EffectiveIncomeTaxRateReconciliationAtFederalStatutoryIncomeTaxRate. - 'The statutory tax rate used in reconciliation was 25% (no jurisdiction specified)' -> flagged as 'tax-rate-ambiguous-jurisdiction'. 8) Logging: Always record reconciliation-anchor span, statutory-cue span, chosen numeric span, and applied tag for audit and retraining.", "[ctx-00001] helpful=0 harmful=0 :: Atomic lexical-to-tag rule: Map any percentage explicitly described as the federal (U.S.) statutory income tax rate in an effective-tax-rate reconciliation to EffectiveIncomeTaxRateReconciliationAtFederalStatutoryIncomeTaxRate.", "- Exact lexical cues (case-insensitive regexes): /federal\\s+(?:statutory\\s+)?income\\s+tax\\s+rate\\b/, /U\\.S\\.?\\s+statutory\\s+tax\\s+rate\\b/, /U\\.S\\.?\\s+federal\\s+statutory\\s+rate\\b/, /statutory\\s+tax\\s+rate\\b/ when co-occurring with 'federal' or 'U.S.'; also accept phrase variants that include 'used in reconciliation', 'used in the effective tax-rate reconciliation', or 'effective tax-rate reconciliation'.", "- Association window: require the percentage token to appear in the same sentence as the cue or within ±8 tokens of the cue; if 'reconciliation' or 'effective tax-rate' appears in the immediately preceding sentence (±1 sentence), allow antecedent resolution and link the percent to the cue across the sentence boundary (span <= 40 tokens).", "- Precedence: If this cue is detected, assign EffectiveIncomeTaxRateReconciliationAtFederalStatutoryIncomeTaxRate and override any generic percentage tags (e.g., InterestRate, ConcentrationRiskPercentage1) or ambiguous percent heuristics."], "removed_content": []}
{"timestamp": "2026-02-05T18:01:17.640711", "step": 13, "playbook_before_length": 50943, "playbook_after_length": 55732, "lines_before": 158, "lines_after": 185, "added_lines": 26, "removed_lines": 0, "operations_count": 1, "operations": [{"type": "ADD", "section": "context_clues_and_indicators", "content": "Measurement-aware customer-concentration mapping (atomic heuristic):\n- Purpose: ensure percentage tokens that quantify a named customer's share of a specific measure (revenue, trade receivables, other) map to the most specific concentration tag available in the taxonomy rather than always to the generic ConcentrationRiskPercentage1.\n- Detection patterns (case-insensitive; apply to the sentence containing the percentage and ±1 surrounding sentence for antecedents):\n  - customer anchor cues: /\\b(customer|customers|client|clients|Tech\\s+Data|the\\s+customer)\\b/ within ±10 tokens of the percentage or elsewhere in same sentence. Require a named-customer token OR lexical 'customer(s)' anchor to consider customer-concentration mapping.\n  - revenue measurement cues: /\\b(revenue|revenues|total\\s+net\\s+revenue|net\\s+revenue|sales)\\b/ within ±10 tokens of the percentage or in an immediately adjoining noun phrase 'of (our|the|Company's) (total\\s+net\\s+)?revenue'.\n  - receivables measurement cues: /\\b(accounts?\\s+receivable|trade\\s+accounts\\s+receivable|receivables|trade\\s+receivables)\\b/ within ±10 tokens of the percentage or in 'of (our|the) trade accounts receivable'.\n- Taxonomy lookup & selection algorithm (atomic steps):\n  1) Upon detecting a percentage token and a customer anchor, extract the nearest measurement-cue (revenue OR receivable) within ±10 tokens; if none found, mark measurement = 'unspecified'.\n  2) Query the taxonomy for candidate concentration tags whose names or metadata contain measurement qualifiers (search for token groups: ['revenue','receivable','receivables','accounts receivable','trade receivable','sales']).\n  3) If measurement == 'revenue' and taxonomy contains any tag whose id/name contains revenue-related token(s) (e.g., ...RevenueConcentration..., ...ConcentrationPercentageOfRevenue...), select the most specific revenue-tag. If multiple revenue-specific tags exist, prefer the one with the closest lexical match (e.g., 'total net revenue' > 'revenue').\n  4) If measurement == 'receivable' and taxonomy contains any receivable-specific concentration tag, select the most specific receivable-tag.\n  5) If measurement == 'unspecified' OR no measurement-specific tag exists in taxonomy, select generic ConcentrationRiskPercentage1.\n  6) If taxonomy contains both revenue- and receivable-specific tags but measurement cue matches neither or both ambiguously, flag as 'concentration-measurement-ambiguous' for human review rather than auto-assigning generic tag.\n- Precedence & tie-breakers (apply in order):\n  a) Exact phrase match to measurement (e.g., 'total net revenue', 'trade accounts receivable') -> choose taxonomy tag whose metadata/name contains that exact phrase.\n  b) Measurement-category match (revenue vs receivable) -> choose tag with matching category token.\n  c) If both revenue and receivable cues appear in same sentence referring to different percentages, resolve each percentage by its nearest measurement cue; do not conflate.\n  d) If proximity equal and both tag types exist, flag for review (do not default to generic without logging).\n- Token windows and antecedent resolution:\n  - Primary window: ±10 tokens around percentage for measurement cues.\n  - Antecedent window: allow measurement-anchor in immediately preceding sentence (±1 sentence) when anaphoric phrases ('the receivables', 'those revenues') appear; antecedent span must be <= 40 tokens.\n- Unit-tests (atomic examples to add):\n  - 'Tech Data accounted for 7% of Autodesk's total net revenue.' -> 7% = (taxonomy tag that contains 'revenue' e.g., ConcentrationRiskPercentageRevenue) else ConcentrationRiskPercentage1.\n  - 'Tech Data accounted for 5% of trade accounts receivable.' -> 5% = (taxonomy tag that contains 'receivable' e.g., ConcentrationRiskPercentageReceivables) else ConcentrationRiskPercentage1.\n  - 'Our largest customer represented 22%.' (no measurement cue) -> flag 'concentration-measurement-ambiguous' and queue for human review; do NOT auto-map to revenue-specific tag.\n- Logging & QA: always record the percentage span, customer anchor span, measurement cue span, chosen taxonomy tag id, and whether a measurement-specific tag was found. For any fallback to generic ConcentrationRiskPercentage1, record which measurement-specific candidate tags were present in taxonomy and why they were not chosen (absent/mismatch/ambiguous) to support retraining.\n- Implementation note: apply this heuristic before any generic 'customer+percent -> ConcentrationRiskPercentage1' fallback. Make the taxonomy-query a deterministic step in the mapping pipeline so that future additions to the taxonomy (e.g., revenue- or receivable-specific concentration tags) are automatically preferred when measurement cues exist."}], "added_content": ["[ctx-00005] helpful=0 harmful=0 :: Measurement-aware customer-concentration mapping (atomic heuristic):", "- Purpose: ensure percentage tokens that quantify a named customer's share of a specific measure (revenue, trade receivables, other) map to the most specific concentration tag available in the taxonomy rather than always to the generic ConcentrationRiskPercentage1.", "- Detection patterns (case-insensitive; apply to the sentence containing the percentage and ±1 surrounding sentence for antecedents):", "  - customer anchor cues: /\\b(customer|customers|client|clients|Tech\\s+Data|the\\s+customer)\\b/ within ±10 tokens of the percentage or elsewhere in same sentence. Require a named-customer token OR lexical 'customer(s)' anchor to consider customer-concentration mapping.", "  - revenue measurement cues: /\\b(revenue|revenues|total\\s+net\\s+revenue|net\\s+revenue|sales)\\b/ within ±10 tokens of the percentage or in an immediately adjoining noun phrase 'of (our|the|Company's) (total\\s+net\\s+)?revenue'."], "removed_content": []}
{"timestamp": "2026-02-05T18:01:30.658794", "step": 13, "playbook_before_length": 42583, "playbook_after_length": 46861, "lines_before": 146, "lines_after": 161, "added_lines": 15, "removed_lines": 0, "operations_count": 1, "operations": [{"type": "ADD", "section": "common_mistakes_to_avoid", "content": "err-000XX :: Heuristic-use logging and auto-linking rule (atomic prevention of traceability inconsistencies): Purpose: ensure every auto-assigned tag that corresponds to a playbook heuristic is recorded with that heuristic id and supporting evidence; detect and correct cases where tag assignment and playbook-bullet usage are inconsistent.\nRules (apply at tag-assignment time, deterministic steps):\n1) Heuristic-match pass (post-tag decision): run a deterministic heuristic-matcher over the sentence/span using the canonical set of playbook heuristics (use same regexes/token-windows as playbook bullets) and compute for each bullet: match_score = sum(matched_cues_weight) - distance_penalty. Use identical precedence rules as the playbook.\n2) If the assigned tag equals the top-scoring playbook bullet's canonical mapping AND match_score >= MATCH_THRESHOLD (e.g., 0.7), then automatically attach the following fields to the annotation: { attached_bullet_id: <id>, match_score: <float>, matched_cue_spans: [ { cue_text, start_token, end_token } ], numeric_span: { start_token, end_token }, evidence_sentence_id }.\n3) If the assigned tag equals a playbook canonical mapping but no bullet matched with score >= MATCH_THRESHOLD, create a derived_bullet record with id derived-<hash> containing the observed cue patterns, numeric span, sentence, and system-generated regex; attach derived_bullet_id to the annotation and add the derived record to the 'to-review' queue.\n4) If the generator attempted to attach 'no playbook bullet used' but the post-decision heuristic-match finds a bullet with match_score >= MATCH_THRESHOLD, override 'no-bullet' flag by attaching the matched bullet id and log an inconsistency event: { event: 'bullet-missing-on-output', predicted_tag, matched_bullet_id, match_score, run_id }.\n5) If the assigned tag does NOT correspond to any existing bullet mapping, attach explicit { attached_bullet_id: null, reason: 'no-bullet-match', top_candidate_bullets: [ {id, match_score} ] } and queue example for playbook author review if top_candidate match_score >= REVIEW_THRESHOLD (e.g., 0.5).\n6) Mandatory trace fields (always attach these to each numeric-tag annotation): { tag_assigned, numeric_span_tokens, anchor_span_tokens (if any), attached_bullet_id (or derived id or null), match_score, matched_cue_texts, confidence_score, provenance: { model_version, pipeline_version, timestamp } }.\n7) Post-commit validator: after annotation commit, run a validator that checks 'if tag_assigned in canonical_playbook_map and attached_bullet_id not equal canonical_id then emit error-level QA record and auto-attach canonical_id (idempotent). Example: if tag_assigned == ConcentrationRiskPercentage1 and canonical bullet==ctx-00013 but attached_bullet_id==null -> auto-attach ctx-00013 and create QA record.\n8) Unit-tests (atomic examples to add to CI):\n   - Sentence: 'Tech Data accounted for 32% of total net revenue for the year' -> expected: ConcentrationRiskPercentage1 attached_bullet_id == 'ctx-00013', matched_cue_spans include 'of total net revenue' and 'Tech Data'.\n   - Negative: 'Random percent in unrelated sentence' -> if no playbook bullet matches, attached_bullet_id == null and top_candidate_bullets list empty or low scores.\n   - Inconsistency detection: simulate pipeline that would earlier output 'no bullet used' but matches ctx-00013 on validator; assert validator auto-attaches ctx-00013 and emits QA record 'bullet-missing-on-output'.\n9) Logging & QA metrics: record counts and example lists for (a) auto-attached bullets, (b) derived bullets created, (c) inconsistency corrections. Surface these in weekly QA dashboard and include example spans for human review. Persist match_score thresholds and allow hyperparameter tuning, but require explicit change-log entry when thresholds are updated.\n10) Implementation notes: Implement this rule as a lightweight deterministic post-processing module in the tagging pipeline (idempotent). It must run the same matching logic as playbook bullets to avoid mismatch. Add regression tests to ensure existing high-confidence mappings (e.g., ctx-00013 -> customer concentration percent -> ConcentrationRiskPercentage1) always result in attached_bullet_id == ctx-00013."}], "added_content": ["[err-00003] helpful=0 harmful=0 :: err-000XX :: Heuristic-use logging and auto-linking rule (atomic prevention of traceability inconsistencies): Purpose: ensure every auto-assigned tag that corresponds to a playbook heuristic is recorded with that heuristic id and supporting evidence; detect and correct cases where tag assignment and playbook-bullet usage are inconsistent.", "Rules (apply at tag-assignment time, deterministic steps):", "1) Heuristic-match pass (post-tag decision): run a deterministic heuristic-matcher over the sentence/span using the canonical set of playbook heuristics (use same regexes/token-windows as playbook bullets) and compute for each bullet: match_score = sum(matched_cues_weight) - distance_penalty. Use identical precedence rules as the playbook.", "2) If the assigned tag equals the top-scoring playbook bullet's canonical mapping AND match_score >= MATCH_THRESHOLD (e.g., 0.7), then automatically attach the following fields to the annotation: { attached_bullet_id: <id>, match_score: <float>, matched_cue_spans: [ { cue_text, start_token, end_token } ], numeric_span: { start_token, end_token }, evidence_sentence_id }.", "3) If the assigned tag equals a playbook canonical mapping but no bullet matched with score >= MATCH_THRESHOLD, create a derived_bullet record with id derived-<hash> containing the observed cue patterns, numeric span, sentence, and system-generated regex; attach derived_bullet_id to the annotation and add the derived record to the 'to-review' queue."], "removed_content": []}
{"timestamp": "2026-02-05T18:02:35.581600", "step": 14, "playbook_before_length": 55732, "playbook_after_length": 59860, "lines_before": 185, "lines_after": 206, "added_lines": 21, "removed_lines": 0, "operations_count": 1, "operations": [{"type": "ADD", "section": "context_clues_and_indicators", "content": "ctx-000XX :: Percent-as-instrument-coupon (atomic heuristic to map percent tokens that are lexical modifiers of debt instrument names to DebtInstrumentInterestRateStatedPercentage)\n- Purpose: deterministically map percentage tokens that directly modify or are explicitly tied to debt-instrument nouns to DebtInstrumentInterestRateStatedPercentage, even when 'per annum' is absent.\n- Exact lexical patterns (case-insensitive regexes; apply before generic percent fallbacks):\n  1) Percent-before-instrument (adjacent modifier): /\\b([0-9]+(?:\\.[0-9]+)?)\\s*%\\s*(?:coupon\\s+)?\\s*(?:on\\s+)?(?:the\\s+)?(senior\\s+notes|senior\\s+note|notes|note|term\\s+loan|loan|revolver|seller\\s+note|debenture|obligation)s?\\b/i\n  2) Instrument-bearing-percent (instrument then explicit verb/phrase): /\\b(senior\\s+notes|senior\\s+note|notes|note|term\\s+loan|loan|revolver|seller\\s+note|debenture|obligation)s?\\b[\\s\\S]{0,40}?\\b(?:bearing\\s+interest\\s+at|bearing\\s+interest\\s+of|with\\s+interest\\s+of|with\\s+an\\s+interest\\s+rate\\s+of|at|rates?\\s+of)\\s*([0-9]+(?:\\.[0-9]+)?)\\s*%/i\n  3) Parenthetical/inline: /\\b(senior\\s+notes|notes|term\\s+loan|revolver)\\b[^,\\n\\r]{0,40}?\\(.*?([0-9]+(?:\\.[0-9]+)?)\\s*%.*?\\)/i\n- Association window & adjacency rule:\n  - For pattern (1), require percent token to be adjacent to or within 1 token of the instrument noun (effectively immediate modifier): treat as direct coupon modifier.\n  - For pattern (2)/(3), allow up to 40-token span across intervening descriptive words but require explicit linking verbs/phrases ('bearing interest at', 'with interest of', 'at') to assert instrument-rate relation.\n- Precedence & conflict resolution (apply in order):\n  1) If Percent-as-instrument-coupon pattern matches -> assign DebtInstrumentInterestRateStatedPercentage and link mapping to the detected instrument anchor (capture instrument span). This mapping overrides generic percentage tags (e.g., concentration, generic 'percentage' tags) and overrides spread tags unless a spread indicator is also present (see 2).\n  2) If the sentence also contains explicit spread/basis cues (LIBOR/ABR + 'plus'/'over' or 'margin'/'spread' within ±6 tokens of the percent) -> prefer DebtInstrumentBasisSpreadOnVariableRate1 for that percent and log 'rate-vs-spread-conflict' (do not auto-assign stated-rate). Only assign stated-rate if the percent is syntactically a modifier of the instrument name (pattern 1) and no spread cues are present.\n  3) If both 'per annum' and an instrument-anchor are present but text also contains 'plus'/'LIBOR', prefer spread mapping for the LIBOR-plus form; otherwise prefer DebtInstrumentInterestRateStatedPercentage.\n- Tag-linking requirement: when assigning DebtInstrumentInterestRateStatedPercentage, also capture and record the instrument anchor span (e.g., 'Senior Notes') so that downstream QA can link the rate to the correct debt instrument id.\n- Unit-tests / atomic examples to add:\n  - 'we issued 2.250% Senior Notes due 2025' -> 2.250% = DebtInstrumentInterestRateStatedPercentage (instrument anchor: Senior Notes).\n  - 'Senior Notes bearing interest at 2.250% were issued' -> 2.250% = DebtInstrumentInterestRateStatedPercentage.\n  - 'The interest rate is 4.15% per annum on the term loan' -> 4.15% = DebtInstrumentInterestRateStatedPercentage (covered by existing per-annum rule; ensure no regression).\n  - 'LIBOR plus 4.15%' alongside 'Senior Notes at 4.15%' -> percent next to 'LIBOR plus' = DebtInstrumentBasisSpreadOnVariableRate1; percent adjacent to 'Senior Notes' = DebtInstrumentInterestRateStatedPercentage; log if same numeric appears in conflicting positions.\n- Logging & QA: record percent token span, instrument anchor span, matched pattern id (1/2/3), chosen tag id, and any conflict reason. If mapping overrides a previously considered spread/market tag, add sample to 'rate-vs-spread-conflict' queue for human review and inclusion in unit-tests.\n- Implementation note: insert this rule into the pipeline before generic percentage-to-tag heuristics and before classifier fallbacks so that adjacency-based stated-rate matches win deterministically."}], "added_content": ["[ctx-00006] helpful=0 harmful=0 :: ctx-000XX :: Percent-as-instrument-coupon (atomic heuristic to map percent tokens that are lexical modifiers of debt instrument names to DebtInstrumentInterestRateStatedPercentage)", "- Purpose: deterministically map percentage tokens that directly modify or are explicitly tied to debt-instrument nouns to DebtInstrumentInterestRateStatedPercentage, even when 'per annum' is absent.", "- Exact lexical patterns (case-insensitive regexes; apply before generic percent fallbacks):", "  1) Percent-before-instrument (adjacent modifier): /\\b([0-9]+(?:\\.[0-9]+)?)\\s*%\\s*(?:coupon\\s+)?\\s*(?:on\\s+)?(?:the\\s+)?(senior\\s+notes|senior\\s+note|notes|note|term\\s+loan|loan|revolver|seller\\s+note|debenture|obligation)s?\\b/i", "  2) Instrument-bearing-percent (instrument then explicit verb/phrase): /\\b(senior\\s+notes|senior\\s+note|notes|note|term\\s+loan|loan|revolver|seller\\s+note|debenture|obligation)s?\\b[\\s\\S]{0,40}?\\b(?:bearing\\s+interest\\s+at|bearing\\s+interest\\s+of|with\\s+interest\\s+of|with\\s+an\\s+interest\\s+rate\\s+of|at|rates?\\s+of)\\s*([0-9]+(?:\\.[0-9]+)?)\\s*%/i"], "removed_content": []}
{"timestamp": "2026-02-05T18:02:55.494082", "step": 14, "playbook_before_length": 46861, "playbook_after_length": 52321, "lines_before": 161, "lines_after": 186, "added_lines": 25, "removed_lines": 0, "operations_count": 2, "operations": [{"type": "ADD", "section": "context_clues_and_indicators", "content": "Depreciation & Amortization lexical-to-tag atomic rule (exact cues + variants):\n1) Purpose: deterministically map currency amounts labeled as depreciation/amortization to the most specific US GAAP tags and ensure comparative/sibling numeric mentions in the same clause use the same tag.\n2) Exact lexical cues (case-insensitive regex examples):\n   - Depreciation cues -> /\\bdepreciation\\s+expense(s)?\\b/, /\\bdepreciation\\b/.\n   - Amortization cues -> /\\bamortization\\s+expense(s)?\\b/, /\\bamortization\\b/.\n   - Amortization-of-intangibles qualifier -> /finite-?lived|intangible(s)?|intangibles/ (must co-occur with amortization cue to map to AmortizationOfIntangibleAssets).\n3) Association window: for any currency numeric token in the same sentence, if the sentence contains a Depreciation cue within ±12 tokens -> assign Depreciation to that numeric token. If the sentence contains an Amortization cue AND an intangible qualifier (as above) within ±12 tokens of the numeric token -> assign AmortizationOfIntangibleAssets. If amortization cue appears without intangible qualifier, assign generic Amortization tag if present in taxonomy; otherwise flag as 'amortization-ambiguous-asset-type' for review.\n4) Same-sentence/comparative rule: when multiple numeric tokens appear in the same clause/sentence associated with the same explicit expense cue (e.g., \"Depreciation expense of $29 million and $28 million was recognized\"), map all such tokens to the same canonical tag (Depreciation or AmortizationOfIntangibleAssets) rather than splitting across different tags. Implementation: if a single expense-cue span covers multiple numeric spans, assign the canonical tag to every numeric in that cue-span.\n5) Precedence: these rules override generic currency-to-expense fallbacks. If both Depreciation and Amortization cues appear in the same sentence, assign by nearest token-distance to each numeric; if equidistant, prefer the cue that explicitly names the asset class (e.g., 'intangible') -> AmortizationOfIntangibleAssets.\n6) Unit-tests/examples (atomic):\n   - \"Depreciation expense of $29 million and $28 million was recognized\" -> both $29M and $28M = Depreciation.\n   - \"Amortization expense related to finite-lived intangible assets was $38 million\" -> $38M = AmortizationOfIntangibleAssets.\n   - \"Amortization expense was $38 million and $31 million\" (same sentence, same cue) -> both = AmortizationOfIntangibleAssets (if qualifier present) or Amortization (if no qualifier and taxonomy has only Amortization).\n7) Logging: record matched cue span, matched qualifier spans (e.g., 'finite-lived', 'intangible'), numeric spans, attached_tag, and attached_bullet_id (if playbook bullet exists). Flag ambiguous/no-qualifier amortization mappings for human review."}, {"type": "ADD", "section": "context_clues_and_indicators", "content": "Percent-on-issued-debt instrument atomic rule (issue-percent -> DebtInstrumentInterestRateStatedPercentage):\n1) Purpose: map percentages that directly qualify newly-issued/named debt instruments in issuance language to DebtInstrumentInterestRateStatedPercentage and link to the instrument anchor.\n2) Exact lexical/anchor cues (case-insensitive): issuance verbs/phrases: /\\bissued\\b/, /\\bissued\\s+and\\s+sold\\b/, /\\bwe\\s+issued\\b/, /\\bissued\\s+%\\b/, instrument types: /senior\\s+notes|notes|note|term\\s+loan|loan|seller\\s+note|revolver|debentures/i.\n3) Pattern to detect percentages attached to issuance: numeric percentage token immediately adjacent or within ±3 tokens of issuance-verb + instrument anchor (e.g., \"issued 2.250% Senior Notes\"). Regex example to match pattern: /(issued|we\\s+issued|issued\\s+and\\s+sold)\\s+([0-9]+(?:\\.[0-9]+)?%|[0-9]+(?:\\.[0-9]+)?\\s*percent)\\s+([A-Za-z ]*(note|notes|senior|loan|debenture))/i.\n4) Association window: require both percentage token and instrument-anchor in same sentence OR instrument-anchor in previous sentence (antecedent allowed up to ±1 sentence and <= 40 token span). If instrument-anchor present, require percentage within <=12 tokens of the anchor in same sentence; if anchor in prior sentence allow <=40 token cross-boundary span.\n5) Mapping & precedence: when matched, deterministically assign DebtInstrumentInterestRateStatedPercentage and attach instrument identity (e.g., 'Senior Notes') as anchor metadata. This mapping takes precedence over generic percentage tags (spread, concentration, statutory tax) and over generic interest-rate fallbacks. If both 'margin/spread' cues and direct issuance percentage co-occur (rare), prefer this issuance-stated-rate mapping but log 'rate-vs-spread-conflict' for QA.\n6) Same-sentence numeric siblings: if issuance phrase presents more than one percentage (range or two comparative percentages) within the same issuance-clause, map each to DebtInstrumentInterestRateStatedPercentage and preserve order/association to instrument; if percentages describe different instruments in same sentence, link each percentage to the nearest instrument anchor by token-distance.\n7) Unit-tests/examples:\n   - \"we issued 2.250% Senior Notes\" -> 2.250% = DebtInstrumentInterestRateStatedPercentage (anchor: Senior Notes).\n   - \"Issued 6.00% term loan and 5.25% revolver\" -> 6.00% -> DebtInstrumentInterestRateStatedPercentage (term loan), 5.25% -> DebtInstrumentInterestRateStatedPercentage (revolver).\n8) Logging: record issuance-verb span, percentage span(s), instrument-anchor span(s), assigned_tag, and attached_bullet_id for traceability."}], "added_content": ["[ctx-00004] helpful=0 harmful=0 :: Depreciation & Amortization lexical-to-tag atomic rule (exact cues + variants):", "1) Purpose: deterministically map currency amounts labeled as depreciation/amortization to the most specific US GAAP tags and ensure comparative/sibling numeric mentions in the same clause use the same tag.", "2) Exact lexical cues (case-insensitive regex examples):", "   - Depreciation cues -> /\\bdepreciation\\s+expense(s)?\\b/, /\\bdepreciation\\b/.", "   - Amortization cues -> /\\bamortization\\s+expense(s)?\\b/, /\\bamortization\\b/."], "removed_content": []}
{"timestamp": "2026-02-05T18:05:00.366787", "step": 15, "playbook_before_length": 52321, "playbook_after_length": 59784, "lines_before": 186, "lines_after": 228, "added_lines": 33, "removed_lines": 0, "operations_count": 2, "operations": [{"type": "ADD", "section": "context_clues_and_indicators", "content": "[ctx-xxxx] helpful=0 harmful=0 :: Share-based compensation mapping (atomic heuristics to disambiguate 'recognized' vs 'vested' vs 'expected to be recognized' and 'weighted-average period' vs 'award vesting period')\n\nPurpose: deterministically map numeric tokens in share-based-compensation disclosures to the correct accounting-measure tags by matching measurement verbs/phrases and period semantics rather than relying on lexically-similar tag names.\n\n1) Exact lexical cue groups (case-insensitive regexes):\n   - Recognized/Expense cues -> /(\\brecognized\\b|\\brecorded\\b|\\bexpensed\\b|\\bwas\\s+recognized\\b|\\bwere\\s+recognized\\b|\\bcompensation\\s+expense\\b)/i\n   - Vested + fair-value cues -> /\\bvested\\b.*?(fair\\s*value|total\\s+fair\\s+value)|(?:fair\\s*value).*?vested/i\n   - Unrecognized + expected-to-be-recognized period cues -> /unrecogniz(?:ed|ance)|compensation\\s+cost\\s+not\\s+yet\\s+recognized|not\\s+yet\\s+recognized\\s+compensation|total\\s+unrecognized\\s+compensation\\b/i AND /(expected\\s+to\\s+be\\s+recognized|expected\\s+to\\s+be\\s+recognized\\s+over|will\\s+be\\s+recognized\\s+over|weighted-?average\\s+period)/i\n   - Award-vesting-period lexical forms (to avoid mis-mapping) -> /(?:award|vesting|vesting\\s+period|award\\s+vests|vesting\\s+schedule)\\b/i\n   - Weighted-average qualifier -> /weighted-?average\\s+period|weighted-?average\\s+remaining\\s+period\\b/i\n\n2) Token-window & association policy:\n   - Numeric tokens within the same sentence are primary; allow antecedent resolution to previous sentence only if an anaphor ('these awards', 'such awards', 'the unrecognized cost') exists and antecedent span <= 40 tokens.\n   - For 'unrecognized' + 'expected to be recognized' mapping, require both an unrecognized-cost cue and a period-phrase cue (e.g., 'expected to be recognized over a weighted-average period of X years') within ±12 tokens of the numeric token OR in the same clause.\n   - For 'recognized' mapping, require a recognized/recorded/expensed cue within ±8 tokens of the numeric token.\n   - For 'vested fair value' mapping, require explicit 'vested' and 'fair value' cues co-occurring within ±6 tokens of the numeric token (both cues required). Presence of only 'vested' without 'fair value' should not auto-map to VestedInPeriodTotalFairValue.\n\n3) Deterministic mapping rules & precedence (apply in order):\n   A) If numeric + (unrecognized-cost cue) + (expected-to-be-recognized OR weighted-average qualifier) -> assign EmployeeServiceShareBasedCompensationNonvestedAwardsTotalCompensationCostNotYetRecognizedPeriodForRecognition1 for the PERIOD numeric tokens and EmployeeServiceShareBasedCompensationNonvestedAwardsTotalCompensationCostNotYetRecognized for related AMOUNT tokens (if present). Do NOT map to award-vesting-period tags even if 'period' appears; add anchor note recording 'weighted-average period for recognition'.\n   B) Else if numeric + recognized/recorded/expensed cue (verb forms above) -> assign AllocatedShareBasedCompensationExpense (map to expense/allocated tag). This captures sentences like 'The Company recognized $X of share-based compensation during the [period]'.\n   C) Else if numeric + BOTH 'vested' AND 'fair value' cues -> assign ShareBasedCompensationArrangementByShareBasedPaymentAwardEquityInstrumentsOtherThanOptionsVestedInPeriodTotalFairValue (vested-in-period total fair value tag).\n   D) Else if numeric + 'vested' cue ONLY (no 'fair value') -> do NOT auto-assign vested-fair-value tag; prefer human-review or consider other expense cues in sentence; log as 'vested-no-fairvalue-ambiguous'.\n   E) Else if numeric contains 'weighted-average' but no unrecognized-cost/unrecognized cue -> prefer human review: do NOT assume award-vesting-period. Only map to ShareBasedCompensationArrangementByShareBasedPaymentAwardAwardVestingPeriod1 if explicit 'award-level vesting schedule' language appears (e.g., 'each award vests over X years' or 'vesting period of each award is X years').\n\n4) Anti-pattern rule (atomic): never map the phrase 'weighted-average period' found in context of 'unrecognized compensation cost' to an award vesting-period tag. The token window check in 2) and precedence in 3) enforce this.\n\n5) Unit-tests/examples to add (atomic):\n   - 'The Company recognized $3.2 million of share-based compensation during the three months ended March 31, 2018.' -> $3.2M = AllocatedShareBasedCompensationExpense.\n   - 'Total unrecognized compensation cost related to nonvested awards expected to be recognized over a weighted-average period of 2.34 years.' -> 2.34 years = EmployeeServiceShareBasedCompensationNonvestedAwardsTotalCompensationCostNotYetRecognizedPeriodForRecognition1 (and the unrecognized amount maps to NonvestedAwardsTotalCompensationCostNotYetRecognized if present).\n   - 'The total fair value of awards that vested during the period was $X.' -> $X = VestedInPeriodTotalFairValue (requires explicit 'fair value' + 'vested').\n   - 'The weighted-average remaining contractual term of options outstanding is X years' (explicit award-vesting schedule language) -> map to ShareBasedCompensationArrangementByShareBasedPaymentAwardAwardVestingPeriod1 only when clause clearly describes award vesting schedule.\n\n6) Logging & QA: attach to each auto-assigned annotation: matched_cue_spans (which of the cue groups matched), mapping-rule-id ctx-xxxx, applied_precedence_clause (A/B/C), and a 'semantic_role' field with values { 'expense/allocated', 'vested_fair_value', 'recognition_period' }. Flag any sentence where 'recognized' and 'vested' both appear with conflicting numeric tags as 'recognized-vs-vested-conflict' and queue for human review.\n\n7) Implementation note: run this mapping before generic lexical fallbacks that equate 'period' -> vesting-period or 'recognized' -> vested; this deterministic module must consult tag definitions if available to verify 'PeriodForRecognition' vs 'AwardVestingPeriod' suffix semantics."}, {"type": "ADD", "section": "common_mistakes_to_avoid", "content": "[err-xxxx] helpful=0 harmful=0 :: Anti-pattern: equating 'recognized' with 'vested' in share-based compensation disclosures. Prevention checklist (atomic):\n\n1) Detection: if sentence contains verb 'recognized'/'recorded'/'expensed' within ±8 tokens of numeric token, do NOT map to any 'vested' fair-value tag unless explicit 'vested' AND 'fair value' are both present (within ±6 tokens).\n2) If sentence contains 'unrecognized' + 'expected to be recognized' or 'weighted-average period' in proximity to the numeric token, do NOT map to award-vesting-period tags; instead map period to the 'PeriodForRecognition' tag (only when unrecognized-cost cue present).\n3) Disambiguation priority (use before labeling): expense-recognition verbs > unrecognized-recognition-period cues > vested+fair-value cues > generic 'period'/'vesting' lexical matches.\n4) Unit-tests to add to CI to prevent regression: include at least 6 sentences mixing 'recognized', 'vested', 'fair value', and 'weighted-average' in different permutations showing correct/incorrect mappings (examples from ctx-xxxx unit-tests). Failing any unit-test should block model auto-assignment for that pattern and trigger human-review.\n5) Training data capture: whenever the system would have mapped 'recognized' -> vested-fair-value but the precedence rule chooses AllocatedShareBasedCompensationExpense, log the positive example (sentence, predicted tag, corrected tag) into a 'recognized-vs-vested' training bucket for model fine-tuning."}], "added_content": ["[err-00007] helpful=0 harmful=0 :: [err-xxxx] helpful=0 harmful=0 :: Anti-pattern: equating 'recognized' with 'vested' in share-based compensation disclosures. Prevention checklist (atomic):", "1) Detection: if sentence contains verb 'recognized'/'recorded'/'expensed' within ±8 tokens of numeric token, do NOT map to any 'vested' fair-value tag unless explicit 'vested' AND 'fair value' are both present (within ±6 tokens).", "2) If sentence contains 'unrecognized' + 'expected to be recognized' or 'weighted-average period' in proximity to the numeric token, do NOT map to award-vesting-period tags; instead map period to the 'PeriodForRecognition' tag (only when unrecognized-cost cue present).", "3) Disambiguation priority (use before labeling): expense-recognition verbs > unrecognized-recognition-period cues > vested+fair-value cues > generic 'period'/'vesting' lexical matches.", "4) Unit-tests to add to CI to prevent regression: include at least 6 sentences mixing 'recognized', 'vested', 'fair value', and 'weighted-average' in different permutations showing correct/incorrect mappings (examples from ctx-xxxx unit-tests). Failing any unit-test should block model auto-assignment for that pattern and trigger human-review."], "removed_content": []}
{"timestamp": "2026-02-05T18:06:00.044474", "step": 16, "playbook_before_length": 59860, "playbook_after_length": 64120, "lines_before": 206, "lines_after": 207, "added_lines": 1, "removed_lines": 0, "operations_count": 1, "operations": [{"type": "ADD", "section": "common_mistakes_to_avoid", "content": "[err-000XX] helpful=1 harmful=0 :: Explicit-measurement guard for customer-concentration percentage mappings (atomic prevention rule): - Purpose: Do NOT map a percentage token to any customer-concentration tag (including ConcentrationRiskPercentage1) unless the percentage is explicitly tied to a measurement that denotes a share (e.g., revenue, trade receivables). This prevents mis-mapping of margins, growth rates, tax rates, coupons, spreads, and other non-concentration percentages. - Positive measurement lexical cues (case-insensitive regexes): /\\bof\\s+(our|the|its|their)?\\s*(total\\s+net\\s+)?(revenue|revenues|sales|net\\s+revenue|total\\s+net\\s+revenue|consolidated\\s+revenue)\\b/, /accounted\\s+for\\s+(approximately|about|around)?\\s*[0-9]+(?:\\.[0-9]+)?\\s*%/, /represented\\s+(approximately|about)?\\s*[0-9]+(?:\\.[0-9]+)?\\s*%\\s+of\\s+(revenue|revenues)/, /%\\s+of\\s+(trade\\s+accounts\\s+receivable|accounts?\\s+receivable|receivables)\\b/, /%\\s+of\\s+our\\s+receivables\\b/. - Customer anchor detection (case-insensitive): /\\b(customer|customers|client|clients|the\\s+customer|the\\s+customers)\\b/, or a named-customer token (e.g., company names). Require either (A) measurement cue in same sentence near the percent OR (B) both a customer anchor and a measurement cue present within the association window. - Negative/ exclusion lexical cues (case-insensitive): do NOT map when percent co-occurs with: /\\bmargin|gross\\s+margin|operating\\s+margin|growth|increase|decrease|decline|change|rate|per\\s+annum|per\\s+year|statutory|tax|VAT|coupon|spread|basis|percent\\s+points\\b/. If any negative cue appears within ±6 tokens of the percent, block concentration mapping and evaluate other percentage-tag heuristics. - Association windows & antecedent resolution: primary window = ±10 tokens around the percent for measurement cues and customer anchors. Allow antecedent measurement/customer anchor in the immediately preceding sentence (±1 sentence) when anaphoric phrase ('the revenues', 'those receivables', 'our largest customer') is used and antecedent span <= 40 tokens; require explicit referential match before allowing cross-sentence mapping. - Precedence & decision flow (apply atomically before generic customer-percent -> ConcentrationRiskPercentage1): 1) If percent has a positive measurement cue (e.g., 'of revenue' or 'of trade accounts receivable') within ±10 tokens -> map to the measurement-specific concentration tag (revenue-specific or receivable-specific) if present in taxonomy; if none present, map to generic ConcentrationRiskPercentage1 but record fallback reason. 2) Else if percent is within ±10 tokens of a customer anchor AND a measurement cue exists in same sentence or allowed antecedent -> apply step (1). 3) Else if percent co-occurs with any negative/exclusion cue within ±6 tokens -> do NOT map to any concentration tag; continue other percentage-tag heuristics. 4) Else mark as 'concentration-measurement-ambiguous' and queue for human review (do NOT auto-map to concentration). - Unit-tests (atomic examples to add): 1) 'Our two largest customers accounted for approximately 44% of our revenues.' -> 44% = ConcentrationRiskPercentage1 (or revenue-specific tag). 2) 'Tech Data accounted for 7% of Autodesk\\'s total net revenue.' -> 7% = revenue-specific concentration tag. 3) 'Tech Data accounted for 5% of trade accounts receivable.' -> 5% = receivable-specific concentration tag. 4) 'Gross margin was 45% for the period.' -> 45% = NOT a concentration tag (should map to margin tag or flagged for other heuristics). 5) 'The tax rate was 21%.' -> 21% = tax-rate tag, NOT concentration. 6) 'The largest customer represented 22%.' -> ambiguous -> flag 'concentration-measurement-ambiguous' for review. - Logging & QA: always record percent token span, matched positive measurement cue span (if any), matched customer anchor span (if any), decision outcome (mapped-to-tag id OR blocked-with-reason OR queued-as-ambiguous), and taxonomy candidates considered. - Implementation note: insert this guard as the first step in the measurement-aware concentration mapping pipeline (before any default 'customer+percent -> ConcentrationRiskPercentage1' fallback) and add the unit-tests above to regression suites."}], "added_content": ["[err-00007] helpful=0 harmful=0 :: [err-000XX] helpful=1 harmful=0 :: Explicit-measurement guard for customer-concentration percentage mappings (atomic prevention rule): - Purpose: Do NOT map a percentage token to any customer-concentration tag (including ConcentrationRiskPercentage1) unless the percentage is explicitly tied to a measurement that denotes a share (e.g., revenue, trade receivables). This prevents mis-mapping of margins, growth rates, tax rates, coupons, spreads, and other non-concentration percentages. - Positive measurement lexical cues (case-insensitive regexes): /\\bof\\s+(our|the|its|their)?\\s*(total\\s+net\\s+)?(revenue|revenues|sales|net\\s+revenue|total\\s+net\\s+revenue|consolidated\\s+revenue)\\b/, /accounted\\s+for\\s+(approximately|about|around)?\\s*[0-9]+(?:\\.[0-9]+)?\\s*%/, /represented\\s+(approximately|about)?\\s*[0-9]+(?:\\.[0-9]+)?\\s*%\\s+of\\s+(revenue|revenues)/, /%\\s+of\\s+(trade\\s+accounts\\s+receivable|accounts?\\s+receivable|receivables)\\b/, /%\\s+of\\s+our\\s+receivables\\b/. - Customer anchor detection (case-insensitive): /\\b(customer|customers|client|clients|the\\s+customer|the\\s+customers)\\b/, or a named-customer token (e.g., company names). Require either (A) measurement cue in same sentence near the percent OR (B) both a customer anchor and a measurement cue present within the association window. - Negative/ exclusion lexical cues (case-insensitive): do NOT map when percent co-occurs with: /\\bmargin|gross\\s+margin|operating\\s+margin|growth|increase|decrease|decline|change|rate|per\\s+annum|per\\s+year|statutory|tax|VAT|coupon|spread|basis|percent\\s+points\\b/. If any negative cue appears within ±6 tokens of the percent, block concentration mapping and evaluate other percentage-tag heuristics. - Association windows & antecedent resolution: primary window = ±10 tokens around the percent for measurement cues and customer anchors. Allow antecedent measurement/customer anchor in the immediately preceding sentence (±1 sentence) when anaphoric phrase ('the revenues', 'those receivables', 'our largest customer') is used and antecedent span <= 40 tokens; require explicit referential match before allowing cross-sentence mapping. - Precedence & decision flow (apply atomically before generic customer-percent -> ConcentrationRiskPercentage1): 1) If percent has a positive measurement cue (e.g., 'of revenue' or 'of trade accounts receivable') within ±10 tokens -> map to the measurement-specific concentration tag (revenue-specific or receivable-specific) if present in taxonomy; if none present, map to generic ConcentrationRiskPercentage1 but record fallback reason. 2) Else if percent is within ±10 tokens of a customer anchor AND a measurement cue exists in same sentence or allowed antecedent -> apply step (1). 3) Else if percent co-occurs with any negative/exclusion cue within ±6 tokens -> do NOT map to any concentration tag; continue other percentage-tag heuristics. 4) Else mark as 'concentration-measurement-ambiguous' and queue for human review (do NOT auto-map to concentration). - Unit-tests (atomic examples to add): 1) 'Our two largest customers accounted for approximately 44% of our revenues.' -> 44% = ConcentrationRiskPercentage1 (or revenue-specific tag). 2) 'Tech Data accounted for 7% of Autodesk\\'s total net revenue.' -> 7% = revenue-specific concentration tag. 3) 'Tech Data accounted for 5% of trade accounts receivable.' -> 5% = receivable-specific concentration tag. 4) 'Gross margin was 45% for the period.' -> 45% = NOT a concentration tag (should map to margin tag or flagged for other heuristics). 5) 'The tax rate was 21%.' -> 21% = tax-rate tag, NOT concentration. 6) 'The largest customer represented 22%.' -> ambiguous -> flag 'concentration-measurement-ambiguous' for review. - Logging & QA: always record percent token span, matched positive measurement cue span (if any), matched customer anchor span (if any), decision outcome (mapped-to-tag id OR blocked-with-reason OR queued-as-ambiguous), and taxonomy candidates considered. - Implementation note: insert this guard as the first step in the measurement-aware concentration mapping pipeline (before any default 'customer+percent -> ConcentrationRiskPercentage1' fallback) and add the unit-tests above to regression suites."], "removed_content": []}
{"timestamp": "2026-02-05T18:06:21.760712", "step": 16, "playbook_before_length": 59784, "playbook_after_length": 64927, "lines_before": 228, "lines_after": 229, "added_lines": 1, "removed_lines": 0, "operations_count": 1, "operations": [{"type": "ADD", "section": "context_clues_and_indicators", "content": "[ctx-00013a] helpful=1 harmful=0 :: Customer/Channel/Distributor revenue-anchor classifier + precedence (atomic heuristic) - Purpose: deterministically map percentages that quantify a share of revenue (customer concentration) to ConcentrationRiskPercentage1 and avoid mis-mapping 'of X' percentages that refer to non-revenue metrics or other percentage concepts. - Exact lexical cue groups (case-insensitive regexes):   * CUSTOMER/DISTRIBUTOR/CHANNEL ENTITY CUES: /\\b(customer|customers|client|clients|clientele|distributor|distributors|reseller|resellers|channel|channel\\s+partner(s)?|partner(s)?|our\\s+largest\\s+customer|our\\s+two\\s+largest|one\\s+of\\s+our\\s+distributors)\\b/   * REVENUE-LINK CUES: /\\b(of\\s+(total\\s+)?(net\\s+)?revenue|of\\s+revenues|of\\s+revenue|accounted\\s+for|represented\\s+|represented\\s+(approximately|about)?|comprised\\s+of|constituted)\\b/   * CHANNEL-FORM CUES: /\\bthrough\\s+our\\s+(?:channel|distribution|reseller)\\s+(?:network|partners)|via\\s+our\\s+distributors\\b/ - Token association & antecedent windows:   1) Primary rule: assign ConcentrationRiskPercentage1 when a percentage token appears within ±10 tokens of at least one CUSTOMER/DISTRIBUTOR/CHANNEL ENTITY CUE AND within ±10 tokens of at least one REVENUE-LINK CUE in the same sentence.   2) Ancillary antecedent: allow 'the Channel/Distributor' or 'the customer' as anaphor resolved to an explicit named entity in the previous sentence up to ±1 sentence away (antecedent span <= 40 tokens). In that case apply mapping if combined token-distance from numeric to resolved entity cue + to revenue-link cue <= 50 tokens. - Precedence / conflict resolution (apply deterministically in order):   A) If ctx-00013a condition satisfied -> assign ConcentrationRiskPercentage1 and attach ctx-00013 (or ctx-00013a) as attached_bullet_id; this mapping MUST override other generic percentage heuristics (spread, per-annum interest, statutory tax) except when another heuristic has a stronger explicit anchor (e.g., 'per annum' + instrument anchor for interest-rate issuance).   B) If ctx-00013a condition partially satisfied (e.g., 'of revenue' present but no explicit customer/distributor entity; or customer entity present but no revenue-link) -> DO NOT auto-assign; mark as 'potential-concentration-ambiguous' and queue for human review (log candidate spans).   C) If percentage also matches other high-specificity heuristics (e.g., 'per annum' + loan instrument OR 'LIBOR plus' pattern OR 'federal statutory' + reconciliation anchor): compare anchor-specificity scores (anchors: statutory-reconciliation=10, per-annum+instrument=9, customer+revenue=8). Tie-breaker: require ctx-00013a to beat other heuristics by at least 1 point to auto-assign; otherwise defer to the higher-score mapping. Log all tie events as 'percent-anchor-conflict' with spans & scores. - Negative guardrails (explicit do-not-map patterns): do NOT map percentages to ConcentrationRiskPercentage1 when any of the following appear within ±6 tokens of the percent: 'per annum', 'APR', 'margin', 'spread', 'LIBOR', 'ABR', 'statutory', 'effective tax', 'impairment', 'allocation', 'proration', 'of assets', 'of accounts', 'of consideration', 'of purchases', 'of backlog'. If both a revenue-anchor and a prohibited cue co-occur, treat as conflict and follow precedence rules above. - Logging & traceability: on every auto-assignment attach fields { attached_bullet_id: 'ctx-00013'|'ctx-00013a', match_score: float(0..1), matched_cue_spans: [ { cue_text, start_token, end_token } ], numeric_span: { start_token, end_token }, provenance: { module:'ctx-00013a', timestamp } }. If mapping deferred, attach reason code 'potential-concentration-ambiguous' or 'percent-anchor-conflict' and queue example for human review. - Unit-tests (atomic examples):   1) Positive: 'Tech Data accounted for 32% of total net revenue for the year' -> 32% = ConcentrationRiskPercentage1 (attach ctx-00013).   2) Positive-channel: '32% of revenue through our channel network' -> 32% = ConcentrationRiskPercentage1.   3) Positive-distributor: 'One of our distributors accounted for approximately 27% of our revenue' -> 27% = ConcentrationRiskPercentage1.   4) Negative-ambiguous: '32% of our sales were in Europe' (no customer entity) -> DO NOT auto-assign; flag 'potential-concentration-ambiguous'.   5) Negative-conflict: 'The interest rate is 4.00% per annum and we estimate 4.00% of revenue from one customer' (both forms) -> separate mappings: first -> DebtInstrumentInterestRateStatedPercentage (per-annum wins for that percent); second -> if percent tokens are identical ensure numeric-token disambiguation by proximity; if same token ambiguous, mark for review and log 'percent-anchor-conflict'. - Implementation note: integrate this classifier as an early percentage-disambiguation step (run before generic percentage fallbacks). Ensure post-decision validator (err-00003) auto-attaches ctx-00013 when match_score >= MATCH_THRESHOLD and raises QA record when classifier defers but playbook heuristic would have matched. Record all ambiguous/conflict examples in weekly QA dashboard."}], "added_content": ["[ctx-00008] helpful=0 harmful=0 :: [ctx-00013a] helpful=1 harmful=0 :: Customer/Channel/Distributor revenue-anchor classifier + precedence (atomic heuristic) - Purpose: deterministically map percentages that quantify a share of revenue (customer concentration) to ConcentrationRiskPercentage1 and avoid mis-mapping 'of X' percentages that refer to non-revenue metrics or other percentage concepts. - Exact lexical cue groups (case-insensitive regexes):   * CUSTOMER/DISTRIBUTOR/CHANNEL ENTITY CUES: /\\b(customer|customers|client|clients|clientele|distributor|distributors|reseller|resellers|channel|channel\\s+partner(s)?|partner(s)?|our\\s+largest\\s+customer|our\\s+two\\s+largest|one\\s+of\\s+our\\s+distributors)\\b/   * REVENUE-LINK CUES: /\\b(of\\s+(total\\s+)?(net\\s+)?revenue|of\\s+revenues|of\\s+revenue|accounted\\s+for|represented\\s+|represented\\s+(approximately|about)?|comprised\\s+of|constituted)\\b/   * CHANNEL-FORM CUES: /\\bthrough\\s+our\\s+(?:channel|distribution|reseller)\\s+(?:network|partners)|via\\s+our\\s+distributors\\b/ - Token association & antecedent windows:   1) Primary rule: assign ConcentrationRiskPercentage1 when a percentage token appears within ±10 tokens of at least one CUSTOMER/DISTRIBUTOR/CHANNEL ENTITY CUE AND within ±10 tokens of at least one REVENUE-LINK CUE in the same sentence.   2) Ancillary antecedent: allow 'the Channel/Distributor' or 'the customer' as anaphor resolved to an explicit named entity in the previous sentence up to ±1 sentence away (antecedent span <= 40 tokens). In that case apply mapping if combined token-distance from numeric to resolved entity cue + to revenue-link cue <= 50 tokens. - Precedence / conflict resolution (apply deterministically in order):   A) If ctx-00013a condition satisfied -> assign ConcentrationRiskPercentage1 and attach ctx-00013 (or ctx-00013a) as attached_bullet_id; this mapping MUST override other generic percentage heuristics (spread, per-annum interest, statutory tax) except when another heuristic has a stronger explicit anchor (e.g., 'per annum' + instrument anchor for interest-rate issuance).   B) If ctx-00013a condition partially satisfied (e.g., 'of revenue' present but no explicit customer/distributor entity; or customer entity present but no revenue-link) -> DO NOT auto-assign; mark as 'potential-concentration-ambiguous' and queue for human review (log candidate spans).   C) If percentage also matches other high-specificity heuristics (e.g., 'per annum' + loan instrument OR 'LIBOR plus' pattern OR 'federal statutory' + reconciliation anchor): compare anchor-specificity scores (anchors: statutory-reconciliation=10, per-annum+instrument=9, customer+revenue=8). Tie-breaker: require ctx-00013a to beat other heuristics by at least 1 point to auto-assign; otherwise defer to the higher-score mapping. Log all tie events as 'percent-anchor-conflict' with spans & scores. - Negative guardrails (explicit do-not-map patterns): do NOT map percentages to ConcentrationRiskPercentage1 when any of the following appear within ±6 tokens of the percent: 'per annum', 'APR', 'margin', 'spread', 'LIBOR', 'ABR', 'statutory', 'effective tax', 'impairment', 'allocation', 'proration', 'of assets', 'of accounts', 'of consideration', 'of purchases', 'of backlog'. If both a revenue-anchor and a prohibited cue co-occur, treat as conflict and follow precedence rules above. - Logging & traceability: on every auto-assignment attach fields { attached_bullet_id: 'ctx-00013'|'ctx-00013a', match_score: float(0..1), matched_cue_spans: [ { cue_text, start_token, end_token } ], numeric_span: { start_token, end_token }, provenance: { module:'ctx-00013a', timestamp } }. If mapping deferred, attach reason code 'potential-concentration-ambiguous' or 'percent-anchor-conflict' and queue example for human review. - Unit-tests (atomic examples):   1) Positive: 'Tech Data accounted for 32% of total net revenue for the year' -> 32% = ConcentrationRiskPercentage1 (attach ctx-00013).   2) Positive-channel: '32% of revenue through our channel network' -> 32% = ConcentrationRiskPercentage1.   3) Positive-distributor: 'One of our distributors accounted for approximately 27% of our revenue' -> 27% = ConcentrationRiskPercentage1.   4) Negative-ambiguous: '32% of our sales were in Europe' (no customer entity) -> DO NOT auto-assign; flag 'potential-concentration-ambiguous'.   5) Negative-conflict: 'The interest rate is 4.00% per annum and we estimate 4.00% of revenue from one customer' (both forms) -> separate mappings: first -> DebtInstrumentInterestRateStatedPercentage (per-annum wins for that percent); second -> if percent tokens are identical ensure numeric-token disambiguation by proximity; if same token ambiguous, mark for review and log 'percent-anchor-conflict'. - Implementation note: integrate this classifier as an early percentage-disambiguation step (run before generic percentage fallbacks). Ensure post-decision validator (err-00003) auto-attaches ctx-00013 when match_score >= MATCH_THRESHOLD and raises QA record when classifier defers but playbook heuristic would have matched. Record all ambiguous/conflict examples in weekly QA dashboard."], "removed_content": []}
{"timestamp": "2026-02-05T18:07:13.722074", "step": 17, "playbook_before_length": 64120, "playbook_after_length": 67587, "lines_before": 207, "lines_after": 223, "added_lines": 16, "removed_lines": 0, "operations_count": 1, "operations": [{"type": "ADD", "section": "context_clues_and_indicators", "content": "Atomic lexical rule: map 'aggregate principal amount' / 'principal amount' -> DebtInstrumentFaceAmount\n- Purpose: deterministically tag currency amounts that state the face/aggregate principal amount of a debt instrument as DebtInstrumentFaceAmount and avoid mis-mapping to facility-capacity or generic amount tags.\n- Exact lexical cues/regex (case-insensitive): /\\baggregate\\s+principal\\s+amount\\s+of\\b/, /\\baggregate\\s+principal\\s+amount\\b/, /\\bprincipal\\s+amount\\s+of\\b/, /\\bin\\s+an?\\s+aggregate\\s+principal\\s+amount\\b/, /\\baggregate\\s+principal\\s+amount\\s+of\\s+up\\s+to\\b/\n- Instrument-anchor detection (case-insensitive regex list): /\\b(senior\\s+notes|senior\\s+note|notes|note|debentures?|bonds?|term\\s+loan|term\\s+loans|loan|loans|seller\\s+note)s?\\b/ — when one of these appears in same sentence (primary) or previous sentence within antecedent span <= 40 tokens, treat as debt-instrument anchor.\n- Association window: require numeric currency token to lie within ±8 tokens of the principal/aggregate phrase; if anchor is only in prior sentence allow numeric within ±16 tokens of antecedent anchor but require anaphoric referent (\"the Notes\", \"such notes\").\n- Mapping rule (precedence):\n  1) If principal/aggregate cue matches AND a debt-instrument anchor (notes/bonds/term loan/etc.) is present -> assign DebtInstrumentFaceAmount and link mapping to instrument anchor span.\n  2) If principal/aggregate cue matches BUT anchor indicates a credit facility/revolver (e.g., 'revolver', 'credit facility') -> treat as LineOfCreditFacilityMaximumBorrowingCapacity (facility-size), unless explicit remaining-amount phrase ('amount available', 'borrowing base') is present in which case follow remaining-capacity rules (ctx-00009 / ctx-00005).\n  3) Do NOT override measurement-term precedence: if the sentence explicitly states a measurement term with grammatical subject/predicate (e.g., 'the fair value of our Senior Notes was $X') then the measurement-term precedence rule (ctx-00002) wins — log as 'face-vs-measurement' when both cues occur.\n- Conflict handling & logging: record numeric span, principal-cue span, instrument-anchor span, chosen tag id, and whether a facility-anchor caused a capacity mapping. If both face-amount and another measurement (fair value/carrying amount) are present, log as 'face-vs-measurement' and retain the measurement-term precedence decision.\n- Unit-tests (atomic examples):\n  • 'The 3.550% Senior Notes had an aggregate principal amount of $600 million.' -> $600 million = DebtInstrumentFaceAmount (anchor: Senior Notes).\n  • 'Aggregate principal amount of $600 million of our Senior Notes was issued' -> $600 million = DebtInstrumentFaceAmount.\n  • 'Revolving credit facility in an aggregate principal amount of up to $225.0 million' -> $225.0 million = LineOfCreditFacilityMaximumBorrowingCapacity (facility anchor -> capacity mapping).\n  • 'The fair value of our Senior Notes was $487 million and the aggregate principal amount was $500 million' -> $487M = LongTermDebtFairValue (measurement-term precedence); $500M = DebtInstrumentFaceAmount (face mapping); log 'face-vs-measurement' with spans.\n- Implementation notes: insert this rule before generic currency-to-tag fallbacks and after measurement-term precedence check; capture instrument anchor span for QA and downstream linking. Add unit-tests above to regression suite and surface any 'face-vs-measurement' conflicts to review queue."}], "added_content": ["[ctx-00008] helpful=0 harmful=0 :: Atomic lexical rule: map 'aggregate principal amount' / 'principal amount' -> DebtInstrumentFaceAmount", "- Purpose: deterministically tag currency amounts that state the face/aggregate principal amount of a debt instrument as DebtInstrumentFaceAmount and avoid mis-mapping to facility-capacity or generic amount tags.", "- Exact lexical cues/regex (case-insensitive): /\\baggregate\\s+principal\\s+amount\\s+of\\b/, /\\baggregate\\s+principal\\s+amount\\b/, /\\bprincipal\\s+amount\\s+of\\b/, /\\bin\\s+an?\\s+aggregate\\s+principal\\s+amount\\b/, /\\baggregate\\s+principal\\s+amount\\s+of\\s+up\\s+to\\b/", "- Instrument-anchor detection (case-insensitive regex list): /\\b(senior\\s+notes|senior\\s+note|notes|note|debentures?|bonds?|term\\s+loan|term\\s+loans|loan|loans|seller\\s+note)s?\\b/ — when one of these appears in same sentence (primary) or previous sentence within antecedent span <= 40 tokens, treat as debt-instrument anchor.", "- Association window: require numeric currency token to lie within ±8 tokens of the principal/aggregate phrase; if anchor is only in prior sentence allow numeric within ±16 tokens of antecedent anchor but require anaphoric referent (\"the Notes\", \"such notes\")."], "removed_content": []}
{"timestamp": "2026-02-05T18:07:51.664575", "step": 17, "playbook_before_length": 64927, "playbook_after_length": 70666, "lines_before": 229, "lines_after": 271, "added_lines": 32, "removed_lines": 0, "operations_count": 1, "operations": [{"type": "ADD", "section": "context_clues_and_indicators", "content": "Atomic heuristic: Prefer instrument-class-specific fair-value tags for debt instruments (e.g., LongTermDebtFairValue) over generic DebtInstrumentFairValue when instrument-class can be determined.\n\nPurpose: avoid mapping 'fair value' amounts for named debt instruments to a generic debt-instrument fair-value tag when a more specific class-level fair-value tag exists in the taxonomy.\n\nExact lexical anchors (case-insensitive regexes, apply within same sentence unless indicated):\n- Instrument name cues: /\\bsenior\\s+note(s)?\\b/, /\\bnotes\\s+due\\b/, /\\bnote\\b/, /\\bterm\\s+loan(s)?\\b/, /\\bdebenture(s)?\\b/, /\\brevolver\\b/.\n- Maturity cues: /due\\s+in\\s+\\d{4}\\b/, /due\\s+\\w+\\s+\\d{1,2},?\\s+\\d{4}\\b/, /matures?\\s+in\\s+\\d+\\s+year(s)?\\b/, /matures?\\s+on\\b/, /maturity\\s+date\\b/.\n- Long-term indicator: explicit year >= (current_year + 1) OR any textual 'long-term', 'long term', 'non-current', 'not due within 12 months'. Short-term indicator: 'current portion', 'due within 12 months', 'due next year', or explicit 'current'.\n- Fair-value cue: /fair\\s+value(s)?\\b/ or variants 'carrying value at fair value', 'were $X at fair value'.\n\nAssociation & token-window rules:\n1) Primary association window: require fair-value cue and numeric currency token to be in same sentence; require instrument-name cue in same sentence OR in immediately preceding sentence (±1 sentence) with antecedent span <= 40 tokens.\n2) If maturity-year token (e.g., 'due 2026', 'due 2046') appears, parse year and compute term relative to report date when available; if explicit maturity > 12 months from reporting period or maturity-year > reporting_year (or textual 'long-term') -> classify as LONG_TERM; if explicit 'current portion' or 'due within 12 months' -> classify as SHORT_TERM.\n\nDeterministic mapping & precedence (apply in order):\nA) If fair-value cue + instrument anchor present AND instrument_class==LONG_TERM ->\n   - If taxonomy contains a tag named LongTermDebtFairValue (or equivalent class-specific fair-value tag), assign LongTermDebtFairValue and attach evidence (instrument-anchor span, maturity span, fair-value cue span). This mapping MUST override assignment to DebtInstrumentFairValue.\nB) Else if fair-value cue + instrument anchor present AND instrument_class==SHORT_TERM ->\n   - If taxonomy contains a ShortTermDebtFairValue (or similar) assign that specific tag; else proceed to fallback (C).\nC) Fallback: if no class-specific fair-value tag exists in taxonomy -> assign DebtInstrumentFairValue but attach note: { recommended_specific_tag: '<derived_class>DebtFairValue', reason: 'specific_tag_missing_in_taxonomy', instrument_class } and queue example for playbook update.\n\nTie-breaker: when multiple candidate tags exist (generic and one-or-more class-specific), choose the most specific tag matching the detected instrument class. Specificity order (high->low): class-specific fair-value (LongTermDebtFairValue / ShortTermDebtFairValue) > instrument-type-specific fair-value (e.g., SeniorNotesFairValue if present) > generic DebtInstrumentFairValue.\n\nEdge cases & ambig: If instrument anchor ambiguous (e.g., 'notes' without maturity or 'the notes' and no antecedent in ±1 sentence), do NOT auto-prefer class-specific tag; instead assign DebtInstrumentFairValue and flag 'instrument-class-ambiguous' for human review and training capture.\n\nUnit-tests (atomic examples; add to regression suite):\n1) Positive - long-term: 'The fair value of our Senior Notes due 2026 was $487 million.' -> $487M = LongTermDebtFairValue (attach instrument-anchor 'Senior Notes due 2026', maturity parsed 2026 => LONG_TERM).\n2) Positive - long-term: 'The fair value of Senior Notes due 2046 was $397 million.' -> $397M = LongTermDebtFairValue.\n3) Short-term explicit: 'The fair value of our notes maturing in six months was $2.5 million.' -> if parsed as SHORT_TERM -> ShortTermDebtFairValue (if present) else DebtInstrumentFairValue and log fallback.\n4) Ambiguous instrument: 'The fair value was $X for the notes.' (no antecedent) -> $X = DebtInstrumentFairValue; attach flag 'instrument-class-ambiguous'.\n5) Fallback logging: if LongTermDebtFairValue tag not present in taxonomy but instrument class computed LONG_TERM -> assign DebtInstrumentFairValue and create derived_bullet / playbook-update suggestion recommending LongTermDebtFairValue with matched cues.\n\nLogging & traceability (integrate with err-00003 heuristic-use logging rules):\n- Always attach { attached_bullet_id, match_score, matched_cue_spans: [instrument_anchor, maturity_span (if any), fair_value_cue], numeric_span, instrument_class: 'LONG_TERM'|'SHORT_TERM'|'UNKNOWN', provenance } to every auto-assigned fair-value mapping.\n- If class-specific tag selected, record attached_bullet_id == playbook-bullet-id-for-class-specific; if no such bullet exists, create derived_bullet record and queue for author review.\n\nImplementation notes:\n- Implement as an early post-processing precedence step that runs immediately after lexical fair-value detection and before generic DebtInstrumentFairValue assignment.\n- Use deterministic regexes for anchor detection and a small parser for common maturity forms ('due YYYY', 'matures in N years', explicit dates). If report_date is available, compute >12 months criterion; otherwise rely on textual 'long-term'/'long term' or year-difference heuristic.\n- Add these unit-tests to CI and include examples in weekly 'derived-bullet suggestions' dashboard.\n\nRationale: this atomic rule directly closes the gap identified in the reflection by ensuring the pipeline prefers LongTermDebtFairValue for senior notes with maturities beyond 12 months, preventing systematic misassignment to the generic DebtInstrumentFairValue tag."}], "added_content": ["[ctx-00009] helpful=0 harmful=0 :: Atomic heuristic: Prefer instrument-class-specific fair-value tags for debt instruments (e.g., LongTermDebtFairValue) over generic DebtInstrumentFairValue when instrument-class can be determined.", "Purpose: avoid mapping 'fair value' amounts for named debt instruments to a generic debt-instrument fair-value tag when a more specific class-level fair-value tag exists in the taxonomy.", "Exact lexical anchors (case-insensitive regexes, apply within same sentence unless indicated):", "- Instrument name cues: /\\bsenior\\s+note(s)?\\b/, /\\bnotes\\s+due\\b/, /\\bnote\\b/, /\\bterm\\s+loan(s)?\\b/, /\\bdebenture(s)?\\b/, /\\brevolver\\b/.", "- Maturity cues: /due\\s+in\\s+\\d{4}\\b/, /due\\s+\\w+\\s+\\d{1,2},?\\s+\\d{4}\\b/, /matures?\\s+in\\s+\\d+\\s+year(s)?\\b/, /matures?\\s+on\\b/, /maturity\\s+date\\b/."], "removed_content": []}
{"timestamp": "2026-02-05T18:09:14.962050", "step": 18, "playbook_before_length": 70666, "playbook_after_length": 76248, "lines_before": 271, "lines_after": 300, "added_lines": 22, "removed_lines": 0, "operations_count": 1, "operations": [{"type": "ADD", "section": "context_clues_and_indicators", "content": "Unit-and-anchor validation rule (atomic deterministic post-check for every numeric-tag assignment):\n\n1) Purpose: prevent tag assignments that conflict with the numeric token's measurement unit or that lack the tag's required lexical anchors (fixes margin-vs-rate, capacity-vs-outstanding, authorized-vs-issued/outstanding, par-per-share vs price confusions).\n\n2) Step A — Normalize numeric token unit: classify numeric_token.unit ∈ {PERCENT, CURRENCY, SHARES_COUNT, PER_SHARE_CURRENCY, YEARS, OTHER}. Use explicit markers: '%' or 'percent'→PERCENT; '$'/'dollar'→CURRENCY; tokens matching share-count patterns (\\d[\\d,]*\\s*(shares|share))→SHARES_COUNT; patterns like '$0.01 per share' or 'per share' with currency→PER_SHARE_CURRENCY.\n\n3) Step B — Required-unit table (exact mapping; do NOT assign tag unless numeric unit ∈ allowed_units):\n   - DebtInstrumentBasisSpreadOnVariableRate1: allowed_units = {PERCENT}; required_anchors = { 'margin','spread','plus','over','LIBOR','ABR','index' } (anchor must appear within ±6 tokens or same sentence).\n   - DebtInstrumentInterestRateStatedPercentage: allowed_units = {PERCENT}; required_anchors = { 'per annum','per year','annual','APR','interest rate','% per annum' } AND instrument-anchor (note/loan/term loan/seller note) within ±12 tokens or antecedent ±1 sentence.\n   - LineOfCreditFacilityMaximumBorrowingCapacity: allowed_units = {CURRENCY}; required_anchors = { 'credit facility','revolver','in an aggregate principal amount of','up to','commitment','maximum amount' } (same sentence or previous sentence antecedent allowed up to ±1 sentence).\n   - LineOfCreditFacilityRemainingBorrowingCapacity / LineOfCreditFacilityCurrentBorrowingCapacity: allowed_units = {CURRENCY}; required_anchors = { 'amount available under the facility','amount available','borrowing base','available to borrow','borrowing base','amount available under the credit facility','was available under the facility','totaled' } (explicit remaining-amount cue within ±8 tokens required).\n   - CommonStockSharesAuthorized: allowed_units = {SHARES_COUNT}; required_anchors = { 'authorized','authorized shares','authorized to issue' } (anchor within ±8 tokens or antecedent 'the Plan' with antecedent resolution).\n   - CommonStockSharesOutstanding: allowed_units = {SHARES_COUNT}; required_anchors = { 'outstanding','shares outstanding','outstanding shares' } (±8 tokens).\n   - CommonStockParOrStatedValuePerShare: allowed_units = {PER_SHARE_CURRENCY}; required_anchors = { 'par value','par per share','stated value per share' } (±8 tokens).\n\n4) Step C — Deterministic tie-break rules for frequent conflicts:\n   a) Percent token with both spread-anchor AND 'per annum' present within ±6 tokens: if 'over|plus|above' + LIBOR/ABR/index present → assign DebtInstrumentBasisSpreadOnVariableRate1; else if explicit 'per annum' + instrument-anchor present and no explicit 'over LIBOR' → assign DebtInstrumentInterestRateStatedPercentage; if still ambiguous → DO NOT auto-assign; flag 'rate-vs-spread-conflict' for human review.\n   b) Currency token near 'availability' without explicit 'amount available' or 'borrowing base' but with a prior facility cap anchor in previous sentence → map to LineOfCreditFacilityMaximumBorrowingCapacity (comparative case) only if comparative-language ('may be less than','as a result of','for certain subsidiaries') present; otherwise DO NOT auto-assign and flag 'ambiguous-availability'.\n   c) Share-count token with ambiguous cue 'shares' alone: prefer plan-specific/issuance detection (if plan-anchor or offering-anchor exists). If 'authorized' present → CommonStockSharesAuthorized; if 'issued' present → BusinessAcquisitionEquityInterestsIssuedOrIssuableNumberOfSharesIssued or StockIssuedDuringPeriodSharesNewIssues per issuance heuristics; if 'outstanding' present → CommonStockSharesOutstanding. If none present → DO NOT auto-assign and flag 'shares-ambiguous'.\n\n5) Step D — Enforcement & logging: if assigned_tag violates required_units OR required_anchor absent (within allowed windows), then reject the auto-assignment and instead: (a) emit a trace record { numeric_span, attempted_tag, unit_detected, missing_anchor_list, action:'rejected' }; (b) if one of the tie-break conflict rules applies and resolves deterministically, allow assignment and attach reason_code; (c) if unresolved, attach reason_code 'unit-anchor-mismatch' and queue for human review; also attach matched cue spans if any.\n\n6) Step E — Unit-tests to add (atomic examples from reflection):\n   - 'an applicable margin that varies from 0.50 percent to 2.75 percent' -> both percents (PERCENT) + 'margin' -> DebtInstrumentBasisSpreadOnVariableRate1.\n   - 'borrowing capacity of $250.0 million for the credit facility' -> $250.0M (CURRENCY) + facility-capacity anchor -> LineOfCreditFacilityMaximumBorrowingCapacity.\n   - '100,000,000 authorized shares of common stock' -> 100,000,000 (SHARES_COUNT) + 'authorized' -> CommonStockSharesAuthorized.\n   - 'par value of $0.01 per share' -> $0.01 per share (PER_SHARE_CURRENCY) + 'par value' -> CommonStockParOrStatedValuePerShare.\n\n7) Implementation notes: run this validator as an idempotent deterministic post-check immediately after a candidate tag decision and before final annotation commit; attach trace fields { unit_check_passed:bool, reason_code, matched_anchor_spans, validator_version } to every annotation. Thresholds: no probabilistic fallbacks here — if validator cannot confirm required anchor/unit constraints, prefer human-review rather than risky auto-mapping."}], "added_content": ["[ctx-00010] helpful=0 harmful=0 :: Unit-and-anchor validation rule (atomic deterministic post-check for every numeric-tag assignment):", "1) Purpose: prevent tag assignments that conflict with the numeric token's measurement unit or that lack the tag's required lexical anchors (fixes margin-vs-rate, capacity-vs-outstanding, authorized-vs-issued/outstanding, par-per-share vs price confusions).", "2) Step A — Normalize numeric token unit: classify numeric_token.unit ∈ {PERCENT, CURRENCY, SHARES_COUNT, PER_SHARE_CURRENCY, YEARS, OTHER}. Use explicit markers: '%' or 'percent'→PERCENT; '$'/'dollar'→CURRENCY; tokens matching share-count patterns (\\d[\\d,]*\\s*(shares|share))→SHARES_COUNT; patterns like '$0.01 per share' or 'per share' with currency→PER_SHARE_CURRENCY.", "3) Step B — Required-unit table (exact mapping; do NOT assign tag unless numeric unit ∈ allowed_units):", "   - DebtInstrumentBasisSpreadOnVariableRate1: allowed_units = {PERCENT}; required_anchors = { 'margin','spread','plus','over','LIBOR','ABR','index' } (anchor must appear within ±6 tokens or same sentence)."], "removed_content": []}
{"timestamp": "2026-02-05T18:10:23.652630", "step": 19, "playbook_before_length": 67587, "playbook_after_length": 70556, "lines_before": 223, "lines_after": 224, "added_lines": 1, "removed_lines": 0, "operations_count": 1, "operations": [{"type": "ADD", "section": "common_mistakes_to_avoid", "content": "err-000XX :: Transaction-direction guard for per-share prices (repurchase vs issuance) — atomic prevention rule: Purpose: Always resolve transaction direction before mapping any 'price per share' token. Exact repurchase/treasury lexical cues (case-insensitive regexes): /\\b(repurchas(?:e|ed)|bought\\s+back|acquired\\s+for\\s+treasury|acquired\\s+treasury\\s+stock|treasury\\s+stock|shares\\s+repurchased)\\b/. Exact issuance/sale lexical cues (case-insensitive regexes): /\\b(issued|sold|offered|sale\\s+of|proceeds\\s+from\\s+sale|sold\\s+on\\s+the\\s+market|underwriter(s)?|offering)\\b/. Association window: apply cue detection to the same sentence as the numeric token and the nearest ±8 tokens; allow antecedent anchor in the previous sentence when anaphora ('the shares', 'the repurchase program') is used and antecedent span <= 40 tokens. 'Average' qualifier detection: detect /\\baverage\\s+price|average\\s+cost\\b/ within ±4 tokens of the per-share numeric to disambiguate average-cost phrases. Precedence mapping (apply atomically): 1) If any repurchase/treasury cue matches within the association window -> map per-share price tokens to TreasuryStockAcquiredAverageCostPerShare; map aggregate/total currency amounts associated with the repurchase verb to TreasuryStockValueAcquiredCostMethod. 2) Else if any issuance/sale cue matches within the window -> map per-share price tokens to SaleOfStockPricePerShare (or issuance-price tag if more specific issuance tag exists). 3) If both repurchase and issuance cues appear in the same sentence or adjacent sentences and both are within tie-window (token-distance difference <= 3 tokens) -> do NOT auto-assign; flag as 'transaction-direction-conflict' and queue for human review. Tie-breaker: if 'average' qualifier co-occurs with repurchase cues, prefer TreasuryStockAcquiredAverageCostPerShare even if a generic 'price' or 'sold' token appears elsewhere in sentence. Unit-tests (atomic examples to add): - 'repurchased 70,783 shares at an average price of $15.09' -> $15.09 = TreasuryStockAcquiredAverageCostPerShare; 70,783 shares = TreasuryStockNumberOfSharesAcquired (if such tag exists) or link shares to repurchase event. - 'we sold 70,783 shares at an average price of $15.09' -> $15.09 = SaleOfStockPricePerShare. - 'the company repurchased shares for an aggregate of $1.1 million' -> $1.1M = TreasuryStockValueAcquiredCostMethod. - 'we issued 100,000 shares at $10.00 per share' -> $10.00 = SaleOfStockPricePerShare or issuance-specific price tag. Logging & QA: record matched cue spans (repurchase vs issuance), numeric span, 'average' qualifier span if any, chosen tag id, and conflict reason when flagged. Implementation note: insert this guard as the first step in any per-share price tagging pipeline (before generic 'per share' -> SaleOfStockPricePerShare fallback and before instrument-type heuristics) so transaction direction deterministically overrides generic price mapping."}], "added_content": ["[err-00009] helpful=0 harmful=0 :: err-000XX :: Transaction-direction guard for per-share prices (repurchase vs issuance) — atomic prevention rule: Purpose: Always resolve transaction direction before mapping any 'price per share' token. Exact repurchase/treasury lexical cues (case-insensitive regexes): /\\b(repurchas(?:e|ed)|bought\\s+back|acquired\\s+for\\s+treasury|acquired\\s+treasury\\s+stock|treasury\\s+stock|shares\\s+repurchased)\\b/. Exact issuance/sale lexical cues (case-insensitive regexes): /\\b(issued|sold|offered|sale\\s+of|proceeds\\s+from\\s+sale|sold\\s+on\\s+the\\s+market|underwriter(s)?|offering)\\b/. Association window: apply cue detection to the same sentence as the numeric token and the nearest ±8 tokens; allow antecedent anchor in the previous sentence when anaphora ('the shares', 'the repurchase program') is used and antecedent span <= 40 tokens. 'Average' qualifier detection: detect /\\baverage\\s+price|average\\s+cost\\b/ within ±4 tokens of the per-share numeric to disambiguate average-cost phrases. Precedence mapping (apply atomically): 1) If any repurchase/treasury cue matches within the association window -> map per-share price tokens to TreasuryStockAcquiredAverageCostPerShare; map aggregate/total currency amounts associated with the repurchase verb to TreasuryStockValueAcquiredCostMethod. 2) Else if any issuance/sale cue matches within the window -> map per-share price tokens to SaleOfStockPricePerShare (or issuance-price tag if more specific issuance tag exists). 3) If both repurchase and issuance cues appear in the same sentence or adjacent sentences and both are within tie-window (token-distance difference <= 3 tokens) -> do NOT auto-assign; flag as 'transaction-direction-conflict' and queue for human review. Tie-breaker: if 'average' qualifier co-occurs with repurchase cues, prefer TreasuryStockAcquiredAverageCostPerShare even if a generic 'price' or 'sold' token appears elsewhere in sentence. Unit-tests (atomic examples to add): - 'repurchased 70,783 shares at an average price of $15.09' -> $15.09 = TreasuryStockAcquiredAverageCostPerShare; 70,783 shares = TreasuryStockNumberOfSharesAcquired (if such tag exists) or link shares to repurchase event. - 'we sold 70,783 shares at an average price of $15.09' -> $15.09 = SaleOfStockPricePerShare. - 'the company repurchased shares for an aggregate of $1.1 million' -> $1.1M = TreasuryStockValueAcquiredCostMethod. - 'we issued 100,000 shares at $10.00 per share' -> $10.00 = SaleOfStockPricePerShare or issuance-specific price tag. Logging & QA: record matched cue spans (repurchase vs issuance), numeric span, 'average' qualifier span if any, chosen tag id, and conflict reason when flagged. Implementation note: insert this guard as the first step in any per-share price tagging pipeline (before generic 'per share' -> SaleOfStockPricePerShare fallback and before instrument-type heuristics) so transaction direction deterministically overrides generic price mapping."], "removed_content": []}
{"timestamp": "2026-02-05T18:10:34.884965", "step": 19, "playbook_before_length": 76248, "playbook_after_length": 82307, "lines_before": 300, "lines_after": 342, "added_lines": 31, "removed_lines": 0, "operations_count": 1, "operations": [{"type": "ADD", "section": "context_clues_and_indicators", "content": "Repurchase-program atomic mapping (exact cues, windows, precedence, unit-validation, logging)\n\nPurpose: deterministically map numeric tokens in share repurchase and related compensation sentences to the most specific US GAAP tags: TreasuryStockAcquiredAverageCostPerShare, TreasuryStockValueAcquiredCostMethod, StockRepurchaseProgramRemainingAuthorizedRepurchaseAmount1, and plan/award grant-count tags (e.g., ShareBasedCompensationArrangementByShareBasedPaymentAwardEquityInstrumentsOtherThanOptionsGrantsInPeriod).\n\nExact lexical cues & regexes (case-insensitive):\n- Average-per-share cues (map -> TreasuryStockAcquiredAverageCostPerShare): /(?:average\\s+price|average\\s+cost|average\\s+per\\s+share|average\\s+purchase\\s+price|average\\s+price\\s+paid)\\b/i\n- Aggregate-cost / total cash paid cues (map -> TreasuryStockValueAcquiredCostMethod): /(?:aggregate\\s+cost|aggregate\\s+amount|total\\s+cost|total\\s+amount\\s+paid|total\\s+cash\\s+paid|amount\\s+spent\\s+to\\s+repurchase)\\b/i\n- Remaining-authorized / available-for-repurchase cues (map -> StockRepurchaseProgramRemainingAuthorizedRepurchaseAmount1): /(?:remain(?:ed)?\\s+available|remaining\\s+available|available\\s+for\\s+further\\s+purchases|available\\s+for\\s+repurchase|remaining\\s+authorized\\s+to\\s+repurchase)\\b/i\n- Grant-count RSU/award cues (map -> ShareBasedCompensation...GrantsInPeriod): /(?:restricted\\s+stock\\s+units|RSU[s]?|awards?\\s+granted|grants?\\s+in\\s+period|granted\\s+under\\s+the\\s+plan)\\b/i\n\nUnit classification rules (normalize numeric token): PER_SHARE_CURRENCY (e.g., \"$15.09 per share\" or currency token with nearby 'per share'), CURRENCY (dollar amounts), SHARES_COUNT (bare integer counts or 'units'/'shares' tokens), PERCENT, YEARS.\n\nAssociation windows & antecedents:\n- Primary association: require cue regex match to be within ±8 tokens of the numeric token in the same sentence.\n- Allow antecedent plan/program anchor in previous sentence (±1 sentence) for 'the Program'/'the Plan' references if antecedent span <= 40 tokens.\n\nDeterministic mapping & precedence (apply in order):\n1) If numeric unit == PER_SHARE_CURRENCY AND average-per-share cue matches -> assign TreasuryStockAcquiredAverageCostPerShare. This wins over any generic 'price per share' sale/issuance tags when repurchase-program or 'repurchase'/'repurchased'/'stock repurchase' anchor present within same sentence or prior sentence.\n2) Else if numeric unit == CURRENCY AND aggregate-cost cue matches (or verbs 'paid', 'spent' adjacent) -> assign TreasuryStockValueAcquiredCostMethod.\n3) Else if numeric unit == CURRENCY AND remaining-authorized cue matches -> assign StockRepurchaseProgramRemainingAuthorizedRepurchaseAmount1.\n4) Else if numeric unit == SHARES_COUNT (or token like 'units') AND RSU/award-granted cue matches -> assign ShareBasedCompensationArrangementByShareBasedPaymentAwardEquityInstrumentsOtherThanOptionsGrantsInPeriod (or the most specific grants-in-period tag available). If 'restricted stock units' (RSU) lexical form appears, prefer RSU-specific grants tag if taxonomy contains it.\n\nTie-breakers & anti-pattern prevention (atomic):\n- Do NOT map a 'per share' average-repurchase price to generic SaleOfStockPricePerShare or issuance-price tags when 'repurchase'/'repurchased'/'program' cues are present anywhere in ±1 sentence; repurchase-specific tag takes precedence.\n- Do NOT map an aggregate cash amount with 'paid' to a generic acquisition or consideration tag if 'repurchase' or 'repurchased' anchor present (prefer TreasuryStockValueAcquiredCostMethod).\n- If both 'average price' and an adjacent '$' total appear in the same sentence, map each numeric independently by unit cues (per-share currency -> per-share tag; currency aggregate -> aggregate cost tag). If ambiguous (no explicit 'per share' phrase), require PER_SHARE_CURRENCY detection (currency + explicit 'per share') to assign per-share; otherwise map to aggregate/currency tag and flag 'possible-missing-per-share-cue' for review.\n\nUnit-and-anchor validation (post-check):\n- Before final commit, validate assigned tag unit compatibility (e.g., TreasuryStockAcquiredAverageCostPerShare requires PER_SHARE_CURRENCY; TreasuryStockValueAcquiredCostMethod requires CURRENCY; StockRepurchaseProgramRemainingAuthorizedRepurchaseAmount1 requires CURRENCY; GrantsInPeriod requires SHARES_COUNT). If mismatch, reject auto-assignment and flag for human review.\n\nLogging & traceability (must attach to annotation):\n{ attached_bullet_id: '<new-repurchase-bullet-id>', matched_cue_spans: [...], numeric_span, unit_detected, match_score (deterministic binary or heuristic score), provenance:{module:'repurchase-mapping-v1', timestamp} }\n- Record reason codes when tie-breaks / overrides applied (e.g., 'repurchase-over-sale-precedence').\n\nUnit-tests / minimal examples to add (atomic):\n- '$15.09 was the average price per share paid to repurchase shares.' -> $15.09 (PER_SHARE_CURRENCY) = TreasuryStockAcquiredAverageCostPerShare.\n- '$1.1 million aggregate cost of shares repurchased' -> $1.1M (CURRENCY) = TreasuryStockValueAcquiredCostMethod.\n- '$13.9 million remained available for further purchases under the stock repurchase program' -> $13.9M (CURRENCY) = StockRepurchaseProgramRemainingAuthorizedRepurchaseAmount1.\n- '131,600 restricted stock units were granted during the period' -> 131,600 (SHARES_COUNT) = ShareBasedCompensationArrangementByShareBasedPaymentAwardEquityInstrumentsOtherThanOptionsGrantsInPeriod.\n- 'We repurchased 10,000 shares at an average price of $12.50 per share for a total of $125,000' -> 10,000 (SHARES_COUNT) mapped per repurchase event if present; $12.50 = TreasuryStockAcquiredAverageCostPerShare; $125,000 = TreasuryStockValueAcquiredCostMethod.\n\nIntegration notes: implement as an early deterministic lexical-postprocessing module, run before generic 'per share' or 'sold' fallbacks. Wire to err-00003 heuristic-use logging conventions so the mapping always attaches playbook bullet id and matched spans. Enforce unit-and-anchor validator (ctx-00010) compatibility."}], "added_content": ["[ctx-00011] helpful=0 harmful=0 :: Repurchase-program atomic mapping (exact cues, windows, precedence, unit-validation, logging)", "Purpose: deterministically map numeric tokens in share repurchase and related compensation sentences to the most specific US GAAP tags: TreasuryStockAcquiredAverageCostPerShare, TreasuryStockValueAcquiredCostMethod, StockRepurchaseProgramRemainingAuthorizedRepurchaseAmount1, and plan/award grant-count tags (e.g., ShareBasedCompensationArrangementByShareBasedPaymentAwardEquityInstrumentsOtherThanOptionsGrantsInPeriod).", "Exact lexical cues & regexes (case-insensitive):", "- Average-per-share cues (map -> TreasuryStockAcquiredAverageCostPerShare): /(?:average\\s+price|average\\s+cost|average\\s+per\\s+share|average\\s+purchase\\s+price|average\\s+price\\s+paid)\\b/i", "- Aggregate-cost / total cash paid cues (map -> TreasuryStockValueAcquiredCostMethod): /(?:aggregate\\s+cost|aggregate\\s+amount|total\\s+cost|total\\s+amount\\s+paid|total\\s+cash\\s+paid|amount\\s+spent\\s+to\\s+repurchase)\\b/i"], "removed_content": []}
{"timestamp": "2026-02-05T18:11:51.921112", "step": 20, "playbook_before_length": 70556, "playbook_after_length": 75940, "lines_before": 224, "lines_after": 249, "added_lines": 24, "removed_lines": 0, "operations_count": 1, "operations": [{"type": "ADD", "section": "context_clues_and_indicators", "content": "Share-based-compensation: exact lexical guards for per-share fair value vs aggregate intrinsic value vs counts (atomic heuristic)\n- Purpose: deterministically map numeric tokens that appear in share-based compensation sentences to the most-specific US GAAP tag (weighted-average grant-date fair value per share for equity awards other than options; total intrinsic value of options exercised; grants-in-period counts). Apply this BEFORE generic 'per share' or 'count' fallbacks.\n- Exact lexical cues & regexes (case-insensitive):\n  1) Grant-date per-share fair value (map -> ShareBasedCompensationArrangementByShareBasedPaymentAwardEquityInstrumentsOtherThanOptionsGrantsInPeriodWeightedAverageGrantDateFairValue): /grant[- ]date\\s+fair\\s+value/ and /per\\s+share/ within same clause; variants: /weighted[- ]average\\s+grant[- ]date\\s+fair\\s+value/; parenthetical surface forms: /\\(.*?grant[- ]date\\s+fair\\s+value.*?per\\s+share.*?\\)/. Example matches: \"grant date fair value per share\", \"(grant date fair value of $X per share)\".\n  2) Aggregate intrinsic value of options exercised (map -> ShareBasedCompensationArrangementByShareBasedPaymentAwardOptionsExercisesInPeriodTotalIntrinsicValue): /aggregate\\s+intrinsic\\s+value/ and /(exercis(?:e|ed)|exercised\\s+in\\s+the\\s+period|exercised\\s+during)/ within same sentence/clause. Example matches: \"aggregate intrinsic value of options exercised in the period was $572,000\".\n  3) Grants-in-period counts for equity instruments other than options (map -> ShareBasedCompensationArrangementByShareBasedPaymentAwardEquityInstrumentsOtherThanOptionsGrantsInPeriod): grant-count cues: /\\b(granted\\s+(during|in|for)|grants?(?:\\s+for|\\s+during|\\s+in)|were\\s+granted)\\b/ and numeric token with 'shares' or unit words (shares, RSUs) within ±8 tokens. Example: \"There were 8,000 restricted shares granted during the period.\" \n- Association windows & parenthetical linking:\n  - Primary association window: numeric token must be within ±8 tokens of the matched cue (grant-date fair value / aggregate intrinsic value / 'granted' count). If numeric appears inside parentheses immediately adjacent to a grant/award phrase (parenthetical directly follows or is embedded in the same noun phrase/clause), treat it as linked to that grant phrase even if token distance >8 but within same clause.\n  - Allow antecedent anchor resolution to the immediately preceding sentence (±1 sentence) only when an anaphor ('the grants','such awards','the RSU grants') is present and antecedent span <=40 tokens. Otherwise require same-sentence match.\n- Precedence & tie-breaker (atomic): when multiple share-compensation candidates match the same numeric token, apply in order:\n  1) If 'aggregate intrinsic value' + 'exercised' matches -> choose OptionsExercisesInPeriodTotalIntrinsicValue.\n  2) Else if 'grant date fair value' + 'per share' or 'weighted-average grant-date fair value' matches -> choose GrantsInPeriodWeightedAverageGrantDateFairValue (equity other than options).\n  3) Else if explicit grant-count cue ('granted', 'grants for the period') with unit 'shares'/'RSUs' matches -> choose GrantsInPeriod count tag.\n  4) If a numeric is a currency and both a per-share and an aggregate cue appear (e.g., $X per share and $Y aggregate in same clause), map each numeric to the respective cue: per-share -> weighted-average per-share tag; aggregate -> total intrinsic/aggregate-fair-value tag accordingly.\n  5) If equal-distance ambiguity persists, prefer the explicit verb cue explaining action (\"granted\", \"exercised\") over nominal cues alone.\n- Negative prevention rules (atomic):\n  - Do NOT map a per-share currency numeric to a count tag; require presence of unit tokens (\"shares\",\"RSUs\") to map to counts.\n  - Do NOT map an 'aggregate intrinsic value' phrase to a per-share fair-value tag. The word 'aggregate' + 'intrinsic value' strongly signals a total-dollar intrinsic value; assign the options-exercise total-intrinsic tag.\n- Unit-tests (atomic examples to add):\n  1) 'The weighted-average grant-date fair value of restricted stock awards granted during the period was $12.50 per share.' -> $12.50 = ShareBasedCompensationArrangementByShareBasedPaymentAwardEquityInstrumentsOtherThanOptionsGrantsInPeriodWeightedAverageGrantDateFairValue.\n  2) 'Aggregate intrinsic value of stock options exercised during the year was $572,000.' -> $572,000 = ShareBasedCompensationArrangementByShareBasedPaymentAwardOptionsExercisesInPeriodTotalIntrinsicValue.\n  3) 'There were 8,000 restricted shares granted during the year.' -> 8,000 = ShareBasedCompensationArrangementByShareBasedPaymentAwardEquityInstrumentsOtherThanOptionsGrantsInPeriod.\n  4) 'Included in the grants (grant date fair value of $5.00 per share) are ...' -> $5.00 = GrantsInPeriodWeightedAverageGrantDateFairValue (parenthetical linking).\n- Logging & QA: for each auto-mapping record the matched cue span, numeric span, parenthetical flag (true if numeric was inside parentheses adjacent to grant clause), chosen tag id, and tie-breaker rationale. Queue any example where 'per share' numeric lacks a nearby grant/award anchor or where 'aggregate' and 'per share' cues conflict for human review.\n- Implementation note: insert this heuristic as the first step in the share-based-compensation numeric-tagging pipeline and add the unit-tests above to regression suites."}], "added_content": ["[ctx-00010] helpful=0 harmful=0 :: Share-based-compensation: exact lexical guards for per-share fair value vs aggregate intrinsic value vs counts (atomic heuristic)", "- Purpose: deterministically map numeric tokens that appear in share-based compensation sentences to the most-specific US GAAP tag (weighted-average grant-date fair value per share for equity awards other than options; total intrinsic value of options exercised; grants-in-period counts). Apply this BEFORE generic 'per share' or 'count' fallbacks.", "- Exact lexical cues & regexes (case-insensitive):", "  1) Grant-date per-share fair value (map -> ShareBasedCompensationArrangementByShareBasedPaymentAwardEquityInstrumentsOtherThanOptionsGrantsInPeriodWeightedAverageGrantDateFairValue): /grant[- ]date\\s+fair\\s+value/ and /per\\s+share/ within same clause; variants: /weighted[- ]average\\s+grant[- ]date\\s+fair\\s+value/; parenthetical surface forms: /\\(.*?grant[- ]date\\s+fair\\s+value.*?per\\s+share.*?\\)/. Example matches: \"grant date fair value per share\", \"(grant date fair value of $X per share)\".", "  2) Aggregate intrinsic value of options exercised (map -> ShareBasedCompensationArrangementByShareBasedPaymentAwardOptionsExercisesInPeriodTotalIntrinsicValue): /aggregate\\s+intrinsic\\s+value/ and /(exercis(?:e|ed)|exercised\\s+in\\s+the\\s+period|exercised\\s+during)/ within same sentence/clause. Example matches: \"aggregate intrinsic value of options exercised in the period was $572,000\"."], "removed_content": []}
{"timestamp": "2026-02-05T18:12:07.298428", "step": 20, "playbook_before_length": 82307, "playbook_after_length": 89560, "lines_before": 342, "lines_after": 345, "added_lines": 3, "removed_lines": 0, "operations_count": 3, "operations": [{"type": "ADD", "section": "context_clues_and_indicators", "content": {"id": "ctx-000XX-grant-date-fair-value-per-share", "title": "Grant-date fair value per share -> Award-specific WeightedAverageGrantDateFairValue (atomic)", "purpose": "Map currency-per-share phrases that state a grant-date fair value to the most specific weighted-average grant-date-fair-value tag for the award class (options vs equity instruments other than options).", "exact_lexical_cues": ["/grant\\s+date\\s+fair\\s+value/i", "/weighted-?average\\s+grant\\s+date\\s+fair\\s+value/i", "/grant\\s+date\\s+fair\\s+value\\s+of/i"], "award_type_cues": {"options": ["/option(s)?\\b/", "/stock\\s+option(s)?\\b"], "restricted_equity": ["/restricted\\s+share(s)?\\b/", "/restricted\\s+stock\\b/", "/RSU(s)?\\b/", "/restricted\\s+stock\\s+units\\b/", "/awards?\\s+other\\s+than\\s+options/i", "/other\\s+than\\s+options/"]}, "association_window": "Require a PER_SHARE_CURRENCY numeric token (currency + explicit 'per share' or 'per common share' phrase) within ±6 tokens of a grant-date-fair-value cue. If award-type cue appears anywhere in same sentence (or antecedent sentence ±1 with antecedent span <=40 tokens) treat that award-class as the anchor.", "unit_validation": "PER_SHARE_CURRENCY required (currency symbol/word plus 'per share' or equivalent). If currency present but no 'per share' phrase, do NOT auto-assign per-share fair-value tag; flag 'missing-per-share-cue'.", "precedence": "If award-type cue == options -> assign WeightedAverageGrantDateFairValuePerShareForOptions tag (or taxonomy-equivalent). Else if award-type cue == restricted_equity -> assign WeightedAverageGrantDateFairValuePerShareForEquityInstrumentsOtherThanOptions. These class-specific assignments override generic 'PricePerShare' or sale/issuance price tags.", "tie_breaker": "If both option and restricted cues present, prefer explicit phrasing 'option' or 'stock option' when within ±4 tokens of numeric; else prefer the cue closest by token-distance to numeric.", "logging_and_trace": "Attach { attached_bullet_id, match_score, matched_cue_spans:[grant-date-cue, award-type-cue], numeric_span, unit_detected, provenance }. If no playbook bullet exists for the detected specific tag, create derived_bullet and queue for author review.", "unit_tests": ["\"grant date fair value of $16.25 per share\" + 'restricted stock units' in sentence -> $16.25 per share = WeightedAverageGrantDateFairValuePerShareForEquityInstrumentsOtherThanOptions", "\"weighted-average grant date fair value of $20.90 per share' in RSU award table\" -> $20.90 = WeightedAverageGrantDateFairValuePerShareForEquityInstrumentsOtherThanOptions", "\"grant date fair value of $3.50 per share' in sentence mentioning 'stock option'\" -> $3.50 = WeightedAverageGrantDateFairValuePerShareForOptions", "\"grant date fair value $2.00' but no 'per share' present\" -> flag 'missing-per-share-cue' and require human review"]}}, {"type": "ADD", "section": "context_clues_and_indicators", "content": {"id": "ctx-000XX-aggregate-intrinsic-options-exercised", "title": "Aggregate/Total intrinsic value + options exercised -> OptionsExercisesInPeriodTotalIntrinsicValue (atomic)", "purpose": "Deterministically map currency amounts described as aggregate/total intrinsic value of options exercised during the period to OptionsExercisesInPeriodTotalIntrinsicValue.", "exact_lexical_cues": ["/aggregate\\s+intrinsic\\s+value/i", "/total\\s+intrinsic\\s+value/i", "/aggregate\\s+intrinsic\\s+value\\s+of\\s+stock\\s+options/i", "/intrinsic\\s+value\\s+of\\s+options\\s+exercis(ed|es)?/i"], "exercise_cues": ["/option(s)?\\s+exercis(ed|es)?\\b/", "/stock\\s+options\\s+exercis(ed|es)?\\b/", "/exercised\\s+during\\s+the\\s+period\\b/"], "association_window": "Require a CURRENCY numeric token within ±8 tokens of an aggregate/total-intrinsic cue AND an exercise_cue in the same sentence (or antecedent sentence ±1 if exercise event is described across sentences).", "unit_validation": "CURRENCY required. If unit != CURRENCY reject and queue for review.", "precedence": "This mapping overrides any generic 'aggregate' -> PaymentsToAcquireBusinessesGross or other acquisition-fallbacks when 'options exercised' anchor present.", "tie_breaker": "If 'aggregate intrinsic value' appears alongside multiple numeric currency siblings, assign the numeric closest to the 'intrinsic value' cue; if multiple currency tokens are equidistant, prefer the one co-occurring with 'exercised' or with a sentence/time qualifier 'during the period'.", "logging_and_trace": "Attach { attached_bullet_id, matched_cue_spans:[intrinsic-cue, exercised-cue], numeric_span, confidence, provenance }. Queue examples where 'intrinsic' matches but 'exercised' cue missing for human-review as 'intrinsic-no-exercise-anchor'.", "unit_tests": ["\"Aggregate intrinsic value of stock options exercised during the period was $572,000\" -> $572,000 = OptionsExercisesInPeriodTotalIntrinsicValue", "\"The total intrinsic value of options exercised was $1,234,567 for the year\" -> $1,234,567 = OptionsExercisesInPeriodTotalIntrinsicValue", "\"Intrinsic value totaled $X\" with no 'exercised' anchor -> flag 'intrinsic-no-exercise-anchor' for review"]}}, {"type": "ADD", "section": "context_clues_and_indicators", "content": {"id": "ctx-000XX-grants-in-period-counts", "title": "Numeric counts + 'granted' + award-type -> GrantsInPeriod (atomic)", "purpose": "Map explicit integer counts of shares/units that are stated as 'granted' to the most specific grants-in-period tag for the award class (restricted shares, RSUs, other equity awards).", "exact_lexical_cues": ["/granted\\b/", "/were\\s+granted\\b/", "/awards?\\s+granted\\b/", "/grants?\\s+in\\s+the\\s+period\\b/"], "award_type_cues": {"restricted_equity": ["/restricted\\s+share(s)?\\b/", "/restricted\\s+stock\\b/", "/RSU(s)?\\b/", "/restricted\\s+stock\\s+units\\b/"], "other_awards": ["/awards?\\b/", "/units\\b/", "/shares\\b/"]}, "association_window": "Require a SHARES_COUNT numeric token within ±6 tokens of a 'granted' cue and an award_type cue within same sentence or antecedent sentence ±1 (antecedent span <=40 tokens).", "unit_validation": "SHARES_COUNT required (digits optionally followed by 'shares'/'units'). If numeric has currency unit or percent, reject assignment.", "precedence": "If plan-anchor (plan name or 'the Plan') present ±1 sentence, prefer Plan-specific GrantsInPeriod tag. Award-class-specific grants tag overrides generic 'shares issued' or sale/issuance tags.", "tie_breaker": "If numeric adjacency to both 'granted' and 'issued' cues: prefer 'granted' -> GrantsInPeriod; if both 'granted' and 'sold' appear, flag 'grant-vs-sale-conflict' and prefer human review.", "logging_and_trace": "Attach { attached_bullet_id, matched_cue_spans:[granted-cue, award-type-cue, plan-anchor-if-any], numeric_span, unit_detected, provenance }. Log conflict cases and ambiguous antecedent-resolution examples.", "unit_tests": ["\"There were 8,000 restricted shares granted under the Plan during the year\" -> 8,000 = GrantsInPeriod (restricted equity) with plan-anchor", "\"131,600 restricted stock units were granted during the period\" -> 131,600 = GrantsInPeriod (RSU)", "\"We granted 5,000 awards\" (no award-type) -> mark 'grant-type-ambiguous' and queue for review unless plan-anchor specifies award class"]}}], "added_content": ["[ctx-00012] helpful=0 harmful=0 :: {'id': 'ctx-000XX-grant-date-fair-value-per-share', 'title': 'Grant-date fair value per share -> Award-specific WeightedAverageGrantDateFairValue (atomic)', 'purpose': 'Map currency-per-share phrases that state a grant-date fair value to the most specific weighted-average grant-date-fair-value tag for the award class (options vs equity instruments other than options).', 'exact_lexical_cues': ['/grant\\\\s+date\\\\s+fair\\\\s+value/i', '/weighted-?average\\\\s+grant\\\\s+date\\\\s+fair\\\\s+value/i', '/grant\\\\s+date\\\\s+fair\\\\s+value\\\\s+of/i'], 'award_type_cues': {'options': ['/option(s)?\\\\b/', '/stock\\\\s+option(s)?\\\\b'], 'restricted_equity': ['/restricted\\\\s+share(s)?\\\\b/', '/restricted\\\\s+stock\\\\b/', '/RSU(s)?\\\\b/', '/restricted\\\\s+stock\\\\s+units\\\\b/', '/awards?\\\\s+other\\\\s+than\\\\s+options/i', '/other\\\\s+than\\\\s+options/']}, 'association_window': \"Require a PER_SHARE_CURRENCY numeric token (currency + explicit 'per share' or 'per common share' phrase) within ±6 tokens of a grant-date-fair-value cue. If award-type cue appears anywhere in same sentence (or antecedent sentence ±1 with antecedent span <=40 tokens) treat that award-class as the anchor.\", 'unit_validation': \"PER_SHARE_CURRENCY required (currency symbol/word plus 'per share' or equivalent). If currency present but no 'per share' phrase, do NOT auto-assign per-share fair-value tag; flag 'missing-per-share-cue'.\", 'precedence': \"If award-type cue == options -> assign WeightedAverageGrantDateFairValuePerShareForOptions tag (or taxonomy-equivalent). Else if award-type cue == restricted_equity -> assign WeightedAverageGrantDateFairValuePerShareForEquityInstrumentsOtherThanOptions. These class-specific assignments override generic 'PricePerShare' or sale/issuance price tags.\", 'tie_breaker': \"If both option and restricted cues present, prefer explicit phrasing 'option' or 'stock option' when within ±4 tokens of numeric; else prefer the cue closest by token-distance to numeric.\", 'logging_and_trace': 'Attach { attached_bullet_id, match_score, matched_cue_spans:[grant-date-cue, award-type-cue], numeric_span, unit_detected, provenance }. If no playbook bullet exists for the detected specific tag, create derived_bullet and queue for author review.', 'unit_tests': ['\"grant date fair value of $16.25 per share\" + \\'restricted stock units\\' in sentence -> $16.25 per share = WeightedAverageGrantDateFairValuePerShareForEquityInstrumentsOtherThanOptions', '\"weighted-average grant date fair value of $20.90 per share\\' in RSU award table\" -> $20.90 = WeightedAverageGrantDateFairValuePerShareForEquityInstrumentsOtherThanOptions', '\"grant date fair value of $3.50 per share\\' in sentence mentioning \\'stock option\\'\" -> $3.50 = WeightedAverageGrantDateFairValuePerShareForOptions', '\"grant date fair value $2.00\\' but no \\'per share\\' present\" -> flag \\'missing-per-share-cue\\' and require human review']}", "[ctx-00013] helpful=0 harmful=0 :: {'id': 'ctx-000XX-aggregate-intrinsic-options-exercised', 'title': 'Aggregate/Total intrinsic value + options exercised -> OptionsExercisesInPeriodTotalIntrinsicValue (atomic)', 'purpose': 'Deterministically map currency amounts described as aggregate/total intrinsic value of options exercised during the period to OptionsExercisesInPeriodTotalIntrinsicValue.', 'exact_lexical_cues': ['/aggregate\\\\s+intrinsic\\\\s+value/i', '/total\\\\s+intrinsic\\\\s+value/i', '/aggregate\\\\s+intrinsic\\\\s+value\\\\s+of\\\\s+stock\\\\s+options/i', '/intrinsic\\\\s+value\\\\s+of\\\\s+options\\\\s+exercis(ed|es)?/i'], 'exercise_cues': ['/option(s)?\\\\s+exercis(ed|es)?\\\\b/', '/stock\\\\s+options\\\\s+exercis(ed|es)?\\\\b/', '/exercised\\\\s+during\\\\s+the\\\\s+period\\\\b/'], 'association_window': 'Require a CURRENCY numeric token within ±8 tokens of an aggregate/total-intrinsic cue AND an exercise_cue in the same sentence (or antecedent sentence ±1 if exercise event is described across sentences).', 'unit_validation': 'CURRENCY required. If unit != CURRENCY reject and queue for review.', 'precedence': \"This mapping overrides any generic 'aggregate' -> PaymentsToAcquireBusinessesGross or other acquisition-fallbacks when 'options exercised' anchor present.\", 'tie_breaker': \"If 'aggregate intrinsic value' appears alongside multiple numeric currency siblings, assign the numeric closest to the 'intrinsic value' cue; if multiple currency tokens are equidistant, prefer the one co-occurring with 'exercised' or with a sentence/time qualifier 'during the period'.\", 'logging_and_trace': \"Attach { attached_bullet_id, matched_cue_spans:[intrinsic-cue, exercised-cue], numeric_span, confidence, provenance }. Queue examples where 'intrinsic' matches but 'exercised' cue missing for human-review as 'intrinsic-no-exercise-anchor'.\", 'unit_tests': ['\"Aggregate intrinsic value of stock options exercised during the period was $572,000\" -> $572,000 = OptionsExercisesInPeriodTotalIntrinsicValue', '\"The total intrinsic value of options exercised was $1,234,567 for the year\" -> $1,234,567 = OptionsExercisesInPeriodTotalIntrinsicValue', '\"Intrinsic value totaled $X\" with no \\'exercised\\' anchor -> flag \\'intrinsic-no-exercise-anchor\\' for review']}", "[ctx-00014] helpful=0 harmful=0 :: {'id': 'ctx-000XX-grants-in-period-counts', 'title': \"Numeric counts + 'granted' + award-type -> GrantsInPeriod (atomic)\", 'purpose': \"Map explicit integer counts of shares/units that are stated as 'granted' to the most specific grants-in-period tag for the award class (restricted shares, RSUs, other equity awards).\", 'exact_lexical_cues': ['/granted\\\\b/', '/were\\\\s+granted\\\\b/', '/awards?\\\\s+granted\\\\b/', '/grants?\\\\s+in\\\\s+the\\\\s+period\\\\b/'], 'award_type_cues': {'restricted_equity': ['/restricted\\\\s+share(s)?\\\\b/', '/restricted\\\\s+stock\\\\b/', '/RSU(s)?\\\\b/', '/restricted\\\\s+stock\\\\s+units\\\\b/'], 'other_awards': ['/awards?\\\\b/', '/units\\\\b/', '/shares\\\\b/']}, 'association_window': \"Require a SHARES_COUNT numeric token within ±6 tokens of a 'granted' cue and an award_type cue within same sentence or antecedent sentence ±1 (antecedent span <=40 tokens).\", 'unit_validation': \"SHARES_COUNT required (digits optionally followed by 'shares'/'units'). If numeric has currency unit or percent, reject assignment.\", 'precedence': \"If plan-anchor (plan name or 'the Plan') present ±1 sentence, prefer Plan-specific GrantsInPeriod tag. Award-class-specific grants tag overrides generic 'shares issued' or sale/issuance tags.\", 'tie_breaker': \"If numeric adjacency to both 'granted' and 'issued' cues: prefer 'granted' -> GrantsInPeriod; if both 'granted' and 'sold' appear, flag 'grant-vs-sale-conflict' and prefer human review.\", 'logging_and_trace': 'Attach { attached_bullet_id, matched_cue_spans:[granted-cue, award-type-cue, plan-anchor-if-any], numeric_span, unit_detected, provenance }. Log conflict cases and ambiguous antecedent-resolution examples.', 'unit_tests': ['\"There were 8,000 restricted shares granted under the Plan during the year\" -> 8,000 = GrantsInPeriod (restricted equity) with plan-anchor', '\"131,600 restricted stock units were granted during the period\" -> 131,600 = GrantsInPeriod (RSU)', '\"We granted 5,000 awards\" (no award-type) -> mark \\'grant-type-ambiguous\\' and queue for review unless plan-anchor specifies award class']}"], "removed_content": []}
{"timestamp": "2026-02-05T18:13:20.081803", "step": 21, "playbook_before_length": 75940, "playbook_after_length": 80445, "lines_before": 249, "lines_after": 275, "added_lines": 26, "removed_lines": 0, "operations_count": 1, "operations": [{"type": "ADD", "section": "context_clues_and_indicators", "content": "Atomic rule: Nominal-facility-size -> LineOfCreditFacilityCurrentBorrowingCapacity (apply before generic 'facility-size -> maximum' fallbacks).\n- Purpose: When a sentence names a credit/revolving facility by its size with no contractual-max modifiers, map the stated $X amount to LineOfCreditFacilityCurrentBorrowingCapacity (alias: current borrowing capacity / facility size at inception) rather than LineOfCreditFacilityMaximumBorrowingCapacity.\n- Exact positive lexical patterns (case-insensitive regex examples; numeric capture within same clause):\n  - /\\b(a|an|the)\\s+\\$?[0-9]{1,3}[\\d,]*(?:\\.\\d+)?\\s*(?:million|billion)?\\s+(revolv(?:ing)?\\s+credit\\s+facilit(?:y|ies)|revolver|credit\\s+facility)\\b/\n  - /\\b(consisting\\s+of\\s+a\\s+\\$?[0-9,\\.]+\\s*(?:million|billion)?\\s+credit\\s+facility)\\b/\n  - /\\b(entered\\s+into\\s+a\\s+\\$?[0-9,\\.]+\\s*(?:million|billion)?\\s+revolv(?:ing)?\\s+credit\\s+facility)\\b/\n  - /\\b(with\\s+a\\s+\\$?[0-9,\\.]+\\s*(?:million|billion)?\\s+revolver)\\b/\n  - Variants: 'a $X facility', 'a $X revolver', 'a $X credit facility', 'consisting of a $X facility', 'entered into a $X facility'.\n- Negative/maximum lexical cues (must NOT be present near the numeric to apply this rule): /\\b(maximum|maximum\\s+amount|commitment|committed|up\\s+to|in\\s+an\\s+aggregate\\s+principal\\s+amount|aggregate\\s+principal\\s+amount|in\\s+an\\s+aggregate\\s+amount)\\b/.\n- Association & token-window policy:\n  - Primary window: match positive pattern and ensure the numeric token is within the same clause and within ±8 tokens of the facility cue.\n  - Antecedent resolution: allow facility anchor in previous sentence (±1 sentence) when anaphora ('the facility', 'the revolver') is used and antecedent span <= 40 tokens; require the same-sentence check for the numeric if possible.\n- Precedence (apply in order):\n  1) If an explicit maximum/commitment cue (negative/maximum lexical patterns above) appears within ±8 tokens of the numeric, assign LineOfCreditFacilityMaximumBorrowingCapacity.\n  2) Else if explicit remaining-amount cues exist (e.g., 'amount available under the facility totaled/is/was') -> assign LineOfCreditFacilityRemainingBorrowingCapacity (explicit remaining overrides nominal-size mapping).\n  3) Else if nominal-facility-size positive pattern matches and no maximum/remaining cues found -> assign LineOfCreditFacilityCurrentBorrowingCapacity.\n  4) If both nominal-size and a separate contractual-capacity numeric appear in the same sentence, map each numeric to its adjacent cue by token-distance; if a single numeric is adjacent to conflicting cues, prefer RemainingBorrowingCapacity (explicit) then MaximumBorrowingCapacity (explicit contractual language) and only apply CurrentBorrowingCapacity when no explicit contractual/modifier cues exist.\n- Ambiguity handling: if 'availability' appears alone or the sentence is comparative/constraint without a prior anchor (e.g., 'availability may be less than $X' and no explicit prior facility cap), flag as 'ambiguous-availability-without-anchor' and queue for human review (do NOT auto-map to CurrentBorrowingCapacity).\n- Unit-tests / examples (atomic):\n  - 'a $400 million revolving credit facility' -> $400 million = LineOfCreditFacilityCurrentBorrowingCapacity.\n  - 'consisting of a $225 million credit facility' -> $225 million = LineOfCreditFacilityCurrentBorrowingCapacity.\n  - 'entered into a $50 million revolver' -> $50 million = LineOfCreditFacilityCurrentBorrowingCapacity.\n  - 'In an aggregate principal amount of up to $225.0 million, the revolving credit facility...' -> $225.0M = LineOfCreditFacilityMaximumBorrowingCapacity (contractual 'up to' overrides current-size rule).\n  - 'The amount available under the facility totaled $62.5 million' -> $62.5M = LineOfCreditFacilityRemainingBorrowingCapacity (explicit remaining-amount overrides current-size rule).\n- Logging & QA: record numeric span, matched positive pattern span, any nearby maximum/remaining cue spans, chosen tag id, and rationale ('nominal-facility-size-no-maximum -> current capacity'). If classifier previously mapped to MaximumBorrowingCapacity, add example to 'facility-size-mismap' regression queue.\n- Implementation note: insert this rule before existing generic facility-capacity fallbacks (e.g., before ctx-00009 / any rule that defaults bare facility size to maximum). Add the unit-tests above to the regression suite to prevent recurrence of the '$400 million revolving credit facility' -> MaximumBorrowingCapacity error."}], "added_content": ["[ctx-00011] helpful=0 harmful=0 :: Atomic rule: Nominal-facility-size -> LineOfCreditFacilityCurrentBorrowingCapacity (apply before generic 'facility-size -> maximum' fallbacks).", "- Purpose: When a sentence names a credit/revolving facility by its size with no contractual-max modifiers, map the stated $X amount to LineOfCreditFacilityCurrentBorrowingCapacity (alias: current borrowing capacity / facility size at inception) rather than LineOfCreditFacilityMaximumBorrowingCapacity.", "- Exact positive lexical patterns (case-insensitive regex examples; numeric capture within same clause):", "  - /\\b(a|an|the)\\s+\\$?[0-9]{1,3}[\\d,]*(?:\\.\\d+)?\\s*(?:million|billion)?\\s+(revolv(?:ing)?\\s+credit\\s+facilit(?:y|ies)|revolver|credit\\s+facility)\\b/", "  - /\\b(consisting\\s+of\\s+a\\s+\\$?[0-9,\\.]+\\s*(?:million|billion)?\\s+credit\\s+facility)\\b/"], "removed_content": []}
{"timestamp": "2026-02-05T18:13:46.071672", "step": 21, "playbook_before_length": 89560, "playbook_after_length": 94156, "lines_before": 345, "lines_after": 371, "added_lines": 26, "removed_lines": 0, "operations_count": 1, "operations": [{"type": "ADD", "section": "context_clues_and_indicators", "content": "id: ctx-00015 :: Plain-facility-size default -> LineOfCreditFacilityCurrentBorrowingCapacity (atomic rule)\nPurpose: deterministically map plain descriptive facility-size currency mentions (\"a $X revolving credit facility\", \"a $X credit facility\", \"a $X revolver\") to LineOfCreditFacilityCurrentBorrowingCapacity by default, unless explicit contractual-capacity/commitment language is present that should map to LineOfCreditFacilityMaximumBorrowingCapacity.\nExact plain-facility lexical patterns (case-insensitive): /(a|an|the)?\\s*\\$?\\d{1,3}[\\d,]*(?:\\.\\d+)?\\s*(?:million|billion)?\\s+(revolv(?:ing)?\\s+credit\\s+facilit(?:y|ies)|credit\\s+facility|revolver|revolving\\s+facility)\\b/ (apply to numeric token sentence-level). Also accept patterns like 'a $X revolving facility' and 'a $X credit facility'.\nExplicit MAXIMUM/COMMITMENT override cues (case-insensitive): /\\b(up\\s+to|in\\s+an\\s+aggregate\\s+principal\\s+amount\\s+of|commitment(s)?\\b|maximum\\s+amount|maximum\\s+availability|commitment\\s+amount)\\b/ -> map to LineOfCreditFacilityMaximumBorrowingCapacity.\nExplicit REMAINING/AVAILABLE cues (map to current/remaining): /\\b(amount\\s+available\\s+under\\s+the\\s+faci?lity|was\\s+available\\s+under\\s+the\\s+facility|available\\s+for\\s+borrow|borrowing\\s+base|amount\\s+available)\\b/ -> map to LineOfCreditFacilityRemainingBorrowingCapacity/LineOfCreditFacilityCurrentBorrowingCapacity.\nAssociation windows and antecedent resolution:\n- Primary: apply pattern match in same sentence for numeric token and facility lexical anchor within ±8 tokens.\n- Antecedent: allow facility anchor in immediately preceding sentence (±1 sentence) when 'the facility'/'the revolver' anaphor is used and antecedent span <= 40 tokens.\nDefault mapping flow (deterministic, apply in order):\n1) If numeric token + explicit REMAINING/AVAILABLE cue within ±8 tokens -> assign LineOfCreditFacilityRemainingBorrowingCapacity.\n2) Else if numeric token + explicit MAXIMUM/COMMITMENT override cue within same sentence or antecedent sentence (±1) -> assign LineOfCreditFacilityMaximumBorrowingCapacity.\n3) Else if numeric token matches the plain-facility lexical pattern above (e.g., \"a $X revolving credit facility\") and no override cues matched -> ASSIGN LineOfCreditFacilityCurrentBorrowingCapacity (DEFAULT).\n4) Else if numeric token contains 'availability' alone (no 'amount available' or anchor) and no antecedent facility-capacity anchor -> DO NOT auto-assign; flag 'ambiguous-availability' for review.\nTie-breakers and conflicts:\n- If the same sentence contains both plain-facility description and explicit 'up to'/'in an aggregate principal amount of' adjacent to different numeric tokens, map each numeric to the cue to which it is nearest by token distance.\n- If the SAME numeric token is adjacent to both a plain-facility phrase and an explicit MAXIMUM/COMMITMENT cue, prefer MAXIMUM/COMMITMENT -> assign LineOfCreditFacilityMaximumBorrowingCapacity and log 'plain-size-overridden-by-maximum-cue'.\nUnit and anchor validation:\n- Require numeric unit = CURRENCY. If numeric token is not currency, reject and queue for review.\n- Attach anchor spans: facility_anchor_span and overriding_cue_span (if any) to annotation for traceability.\nUnit-tests (add to regression suite):\n- 'a $400 million revolving credit facility' -> $400M = LineOfCreditFacilityCurrentBorrowingCapacity. (fixes reported error)\n- 'revolving credit facilities in an aggregate principal amount of up to $225.0 million' -> $225.0M = LineOfCreditFacilityMaximumBorrowingCapacity.\n- 'the borrowing base under the credit facility is $425.0 million' -> $425.0M = LineOfCreditFacilityRemainingBorrowingCapacity.\n- 'availability under this credit facility may be less than $75 million as a result of outstanding letters of credit' (with prior anchor $75M) -> $75M = LineOfCreditFacilityMaximumBorrowingCapacity (comparative clause) and mark comparative mapping per ctx-00009 rules.\nLogging & QA fields to attach on each auto-assignment: { attached_bullet_id: 'ctx-00015', matched_pattern: 'plain-facility'|'max-override'|'remaining-cue', facility_anchor_span, overriding_cue_span (if any), numeric_span, match_score (deterministic 1.0), provenance: { module: 'ctx-00015', timestamp, pipeline_version } }.\nRationale: this atomic rule encodes the annotation convention used in the ground truth (plain facility-size descriptions default to current borrowing capacity) and enumerates the explicit override cues that indicate a maximum/commitment amount, removing the model's unsafe blanket mapping of facility size to maximum capacity."}], "added_content": ["[ctx-00015] helpful=0 harmful=0 :: id: ctx-00015 :: Plain-facility-size default -> LineOfCreditFacilityCurrentBorrowingCapacity (atomic rule)", "Purpose: deterministically map plain descriptive facility-size currency mentions (\"a $X revolving credit facility\", \"a $X credit facility\", \"a $X revolver\") to LineOfCreditFacilityCurrentBorrowingCapacity by default, unless explicit contractual-capacity/commitment language is present that should map to LineOfCreditFacilityMaximumBorrowingCapacity.", "Exact plain-facility lexical patterns (case-insensitive): /(a|an|the)?\\s*\\$?\\d{1,3}[\\d,]*(?:\\.\\d+)?\\s*(?:million|billion)?\\s+(revolv(?:ing)?\\s+credit\\s+facilit(?:y|ies)|credit\\s+facility|revolver|revolving\\s+facility)\\b/ (apply to numeric token sentence-level). Also accept patterns like 'a $X revolving facility' and 'a $X credit facility'.", "Explicit MAXIMUM/COMMITMENT override cues (case-insensitive): /\\b(up\\s+to|in\\s+an\\s+aggregate\\s+principal\\s+amount\\s+of|commitment(s)?\\b|maximum\\s+amount|maximum\\s+availability|commitment\\s+amount)\\b/ -> map to LineOfCreditFacilityMaximumBorrowingCapacity.", "Explicit REMAINING/AVAILABLE cues (map to current/remaining): /\\b(amount\\s+available\\s+under\\s+the\\s+faci?lity|was\\s+available\\s+under\\s+the\\s+facility|available\\s+for\\s+borrow|borrowing\\s+base|amount\\s+available)\\b/ -> map to LineOfCreditFacilityRemainingBorrowingCapacity/LineOfCreditFacilityCurrentBorrowingCapacity."], "removed_content": []}
{"timestamp": "2026-02-05T18:14:41.981171", "step": 22, "playbook_before_length": 80445, "playbook_after_length": 83917, "lines_before": 275, "lines_after": 276, "added_lines": 1, "removed_lines": 0, "operations_count": 1, "operations": [{"type": "ADD", "section": "common_mistakes_to_avoid", "content": "[err-000XX] helpful=1 harmful=0 :: Provenance-consistency guard for reasoning outputs (atomic prevention rule): Purpose: ensure reasoning outputs' 'bullet_ids' field exactly reflects which playbook bullets actually triggered a mapping and never lists bullets when none were used. Rule (apply at end of mapping pipeline before producing human-readable reasoning): 1) Maintain mapping_record metadata for each numeric-tag decision with these fields: - used_bullets: [] (array of playbook bullet ids whose regex/heuristic matched and contributed to the decision) - matched_lexical_cues: [] (exact cue strings and token spans) - inference_method: one of ['lexical-rule', 'regex', 'measurement-precedence', 'classifier-fallback', 'tie-breaker'] - provenance_consistency: boolean (computed) 2) Populate used_bullets deterministically: when any playbook ctx bullet contains a regex or pattern that matched the sentence span and influenced the selected tag (score>0 or precedence applied), append that bullet id to used_bullets. If the decision was made solely by classifier fallback or external model scoring without matching any playbook bullet, leave used_bullets empty. 3) Compute provenance_consistency = (listed_bullet_ids_in_output == used_bullets). If provenance_consistency == false, perform automated corrective action: - If used_bullets is non-empty, replace listed_bullet_ids with used_bullets. - If used_bullets is empty, remove any listed_bullet_ids and instead emit listed_bullet_ids=[] and set inference_method='classifier-fallback' (or other appropriate). 4) Output contract for reasoning: always include mapping_record.used_bullets and mapping_record.matched_lexical_cues. Do NOT include any bullet id in reasoning unless it appears in used_bullets. 5) QA and logging: when a correction occurs (provenance_consistency false), log an event 'provenance-inconsistency' with (sentence_span, originally_listed_bullet_ids, used_bullets, chosen_tag_id) and queue for human review. 6) Unit-tests (atomic): - Case A (lexical rule hit): Input: 'revolving credit facilities in an aggregate principal amount of up to $225.0 million' -> mapping_record.used_bullets must contain ctx-00008 or ctx-00011/ctx-00009 as appropriate; reasoning output must list those bullet ids exactly (no extras). - Case B (per-annum rate): Input: '8% per annum on the Seller Notes' -> mapping_record.used_bullets must include ctx-00011; reasoning output lists ctx-00011. - Case C (classifier fallback): Input: sentence with no playbook-regex match but classifier predicts tag -> mapping_record.used_bullets == [] and reasoning output lists no bullet ids and sets inference_method='classifier-fallback'. - Case D (mismatch detection): If any reasoning output attempts to list bullets while used_bullets==[], automated correction must remove listed bullets and log 'provenance-inconsistency'. 7) Implementation notes (atomic): - Implement matching step as deterministic boolean: playbook bullets with regex patterns return match spans; if match contributed (per pipeline scoring), add bullet id. - Add a small schema enforcement check before finalizing explanations: if listed_bullet_ids exists then compare to used_bullets; enforce equality or auto-correct. - Surface mapping_record in stored artifact for QA. 8) Minimal telemetry: increment 'provenance-inconsistency' metric when corrections occur; require human-review when frequency > threshold within a run."}], "added_content": ["[err-00012] helpful=0 harmful=0 :: [err-000XX] helpful=1 harmful=0 :: Provenance-consistency guard for reasoning outputs (atomic prevention rule): Purpose: ensure reasoning outputs' 'bullet_ids' field exactly reflects which playbook bullets actually triggered a mapping and never lists bullets when none were used. Rule (apply at end of mapping pipeline before producing human-readable reasoning): 1) Maintain mapping_record metadata for each numeric-tag decision with these fields: - used_bullets: [] (array of playbook bullet ids whose regex/heuristic matched and contributed to the decision) - matched_lexical_cues: [] (exact cue strings and token spans) - inference_method: one of ['lexical-rule', 'regex', 'measurement-precedence', 'classifier-fallback', 'tie-breaker'] - provenance_consistency: boolean (computed) 2) Populate used_bullets deterministically: when any playbook ctx bullet contains a regex or pattern that matched the sentence span and influenced the selected tag (score>0 or precedence applied), append that bullet id to used_bullets. If the decision was made solely by classifier fallback or external model scoring without matching any playbook bullet, leave used_bullets empty. 3) Compute provenance_consistency = (listed_bullet_ids_in_output == used_bullets). If provenance_consistency == false, perform automated corrective action: - If used_bullets is non-empty, replace listed_bullet_ids with used_bullets. - If used_bullets is empty, remove any listed_bullet_ids and instead emit listed_bullet_ids=[] and set inference_method='classifier-fallback' (or other appropriate). 4) Output contract for reasoning: always include mapping_record.used_bullets and mapping_record.matched_lexical_cues. Do NOT include any bullet id in reasoning unless it appears in used_bullets. 5) QA and logging: when a correction occurs (provenance_consistency false), log an event 'provenance-inconsistency' with (sentence_span, originally_listed_bullet_ids, used_bullets, chosen_tag_id) and queue for human review. 6) Unit-tests (atomic): - Case A (lexical rule hit): Input: 'revolving credit facilities in an aggregate principal amount of up to $225.0 million' -> mapping_record.used_bullets must contain ctx-00008 or ctx-00011/ctx-00009 as appropriate; reasoning output must list those bullet ids exactly (no extras). - Case B (per-annum rate): Input: '8% per annum on the Seller Notes' -> mapping_record.used_bullets must include ctx-00011; reasoning output lists ctx-00011. - Case C (classifier fallback): Input: sentence with no playbook-regex match but classifier predicts tag -> mapping_record.used_bullets == [] and reasoning output lists no bullet ids and sets inference_method='classifier-fallback'. - Case D (mismatch detection): If any reasoning output attempts to list bullets while used_bullets==[], automated correction must remove listed bullets and log 'provenance-inconsistency'. 7) Implementation notes (atomic): - Implement matching step as deterministic boolean: playbook bullets with regex patterns return match spans; if match contributed (per pipeline scoring), add bullet id. - Add a small schema enforcement check before finalizing explanations: if listed_bullet_ids exists then compare to used_bullets; enforce equality or auto-correct. - Surface mapping_record in stored artifact for QA. 8) Minimal telemetry: increment 'provenance-inconsistency' metric when corrections occur; require human-review when frequency > threshold within a run."], "removed_content": []}
{"timestamp": "2026-02-05T18:15:29.904424", "step": 22, "playbook_before_length": 94156, "playbook_after_length": 100153, "lines_before": 371, "lines_after": 401, "added_lines": 30, "removed_lines": 0, "operations_count": 1, "operations": [{"type": "ADD", "section": "context_clues_and_indicators", "content": "[ctx-00016] helpful=1 harmful=0 :: Currency-breakdown fallback for parent monetary facts (atomic heuristic)\nPurpose: deterministically map component currency-breakdowns (e.g., 'of which $X were denominated in U.S. dollars and $Y in other currencies') to the correct parent monetary tag when the taxonomy lacks a dedicated component tag, and to prefer component-level tags when they exist.\nExact lexical anchors (case-insensitive regexes):\n - parent-anchor cues (require one): /(?:outstanding\\s+letters?\\s+of\\s+credit|letters?\\s+of\\s+credit\\s+outstanding|outstanding\\s+letter\\s+of\\s+credit)\\b/, /amounts?\\s+outstanding\\b/, /outstanding\\b/ (in same clause as 'letters of credit' or other instrument name).\n - component-breakdown cues: /of\\s+which\\s+([0-9\\,\\.]+)\\s+(?:were\\s+)?denominated\\s+in\\s+([A-Za-z\\-\\$%]+)|of\\s+which\\s+([0-9\\,\\.]+)\\s+of\\s+which\\s+([0-9\\,\\.]+)\\s+were\\s+denominated|denominated\\s+in\\s+U\\.S\\.\\s+dollars|and\\s+([0-9\\,\\.]+)\\s+in\\s+currencies?\\s+other\\s+than\\s+the\\s+U\\.S\\.\\s+dollar/i, /denominated\\s+in\\s+([A-Z]{3}|U\\.S\\.\\s+dollars|dollars|euro|EUR|USD)\\b/.\nAssociation windows & antecedent resolution:\n - Require a parent-anchor (parent monetary concept e.g. 'letters of credit outstanding') in the same sentence OR the immediately preceding sentence (±1 sentence, antecedent span <= 40 tokens). If no parent-anchor found, do NOT auto-assign component -> parent; flag 'breakdown-no-parent-anchor' for review.\n - For each currency-component numeric token, require the component token to be within the same clause or within ±12 tokens of the component-breakdown cue (tight window to avoid erroneous attachments).\nMapping decision flow (apply in order):\n 1) If taxonomy contains an explicit currency-component tag (e.g., LettersOfCreditOutstandingAmountByCurrency or LettersOfCreditOutstandingAmountInU.S.Dollars) -> assign that specific component tag to the component numeric and link it to the parent via instrument-anchor metadata (parent_tag_id + relation='component-of').\n 2) Else (no currency-component tag exists) -> map component numeric to the parent outstanding tag (e.g., LettersOfCreditOutstandingAmount) with the following deterministics:\n    a) Attach currency attribute metadata: { currency_literal: '<detected currency text>', currency_iso: '<ISO if recognized e.g., USD>', relation: 'component-of', parent_tag: '<parent_tag_id>' }.\n    b) Attach matched_cue_spans: [ parent_anchor_span, component_breakdown_span, numeric_span ].\n    c) Set attached_bullet_id = ctx-00016 and match_score = 1.0 (deterministic) for traceability.\n 3) If the component sentence contains an explicit per-currency tag candidate AND the tag-assignment in step (1) was made but the post-decision validator (ctx-00010) fails unit-or-anchor validation, create derived_bullet record (derived-<hash>) recommending a currency-component tag and queue for playbook author review.\nPrecedence & conflict rules:\n - Component-breakdown mapping to parent overrides generic heuristics that would otherwise map the component amounts to unrelated tags (e.g., PaymentsToAcquireBusinessesGross, RemainingBorrowingCapacity) when parent-anchor is present and component context includes words like 'of which', 'denominated in'.\n - Do NOT split a parent 'outstanding' amount across different parent tags; components must map back to the same canonical parent tag unless explicit component-level taxonomy tags are available.\nValidation & sanity checks:\n - Sum-check logging: when parent total numeric is present in same or adjacent sentence and the components are numeric, compute (sum of components) vs parent_total. If deviation > tolerance (e.g., 0.5% absolute or $1,000 for small amounts), emit 'breakdown-sum-mismatch' QA record with spans and values.\n - Unit-and-anchor enforcement: each component numeric must pass ctx-00010 unit validation (CURRENCY). If unit missing, flag 'component-missing-unit' and queue for review rather than auto-assign.\n - Currency normalization: map detected currency words to ISO where possible (USD, EUR, etc.); if phrase 'currencies other than the U.S. dollar' appears, attach a 'NON_USD' bucket metadata and preserve literal component numeric mapping to parent.\nTrace & logging requirements (attach to each annotation):\n { attached_bullet_id: 'ctx-00016'|'derived-<hash>', parent_tag_id: '<parent_tag>', parent_anchor_span, component_currency_literal, component_currency_iso (if any), numeric_span, matched_cue_spans, match_score, validation: { unit_check_passed:bool, sum_check_passed:bool, reason_codes:[] }, provenance:{ module:'ctx-00016', pipeline_version, timestamp } }\nUnit-tests (atomic examples to add):\n - Positive: 'The Company had $449.9 million of outstanding letters of credit, $242.3 million of which were denominated in U.S. dollars and $207.6 million of which were denominated in currencies other than the U.S. dollar.' -> parent $449.9M = LettersOfCreditOutstandingAmount; $242.3M and $207.6M -> LettersOfCreditOutstandingAmount + currency metadata (USD and NON_USD) attached; sum_check passes.\n - Positive with missing component tag: same sentence but taxonomy lacks currency-component tags -> components map to parent LettersOfCreditOutstandingAmount with currency attribute and derived_bullet suggestion for currency-component tags.\n - Negative/no-anchor: '$242.3 million denominated in U.S. dollars' but no parent-anchor in ±1 sentence -> flag 'breakdown-no-parent-anchor' and do not auto-assign; queue for human review.\n - Sum-mismatch: parent total $450.0M but components sum to $449.9M -> if deviation <= tolerance, allow mapping but log minor mismatch; if > tolerance -> emit 'breakdown-sum-mismatch' QA record.\nOperational note: run this heuristic after parent-anchor detection (e.g., ctx-00013 / ctx-00008 family) and before generic fallbacks. When frequent derived_bullets are created for currency-component patterns, surface recommended taxonomy additions in the weekly 'derived-bullet suggestions' dashboard."}], "added_content": ["[ctx-00016] helpful=0 harmful=0 :: [ctx-00016] helpful=1 harmful=0 :: Currency-breakdown fallback for parent monetary facts (atomic heuristic)", "Purpose: deterministically map component currency-breakdowns (e.g., 'of which $X were denominated in U.S. dollars and $Y in other currencies') to the correct parent monetary tag when the taxonomy lacks a dedicated component tag, and to prefer component-level tags when they exist.", "Exact lexical anchors (case-insensitive regexes):", " - parent-anchor cues (require one): /(?:outstanding\\s+letters?\\s+of\\s+credit|letters?\\s+of\\s+credit\\s+outstanding|outstanding\\s+letter\\s+of\\s+credit)\\b/, /amounts?\\s+outstanding\\b/, /outstanding\\b/ (in same clause as 'letters of credit' or other instrument name).", " - component-breakdown cues: /of\\s+which\\s+([0-9\\,\\.]+)\\s+(?:were\\s+)?denominated\\s+in\\s+([A-Za-z\\-\\$%]+)|of\\s+which\\s+([0-9\\,\\.]+)\\s+of\\s+which\\s+([0-9\\,\\.]+)\\s+were\\s+denominated|denominated\\s+in\\s+U\\.S\\.\\s+dollars|and\\s+([0-9\\,\\.]+)\\s+in\\s+currencies?\\s+other\\s+than\\s+the\\s+U\\.S\\.\\s+dollar/i, /denominated\\s+in\\s+([A-Z]{3}|U\\.S\\.\\s+dollars|dollars|euro|EUR|USD)\\b/."], "removed_content": []}
{"timestamp": "2026-02-05T18:16:45.769563", "step": 23, "playbook_before_length": 83917, "playbook_after_length": 89064, "lines_before": 276, "lines_after": 296, "added_lines": 19, "removed_lines": 0, "operations_count": 1, "operations": [{"type": "ADD", "section": "context_clues_and_indicators", "content": "[ctx-00014] helpful=1 harmful=0 :: Anaphoric partitioning rule for share-grant counts (atomic heuristic)\n- Purpose: deterministically treat numeric mentions introduced as partitions ('remaining', 'the balance', 'the rest', 'of which') as components of a prior grant event and prefer GrantsInPeriod tags, and prevent over-application of vesting/performance -> NonvestedNumber heuristics.\n- Exact anaphor lexical cues (case-insensitive regexes): /\\b(remaining|the\\s+remaining|the\\s+balance|the\\s+rest|remainder|of\\s+which|of\\s+which\\s+the)\\b/, /\\b(the\\s+other|the\\s+second\\s+tranche|the\\s+first\\s+tranche)\\b/ within same sentence or leading connective phrase across sentences.\n- Antecedent detection (search window & matching):\n  1) Search preceding text up to the previous 1 sentence (±1 sentence) for an explicit grant-verb phrase anchored to the same noun head (e.g., 'granted', 'were granted', 'included in the grants', 'grants for the [period]'). Use fuzzy noun-head match: compare normalized head tokens (e.g., 'performance share award(s)', 'RSU(s)', 'restricted shares') between antecedent and anaphoric sentence. Require at least one shared head token (e.g., 'performance' + 'share' OR 'RSU' OR 'restricted') and matching plurality stance.\n  2) If antecedent grant-verb phrase exists and noun-head match succeeds, mark numeric as antecedent-partition.\n- Association & token-distance: require the anaphor cue and numeric to be within the same clause or within ±16 tokens; allow antecedent grant-verb up to 1 sentence earlier and antecedent span <= 40 tokens. If antecedent is >1 sentence earlier or noun-head match confidence < threshold, do not auto-propagate.\n- Precedence & mapping decision (apply atomically in numeric-tag pipeline):\n  1) If numeric is detected as antecedent-partition per above -> assign ShareBasedCompensationArrangementByShareBasedPaymentAwardEquityInstrumentsOtherThanOptionsGrantsInPeriod (i.e., treat as part of the originally granted count). Record antecedent link in mapping_record.used_bullets and provenance. Override any vesting/performance-based NonvestedNumber assignment.\n  2) If numeric matches explicit nonvested/unvested lexical anchors (e.g., /\\b(non-?vested|unvested|outstanding\\s+and\\s+unvested|shares?\\s+unvested)\\b/) and those anchors are nearer to the numeric than the antecedent grant-verb (token-distance), then assign NonvestedNumber (explicit nonvested wins).\n  3) If numeric is introduced by an anaphor but no antecedent grant-verb with noun-head match is found, do NOT infer NonvestedNumber from perf/vesting words alone; instead flag 'ambiguous-anaphoric-grant' for human review.\n- Vesting/performance suppression rule (atomic): when antecedent-partition is true, treat performance-period / three-year-performance / will-vest / vesting-criteria lexical cues as neutral modifiers (do NOT trigger NonvestedNumber). Only explicit outstanding/unvested language or explicit 'as of [date] nonvested' phrases may override the antecedent-grants mapping.\n- Tie-breaker: if both antecedent-grant and an explicit nonvested phrase are present, compute token-distance to numeric; if distances equal within ±1 token, prefer explicit nonvested only when the nonvested phrase contains an explicit outstanding/time anchor (e.g., 'outstanding and unvested as of December 31'); otherwise prefer GrantsInPeriod.\n- Confidence & fallback: attach confidence flag 'anaphoric-grant-inferred' when antecedent propagation used. If antecedent-match confidence < 0.75 (e.g., fuzzy head-match weak or antecedent sentence > 1 clause away), do not auto-map; enqueue for human review.\n- Unit-tests (atomic examples to add):\n  1) 'The Compensation Committee granted 261,642 RSUs and 254,620 performance share awards. The performance share awards consist of two awards: one group (123,812) was granted based on TSR. The remaining 130,808 performance share awards have a three-year performance period.' -> 123,812 = GrantsInPeriod; 130,808 = GrantsInPeriod (antecedent propagation; performance-period neutral).\n  2) 'We granted 100,000 RSUs. The remaining 40,000 remain unvested and outstanding.' -> 100,000 = GrantsInPeriod; 40,000 = NonvestedNumber (explicit 'unvested and outstanding' overrides partitioning only if nearer).\n  3) 'Included in the grants are 71,000 performance-vesting RSUs. Of which 21,000 will vest next year.' (no explicit 'granted' verb in prior sentence) -> 71,000 = GrantsInPeriod if a grant-verb exists in same clause; 21,000 flagged 'ambiguous-anaphoric-grant' if no antecedent grant found.\n- Logging & provenance: always record antecedent span, noun-head tokens matched, anaphor cue span, token-distances, chosen tag id, and mapping_record.used_bullets includes this ctx-00014. Emit 'anaphoric-propagation' telemetry when used and 'ambiguous-anaphoric-grant' when queued for review.\n- Implementation note: insert this rule before any lexical mapping that maps 'performance period'/'vesting' -> NonvestedNumber and before classifier fallback. Add unit-tests above to regression suite and ensure mapping_record.provenance_consistency records ctx-00014 when applied."}], "added_content": ["[ctx-00013] helpful=0 harmful=0 :: [ctx-00014] helpful=1 harmful=0 :: Anaphoric partitioning rule for share-grant counts (atomic heuristic)", "- Purpose: deterministically treat numeric mentions introduced as partitions ('remaining', 'the balance', 'the rest', 'of which') as components of a prior grant event and prefer GrantsInPeriod tags, and prevent over-application of vesting/performance -> NonvestedNumber heuristics.", "- Exact anaphor lexical cues (case-insensitive regexes): /\\b(remaining|the\\s+remaining|the\\s+balance|the\\s+rest|remainder|of\\s+which|of\\s+which\\s+the)\\b/, /\\b(the\\s+other|the\\s+second\\s+tranche|the\\s+first\\s+tranche)\\b/ within same sentence or leading connective phrase across sentences.", "- Antecedent detection (search window & matching):", "  1) Search preceding text up to the previous 1 sentence (±1 sentence) for an explicit grant-verb phrase anchored to the same noun head (e.g., 'granted', 'were granted', 'included in the grants', 'grants for the [period]'). Use fuzzy noun-head match: compare normalized head tokens (e.g., 'performance share award(s)', 'RSU(s)', 'restricted shares') between antecedent and anaphoric sentence. Require at least one shared head token (e.g., 'performance' + 'share' OR 'RSU' OR 'restricted') and matching plurality stance."], "removed_content": []}
{"timestamp": "2026-02-05T18:17:13.722429", "step": 23, "playbook_before_length": 100153, "playbook_after_length": 105044, "lines_before": 401, "lines_after": 427, "added_lines": 25, "removed_lines": 0, "operations_count": 1, "operations": [{"type": "ADD", "section": "context_clues_and_indicators", "content": "Title: Disambiguate \"remaining <N>\" -> 'remaining-of-grant' vs 'remaining-outstanding' (atomic heuristic)\nPurpose: Prevent mapping 'remaining N awards' by default to NonvestedNumber when the phrase is actually partitioning a previously described grant pool (should map to GrantsInPeriod).\nExact lexical cues (case-insensitive regexes):\n - grant-anchor cues: /\\b(granted|were\\s+granted|grants?\\s+in\\s+the\\s+period|awards?\\s+granted|grants?\\s+in\\s+the\\s+year|the\\s+Company\\s+granted)\\b/\n - remaining-cue forms: /\\b(remaining|the\\s+remaining|remainder|the\\s+remainder)\\b/\n - outstanding/unvested cues (explicit nonvested): /\\b(nonvested|unvested|outstanding|vested\\/unvested|vested\\s+and\\s+unvested|remaining\\s+unvested|still\\s+outstanding)\\b/\nAssociation windows & antecedent resolution:\n - If a numeric token appears within ±4 tokens of a remaining-cue, run antecedent-scan for a grant-anchor in the same sentence OR in the immediately preceding sentence (±1 sentence). Allow antecedent span up to 40 tokens across sentence boundary.\n - Treat a prior numeric grant-anchor (e.g., '254,620 performance share awards were granted') as a definitive grant pool anchor when it co-occurs with grant-anchor cues above.\nDecision flow (deterministic, apply in order):\n 1) If numeric token matches remaining-cue AND antecedent-scan finds a grant-anchor (textual 'granted' + an earlier grant count or explicit 'grants in the period' anchor) within allowed window -> map numeric to GrantsInPeriod (same grants-in-period tag used for the antecedent grant counts). Attach relation metadata: { relation: 'component-of-grant', grant_anchor_span }.\n 2) Else if numeric token matches remaining-cue AND same sentence (or ±1 sentence) includes an explicit outstanding/unvested cue -> map numeric to NonvestedNumber (or other outstanding-specific tag) and attach anchor span for 'outstanding/unvested'. Example cues: 'nonvested', 'outstanding', 'unvested'.\n 3) Else if numeric token matches remaining-cue but both grant-anchor AND outstanding cues present: prefer explicit outstanding/unvested cues (NonvestedNumber) only if the outstanding/unvested cue is lexically closer to the numeric token (token-distance rule). Otherwise prefer GrantsInPeriod if antecedent grant-anchor is the semantic antecedent (e.g., sentence is partitioning a previously stated grant pool). Log tie events.\n 4) Else (no antecedent grant-anchor and no explicit outstanding/unvested cue) -> DO NOT auto-assign. Flag as 'remaining-ambiguous' and queue example for human review instead of guessing.\nPrecedence & tie-breakers (atomic):\n - Highest precedence: explicit in-sentence outstanding/unvested lexical cue near numeric -> NonvestedNumber.\n - Next: detected antecedent grant-anchor within ±1 sentence and token-distance to numeric <= 40 -> GrantsInPeriod (treat 'remaining' as partition of grant pool).\n - If both cues present and distances equal, prefer the label whose required-anchor-cue includes an award-verb ('granted') when the antecedent explicitly declares a grant event; otherwise require human review.\nUnit-and-evidence validation (must run and attach traces):\n - Required evidence fields to attach on decision: { attached_bullet_id, decision_rule_id: 'ctx-remaining-01', matched_cue_spans: [remaining_cue_span, grant_anchor_span|null, outstanding_cue_span|null], numeric_span, decision: 'grants-in-period'|'nonvested'|'deferred-ambiguous', match_score: deterministic (1.0 when antecedent found), provenance: { module:'ctx-remaining-01', timestamp, pipeline_version } }.\nUnit-tests (atomic examples):\n - Positive (should map to GrantsInPeriod): 'The Company granted 254,620 performance share awards during the period. 123,812 were TSR awards and the remaining 130,808 performance share awards have a three-year performance period.' -> 254,620 = GrantsInPeriod; 123,812 = GrantsInPeriod; 130,808 = GrantsInPeriod (rule applies because antecedent grant-anchor exists).\n - Negative (should map to NonvestedNumber): 'As of December 31, 130,808 awards remained outstanding and nonvested under the plan.' -> 130,808 = NonvestedNumber (explicit 'outstanding'/'nonvested').\n - Ambiguous (defer to review): 'The remaining 130,808 amount was noted.' (no grant or outstanding anchors within ±1 sentence) -> flag 'remaining-ambiguous' and require human review.\nLogging & QA: always record anchor spans and which rule branch fired; log 'remaining-ambiguous' instances to retraining queue. Create derived_bullet suggestion when GrantsInPeriod mapping is common for this pattern but no playbook bullet explicitly documents it.\nImplementation note: run this heuristic early in share-based-compensation mapping pipeline (before general lexical fallbacks that equate 'remaining' -> outstanding). Integrate with err-00003 heuristic-use logging so attached_bullet_id and matched spans are persisted for audit."}], "added_content": ["[ctx-00017] helpful=0 harmful=0 :: Title: Disambiguate \"remaining <N>\" -> 'remaining-of-grant' vs 'remaining-outstanding' (atomic heuristic)", "Purpose: Prevent mapping 'remaining N awards' by default to NonvestedNumber when the phrase is actually partitioning a previously described grant pool (should map to GrantsInPeriod).", "Exact lexical cues (case-insensitive regexes):", " - grant-anchor cues: /\\b(granted|were\\s+granted|grants?\\s+in\\s+the\\s+period|awards?\\s+granted|grants?\\s+in\\s+the\\s+year|the\\s+Company\\s+granted)\\b/", " - remaining-cue forms: /\\b(remaining|the\\s+remaining|remainder|the\\s+remainder)\\b/"], "removed_content": []}
{"timestamp": "2026-02-05T18:18:10.870268", "step": 24, "playbook_before_length": 89064, "playbook_after_length": 92400, "lines_before": 296, "lines_after": 317, "added_lines": 19, "removed_lines": 0, "operations_count": 1, "operations": [{"type": "ADD", "section": "context_clues_and_indicators", "content": "Share-based-compensation: 'vested' + total-fair-value lexical guard (atomic heuristic)\n- Purpose: deterministically map currency totals that describe the total fair value of equity awards that vested in the period to the vested-in-period total-fair-value tag; avoid conflating these totals with per-share weighted-average fair-value measures.\n- Exact lexical patterns (case-insensitive regexes; apply before per-share/weighted-average and generic 'fair value' fallbacks):\n  - /(?:total\\s+)?fair\\s+value\\s+of\\s+(?:shares|awards|options?)\\s+vested/ i\n  - /(?:the\\s+)?total\\s+fair\\s+value\\s+vested/ i\n  - /fair\\s+value\\s+of\\s+(?:vested|awarded\\s+and\\s+vested)\\s+(?:shares|awards|options?)/ i\n  - /aggregate\\s+fair\\s+value\\s+of\\s+shares\\s+vested/ i\n- Association window: require the matched lexical pattern to be in the same sentence as the currency numeric token and within ±8 tokens of the numeric. If numeric appears inside a parenthetical immediately adjacent to the matched cue, allow mapping even if token-distance >8 but within same clause.\n- Mapping: if matched -> assign ShareBasedCompensation...VestedInPeriodTotalFairValue (the most-specific taxonomy tag representing total fair value of awards vested in the period). Record instrument/plan anchor when present.\n- Precedence rules (apply in order):\n  1) If 'weighted-average' + 'grant-date fair value' or 'per share' lexical cue appears within ±8 tokens of the numeric -> map to GrantsInPeriodWeightedAverageGrantDateFairValue (per-share weighted-average) and skip this rule.\n  2) Else if 'aggregate' or 'total' + 'fair value' + 'vested' matches -> map to VestedInPeriodTotalFairValue (this rule).\n  3) Else if only 'fair value' appears without 'vested' and multiple measurement terms exist (fair value vs carrying amount) apply measurement-term precedence (ctx-00002) before mapping.\n- Negative prevention: do NOT map per-share numbers (presence of 'per share' or percentage-of-share units) to this total-fair-value tag. Do NOT map 'intrinsic value' or 'aggregate intrinsic value of options exercised' to vested-total-fair-value; those have their own tags (ctx-00010).\n- Unit-tests (atomic examples to add):\n  - 'The total fair value of shares vested was $93 million' -> $93M = VestedInPeriodTotalFairValue.\n  - 'Aggregate fair value of awards vested during the period was $76 million' -> $76M = VestedInPeriodTotalFairValue.\n  - 'The weighted-average grant-date fair value of awards granted was $20.77 per share' -> $20.77 = GrantsInPeriodWeightedAverageGrantDateFairValue (ensures precedence/negative prevention works).\n  - '(The total fair value of shares vested was $57 million.)' (parenthetical) -> $57M = VestedInPeriodTotalFairValue.\n- Logging & provenance: record matched lexical cue span, numeric span, chosen tag id, rule-id 'ctx-delta-vested-total-fv', and used_bullets entry. Emit 'vested-total-fv-mapped' telemetry and queue any cases where both 'per share' and 'total fair value vested' cues co-occur for QA (flag as 'vested-total-vs-per-share-conflict').\n- Implementation note: insert this guard as the first step in the share-based-compensation monetary-tagging pipeline (immediately before ctx-00010 per-share guards) so that explicit 'vested' total-dollar statements deterministically map to the vested-total-fair-value tag."}], "added_content": ["[ctx-00014] helpful=0 harmful=0 :: Share-based-compensation: 'vested' + total-fair-value lexical guard (atomic heuristic)", "- Purpose: deterministically map currency totals that describe the total fair value of equity awards that vested in the period to the vested-in-period total-fair-value tag; avoid conflating these totals with per-share weighted-average fair-value measures.", "- Exact lexical patterns (case-insensitive regexes; apply before per-share/weighted-average and generic 'fair value' fallbacks):", "  - /(?:total\\s+)?fair\\s+value\\s+of\\s+(?:shares|awards|options?)\\s+vested/ i", "  - /(?:the\\s+)?total\\s+fair\\s+value\\s+vested/ i"], "removed_content": []}
{"timestamp": "2026-02-05T18:19:16.574681", "step": 24, "playbook_before_length": 105044, "playbook_after_length": 110316, "lines_before": 427, "lines_after": 451, "added_lines": 24, "removed_lines": 0, "operations_count": 1, "operations": [{"type": "ADD", "section": "context_clues_and_indicators", "content": "id: ctx-00018 :: Sibling-numeric disambiguation for share-based-compensation (aggregate-vs-per-share) (atomic)\nPurpose: deterministically map multiple numeric tokens in the same clause/sentence that refer to share-based-compensation metrics so aggregates and per-share measures are assigned to distinct, correct tags and instrument class (options vs equity-other-than-options) is enforced.\nExact lexical cues (case-insensitive):\n - vested-aggregate cues: /\\b(total\\s+fair\\s+value\\s+of\\s+(shares|awards)\\s+vested|total\\s+fair\\s+value\\s+of\\s+awards\\s+that\\s+vested|fair\\s+value\\s+of\\s+awards\\s+that\\s+vested)\\b/\n - grant-date per-share cues: /\\b(weighted-?average\\s+grant-?date\\s+fair\\s+value\\b|grant-?date\\s+fair\\s+value\\s+per\\s+share|weighted-?average\\s+grant-?date\\s+fair\\s+value\\s+of)\\b/\n - instrument-class cues (equity-other-than-options): /\\b(restricted\\s+stock|restricted\\s+share|common\\s+share|common\\s+stock|RSU|restricted\\s+stock\\s+units|awards?\\s+other\\s+than\\s+options)\\b/\nAssociation windows & token rules:\n - Operate on the minimal clause (same sentence or immediately adjacent sentence where connective phrases tie the metrics). Consider numeric tokens within ±12 tokens of the cues.\n - For any sentence containing at least one vested-aggregate cue AND at least one grant-date per-share cue: apply sibling-disambiguation mapping below rather than single-token lexical fallbacks.\n Unit validation:\n - Vested-aggregate mapping requires numeric token unit == CURRENCY (e.g., $93 million). If unit != CURRENCY reject and queue for review.\n - Grant-date per-share mapping requires unit == PER_SHARE_CURRENCY (currency + explicit 'per share' or 'per common share'); if currency present without 'per share', flag 'missing-per-share-cue' and queue for review.\n Deterministic mapping rules & precedence (apply in order):\n 1) If CURRENCY numeric + vested-aggregate cue present -> assign ShareBasedCompensationArrangementByShareBasedPaymentAwardEquityInstrumentsOtherThanOptionsVestedInPeriodTotalFairValue (vested-in-period aggregate). Attach instrument-class anchor if present (see step 3). Do NOT map this currency to any grant-date-per-share tag.\n 2) If PER_SHARE_CURRENCY numeric + grant-date per-share cue present -> assign ShareBasedCompensationArrangementByShareBasedPaymentAwardEquityInstrumentsOtherThanOptionsGrantsInPeriodWeightedAverageGrantDateFairValue (award-class-specific weighted-average grant-date fair value). Do NOT map this per-share number to aggregate/vested tags.\n 3) Instrument-class enforcement: if instrument-class cue (restricted/common/RSU) appears in same sentence or antecedent ±1 sentence (antecedent span <= 40 tokens), force assignment to the 'EquityInstrumentsOtherThanOptions' family for both tags above. If only 'option' / 'stock option' appears, do NOT assign the equity-other-than-options variants; instead route to option-specific tags (e.g., options-weighted-average-grant-date) per existing ctx-00012 rules.\n 4) Multi-sibling tie-breaker: when multiple currency tokens appear near the vested-aggregate cue, choose the numeric token closest by token-distance to the exact phrase 'total fair value' or 'vested'. When multiple per-share tokens appear near grant-date cue, choose the per-share numeric closest to 'grant-date fair value' or 'weighted-average'.\n 5) Cross-mapping guardrails: if algorithm would assign the same numeric token to both an aggregate-fair-value and a per-share grant-date tag, reject ambiguous double-assignment and flag 'sharecomp-sibling-ambiguous' for human review. Prefer deterministic single assignments above; only allow both tags if the text contains explicit dual measurements referencing different units (e.g., '$93 million' and '$20.77 per share') and units match required types.\n Logging & evidence attachment (mandatory): for every auto-assignment attach { attached_bullet_id, matched_cue_spans: [vested_cue_span|null, grantdate_cue_span|null, instrument_class_span|null], numeric_span, unit_detected, decision_rule_id:'ctx-00018', match_score:1.0, provenance }. If instrument-class anchor absent, attach 'instrument_class_inferred': 'EQUITY_OTHER_THAN_OPTIONS' only when lexical evidence present; otherwise attach 'instrument_class_missing' and queue example for review.\n Minimal unit-tests/examples (atomic):\n - 'The total fair value of shares vested was $93 million in 2018... The weighted-average grant-date fair value of awards granted was $20.77 during 2018.' -> $93M -> VestedInPeriodTotalFairValue (EquityInstrumentsOtherThanOptions); $20.77 per share -> GrantsInPeriodWeightedAverageGrantDateFairValue (EquityInstrumentsOtherThanOptions). (pass)\n - 'Total fair value of awards that vested during the year was $5.6 million and the weighted-average grant-date fair value was $4.50 per share.' -> map respectively by unit. (pass)\n - 'Weighted-average grant-date fair value $4.50 (no \"per share\" present)' -> flag 'missing-per-share-cue' and queue for human review. (validation)\n Implementation note: run ctx-00018 after ctx-00006/ctx-00012 lexical detection but before generic numeric fallbacks. Integrate with err-00003 heuristic-use logging so attached_bullet_id is recorded and create derived_bullet if taxonomy lacks an award-class-specific tag."}], "added_content": ["[ctx-00018] helpful=0 harmful=0 :: id: ctx-00018 :: Sibling-numeric disambiguation for share-based-compensation (aggregate-vs-per-share) (atomic)", "Purpose: deterministically map multiple numeric tokens in the same clause/sentence that refer to share-based-compensation metrics so aggregates and per-share measures are assigned to distinct, correct tags and instrument class (options vs equity-other-than-options) is enforced.", "Exact lexical cues (case-insensitive):", " - vested-aggregate cues: /\\b(total\\s+fair\\s+value\\s+of\\s+(shares|awards)\\s+vested|total\\s+fair\\s+value\\s+of\\s+awards\\s+that\\s+vested|fair\\s+value\\s+of\\s+awards\\s+that\\s+vested)\\b/", " - grant-date per-share cues: /\\b(weighted-?average\\s+grant-?date\\s+fair\\s+value\\b|grant-?date\\s+fair\\s+value\\s+per\\s+share|weighted-?average\\s+grant-?date\\s+fair\\s+value\\s+of)\\b/"], "removed_content": []}
{"timestamp": "2026-02-05T18:19:44.609259", "step": 25, "playbook_before_length": 92400, "playbook_after_length": 96369, "lines_before": 317, "lines_after": 339, "added_lines": 21, "removed_lines": 0, "operations_count": 1, "operations": [{"type": "ADD", "section": "context_clues_and_indicators", "content": "Atomic lexical-to-tag rule: Redemption/Call/Repurchase price percentages -> DebtInstrumentRedemptionPricePercentage\n- Purpose: deterministically map percent tokens that express a redemption/call/repurchase price (percent of par/principal) to DebtInstrumentRedemptionPricePercentage and link to the debt instrument anchor.\n- Exact lexical cues (case-insensitive regexes; match BEFORE generic percent heuristics):\n  - '\\bredeemable\\s+at\\b', '\\bredeemable\\s+at\\s+[0-9]+(?:\\.[0-9]+)?\\s*%\\b', '\\bcallable\\s+at\\b', '\\bcallable\\s+at\\s+[0-9]+(?:\\.[0-9]+)?\\s*%\\b', '\\bcall\\s+at\\b', '\\bmay\\s+be\\s+redeemed\\s+at\\b', '\\bprepaid\\s+at\\b', '\\bprepayment\\s+price\\s+of\\b', '\\bprice\\s+equal\\s+to\\s+[0-9]+(?:\\.[0-9]+)?\\s*%\\s+of\\s+par\\b', '\\bpercent\\s+of\\s+par\\b', '\\b%\\s+of\\s+par\\b', '\\bredemption\\s+price\\b', '\\bredeemed\\s+at\\b', '\\brepurchase\\s+at\\b'.\n- Parenthetical forms: detect patterns like \"(redeemable at 103.813%)\" within same clause and treat as strong redemption cue.\n- Instrument-anchor detection: require a debt-instrument anchor in same sentence or previous sentence (allow antecedent resolution ±1 sentence, antecedent span <= 40 tokens). Debt anchors: /\\b(senior\\s+notes|notes|note|term\\s+loan|loan|debenture|bond|obligation|preferred\\s+stock)s?\\b/.\n- Association windows & adjacency:\n  1) Primary: redemption lexical cue within ±6 tokens of the percent numeric -> strong match.\n  2) Secondary: redemption cue anywhere in same clause and instrument anchor within same sentence or prior sentence (antecedent <=40 tokens) -> assign if percent appears in same clause.\n- Precedence & tie-breaker (apply before ctx-00011 'per annum' and ctx-00006 percent-as-instrument-coupon):\n  1) If redemption cue matches (primary or parenthetical) -> assign DebtInstrumentRedemptionPricePercentage and link mapping_record.instrument_anchor = captured instrument span.\n  2) If both redemption cue and interest-rate cue ('per annum', 'interest rate', 'bearing interest at') co-occur and reference the same percent token, flag as 'redeem-vs-rate-conflict' and queue for human review; do NOT auto-assign unless textual syntax clearly attaches the percent to one predicate (use dependency parse if available).\n  3) If redemption cue present but percent also co-occurs with LIBOR/ABR/margin cues (rare), prefer redemption mapping for explicit 'redeemable at X%' surface forms; log conflict for QA.\n- Normalization & linkage: capture percent span, redemption-cue span, instrument-anchor span, and store mapping_record.used_bullets entry for this rule. Emit provenance tag 'redemption-price-mapped' with spans.\n- Unit-tests (atomic examples to add):\n  1) 'The notes are redeemable at 103.813% until July 15, 2023.' -> 103.813% = DebtInstrumentRedemptionPricePercentage (anchor: notes).\n  2) 'The 3.550% Senior Notes are redeemable at 101% of the principal amount.' -> 101% = DebtInstrumentRedemptionPricePercentage (anchor: Senior Notes); 3.550% remains interest-rate mapped per ctx-00006.\n  3) 'The bonds are callable at 100% plus accrued interest' -> 100% = DebtInstrumentRedemptionPricePercentage; log 'plus accrued interest' context as attached text.\n  4) 'The debt may be prepaid at a price equal to 102% of par prior to maturity.' -> 102% = DebtInstrumentRedemptionPricePercentage.\n  5) Parenthetical: 'Senior Notes (redeemable at 103.813%) were issued' -> 103.813% = DebtInstrumentRedemptionPricePercentage.\n- Logging & QA: always record percent span, redemption-cue span, instrument anchor span, chosen tag id, and any co-occurring interest/spread cues that were suppressed. When 'redeem-vs-rate-conflict' is flagged, increment a telemetry counter and add sentence to review queue.\n- Implementation note: insert this rule into the percentage-tag pipeline before percent-as-instrument-coupon (ctx-00006) and per-annum interest-rate heuristics (ctx-00011) so explicit redemption-language deterministically maps to DebtInstrumentRedemptionPricePercentage."}], "added_content": ["[ctx-00015] helpful=0 harmful=0 :: Atomic lexical-to-tag rule: Redemption/Call/Repurchase price percentages -> DebtInstrumentRedemptionPricePercentage", "- Purpose: deterministically map percent tokens that express a redemption/call/repurchase price (percent of par/principal) to DebtInstrumentRedemptionPricePercentage and link to the debt instrument anchor.", "- Exact lexical cues (case-insensitive regexes; match BEFORE generic percent heuristics):", "  - '\\bredeemable\\s+at\\b', '\\bredeemable\\s+at\\s+[0-9]+(?:\\.[0-9]+)?\\s*%\\b', '\\bcallable\\s+at\\b', '\\bcallable\\s+at\\s+[0-9]+(?:\\.[0-9]+)?\\s*%\\b', '\\bcall\\s+at\\b', '\\bmay\\s+be\\s+redeemed\\s+at\\b', '\\bprepaid\\s+at\\b', '\\bprepayment\\s+price\\s+of\\b', '\\bprice\\s+equal\\s+to\\s+[0-9]+(?:\\.[0-9]+)?\\s*%\\s+of\\s+par\\b', '\\bpercent\\s+of\\s+par\\b', '\\b%\\s+of\\s+par\\b', '\\bredemption\\s+price\\b', '\\bredeemed\\s+at\\b', '\\brepurchase\\s+at\\b'.", "- Parenthetical forms: detect patterns like \"(redeemable at 103.813%)\" within same clause and treat as strong redemption cue."], "removed_content": []}
{"timestamp": "2026-02-05T18:22:03.523348", "step": 26, "playbook_before_length": 96369, "playbook_after_length": 101491, "lines_before": 339, "lines_after": 365, "added_lines": 26, "removed_lines": 0, "operations_count": 1, "operations": [{"type": "ADD", "section": "context_clues_and_indicators", "content": "ctx-00016 Instrument-principal vs liability-balance precedence (atomic heuristic)\nPurpose: Prevent mis-tagging currency amounts that describe an entity's outstanding debt balance as instrument-level face amount. Ensure 'outstanding/remaining/balance' presentation cues win over naive 'notes/issued/aggregate principal' heuristics.\nExact lexical cues (case-insensitive regex examples) that indicate balance-sheet / liability presentation (map numeric -> LongTermDebt or appropriate liability tag): /\\b(outstanding|amounts?\\s+outstanding|remaining\\s+outstanding|remaining\\s+debt|remaining\\s+balance|balance\\s+sheet|reported\\s+as\\s+(long-?term|noncurrent)|classified\\s+as\\s+long-?term|noncurrent|current\\s+portion)\\b/i and /\\b(represent(ed|ing)\\s+the\\s+remaining|totaling\\s+.*\\s+outstanding|totaled\\s+.*\\s+outstanding)\\b/i.\nTransactional/issuance cues that tend to indicate instrument-face/principal (map numeric -> DebtInstrumentFaceAmount if no balance cues): /\\b(issued|we\\s+issued|obtained|we\\s+obtained|borrowed|entered\\s+into\\s+an?\\s+?loan|in an aggregate principal amount of|aggregate principal amount|principal amount of)\\b/i.\nAssociation windows and clause policy:\n- Primary association: if a balance-sheet cue appears in the same sentence and the numeric token is within the same clause or within ±12 tokens of the balance cue, treat numeric as a liability/balance (LongTermDebt or appropriate outstanding-balance tag).\n- Allow antecedent resolution: if anaphoric phrase ('the remaining debt', 'the outstanding balance') refers back to a previous sentence with a named instrument anchor, permit cross-sentence mapping when antecedent span <= 40 tokens and coreferent noun exists.\nDecision precedence (apply in order):\n1) If any balance/presentation cue (see lexicon above) matches in the same clause/sentence and links to the numeric -> assign the balance-sheet liability tag (e.g., LongTermDebt or instrument-specific outstanding-balance tag). This overrides any face-amount mapping.\n2) Else if numeric is directly anchored by transactional issuance verbs/phrases (e.g., 'obtained a $X loan', 'issued notes totaling $X') AND no balance/presentation cue is present in the same clause/sentence -> assign DebtInstrumentFaceAmount and link to instrument anchor.\n3) If both balance cue and issuance verb appear: inspect clause-level attachment (dependency parse if available):\n   - If numeric is syntactically the complement of a predicate that presents a balance (verbs like 'represented', 'was', 'totaled', 'reported') -> assign balance-sheet tag.\n   - If numeric is syntactically the direct object of a transactional issuance verb ('we issued X notes' where numeric is the object of 'issued') and the balance cue is only in a subordinate relative clause that modifies the instrument but does not predicate the entity-level balance, prefer balance-sheet tag if the modifying clause explicitly states 'outstanding'/'remaining'; otherwise if the main clause is a pure transactional issuance with no presentation phrasing, prefer DebtInstrumentFaceAmount but record a low-confidence flag.\nTie-breakers & ambiguity handling:\n- When ambiguous and clause-attachment cannot be resolved reliably, prefer the more general financial-statement classification (LongTermDebt / outstanding-balance) and queue the example for human review (do NOT auto-assign face-amount when 'outstanding' semantics are plausible).\nUnit-tests (atomic examples):\n- 'issued three notes totaling $546,440, which represented the remaining outstanding debt of CRA' -> $546,440 = LongTermDebt (balance precedence). (Regression target)\n- 'obtained a $2,254,500 loan to finance operations' -> $2,254,500 = DebtInstrumentFaceAmount (transactional issuance, no outstanding presentation). \n- 'The amount outstanding under the revolver totaled $50 million' -> $50M = outstanding-balance tag (do NOT map to capacity or face amount).\n- 'The aggregate principal amount of $600 million of Senior Notes was issued' (transaction narrative, no 'outstanding' presentation) -> $600M = DebtInstrumentFaceAmount.\n- 'The fair value of our Senior Notes approximated the carrying amount of $X, and the aggregate principal amount was $Y' -> $X = LongTermDebtFairValue (measurement-term precedence wins); $Y = DebtInstrumentFaceAmount (face mapping) and log 'face-vs-measurement' conflict.\nLogging & QA:\n- Record matched cue spans (balance vs issuance), syntactic attachment decision (predicate vs object), chosen tag id, and tie-break rationale in mapping_record.used_bullets and matched_lexical_cues.\n- When defaulting to balance-sheet tag in ambiguous cases, set mapping_record.confidence='low' and enqueue example into 'face-vs-balance-ambiguous' review queue.\nImplementation notes:\n- Insert this rule into the numeric-tagging pipeline immediately after measurement-term precedence (ctx-00002/ctx-000??) and BEFORE any unconditional 'aggregate principal amount -> DebtInstrumentFaceAmount' rules. This prevents misapplication illustrated in the Reflection while preserving correct face-amount mappings for pure transaction descriptions."}], "added_content": ["[ctx-00016] helpful=0 harmful=0 :: ctx-00016 Instrument-principal vs liability-balance precedence (atomic heuristic)", "Purpose: Prevent mis-tagging currency amounts that describe an entity's outstanding debt balance as instrument-level face amount. Ensure 'outstanding/remaining/balance' presentation cues win over naive 'notes/issued/aggregate principal' heuristics.", "Exact lexical cues (case-insensitive regex examples) that indicate balance-sheet / liability presentation (map numeric -> LongTermDebt or appropriate liability tag): /\\b(outstanding|amounts?\\s+outstanding|remaining\\s+outstanding|remaining\\s+debt|remaining\\s+balance|balance\\s+sheet|reported\\s+as\\s+(long-?term|noncurrent)|classified\\s+as\\s+long-?term|noncurrent|current\\s+portion)\\b/i and /\\b(represent(ed|ing)\\s+the\\s+remaining|totaling\\s+.*\\s+outstanding|totaled\\s+.*\\s+outstanding)\\b/i.", "Transactional/issuance cues that tend to indicate instrument-face/principal (map numeric -> DebtInstrumentFaceAmount if no balance cues): /\\b(issued|we\\s+issued|obtained|we\\s+obtained|borrowed|entered\\s+into\\s+an?\\s+?loan|in an aggregate principal amount of|aggregate principal amount|principal amount of)\\b/i.", "Association windows and clause policy:"], "removed_content": []}
{"timestamp": "2026-02-05T18:22:23.458877", "step": 26, "playbook_before_length": 110316, "playbook_after_length": 116043, "lines_before": 451, "lines_after": 491, "added_lines": 27, "removed_lines": 0, "operations_count": 1, "operations": [{"type": "ADD", "section": "context_clues_and_indicators", "content": "[ctx-00019] helpful=1 harmful=0 :: Instrument-vs-Account decision rule (atomic): Distinguish instrument-level face amounts from account-level outstanding/balance-sheet liabilities by detecting period-end and outstanding-language and applying deterministic precedence.\n\nPurpose: prevent mapping period-end/outstanding liability amounts to DebtInstrumentFaceAmount when the text frames the number as a balance-sheet carrying/outstanding amount (LongTermDebt / CurrentPortionOfLongTermDebt / ShortTermDebt etc.).\n\nExact lexical balance-sheet cues (case-insensitive regexes; require at least one to consider account-level mapping): /\\boutstanding\\b/, /\\bremaining\\s+outstanding\\b/, /\\bremaining\\s+debt\\b/, /\\bremaining\\s+outstanding\\s+debt\\b/, /\\bremaining\\s+debt\\b/, /\\bremaining\\b/, /\\bwas\\s+outstanding\\b/, /\\bat\\s+\\w+\\s+\\d{1,2},?\\s*\\d{4}\\b/, /\\bas\\s+of\\b/, /\\bat\\s+[A-Za-z0-9]+\\s+\\d{1,2},?\\s*\\d{4}\\b/, /\\bat\\s+March\\s+31,?\\s+\\d{4}\\b/, /\\bfor\\s+the\\s+period\\s+ended\\b/, /\\bclosing\\b/, /\\bbalance\\s+sheet\\b/, /\\bwas\\s+included\\s+as\\s+part\\s+of\\s+the\\s+sale\\b/.\n\nExact issuance/transaction cues (case-insensitive regexes): /\\bissued\\b/, /\\bobtained\\b/, /\\bwas\\s+issued\\b/, /\\bwe\\s+issued\\b/, /\\bwe\\s+obtained\\b/, /\\bissued\\s+three\\s+notes\\b/, /\\bissued\\s+[0-9,]+\\b/, /\\bwas\\s+issued\\s+in\\b/, /\\bunderwriters\\b/, /\\boffering\\b/.\n\nAssociation windows and antecedent resolution:\n- Primary window: same sentence. If a balance-sheet cue appears anywhere in the same sentence as the numeric token, prefer account-level tags.\n- Antecedent window: allow antecedent balance-sheet cues in the immediately preceding sentence (±1 sentence) when anaphors are used (e.g., 'the notes', 'such amounts'); antecedent span must be <= 40 tokens.\n- Token-distance tie: compute token_distance_balance = min distance from numeric to any balance-sheet cue; token_distance_issuance = min distance from numeric to any issuance cue within the same ±1 sentence window.\n\nDeterministic precedence (apply in order):\n1) If any balance-sheet cue matches within primary/antecedent windows -> map to account-level liability tags (prefer LongTermDebt when 'long-term', maturity > 12 months, or reporting-date anchor present; prefer CurrentPortionOfLongTermDebt / ShortTermDebt when 'current portion', 'due within 12 months', or date indicates within 12 months). Attach evidence fields (see Logging).\n2) Else if issuance/transaction cue(s) present and no balance-sheet cue present in the allowed windows -> map to instrument-level tags (DebtInstrumentFaceAmount or instrument-specific face amount).\n3) If BOTH cue types present in allowed windows, choose the mapping whose token_distance is smaller by at least 2 tokens. If distances are equal or difference < 2 tokens, prioritize balance-sheet mapping (conservative default) and log as 'instrument-vs-account-tie' for QA.\n\nShort-vs-long-term selection rules:\n- If account-level chosen and explicit 'current portion' or 'due within 12 months' or 'within the next year' or 'current' appears within ±12 tokens -> assign CurrentPortionOfLongTermDebt or ShortTermDebt as appropriate.\n- If account-level chosen and reporting-date anchor 'at [date]'/'as of [date]' present -> treat as point-in-time carrying amount and prefer LongTermDebt when textual maturities or 'long-term'/'not included as part of the sale at [date]' indicate non-current status.\n\nUnit validation: require numeric unit = CURRENCY to map to debt account tags. If numeric unit missing or ambiguous, DO NOT auto-assign; flag 'instrument-account-unit-missing'.\n\nExamples / unit-tests (atomic):\n- Positive account-level: 'issued three notes totaling $546,440, which represented the remaining outstanding debt of CRA that was not included as part of the sale of U.S. Operations at March 31, 2016' -> $546,440 = LongTermDebt (balance-sheet cue: 'remaining outstanding debt', 'at March 31, 2016'; issuance word 'issued' ignored because balance-sheet cues present and closer/stronger).\n- Issuance-level: 'the Company obtained a $2,254,500 loan' -> $2,254,500 = DebtInstrumentFaceAmount (issuance cue, no balance-sheet/time anchor).\n- Tie resolution: 'we issued notes totaling $X that were outstanding at March 31' -> $X = LongTermDebt (balance-sheet cue 'outstanding at March 31' wins despite 'issued').\n- Current portion: 'the current portion of long-term debt was $Y as of December 31' -> $Y = CurrentPortionOfLongTermDebt.\n\nLogging & trace fields (attach to every auto-assignment per err-00003 conventions):\n{ attached_bullet_id, mapping_rule_id: 'ctx-00019', numeric_span_tokens, matched_balance_cue_spans:[], matched_issuance_cue_spans:[], chosen_mapping: '<tag>', token_distance_balance, token_distance_issuance, antecedent_sentence_id|null, unit_detected, confidence_score (deterministic: 1.0 when rule matched unambiguously, 0.7 when antecedent used), provenance:{ module:'ctx-00019', pipeline_version, timestamp } }.\n\nAmbiguity handling & QA queueing:\n- If neither balance-sheet nor issuance cues appear within windows -> fall back to existing instrument heuristics but tag annotation with 'no-period-anchor' and queue example for human review.\n- If conflict unresolved by token-distance rule -> prefer account-level mapping but add the example to 'instrument-vs-account-conflict' review queue and increment a weekly QA counter.\n\nImplementation notes:\n- Run this rule before generic issuance->DebtInstrumentFaceAmount heuristics and before interest-rate mapping precedence steps to avoid overapplication of issuance heuristics.\n- Add the three unit-tests above to CI and assert Q1 maps to LongTermDebt.  Ensure the post-decision validator (ctx-00010 / err-00003) attaches this ctx-00019 bullet id and matched spans."}], "added_content": ["[ctx-00019] helpful=0 harmful=0 :: [ctx-00019] helpful=1 harmful=0 :: Instrument-vs-Account decision rule (atomic): Distinguish instrument-level face amounts from account-level outstanding/balance-sheet liabilities by detecting period-end and outstanding-language and applying deterministic precedence.", "Purpose: prevent mapping period-end/outstanding liability amounts to DebtInstrumentFaceAmount when the text frames the number as a balance-sheet carrying/outstanding amount (LongTermDebt / CurrentPortionOfLongTermDebt / ShortTermDebt etc.).", "Exact lexical balance-sheet cues (case-insensitive regexes; require at least one to consider account-level mapping): /\\boutstanding\\b/, /\\bremaining\\s+outstanding\\b/, /\\bremaining\\s+debt\\b/, /\\bremaining\\s+outstanding\\s+debt\\b/, /\\bremaining\\s+debt\\b/, /\\bremaining\\b/, /\\bwas\\s+outstanding\\b/, /\\bat\\s+\\w+\\s+\\d{1,2},?\\s*\\d{4}\\b/, /\\bas\\s+of\\b/, /\\bat\\s+[A-Za-z0-9]+\\s+\\d{1,2},?\\s*\\d{4}\\b/, /\\bat\\s+March\\s+31,?\\s+\\d{4}\\b/, /\\bfor\\s+the\\s+period\\s+ended\\b/, /\\bclosing\\b/, /\\bbalance\\s+sheet\\b/, /\\bwas\\s+included\\s+as\\s+part\\s+of\\s+the\\s+sale\\b/.", "Exact issuance/transaction cues (case-insensitive regexes): /\\bissued\\b/, /\\bobtained\\b/, /\\bwas\\s+issued\\b/, /\\bwe\\s+issued\\b/, /\\bwe\\s+obtained\\b/, /\\bissued\\s+three\\s+notes\\b/, /\\bissued\\s+[0-9,]+\\b/, /\\bwas\\s+issued\\s+in\\b/, /\\bunderwriters\\b/, /\\boffering\\b/.", "- Primary window: same sentence. If a balance-sheet cue appears anywhere in the same sentence as the numeric token, prefer account-level tags."], "removed_content": []}
{"timestamp": "2026-02-05T18:23:45.891733", "step": 27, "playbook_before_length": 101491, "playbook_after_length": 107791, "lines_before": 365, "lines_after": 392, "added_lines": 26, "removed_lines": 0, "operations_count": 1, "operations": [{"type": "ADD", "section": "context_clues_and_indicators", "content": "Instrument-instance anchoring & cross-field linking (atomic heuristic):\n- Purpose: create a persistent instrument instance when an instrument-anchor is present and deterministically link all proximate numeric tokens (face/principal amounts, stated interest percentages, redemption/price percentages, quoted spreads, instrument-specific interest-charge currency amounts) to that instrument so instrument-specific tags override generic fallbacks and provenance records include instrument anchors.\n- Instrument-anchor detection (case-insensitive regexes): /\\b(note|notes|promissory\\s+note|term\\s+loan|term\\s+loans|seller\\s+note|senior\\s+notes|revolver|loan|debenture|bond|obligation)s?\\b/ and variants including modifiers (\"convertible promissory note\", \"Seller Notes\"). Capture full anchor span and any qualifying modifiers (senior/subordinated/convertible/series).\n- Instrument-instance creation: when an instrument-anchor is detected in a sentence, create instrument_instance with fields: { instrument_anchor_span, instrument_type_label (normalized), instrument_qualifier_tokens, sentence_index }. Persist instance for antecedent resolution up to ±1 sentence (antecedent_span_limit=40 tokens).\n- Numeric association windows (apply to each numeric token):\n  1) Same-sentence strong link: if numeric lies within ±12 tokens of instrument_anchor_span -> link numeric to instrument_instance (confidence=high).\n  2) Prior-sentence antecedent link: if instrument_anchor appears only in previous sentence, allow linking when numeric is within ±40 tokens across the sentence boundary and anaphoric indicators exist ('the note','such note','the seller note') or the instrument qualifier is unique in doc scope (confidence=medium). Require antecedent anaphor or unique instrument name to avoid cross-instrument bleed.\n  3) Multi-instrument same-sentence disambiguation: if more than one instrument-anchor appears in same sentence, compute token-distance from numeric to each anchor; link to nearest anchor if distance difference >=3 tokens; if tie (<=3 tokens) do NOT auto-link and flag 'instrument-ambiguous' for review.\n- Tagging precedence when numeric is linked to an instrument_instance (apply atomically and override generic heuristics):\n  1) Currency numeric + 'in the amount of'/'aggregate principal amount' lexical cue within ±8 tokens -> DebtInstrumentFaceAmount (link to instrument_instance).\n  2) Percentage numeric + 'per annum'/'per year'/'annual' within ±3 tokens or percent syntactically modifying instrument noun -> DebtInstrumentInterestRateStatedPercentage (link to instrument_instance).\n  3) Percentage numeric adjacent to LIBOR/ABR + 'plus'/'over' -> DebtInstrumentBasisSpreadOnVariableRate1 (link to instrument_instance) unless explicit stated-rate phrase attaches to same numeric with stronger syntax.\n  4) Percentage numeric in redemption/call lexical context (redeemable at X%, callable at X%) -> DebtInstrumentRedemptionPricePercentage (link to instrument_instance).\n  5) Currency numeric appearing with 'interest charges'/'interest expense' and instrument_anchor present within association window -> InterestExpenseDebt (link to instrument_instance).\n- Provenance & mapping_record integration (enforce with Provenance-consistency guard):\n  - For each numeric-tag decision linked to an instrument_instance, set mapping_record.instrument_instance_id = <generated-id>, mapping_record.instrument_anchor_span, mapping_record.used_bullets must include the rule ids that matched (e.g., ctx-xxxx), and inference_method must indicate 'instrument-scoped-lexical-rule' when this rule contributed.\n  - If decision lists an instrument-linked bullet id, ensure used_bullets contains that bullet; if mismatch occurs, auto-correct and log 'provenance-inconsistency' event.\n- Conflict handling & QA:\n  - If instrument_instance linking produces contradictory tag candidates for the same numeric (e.g., percent appears both in 'per annum' and 'LIBOR plus' contexts within ±6 tokens), apply explicit conflict precedence: redemption > spread > stated-rate > generic percentage tags; log the conflict as 'instrument-rate-vs-spread-conflict' and queue for review if syntactic parse cannot disambiguate.\n  - If multiple numerics in same sentence are linked to same instrument_instance but map to incompatible tags (e.g., one numeric mapped to FaceAmount and another mapped inadvertently to LongTermDebtFairValue because of measurement-term confusion), retain both mappings but label them with mapping_record.instrument_instance_id and log 'face-vs-measurement' for QA.\n- Unit-tests (atomic examples to add):\n  1) 'a seller financing note in the amount of $625,000, bearing interest at 5% per annum and accruing at 6% per annum thereafter' -> $625,000 = DebtInstrumentFaceAmount (linked instrument: seller financing note); 5% = DebtInstrumentInterestRateStatedPercentage (same instrument); 6% = DebtInstrumentInterestRateStatedPercentage (same instrument, event-specific mapping). mapping_record.instrument_instance_id populated for each numeric.\n  2) 'a convertible promissory note in the amount of $83,750' -> $83,750 = DebtInstrumentFaceAmount (convertible promissory note anchor; linked and recorded).\n  3) 'Senior Notes (redeemable at 103.813%)' -> 103.813% = DebtInstrumentRedemptionPricePercentage with instrument_instance 'Senior Notes'.\n  4) Two instruments same sentence: 'we issued Senior Notes of $500M and Subordinated Notes of $200M' -> link $500M to Senior Notes and $200M to Subordinated Notes by nearest-anchor distance; if ambiguous, flag 'instrument-ambiguous'.\n- Logging: always record mapping_record.instrument_instance_id, instrument_anchor_span, matched_cue_spans, chosen_tag_id, and confidence score. Increment 'instrument-link-used' telemetry when this rule applied. Queue ambiguous/tie cases to human review and to retraining dataset.\n- Implementation notes: insert this rule early in numeric-tagging pipeline (immediately after instrument-anchor lexical detection stage, and before isolated nearest-lexical-match fallbacks). Ensure classifiers consult instrument_instance context as additional features. This single atomic addition prevents isolated mis-tagging in examples like the Reflection and enforces consistent instrument-level provenance."}], "added_content": ["[ctx-00017] helpful=0 harmful=0 :: Instrument-instance anchoring & cross-field linking (atomic heuristic):", "- Purpose: create a persistent instrument instance when an instrument-anchor is present and deterministically link all proximate numeric tokens (face/principal amounts, stated interest percentages, redemption/price percentages, quoted spreads, instrument-specific interest-charge currency amounts) to that instrument so instrument-specific tags override generic fallbacks and provenance records include instrument anchors.", "- Instrument-anchor detection (case-insensitive regexes): /\\b(note|notes|promissory\\s+note|term\\s+loan|term\\s+loans|seller\\s+note|senior\\s+notes|revolver|loan|debenture|bond|obligation)s?\\b/ and variants including modifiers (\"convertible promissory note\", \"Seller Notes\"). Capture full anchor span and any qualifying modifiers (senior/subordinated/convertible/series).", "- Instrument-instance creation: when an instrument-anchor is detected in a sentence, create instrument_instance with fields: { instrument_anchor_span, instrument_type_label (normalized), instrument_qualifier_tokens, sentence_index }. Persist instance for antecedent resolution up to ±1 sentence (antecedent_span_limit=40 tokens).", "- Numeric association windows (apply to each numeric token):"], "removed_content": []}
{"timestamp": "2026-02-05T18:25:09.800999", "step": 28, "playbook_before_length": 107791, "playbook_after_length": 111473, "lines_before": 392, "lines_after": 421, "added_lines": 21, "removed_lines": 0, "operations_count": 1, "operations": [{"type": "ADD", "section": "CONTEXT CLUES & INDICATORS", "content": "ctx-delta-repurchase-guard :: Atomic lexical-to-tag rule: Map explicit repurchase / buyback language to treasury-stock tags (shares counts, aggregate currency, and average per-share cost). Purpose: deterministically assign TreasuryStockSharesAcquired, TreasuryStockValueAcquiredCostMethod, and TreasuryStockAcquiredAverageCostPerShare when repurchase cues are present; enforce unit-checks (shares vs years vs currency) and precedence over generic 'shares' or 'per share' fallbacks.\n\nExact lexical cues (case-insensitive regexes): /\\b(repurchas(?:e|ed)|bought\\s+back|brought\\s+back|repurchase\\s+program|share\\s+repurchases|repurchases)\\b/, /\\b(treasury\\s+stock|treasury\\s+shares)\\b/, /\\b(acquired\\s+for\\s+treasury|acquired\\s+treasury\\s+stock)\\b/.\n\nAssociation & unit policy:\n- Primary numeric association window: ±8 tokens around numeric token in same sentence.\n- Unit check: require the numeric token to be explicitly expressed in 'shares' unit (regex: /\\bshares?\\b|\\bunits?\\b|\\bRSU?s?\\b/) to map to TreasuryStockSharesAcquired; require currency unit ($/dollars) to map to TreasuryStockValueAcquiredCostMethod; require a per-share currency plus 'average' qualifier (/(?:average|avg)\\b|\\baverage\\s+price\\b/) within ±4 tokens to map to TreasuryStockAcquiredAverageCostPerShare.\n\nMapping precedence (apply atomically):\n1) If repurchase/treasury cue matches within primary window AND numeric unit == 'shares' -> assign TreasuryStockSharesAcquired and link numeric to repurchase event (used_bullets includes this ctx-delta-repurchase-guard).\n2) Else if repurchase/treasury cue matches AND numeric unit == currency -> assign TreasuryStockValueAcquiredCostMethod.\n3) Additionally, if a per-share currency numeric appears with an 'average' qualifier near a repurchase cue -> assign TreasuryStockAcquiredAverageCostPerShare (link shares count if present in sentence).\n4) If both repurchase and issuance cues co-occur within tie-window (token-distance difference <= 3 tokens) -> do NOT auto-assign; flag 'transaction-direction-conflict' and queue for human review.\n5) This repurchase guard overrides generic share/issuance/sale fallbacks (e.g., SaleOfStockPricePerShare, StockIssuedDuringPeriodSharesNewIssues) when repurchase cues matched with confidence.\n\nToken-window & antecedent resolution:\n- Allow antecedent repurchase anchor in previous sentence when anaphors ('the repurchase program', 'the program') are used and antecedent span <= 40 tokens; require numeric still within ±16 tokens of anaphor.\n\nUnit-tests (atomic examples):\n- '703,000 shares were repurchased under the repurchase program.' -> 703,000 = TreasuryStockSharesAcquired.\n- 'Repurchased 70,783 shares at an average price of $15.09.' -> 70,783 = TreasuryStockSharesAcquired; $15.09 = TreasuryStockAcquiredAverageCostPerShare.\n- 'The Company repurchased shares for an aggregate of $1.1 million.' -> $1.1M = TreasuryStockValueAcquiredCostMethod.\n- 'We sold 70,783 shares at an average price of $15.09' -> no repurchase mapping (ensures issuance/sale heuristics still apply).\n\nLogging & provenance:\n- Record matched cue span(s), numeric span, unit type ('shares'/'currency'/'per-share'), chosen tag id, and mapping_record.used_bullets must include ctx-delta-repurchase-guard when applied. If antecedent resolution used, record antecedent span. If conflict flagged, emit 'transaction-direction-conflict' telemetry.\n\nImplementation note:\n- Insert this guard early in numeric-tagging pipeline (before generic 'shares' fallbacks and after instrument-instance anchoring). Ensure it participates in provenance-consistency (err-00012) so any explanation lists this bullet id when it contributed."}], "added_content": ["[ctx-00018] helpful=0 harmful=0 :: ctx-delta-repurchase-guard :: Atomic lexical-to-tag rule: Map explicit repurchase / buyback language to treasury-stock tags (shares counts, aggregate currency, and average per-share cost). Purpose: deterministically assign TreasuryStockSharesAcquired, TreasuryStockValueAcquiredCostMethod, and TreasuryStockAcquiredAverageCostPerShare when repurchase cues are present; enforce unit-checks (shares vs years vs currency) and precedence over generic 'shares' or 'per share' fallbacks.", "Exact lexical cues (case-insensitive regexes): /\\b(repurchas(?:e|ed)|bought\\s+back|brought\\s+back|repurchase\\s+program|share\\s+repurchases|repurchases)\\b/, /\\b(treasury\\s+stock|treasury\\s+shares)\\b/, /\\b(acquired\\s+for\\s+treasury|acquired\\s+treasury\\s+stock)\\b/.", "Association & unit policy:", "- Primary numeric association window: ±8 tokens around numeric token in same sentence.", "- Unit check: require the numeric token to be explicitly expressed in 'shares' unit (regex: /\\bshares?\\b|\\bunits?\\b|\\bRSU?s?\\b/) to map to TreasuryStockSharesAcquired; require currency unit ($/dollars) to map to TreasuryStockValueAcquiredCostMethod; require a per-share currency plus 'average' qualifier (/(?:average|avg)\\b|\\baverage\\s+price\\b/) within ±4 tokens to map to TreasuryStockAcquiredAverageCostPerShare."], "removed_content": []}
{"timestamp": "2026-02-06T11:00:31.976849", "step": 29, "playbook_before_length": 38622, "playbook_after_length": 43248, "lines_before": 138, "lines_after": 139, "added_lines": 1, "removed_lines": 0, "operations_count": 1, "operations": [{"type": "ADD", "section": "context_clues_and_indicators", "content": "Atomic rule: Parenthetical-numbered footnote component resolution (map component amounts to the aggregate/line-item the footnote enumerates). Steps (apply in order for any numeric token appearing inside a parenthetical-numbered clause like \"(3) Includes\", \"(2) Consists of\", leading \"(3)\" or a parenthetical index): 1) Detect footnote-component syntax: regex cues (case-insensitive) for leading parenthetical index + include/consist language within same clause: /^\\(\\d+\\)\\s*(Includes|Consists|Compris(es)?|Consisting\\s+of|Includes\\s+the)\\b/ or tokens pattern [\"(\\d+)\", \"Includes\", \"Consists\", \"Includes the\"]. If matched and numeric tokens present in the clause, mark numeric tokens as candidate footnote-components. 2) Antecedent anchor search (ordered scope): a) Same footnote/clause: scan earlier tokens in same footnote sentence for explicit aggregate label nouns/phrases (within the same sentence or clause) — target lexical anchors: /gain(s)?\\s+on\\s+extinguishment|loss(es)?\\s+on\\s+extinguishment|extinguishment\\s+of\\s+debt|restructur(ing|e)\\s+charge(s)?|acquisition\\s+cost(s)?|settlement\\s+charge(s)?|other\\s+loss(es|es)?/i. If found, assign the component numeric to the same aggregate tag (exact tag mapping table below). b) Previous text window: if no anchor in same sentence, search up to 2 previous sentences and the nearest note heading/title within ±3 sentences for the same anchor phrases or for explicit line-item labels (note titles like 'Debt', 'Gain (Loss) on Extinguishment of Debt', 'Restructuring') and map component amounts to that anchor tag. c) Section-level fallback: if still no explicit anchor but the surrounding note header matches a known note type (e.g., 'Debt', 'Commitments and Contingencies', 'Restructuring and Other Charges'), prefer the plausible transaction tags associated with that note (e.g., 'Debt' -> GainsLossesOnExtinguishmentOfDebt; 'Restructuring' -> RestructuringCharges). 3) Negative-evidence de-prioritization: if candidate tag would be AssetImpairmentCharges but the clause and the preceding 2 sentences do NOT contain impairment keywords (regex: /impair|impairment|write-?down|recoverable|fair\\s+value\\s+less\\s+costs/i), deprioritize and do NOT assign AssetImpairmentCharges solely because of large amount; instead prefer aggregate-anchor tag found via steps 2a-2c or queue for review. 4) Shortlist & tag mapping precedence when anchor ambiguous: construct shortlist of plausible component tags in this order of preference when multiple plausible anchors exist or when anchor is only a generic 'other'/'charges': (high) GainsLossesOnExtinguishmentOfDebt, RestructuringCharges, AcquisitionRelatedCosts, TransactionRelatedGainsLosses (domain-specific candidate tags) -> (low) AssetImpairmentCharges. Only pick AssetImpairmentCharges if explicit impairment lexical cues exist. 5) Multi-amount handling: if clause enumerates multiple numeric tokens separated by 'and' or commas under the same parenthetical index, map all enumerated amounts to the same resolved aggregate tag (do not split across different tags unless explicit sub-labels present in the clause). 6) Ambiguity/triage: if no anchor found in steps 2-4 and no strong negative cues to rule out impairment, do NOT auto-assign AssetImpairmentCharges by magnitude. Instead label the numeric(s) as 'footnote-component-ambiguous' and queue for human review / classifier-resolution. 7) Logging and provenance: when mapping via this rule, record: parenthetical index span, clause span, chosen antecedent anchor span (sentence or heading), resolved tag, and the negative-evidence span if impairment was de-prioritized. 8) Minimal unit-tests (atomic examples to add): - \"(3) Includes $18.5 million, and $135.2 million.\" where prior sentence in note states \"Gains (Losses) on Extinguishment of Debt — total $XX (see (3))\" -> both amounts -> GainsLossesOnExtinguishmentOfDebt. - \"(2) Includes $5.0 million of lease termination costs and $2.0 million of severance\" with note header 'Restructuring and Other Charges' -> both amounts -> RestructuringCharges. - \"(1) Includes of $50.0 and $10.0\" with no impairment keywords and prior heading 'Debt' or 'Note 7 — Debt' -> map to GainsLossesOnExtinguishmentOfDebt (do not map to AssetImpairmentCharges). - Clause with explicit 'impair' nearby -> map to AssetImpairmentCharges. Implementation note: run this rule before magnitude-based fallbacks and before generic lexical-to-tag mapping; add examples where parenthetical indices reference an earlier aggregate via 'see (n)' to training/regression suites to ensure antecedent resolution is learned."}], "added_content": ["[ctx-00001] helpful=0 harmful=0 :: Atomic rule: Parenthetical-numbered footnote component resolution (map component amounts to the aggregate/line-item the footnote enumerates). Steps (apply in order for any numeric token appearing inside a parenthetical-numbered clause like \"(3) Includes\", \"(2) Consists of\", leading \"(3)\" or a parenthetical index): 1) Detect footnote-component syntax: regex cues (case-insensitive) for leading parenthetical index + include/consist language within same clause: /^\\(\\d+\\)\\s*(Includes|Consists|Compris(es)?|Consisting\\s+of|Includes\\s+the)\\b/ or tokens pattern [\"(\\d+)\", \"Includes\", \"Consists\", \"Includes the\"]. If matched and numeric tokens present in the clause, mark numeric tokens as candidate footnote-components. 2) Antecedent anchor search (ordered scope): a) Same footnote/clause: scan earlier tokens in same footnote sentence for explicit aggregate label nouns/phrases (within the same sentence or clause) — target lexical anchors: /gain(s)?\\s+on\\s+extinguishment|loss(es)?\\s+on\\s+extinguishment|extinguishment\\s+of\\s+debt|restructur(ing|e)\\s+charge(s)?|acquisition\\s+cost(s)?|settlement\\s+charge(s)?|other\\s+loss(es|es)?/i. If found, assign the component numeric to the same aggregate tag (exact tag mapping table below). b) Previous text window: if no anchor in same sentence, search up to 2 previous sentences and the nearest note heading/title within ±3 sentences for the same anchor phrases or for explicit line-item labels (note titles like 'Debt', 'Gain (Loss) on Extinguishment of Debt', 'Restructuring') and map component amounts to that anchor tag. c) Section-level fallback: if still no explicit anchor but the surrounding note header matches a known note type (e.g., 'Debt', 'Commitments and Contingencies', 'Restructuring and Other Charges'), prefer the plausible transaction tags associated with that note (e.g., 'Debt' -> GainsLossesOnExtinguishmentOfDebt; 'Restructuring' -> RestructuringCharges). 3) Negative-evidence de-prioritization: if candidate tag would be AssetImpairmentCharges but the clause and the preceding 2 sentences do NOT contain impairment keywords (regex: /impair|impairment|write-?down|recoverable|fair\\s+value\\s+less\\s+costs/i), deprioritize and do NOT assign AssetImpairmentCharges solely because of large amount; instead prefer aggregate-anchor tag found via steps 2a-2c or queue for review. 4) Shortlist & tag mapping precedence when anchor ambiguous: construct shortlist of plausible component tags in this order of preference when multiple plausible anchors exist or when anchor is only a generic 'other'/'charges': (high) GainsLossesOnExtinguishmentOfDebt, RestructuringCharges, AcquisitionRelatedCosts, TransactionRelatedGainsLosses (domain-specific candidate tags) -> (low) AssetImpairmentCharges. Only pick AssetImpairmentCharges if explicit impairment lexical cues exist. 5) Multi-amount handling: if clause enumerates multiple numeric tokens separated by 'and' or commas under the same parenthetical index, map all enumerated amounts to the same resolved aggregate tag (do not split across different tags unless explicit sub-labels present in the clause). 6) Ambiguity/triage: if no anchor found in steps 2-4 and no strong negative cues to rule out impairment, do NOT auto-assign AssetImpairmentCharges by magnitude. Instead label the numeric(s) as 'footnote-component-ambiguous' and queue for human review / classifier-resolution. 7) Logging and provenance: when mapping via this rule, record: parenthetical index span, clause span, chosen antecedent anchor span (sentence or heading), resolved tag, and the negative-evidence span if impairment was de-prioritized. 8) Minimal unit-tests (atomic examples to add): - \"(3) Includes $18.5 million, and $135.2 million.\" where prior sentence in note states \"Gains (Losses) on Extinguishment of Debt — total $XX (see (3))\" -> both amounts -> GainsLossesOnExtinguishmentOfDebt. - \"(2) Includes $5.0 million of lease termination costs and $2.0 million of severance\" with note header 'Restructuring and Other Charges' -> both amounts -> RestructuringCharges. - \"(1) Includes of $50.0 and $10.0\" with no impairment keywords and prior heading 'Debt' or 'Note 7 — Debt' -> map to GainsLossesOnExtinguishmentOfDebt (do not map to AssetImpairmentCharges). - Clause with explicit 'impair' nearby -> map to AssetImpairmentCharges. Implementation note: run this rule before magnitude-based fallbacks and before generic lexical-to-tag mapping; add examples where parenthetical indices reference an earlier aggregate via 'see (n)' to training/regression suites to ensure antecedent resolution is learned."], "removed_content": []}
{"timestamp": "2026-02-06T11:02:16.859962", "step": 30, "playbook_before_length": 43248, "playbook_after_length": 47421, "lines_before": 139, "lines_after": 140, "added_lines": 1, "removed_lines": 0, "operations_count": 1, "operations": [{"type": "ADD", "section": "context_clues_and_indicators", "content": "Atomic heuristic: Prefer Allocated/Expense taxonomy tags for share-based compensation amounts when sentence context indicates an income-statement expense. Steps (apply in order for each currency numeric candidate near \"share-based\" lexical matches): 1) Income-statement expense detection (must be true to trigger this rule): detect any of these lexical cues in same sentence or ±1 sentence: /total compensation cost|compensation cost|compensation expense|share-?based compensation expense|cost for share-?based payment arrangements|expense recognized|included in operating expenses|on the income statement|for the year ended|for the period ended/ (case-insensitive). 2) Candidate-tag shortlist: when a lexical mapping produces multiple candidate tags for the phrase \"share-based compensation\" (e.g., ShareBasedCompensation, AllocatedShareBasedCompensationExpense, EmployeeServiceShareBasedCompensationTaxBenefitFromCompensationExpense), retrieve each candidate tag's preferred label and definition from the taxonomy. 3) Taxonomy-label/definition signals: compute taxonomy-specific scores using atomic features: +10 if preferred-label or definition contains keywords: '\\bexpense\\b', '\\ballocated\\b', '\\ballocated expense\\b', '\\ballocated compensation\\b'; +6 if contains '\\bcompensation\\b' and '\\bshare\\b' or 'share-based'; +4 if contains 'employee service' (indicates benefit/tax side). 4) Context-match score: compute context score: +8 if income-statement expense detection matched (step 1), +5 if the numeric token is immediately adjacent (±8 tokens) to an explicit expense cue (e.g., 'expense', 'cost', 'total compensation cost'), +3 if sentence contains reporting-period anchors ('for the year ended', 'for the quarter ended'). 5) Decision rule (tie-breaker): final_score = taxonomy_score + context_score. Prefer the candidate with highest final_score. If top candidate has an 'Expense'/'Allocated' taxonomy signal, it must win when income-statement expense detection was true. 6) Negative prevention rule (atomic): do NOT auto-assign generic ShareBasedCompensation when income-statement expense cues are present and a taxonomy candidate with 'Expense' or 'Allocated' exists. 7) Tax-benefit mapping exception: if numeric amount co-occurs with explicit tax cues ('tax benefit', 'tax effect', 'tax benefit related to share-based compensation', 'tax benefit of $X'), map to EmployeeServiceShareBasedCompensationTaxBenefitFromCompensationExpense (explicit tax mapping overrides expense-tag rule for tax amounts). 8) Association windows: apply lexical/income-statement cue detection within the same sentence or ±1 sentence; require numeric-token distance <= 8 tokens to primary expense cue for strongest match. 9) Logging and QA: record chosen tag, competing candidate tags with taxonomy_label/definition snippets, matched expense lexical cue span, and numeric token span. If generic tag would have been selected absent this rule, mark case as 'allocated-expense-overrode-generic' for retraining. 10) Minimal unit-tests (atomic examples to add): - 'Total compensation cost for share-based payment arrangements was $10,730, $13,488 and $19,289' -> $13,488 and $19,289 => AllocatedShareBasedCompensationExpense; $10,730 if described similarly should also map to AllocatedShareBasedCompensationExpense. - 'The tax benefit related to share-based compensation was $2,678 and $5,058' -> both tax amounts => EmployeeServiceShareBasedCompensationTaxBenefitFromCompensationExpense. - 'We recognized $3,200 of share-based compensation as expense in cost of goods sold' -> $3,200 => AllocatedShareBasedCompensationExpense (expense-location cue 'cost of goods sold' present). - 'Share-based compensation outstanding under the Plan: 1,000,000 shares available' -> numeric => plan-availability tag (do not map to AllocatedShareBasedCompensationExpense because income-statement expense cues absent). Implementation note: run this rule immediately after lexical-to-tag candidate generation and before generic fallback-to-first-lexical-match; surface all logged 'allocated-expense-overrode-generic' cases to QA for verification and add to regression suite."}], "added_content": ["[ctx-00002] helpful=0 harmful=0 :: Atomic heuristic: Prefer Allocated/Expense taxonomy tags for share-based compensation amounts when sentence context indicates an income-statement expense. Steps (apply in order for each currency numeric candidate near \"share-based\" lexical matches): 1) Income-statement expense detection (must be true to trigger this rule): detect any of these lexical cues in same sentence or ±1 sentence: /total compensation cost|compensation cost|compensation expense|share-?based compensation expense|cost for share-?based payment arrangements|expense recognized|included in operating expenses|on the income statement|for the year ended|for the period ended/ (case-insensitive). 2) Candidate-tag shortlist: when a lexical mapping produces multiple candidate tags for the phrase \"share-based compensation\" (e.g., ShareBasedCompensation, AllocatedShareBasedCompensationExpense, EmployeeServiceShareBasedCompensationTaxBenefitFromCompensationExpense), retrieve each candidate tag's preferred label and definition from the taxonomy. 3) Taxonomy-label/definition signals: compute taxonomy-specific scores using atomic features: +10 if preferred-label or definition contains keywords: '\\bexpense\\b', '\\ballocated\\b', '\\ballocated expense\\b', '\\ballocated compensation\\b'; +6 if contains '\\bcompensation\\b' and '\\bshare\\b' or 'share-based'; +4 if contains 'employee service' (indicates benefit/tax side). 4) Context-match score: compute context score: +8 if income-statement expense detection matched (step 1), +5 if the numeric token is immediately adjacent (±8 tokens) to an explicit expense cue (e.g., 'expense', 'cost', 'total compensation cost'), +3 if sentence contains reporting-period anchors ('for the year ended', 'for the quarter ended'). 5) Decision rule (tie-breaker): final_score = taxonomy_score + context_score. Prefer the candidate with highest final_score. If top candidate has an 'Expense'/'Allocated' taxonomy signal, it must win when income-statement expense detection was true. 6) Negative prevention rule (atomic): do NOT auto-assign generic ShareBasedCompensation when income-statement expense cues are present and a taxonomy candidate with 'Expense' or 'Allocated' exists. 7) Tax-benefit mapping exception: if numeric amount co-occurs with explicit tax cues ('tax benefit', 'tax effect', 'tax benefit related to share-based compensation', 'tax benefit of $X'), map to EmployeeServiceShareBasedCompensationTaxBenefitFromCompensationExpense (explicit tax mapping overrides expense-tag rule for tax amounts). 8) Association windows: apply lexical/income-statement cue detection within the same sentence or ±1 sentence; require numeric-token distance <= 8 tokens to primary expense cue for strongest match. 9) Logging and QA: record chosen tag, competing candidate tags with taxonomy_label/definition snippets, matched expense lexical cue span, and numeric token span. If generic tag would have been selected absent this rule, mark case as 'allocated-expense-overrode-generic' for retraining. 10) Minimal unit-tests (atomic examples to add): - 'Total compensation cost for share-based payment arrangements was $10,730, $13,488 and $19,289' -> $13,488 and $19,289 => AllocatedShareBasedCompensationExpense; $10,730 if described similarly should also map to AllocatedShareBasedCompensationExpense. - 'The tax benefit related to share-based compensation was $2,678 and $5,058' -> both tax amounts => EmployeeServiceShareBasedCompensationTaxBenefitFromCompensationExpense. - 'We recognized $3,200 of share-based compensation as expense in cost of goods sold' -> $3,200 => AllocatedShareBasedCompensationExpense (expense-location cue 'cost of goods sold' present). - 'Share-based compensation outstanding under the Plan: 1,000,000 shares available' -> numeric => plan-availability tag (do not map to AllocatedShareBasedCompensationExpense because income-statement expense cues absent). Implementation note: run this rule immediately after lexical-to-tag candidate generation and before generic fallback-to-first-lexical-match; surface all logged 'allocated-expense-overrode-generic' cases to QA for verification and add to regression suite."], "removed_content": []}
{"timestamp": "2026-02-06T11:03:49.460325", "step": 31, "playbook_before_length": 47421, "playbook_after_length": 51468, "lines_before": 140, "lines_after": 141, "added_lines": 1, "removed_lines": 0, "operations_count": 1, "operations": [{"type": "ADD", "section": "context_clues_and_indicators", "content": "Atomic heuristic: Tax-line polarity detection and preference for IncomeTaxExpenseBenefit (expense vs benefit). Purpose: avoid literal-phrase-only mapping for 'income tax' line-items; determine polarity (expense vs benefit) using explicit lexical cues, numeric notation, and economic context and prefer IncomeTaxExpenseBenefit when benefit cues present. Rules (apply in order): 1) Candidate scope: apply when a numeric currency/amount token is in the same clause/sentence as any tax lexical anchor: /income\\s+tax\\b/, /income\\s+tax\\s+expense\\b/, /income\\s+tax\\s+provision\\b/, /provision\\s+for\\s+income\\s+taxes\\b/, /current\\s+tax\\b/, /deferred\\s+tax\\b/. 2) Explicit-benefit lexical cue (highest-confidence): if the same sentence (±0 tokens) contains words/phrases: /benefit(s)?\\b/, /tax\\s+benefit\\b/, /income\\s+tax\\s+benefit\\b/, /credit(s)?\\s+for\\s+income\\s+taxes\\b/, or parenthetical heading variants like /income\\s+tax\\s+benefit\\s*\\(expense\\)|income\\s+tax\\s*\\(benefit\\)/i -> assign IncomeTaxExpenseBenefit (override IncomeTaxExpense). 3) Numeric-sign / notation heuristic (high-confidence): if the numeric token is explicitly negative (leading '-' sign) OR enclosed in parentheses (e.g., '(' and ')') when usual format uses parentheses for negatives, treat as negative -> assign IncomeTaxExpenseBenefit (log that the numeric sign indicated a benefit). 4) Economic-context heuristic (moderate-confidence): if the same sentence or immediately adjacent sentence (±1 sentence) contains pre-tax-loss indicators: /pre-?tax\\s+loss(es)?\\b/, /loss\\s+before\\s+income\\s+tax(es)?\\b/, /net\\s+loss\\b/, /loss\\s+for\\s+the\\s+year\\b/, /income\\s*\\(loss\\)\\s+before\\s+income\\s+tax(es)?\\b/, then prefer IncomeTaxExpenseBenefit over IncomeTaxExpense for tax-line numeric(s) linked to the tax lexical anchors. 5) Parenthetical/label disambiguation (high-confidence): if heading or nearby label contains the pattern 'Income tax (benefit) (expense)' or 'Income tax benefit (expense)' or 'Income tax (expense) (benefit)' choose the more specific tag that matches the explicit parenthetical ordering if 'benefit' is present; otherwise use label ordering + numeric sign to decide. 6) Precedence and tie-breaker: precedence of cues = explicit-benefit-lexical > numeric-sign/parentheses > parenthetical/heading cue > economic-context. If multiple cues conflict (e.g., positive numeric but explicit 'benefit' word), prefer explicit lexical cue but log conflict and mark for review if numeric polarity contradicts lexical cue. 7) Ambiguity handling: if no benefit cues present and neither numeric sign nor pre-tax-loss context present, fall back to existing lexical mapping (IncomeTaxExpense) but add an 'uncertain-tax-polarity' flag and queue example for review/training. 8) Logging & traceability: record selected tag, matched cue type(s) and spans (lexical-benefit span, numeric-sign span, pre-tax-loss phrase span), and confidence score. Any case where economic-context changed a literal lexical match must be logged as 'context-overrode-lexical-tax' for QA. 9) Unit-tests (atomic examples to add): - \"Income tax expense (benefit) of $34.4 and $53.1\" -> both amounts = IncomeTaxExpenseBenefit (parenthetical label includes 'benefit'). - \"We recorded a pre-tax loss of $100 and an income tax expense of $10\" (where 'income tax' appears but context implies benefit) -> $10 = IncomeTaxExpenseBenefit (pre-tax-loss context triggers benefit). - \"Income tax expense was $(5.0) for the year\" -> $(5.0) = IncomeTaxExpenseBenefit (parentheses -> negative). - \"The tax benefit related to continuing operations was $2.5\" -> $2.5 = IncomeTaxExpenseBenefit (explicit 'benefit'). - \"Income tax expense of $7.0 on income before taxes of $20.0\" -> $7.0 = IncomeTaxExpense (no benefit cues). 10) Implementation note: run this heuristic immediately after tax-lexical anchor detection and before any strict lexical-to-tag assignment; surface logged conflicts to the human-review queue and add them to retraining dataset to reduce reliance on exact-token-match."}], "added_content": ["[ctx-00003] helpful=0 harmful=0 :: Atomic heuristic: Tax-line polarity detection and preference for IncomeTaxExpenseBenefit (expense vs benefit). Purpose: avoid literal-phrase-only mapping for 'income tax' line-items; determine polarity (expense vs benefit) using explicit lexical cues, numeric notation, and economic context and prefer IncomeTaxExpenseBenefit when benefit cues present. Rules (apply in order): 1) Candidate scope: apply when a numeric currency/amount token is in the same clause/sentence as any tax lexical anchor: /income\\s+tax\\b/, /income\\s+tax\\s+expense\\b/, /income\\s+tax\\s+provision\\b/, /provision\\s+for\\s+income\\s+taxes\\b/, /current\\s+tax\\b/, /deferred\\s+tax\\b/. 2) Explicit-benefit lexical cue (highest-confidence): if the same sentence (±0 tokens) contains words/phrases: /benefit(s)?\\b/, /tax\\s+benefit\\b/, /income\\s+tax\\s+benefit\\b/, /credit(s)?\\s+for\\s+income\\s+taxes\\b/, or parenthetical heading variants like /income\\s+tax\\s+benefit\\s*\\(expense\\)|income\\s+tax\\s*\\(benefit\\)/i -> assign IncomeTaxExpenseBenefit (override IncomeTaxExpense). 3) Numeric-sign / notation heuristic (high-confidence): if the numeric token is explicitly negative (leading '-' sign) OR enclosed in parentheses (e.g., '(' and ')') when usual format uses parentheses for negatives, treat as negative -> assign IncomeTaxExpenseBenefit (log that the numeric sign indicated a benefit). 4) Economic-context heuristic (moderate-confidence): if the same sentence or immediately adjacent sentence (±1 sentence) contains pre-tax-loss indicators: /pre-?tax\\s+loss(es)?\\b/, /loss\\s+before\\s+income\\s+tax(es)?\\b/, /net\\s+loss\\b/, /loss\\s+for\\s+the\\s+year\\b/, /income\\s*\\(loss\\)\\s+before\\s+income\\s+tax(es)?\\b/, then prefer IncomeTaxExpenseBenefit over IncomeTaxExpense for tax-line numeric(s) linked to the tax lexical anchors. 5) Parenthetical/label disambiguation (high-confidence): if heading or nearby label contains the pattern 'Income tax (benefit) (expense)' or 'Income tax benefit (expense)' or 'Income tax (expense) (benefit)' choose the more specific tag that matches the explicit parenthetical ordering if 'benefit' is present; otherwise use label ordering + numeric sign to decide. 6) Precedence and tie-breaker: precedence of cues = explicit-benefit-lexical > numeric-sign/parentheses > parenthetical/heading cue > economic-context. If multiple cues conflict (e.g., positive numeric but explicit 'benefit' word), prefer explicit lexical cue but log conflict and mark for review if numeric polarity contradicts lexical cue. 7) Ambiguity handling: if no benefit cues present and neither numeric sign nor pre-tax-loss context present, fall back to existing lexical mapping (IncomeTaxExpense) but add an 'uncertain-tax-polarity' flag and queue example for review/training. 8) Logging & traceability: record selected tag, matched cue type(s) and spans (lexical-benefit span, numeric-sign span, pre-tax-loss phrase span), and confidence score. Any case where economic-context changed a literal lexical match must be logged as 'context-overrode-lexical-tax' for QA. 9) Unit-tests (atomic examples to add): - \"Income tax expense (benefit) of $34.4 and $53.1\" -> both amounts = IncomeTaxExpenseBenefit (parenthetical label includes 'benefit'). - \"We recorded a pre-tax loss of $100 and an income tax expense of $10\" (where 'income tax' appears but context implies benefit) -> $10 = IncomeTaxExpenseBenefit (pre-tax-loss context triggers benefit). - \"Income tax expense was $(5.0) for the year\" -> $(5.0) = IncomeTaxExpenseBenefit (parentheses -> negative). - \"The tax benefit related to continuing operations was $2.5\" -> $2.5 = IncomeTaxExpenseBenefit (explicit 'benefit'). - \"Income tax expense of $7.0 on income before taxes of $20.0\" -> $7.0 = IncomeTaxExpense (no benefit cues). 10) Implementation note: run this heuristic immediately after tax-lexical anchor detection and before any strict lexical-to-tag assignment; surface logged conflicts to the human-review queue and add them to retraining dataset to reduce reliance on exact-token-match."], "removed_content": []}
{"timestamp": "2026-02-06T11:05:05.664405", "step": 32, "playbook_before_length": 51468, "playbook_after_length": 57029, "lines_before": 141, "lines_after": 163, "added_lines": 21, "removed_lines": 0, "operations_count": 1, "operations": [{"type": "ADD", "section": "context_clues_and_indicators", "content": "Atomic heuristic: Regulatory rate-requests mapping -> PublicUtilitiesRequestedRateIncreaseDecreaseAmount\n- Purpose: deterministically map currency numeric tokens that express a utility's requested (filed/submitted/asked-for) rate increase or decrease to PublicUtilitiesRequestedRateIncreaseDecreaseAmount and avoid false mapping to Revenues/Expense/generic financial tags.\n- Exact filing/request lexical cues (case-insensitive regex examples): /\\bfiled\\b/, /\\bfiled an application\\b/, /\\bsubmitted a request\\b/, /\\brequested\\b/, /\\bseeks to increase\\b/, /\\bseeking approval to increase\\b/, /\\bpetition(ed)?\\b/, /\\bproposed\\b/, /\\bseeks to decrease\\b/, /\\bsubmitted a petition\\b/, /\\bstipulation .* for a net increase\\b/, /(for|requesting|seeking).*rate (increase|decrease) of/i. If any of these cues co-occur with a rate/increase/decrease lexical anchor, treat as regulatory-request.\n- Rate-change lexical anchors: /rate(s)? (increase|decrease)|increase[s]? rates?|decrease[s]? rates?|net increase|net decrease|rate adjustment|proposed rate change|requested rate change/.\n- Association window & antecedent resolution: require numeric token in the same sentence and within ±12 tokens of a filing/request cue OR within the same clause. Allow antecedent anchors up to ±1 sentence when the numeric is introduced as 'the net increase of $X' or via a parenthetical referring to the filing (e.g., 'in the filing, for a net increase of $1.2 million').\n- Decision rule (apply in order):\n  1) If a filing/request cue AND a rate-change anchor are detected as above -> assign PublicUtilitiesRequestedRateIncreaseDecreaseAmount to the nearest currency numeric token (regardless of 'net' / 'after adjustments' language). If phrase explicitly contains 'decrease', preserve semantic sign (tag remains same but mark as decrease).\n  2) If 'approved', 'authorized', 'granted', 'effective', 'in effect as of', or 'we will implement' appear in place of filing/request cues -> do NOT map to Requested tag; instead map to the taxonomy's approved/implemented-rate-change tag (e.g., PublicUtilitiesApprovedRateIncreaseDecreaseAmount) or, if that tag is absent, flag for human-review rather than mapping to Revenues.\n  3) If sentence describes expected/estimated revenue impact using verbs like 'will result in', 'expected to increase (our) revenues by', 'resulting in additional revenues of' -> do NOT map to the Requested-rate tag; map to the appropriate Revenues/EstimatedImpact tag or flag for review (avoid mapping requested-rate -> Revenues).\n- Precedence/tie-breaker: when a filing/request cue is present, this rule overrides generic lexical matches (e.g., 'increase', 'increase of $X' that could be mis-mapped to Revenues or Contract-related tags). If both filing and 'expected revenue' cues appear, prefer requested-rate mapping but log for human review because text describes both regulatory request and revenue impact.\n- Net/after-adjustment handling: presence of modifiers like 'net', 'after adjustments', 'after pro forma adjustments', or 'net of' does NOT change mapping — still map to PublicUtilitiesRequestedRateIncreaseDecreaseAmount if filing/request cues remain present; record modifier span in logs for provenance.\n- Negative/zero handling: if filing/request clause uses 'decrease' or explicitly states 'a decrease of $X' map same tag and mark as decrease; if phrase is 'no change requested' or contains negation near rate-change anchor, normalize numeric to 0 and map to PublicUtilitiesRequestedRateIncreaseDecreaseAmount = 0 and log negation span.\n- Token-normalization: recognize approximate/caretakers tokens ('approximately', 'about', '~', 'approx.') and numeric ranges ('approximately $5.9 million', '$5.5 – $6.0 million') — map central expression to requested tag and attach span confidence; for ranges, map whole range as candidate value and flag for downstream normalization.\n- Logging & QA: always record filing/request cue span, rate-change anchor span, numeric span, and chosen tag; if the pipeline would otherwise map the numeric to Revenues or to a recognized/approved tag, log as 'regulatory-request-vs-other' for QA. Queue ambiguous/dual-cue sentences (both filing and approved language or both revenue-impact and filing) for human review.\n- Unit-tests (atomic examples to add):\n  - 'filed an application with the Commission for a natural gas rate increase of approximately $5.9 million' -> $5.9M = PublicUtilitiesRequestedRateIncreaseDecreaseAmount.\n  - 'submitted a request to decrease its electric rates by $7.2 million' -> $7.2M (decrease) = PublicUtilitiesRequestedRateIncreaseDecreaseAmount.\n  - 'filed a general rate case with a requested overall increase of approximately $2.3 million' -> $2.3M = PublicUtilitiesRequestedRateIncreaseDecreaseAmount.\n  - 'filed a stipulation with the Commission for a net increase of $1.2 million' -> $1.2M = PublicUtilitiesRequestedRateIncreaseDecreaseAmount (net modifier preserved in log).\n  - 'the Commission approved an increase of $4.0 million' -> do NOT map to Requested tag; map to PublicUtilitiesApprovedRateIncreaseDecreaseAmount or flag for review.\n  - 'the filing is expected to result in annual revenue increases of $3.0 million' -> do NOT map to Requested tag; map to Revenues/EstimatedImpact or flag for review.\n- Implementation note: run this rule early in lexical-to-tag pipeline (before generic currency-to-revenue fallbacks). Ensure supervision records include cue spans to train classifiers to distinguish requested vs approved vs revenue-impact contexts."}], "added_content": ["[ctx-00004] helpful=0 harmful=0 :: Atomic heuristic: Regulatory rate-requests mapping -> PublicUtilitiesRequestedRateIncreaseDecreaseAmount", "- Purpose: deterministically map currency numeric tokens that express a utility's requested (filed/submitted/asked-for) rate increase or decrease to PublicUtilitiesRequestedRateIncreaseDecreaseAmount and avoid false mapping to Revenues/Expense/generic financial tags.", "- Exact filing/request lexical cues (case-insensitive regex examples): /\\bfiled\\b/, /\\bfiled an application\\b/, /\\bsubmitted a request\\b/, /\\brequested\\b/, /\\bseeks to increase\\b/, /\\bseeking approval to increase\\b/, /\\bpetition(ed)?\\b/, /\\bproposed\\b/, /\\bseeks to decrease\\b/, /\\bsubmitted a petition\\b/, /\\bstipulation .* for a net increase\\b/, /(for|requesting|seeking).*rate (increase|decrease) of/i. If any of these cues co-occur with a rate/increase/decrease lexical anchor, treat as regulatory-request.", "- Rate-change lexical anchors: /rate(s)? (increase|decrease)|increase[s]? rates?|decrease[s]? rates?|net increase|net decrease|rate adjustment|proposed rate change|requested rate change/.", "- Association window & antecedent resolution: require numeric token in the same sentence and within ±12 tokens of a filing/request cue OR within the same clause. Allow antecedent anchors up to ±1 sentence when the numeric is introduced as 'the net increase of $X' or via a parenthetical referring to the filing (e.g., 'in the filing, for a net increase of $1.2 million')."], "removed_content": []}
{"timestamp": "2026-02-06T11:06:21.830226", "step": 33, "playbook_before_length": 57029, "playbook_after_length": 62556, "lines_before": 163, "lines_after": 165, "added_lines": 2, "removed_lines": 0, "operations_count": 2, "operations": [{"type": "ADD", "section": "context_clues_and_indicators", "content": "Atomic rule: Lease-range endpoint mapping when a single 'between A and B' range is used with both 'lease assets' and 'lease liabilities'. Purpose: deterministically map numeric endpoints in phrases like \"recognition of additional lease assets and lease liabilities between $250.0 and $350.0 as of <date>\". Detection patterns (case-insensitive): /(?:recognition|recognise|recognized|recognised).*lease assets?\\s+and\\s+lease liabilities?\\s+between\\s+\\$?[0-9,]+(?:\\.\\d+)?\\s+and\\s+\\$?[0-9,]+(?:\\.\\d+)?/i or general pattern /(lease assets?|lease liabilities?).{0,80}?between\\s+\\$?[0-9,]+(?:\\.\\d+)?\\s+and\\s+\\$?[0-9,]+(?:\\.\\d+)?/i. Decision flow (apply in order): 1) If the clause explicitly assigns amounts to each side (e.g., \"assets of $A and liabilities of $B\"), map accordingly (assets -> OperatingLeaseRightOfUseAsset; liabilities -> OperatingLeaseLiability). 2) Else if the clause uses a two-endpoint range \"between A and B\" and both nouns 'assets' and 'liabilities' appear: a) If nouns appear in order 'assets' then 'liabilities' in the clause, map upper endpoint B -> OperatingLeaseRightOfUseAsset and lower endpoint A -> OperatingLeaseLiability. b) If nouns appear in reverse order ('liabilities' then 'assets'), invert mapping (upper -> liability, lower -> asset). 3) Else if only a single endpoint token is present (e.g., only \"$350.0\" appears) or endpoints are not clearly ordered, apply nearest-noun lexical association (token-distance window ±8 tokens): map the numeric to the most specific tag matching the nearest noun (\"asset\" -> OperatingLeaseRightOfUseAsset; \"liability\" -> OperatingLeaseLiability). 4) If token-distance method yields ties or no nearby asset/liability noun within ±8 tokens, mark the numeric as 'lease-range-ambiguous' and queue for human review (do NOT fall back to generic money tags). 5) Logging: record noun order, token distances, chosen mapping, and clause span. Unit-tests (atomic): - \"recognition of additional lease assets and lease liabilities between $250.0 and $350.0 as of January 1, 2019\" -> $350.0 => OperatingLeaseRightOfUseAsset; $250.0 => OperatingLeaseLiability (assets before liabilities rule). - \"recognition of additional lease liabilities and lease assets between $100 and $200\" -> $200 => OperatingLeaseLiability; $100 => OperatingLeaseRightOfUseAsset (reverse-order rule). - \"We recognized $350.0 of additional lease assets and liabilities\" (single token nearest 'assets') -> $350.0 => OperatingLeaseRightOfUseAsset. Implementation note: apply this rule before generic currency-to-asset/liability fallbacks and log ambiguous-range cases for QA."}, {"type": "ADD", "section": "context_clues_and_indicators", "content": "Atomic lexical-to-tag mapping: 'net sales' + geographic customer anchor -> RevenueFromContractWithCustomerExcludingAssessedTax. Purpose: deterministically map amounts described as 'net sales' to geographically qualified customers (e.g., 'to customers located outside the United States') to the most specific revenue taxonomy element and choose the assessed-tax variant. Detection patterns (case-insensitive): - Net-sales lexical cue: /\\bnet\\s+sales\\b|\\bsales,?\\s+net\\b/ within the sentence. - Geographic-customer anchors: /customers?\\s+(?:located|based)\\s+outside\\s+the\\s+United\\s+States|to\\s+customers\\s+outside\\s+the\\s+United\\s+States|international\\s+customers|foreign\\s+customers/ or short-form '\\boutside the U\\.S\\.?\\b'. Decision flow (apply in order): 1) If a currency numeric token appears within ±10 tokens of 'net sales' and a geographic-customer anchor appears in same sentence (or immediately adjacent sentence ±1), assign RevenueFromContractWithCustomerExcludingAssessedTax to that numeric. 2) Taxonomy-variant selection: prefer the 'ExcludingAssessedTax' variant when the sentence does NOT mention assessed taxes, sales taxes, VAT, GST, or tax-inclusive language. Detection regex for tax-inclusion cues: /assessed tax|sales tax|inclusive of tax|includes tax|VAT|GST|inclusive of|exclusive of taxes/i. 3) If sentence contains explicit assessed/sales-tax inclusion language, map to the 'IncludingAssessedTax' variant (if present) or flag 'revenue-tax-variant-ambiguous' for review. 4) Year-association: when multiple year-labeled numeric values are listed in same sentence (e.g., \"$634.8, $627.1 and $655.6 for 2018, 2017 and 2016\"), preserve mapping of each numeric to its year label by nearest-year-token association (token-distance window ±6 tokens) before applying revenue tag; attach year metadata to each assigned RevenueFromContractWithCustomerExcludingAssessedTax tag. 5) Ambiguity handling: if 'net sales' appears without a customer geographic anchor but a nearby phrase 'international'/'outside' exists, treat as geographic match; otherwise map 'net sales' to the generic RevenueFromContractWithCustomer tag but log for QA. 6) Unit-tests (atomic): - \"Net sales to customers located outside the United States were $634.8, $627.1 and $655.6 for 2018, 2017 and 2016\" -> map each numeric to RevenueFromContractWithCustomerExcludingAssessedTax with corresponding year association. - \"Net sales to foreign customers were $10.0\" -> $10.0 => RevenueFromContractWithCustomerExcludingAssessedTax. - \"Net sales (including sales tax) to customers outside the U.S. were $5.0\" -> map to RevenueFromContractWithCustomerIncludingAssessedTax or flag if taxonomy variant missing. Implementation note: run this rule before generic currency-to-sales fallbacks and always log the presence/absence of assessed-tax cues and year associations for traceability."}], "added_content": ["[ctx-00005] helpful=0 harmful=0 :: Atomic rule: Lease-range endpoint mapping when a single 'between A and B' range is used with both 'lease assets' and 'lease liabilities'. Purpose: deterministically map numeric endpoints in phrases like \"recognition of additional lease assets and lease liabilities between $250.0 and $350.0 as of <date>\". Detection patterns (case-insensitive): /(?:recognition|recognise|recognized|recognised).*lease assets?\\s+and\\s+lease liabilities?\\s+between\\s+\\$?[0-9,]+(?:\\.\\d+)?\\s+and\\s+\\$?[0-9,]+(?:\\.\\d+)?/i or general pattern /(lease assets?|lease liabilities?).{0,80}?between\\s+\\$?[0-9,]+(?:\\.\\d+)?\\s+and\\s+\\$?[0-9,]+(?:\\.\\d+)?/i. Decision flow (apply in order): 1) If the clause explicitly assigns amounts to each side (e.g., \"assets of $A and liabilities of $B\"), map accordingly (assets -> OperatingLeaseRightOfUseAsset; liabilities -> OperatingLeaseLiability). 2) Else if the clause uses a two-endpoint range \"between A and B\" and both nouns 'assets' and 'liabilities' appear: a) If nouns appear in order 'assets' then 'liabilities' in the clause, map upper endpoint B -> OperatingLeaseRightOfUseAsset and lower endpoint A -> OperatingLeaseLiability. b) If nouns appear in reverse order ('liabilities' then 'assets'), invert mapping (upper -> liability, lower -> asset). 3) Else if only a single endpoint token is present (e.g., only \"$350.0\" appears) or endpoints are not clearly ordered, apply nearest-noun lexical association (token-distance window ±8 tokens): map the numeric to the most specific tag matching the nearest noun (\"asset\" -> OperatingLeaseRightOfUseAsset; \"liability\" -> OperatingLeaseLiability). 4) If token-distance method yields ties or no nearby asset/liability noun within ±8 tokens, mark the numeric as 'lease-range-ambiguous' and queue for human review (do NOT fall back to generic money tags). 5) Logging: record noun order, token distances, chosen mapping, and clause span. Unit-tests (atomic): - \"recognition of additional lease assets and lease liabilities between $250.0 and $350.0 as of January 1, 2019\" -> $350.0 => OperatingLeaseRightOfUseAsset; $250.0 => OperatingLeaseLiability (assets before liabilities rule). - \"recognition of additional lease liabilities and lease assets between $100 and $200\" -> $200 => OperatingLeaseLiability; $100 => OperatingLeaseRightOfUseAsset (reverse-order rule). - \"We recognized $350.0 of additional lease assets and liabilities\" (single token nearest 'assets') -> $350.0 => OperatingLeaseRightOfUseAsset. Implementation note: apply this rule before generic currency-to-asset/liability fallbacks and log ambiguous-range cases for QA.", "[ctx-00006] helpful=0 harmful=0 :: Atomic lexical-to-tag mapping: 'net sales' + geographic customer anchor -> RevenueFromContractWithCustomerExcludingAssessedTax. Purpose: deterministically map amounts described as 'net sales' to geographically qualified customers (e.g., 'to customers located outside the United States') to the most specific revenue taxonomy element and choose the assessed-tax variant. Detection patterns (case-insensitive): - Net-sales lexical cue: /\\bnet\\s+sales\\b|\\bsales,?\\s+net\\b/ within the sentence. - Geographic-customer anchors: /customers?\\s+(?:located|based)\\s+outside\\s+the\\s+United\\s+States|to\\s+customers\\s+outside\\s+the\\s+United\\s+States|international\\s+customers|foreign\\s+customers/ or short-form '\\boutside the U\\.S\\.?\\b'. Decision flow (apply in order): 1) If a currency numeric token appears within ±10 tokens of 'net sales' and a geographic-customer anchor appears in same sentence (or immediately adjacent sentence ±1), assign RevenueFromContractWithCustomerExcludingAssessedTax to that numeric. 2) Taxonomy-variant selection: prefer the 'ExcludingAssessedTax' variant when the sentence does NOT mention assessed taxes, sales taxes, VAT, GST, or tax-inclusive language. Detection regex for tax-inclusion cues: /assessed tax|sales tax|inclusive of tax|includes tax|VAT|GST|inclusive of|exclusive of taxes/i. 3) If sentence contains explicit assessed/sales-tax inclusion language, map to the 'IncludingAssessedTax' variant (if present) or flag 'revenue-tax-variant-ambiguous' for review. 4) Year-association: when multiple year-labeled numeric values are listed in same sentence (e.g., \"$634.8, $627.1 and $655.6 for 2018, 2017 and 2016\"), preserve mapping of each numeric to its year label by nearest-year-token association (token-distance window ±6 tokens) before applying revenue tag; attach year metadata to each assigned RevenueFromContractWithCustomerExcludingAssessedTax tag. 5) Ambiguity handling: if 'net sales' appears without a customer geographic anchor but a nearby phrase 'international'/'outside' exists, treat as geographic match; otherwise map 'net sales' to the generic RevenueFromContractWithCustomer tag but log for QA. 6) Unit-tests (atomic): - \"Net sales to customers located outside the United States were $634.8, $627.1 and $655.6 for 2018, 2017 and 2016\" -> map each numeric to RevenueFromContractWithCustomerExcludingAssessedTax with corresponding year association. - \"Net sales to foreign customers were $10.0\" -> $10.0 => RevenueFromContractWithCustomerExcludingAssessedTax. - \"Net sales (including sales tax) to customers outside the U.S. were $5.0\" -> map to RevenueFromContractWithCustomerIncludingAssessedTax or flag if taxonomy variant missing. Implementation note: run this rule before generic currency-to-sales fallbacks and always log the presence/absence of assessed-tax cues and year associations for traceability."], "removed_content": []}
{"timestamp": "2026-02-06T11:08:10.984734", "step": 34, "playbook_before_length": 62556, "playbook_after_length": 68163, "lines_before": 165, "lines_after": 166, "added_lines": 1, "removed_lines": 0, "operations_count": 1, "operations": [{"type": "ADD", "section": "context_clues_and_indicators", "content": "Equity/Share-based two-step disambiguation (subject-action + specificity precedence) — atomic heuristic to distinguish grants-in-period vs plan-authorized vs generic common-stock-reserved for any share-count numeric. Steps (apply in order): 1) Subject & action extraction (primary anchors): - Detect subject tokens (case-insensitive): /option(s)?\\b/, /award(s)?\\b/, /grant(s)?\\b/, /share-based payment/, /the Plan\\b/, /stock plan\\b/, /Long Term Incentive Plan\\b/, /the Plan\\b/. - Detect action/verb tokens (case-insensitive): GRANT cues = /grant|granted|may continue to receive|may receive|will receive|annual option grant|annual grant|per director|per\\s+year|each\\s+director/; AUTH/RESERVE cues = /authorized|authorised|reserve(d)? for future grant|reserved for future grant|reserved for future issuance|reserved\\b/; ISSUANCE cues = /issued|issued and outstanding|issued to|issued at/; AVAILABILITY cues = /available for grant|remain available|available under the Plan/. 2) Association windows & antecedent resolution: - Require numeric token to be within ±8 tokens of the detected subject/action cue in the same sentence for high-confidence mapping. - Allow antecedent plan-subject resolution from previous sentence if anaphor ('the Plan', named plan) present; antecedent span allowed ≤ 40 tokens across sentence boundary and only ±1 sentence. 3) Per-period / per-award grant detection rules (map -> OptionsGrantsInPeriodGross): - If subject includes 'option(s)'/'grant(s)' AND action cue matches any GRANT cues above (especially modifiers: 'annual', 'per director', 'each', 'no more than', 'maximum annual grant', 'for no more than'), map numeric -> OptionsGrantsInPeriodGross (grants-in-period). - Example triggers (atomic): /annual option grant for no more than\\s+[0-9,]+/, /may continue to receive an annual option grant of\\s+[0-9,]+/, /no more than\\s+[0-9,]+\\s+shares\\s+(per|each|annually)/. 4) Plan-specific authorization/reservation detection rules (map -> ShareBasedCompensationArrangementByShareBasedPaymentAwardNumberOfSharesAuthorized): - If action includes AUTH/RESERVE cues AND subject refers to options/awards/plan (explicit 'options to purchase', 'under the Plan', 'reserved for future grant' co-occurring with 'option(s)'/'award(s)'), map numeric -> ShareBasedCompensationArrangementByShareBasedPaymentAwardNumberOfSharesAuthorized. - Treat the collocation 'authorized and reserved for future grant' with an 'option' subject as a strong plan-authorization signal. 5) Generic common-stock reserved fallback (map -> CommonStockCapitalSharesReservedForFutureIssuance): - If action includes 'reserved'/'reserved for future issuance' but NO explicit option/award/plan anchor within ±8 tokens or antecedent ±1 sentence, map numeric -> CommonStockCapitalSharesReservedForFutureIssuance. 6) Precedence & tie-breakers (apply when multiple candidate tags score >0): - Precedence order: (a) If GRANT cue present -> OptionsGrantsInPeriodGross (highest when 'annual', 'per', 'no more than', 'each', 'may continue to receive' appear). (b) Else if AUTH/RESERVE cue present with option/plan anchor -> ShareBasedCompensationArrangementByShareBasedPaymentAwardNumberOfSharesAuthorized. (c) Else if only generic 'reserved' + common-stock anchor present -> CommonStockCapitalSharesReservedForFutureIssuance. - If both grant-modifier and authorization verb appear in same clause (e.g., 'may receive a grant not to exceed X shares authorized under the Plan for annual grants'), prefer the tag indicated by the modifier that scopes the number: 'per-period/per-award' modifiers (annual/per director/each) -> grants-in-period. If conflict persists, flag as 'plan-grant-auth-ambiguous' for human review and log both anchors. 7) Token matching sensitivity & confidence flags: - Treat words 'annual', 'per', 'each', 'no more than', 'maximum' as strong per-period signals (weight +10). - Treat verbs 'authorized', 'reserved for future grant', 'reserved' with an option/plan anchor as strong authorization signals (weight +9). - Map only when weighted score for chosen tag exceeds alternate by a threshold (e.g., >4); otherwise queue for review. 8) Examples / unit-tests to add (atomic): - 'non-employee directors may continue to receive an annual option grant for no more than 10,000 shares.' -> 10,000 = OptionsGrantsInPeriodGross. - 'options to purchase 989,081 shares ... were authorized and reserved for future grant.' -> 989,081 = ShareBasedCompensationArrangementByShareBasedPaymentAwardNumberOfSharesAuthorized. - '1,000,000 shares reserved for future issuance under the charter' (no plan/option mention) -> 1,000,000 = CommonStockCapitalSharesReservedForFutureIssuance. - 'maximum number of shares that may be delivered under the Plan is 15,000,000' -> 15,000,000 = ShareBasedCompensationArrangementByShareBasedPaymentAwardNumberOfSharesAuthorized. - 'no shares remain available under the 2014 Long Term Incentive Plan' -> 0 = ShareBasedCompensationArrangementByShareBasedPaymentAwardNumberOfSharesAvailableForGrant. 9) Logging & QA: - For every mapping log: subject anchor span, action cue span, chosen tag, competing tag(s) with score differential, and antecedent-plan span if used. - If mapping results in tie or falls below confidence threshold, label 'plan-grant-auth-ambiguous' and queue for human review/training. Implementation note: place this rule immediately after existing ctx-00001 plan-anchor detection and before any generic 'reserved'->CommonStockCapitalSharesReservedForFutureIssuance or nearest-lexical-match fallback to prevent the two mislabels observed."}], "added_content": ["[ctx-00007] helpful=0 harmful=0 :: Equity/Share-based two-step disambiguation (subject-action + specificity precedence) — atomic heuristic to distinguish grants-in-period vs plan-authorized vs generic common-stock-reserved for any share-count numeric. Steps (apply in order): 1) Subject & action extraction (primary anchors): - Detect subject tokens (case-insensitive): /option(s)?\\b/, /award(s)?\\b/, /grant(s)?\\b/, /share-based payment/, /the Plan\\b/, /stock plan\\b/, /Long Term Incentive Plan\\b/, /the Plan\\b/. - Detect action/verb tokens (case-insensitive): GRANT cues = /grant|granted|may continue to receive|may receive|will receive|annual option grant|annual grant|per director|per\\s+year|each\\s+director/; AUTH/RESERVE cues = /authorized|authorised|reserve(d)? for future grant|reserved for future grant|reserved for future issuance|reserved\\b/; ISSUANCE cues = /issued|issued and outstanding|issued to|issued at/; AVAILABILITY cues = /available for grant|remain available|available under the Plan/. 2) Association windows & antecedent resolution: - Require numeric token to be within ±8 tokens of the detected subject/action cue in the same sentence for high-confidence mapping. - Allow antecedent plan-subject resolution from previous sentence if anaphor ('the Plan', named plan) present; antecedent span allowed ≤ 40 tokens across sentence boundary and only ±1 sentence. 3) Per-period / per-award grant detection rules (map -> OptionsGrantsInPeriodGross): - If subject includes 'option(s)'/'grant(s)' AND action cue matches any GRANT cues above (especially modifiers: 'annual', 'per director', 'each', 'no more than', 'maximum annual grant', 'for no more than'), map numeric -> OptionsGrantsInPeriodGross (grants-in-period). - Example triggers (atomic): /annual option grant for no more than\\s+[0-9,]+/, /may continue to receive an annual option grant of\\s+[0-9,]+/, /no more than\\s+[0-9,]+\\s+shares\\s+(per|each|annually)/. 4) Plan-specific authorization/reservation detection rules (map -> ShareBasedCompensationArrangementByShareBasedPaymentAwardNumberOfSharesAuthorized): - If action includes AUTH/RESERVE cues AND subject refers to options/awards/plan (explicit 'options to purchase', 'under the Plan', 'reserved for future grant' co-occurring with 'option(s)'/'award(s)'), map numeric -> ShareBasedCompensationArrangementByShareBasedPaymentAwardNumberOfSharesAuthorized. - Treat the collocation 'authorized and reserved for future grant' with an 'option' subject as a strong plan-authorization signal. 5) Generic common-stock reserved fallback (map -> CommonStockCapitalSharesReservedForFutureIssuance): - If action includes 'reserved'/'reserved for future issuance' but NO explicit option/award/plan anchor within ±8 tokens or antecedent ±1 sentence, map numeric -> CommonStockCapitalSharesReservedForFutureIssuance. 6) Precedence & tie-breakers (apply when multiple candidate tags score >0): - Precedence order: (a) If GRANT cue present -> OptionsGrantsInPeriodGross (highest when 'annual', 'per', 'no more than', 'each', 'may continue to receive' appear). (b) Else if AUTH/RESERVE cue present with option/plan anchor -> ShareBasedCompensationArrangementByShareBasedPaymentAwardNumberOfSharesAuthorized. (c) Else if only generic 'reserved' + common-stock anchor present -> CommonStockCapitalSharesReservedForFutureIssuance. - If both grant-modifier and authorization verb appear in same clause (e.g., 'may receive a grant not to exceed X shares authorized under the Plan for annual grants'), prefer the tag indicated by the modifier that scopes the number: 'per-period/per-award' modifiers (annual/per director/each) -> grants-in-period. If conflict persists, flag as 'plan-grant-auth-ambiguous' for human review and log both anchors. 7) Token matching sensitivity & confidence flags: - Treat words 'annual', 'per', 'each', 'no more than', 'maximum' as strong per-period signals (weight +10). - Treat verbs 'authorized', 'reserved for future grant', 'reserved' with an option/plan anchor as strong authorization signals (weight +9). - Map only when weighted score for chosen tag exceeds alternate by a threshold (e.g., >4); otherwise queue for review. 8) Examples / unit-tests to add (atomic): - 'non-employee directors may continue to receive an annual option grant for no more than 10,000 shares.' -> 10,000 = OptionsGrantsInPeriodGross. - 'options to purchase 989,081 shares ... were authorized and reserved for future grant.' -> 989,081 = ShareBasedCompensationArrangementByShareBasedPaymentAwardNumberOfSharesAuthorized. - '1,000,000 shares reserved for future issuance under the charter' (no plan/option mention) -> 1,000,000 = CommonStockCapitalSharesReservedForFutureIssuance. - 'maximum number of shares that may be delivered under the Plan is 15,000,000' -> 15,000,000 = ShareBasedCompensationArrangementByShareBasedPaymentAwardNumberOfSharesAuthorized. - 'no shares remain available under the 2014 Long Term Incentive Plan' -> 0 = ShareBasedCompensationArrangementByShareBasedPaymentAwardNumberOfSharesAvailableForGrant. 9) Logging & QA: - For every mapping log: subject anchor span, action cue span, chosen tag, competing tag(s) with score differential, and antecedent-plan span if used. - If mapping results in tie or falls below confidence threshold, label 'plan-grant-auth-ambiguous' and queue for human review/training. Implementation note: place this rule immediately after existing ctx-00001 plan-anchor detection and before any generic 'reserved'->CommonStockCapitalSharesReservedForFutureIssuance or nearest-lexical-match fallback to prevent the two mislabels observed."], "removed_content": []}
{"timestamp": "2026-02-06T11:09:56.060774", "step": 35, "playbook_before_length": 68163, "playbook_after_length": 71852, "lines_before": 166, "lines_after": 167, "added_lines": 1, "removed_lines": 0, "operations_count": 1, "operations": [{"type": "ADD", "section": "context_clues_and_indicators", "content": "Atomic heuristic: Instrument-class-first mapping for share-based awards (prevent misclassifying SARs/UARs as options). Purpose: always classify award instrument type before selecting grants/issued tag or tag-variant (Gross vs Non-Options). Rules (apply in order): 1) Instrument-class lexicon (case-insensitive regexes; apply exact-match before fuzzy): - Options signals -> /\\boption(s)?\\b|stock\\s+option(s)?|option-based\\b/. - Equity-instruments-other-than-options signals -> /\\b(unit\\s+appreciation\\s+right(s)?|UARs?|UAR|SARs?|SAR|stock\\s+appreciation\\s+right(s)?|restricted\\s+stock\\s+unit(s)?|RSU(s)?|dividend\\s+equivalent\\s+unit(s)?|dividend\\s+equivalent\\b|restricted\\s+stock\\b)/. If both classes appear, prefer explicit token that matches the instrument noun closest to numeric token (distance weighting). 2) Association window: treat the instrument-class cue as global for any numeric token in the same sentence or within ±1 sentence if anaphoric ('the awards', 'such units') and antecedent span <= 40 tokens. 3) Grants-in-period mapping: when action verb indicates issuance/grant (regex: /\\b(grant(ed)?|issued|awarded|awards|grants-in-period|grants|issued and outstanding)\\b/) and instrument-class == options -> map to OptionsGrantsInPeriod... (option grants). If instrument-class == equity-instruments-other-than-options -> map to ShareBasedCompensationArrangementByShareBasedPaymentAwardEquityInstrumentsOtherThanOptionsGrantsInPeriod (grants-in-period for non-options). 4) Outstanding / Nonvested counts: when numeric phrase describes 'units outstanding', 'nonvested', 'nonvested units', 'dividend equivalent units outstanding' and instrument-class matches equity-instruments-other-than-options -> map to ShareBasedCompensationArrangementByShareBasedPaymentAwardEquityInstrumentsOtherThanOptionsNonvestedNumber (or taxonomy NonvestedNumber variant appropriate). 5) Gross-variant guard: only allow selection of an 'Options...Gross' variant when (a) instrument-class == options AND (b) either the sentence contains explicit 'gross' / 'before forfeitures' cues (/\\bgross\\b|before\\s+forfeitur(es)?|gross\\s+of\\s+forfeitures/) OR taxonomy definitions require Gross form. Otherwise, do NOT select an options-Gross variant for non-option instruments. 6) Precedence scoring & tie-breaker: compute score = (instrument_class_exact_match? 10 : 0) + (action_verb_grant? 5 : 0) + (token_distance_factor = max(0, 8 - token_distance_to_numeric)). Choose tag with highest score; require chosen tag score >= next_best + 4, else flag 'instrument-class-ambiguous' for review. 7) Examples / unit-tests (atomic): - '8 thousand unit appreciation rights issued' -> 8,000 = ShareBasedCompensationArrangementByShareBasedPaymentAwardEquityInstrumentsOtherThanOptionsGrantsInPeriod. - '5,000 SARs were granted' -> 5,000 = ShareBasedCompensationArrangementByShareBasedPaymentAwardEquityInstrumentsOtherThanOptionsGrantsInPeriod. - '10,000 options were granted' -> 10,000 = OptionsGrantsInPeriodGross (only if 'gross' cue present) else OptionsGrantsInPeriodNet/appropriate variant per taxonomy. - '33 thousand dividend equivalent units outstanding at March 31' -> 33,000 = EquityInstrumentsOtherThanOptionsNonvestedNumber. 8) Ambiguity handling & logging: log instrument-class cue span, action-verb span, chosen tag, competing tag(s) with scores, and rule reason. On low-confidence or ties, label 'instrument-class-ambiguous' and queue for human review; accumulate these cases for retraining. 9) Implementation note: run this rule before any generic 'grants'/'issued' -> options fallback and before applying 'nearest lexical match' to prevent superficial keyword collisions."}], "added_content": ["[ctx-00008] helpful=0 harmful=0 :: Atomic heuristic: Instrument-class-first mapping for share-based awards (prevent misclassifying SARs/UARs as options). Purpose: always classify award instrument type before selecting grants/issued tag or tag-variant (Gross vs Non-Options). Rules (apply in order): 1) Instrument-class lexicon (case-insensitive regexes; apply exact-match before fuzzy): - Options signals -> /\\boption(s)?\\b|stock\\s+option(s)?|option-based\\b/. - Equity-instruments-other-than-options signals -> /\\b(unit\\s+appreciation\\s+right(s)?|UARs?|UAR|SARs?|SAR|stock\\s+appreciation\\s+right(s)?|restricted\\s+stock\\s+unit(s)?|RSU(s)?|dividend\\s+equivalent\\s+unit(s)?|dividend\\s+equivalent\\b|restricted\\s+stock\\b)/. If both classes appear, prefer explicit token that matches the instrument noun closest to numeric token (distance weighting). 2) Association window: treat the instrument-class cue as global for any numeric token in the same sentence or within ±1 sentence if anaphoric ('the awards', 'such units') and antecedent span <= 40 tokens. 3) Grants-in-period mapping: when action verb indicates issuance/grant (regex: /\\b(grant(ed)?|issued|awarded|awards|grants-in-period|grants|issued and outstanding)\\b/) and instrument-class == options -> map to OptionsGrantsInPeriod... (option grants). If instrument-class == equity-instruments-other-than-options -> map to ShareBasedCompensationArrangementByShareBasedPaymentAwardEquityInstrumentsOtherThanOptionsGrantsInPeriod (grants-in-period for non-options). 4) Outstanding / Nonvested counts: when numeric phrase describes 'units outstanding', 'nonvested', 'nonvested units', 'dividend equivalent units outstanding' and instrument-class matches equity-instruments-other-than-options -> map to ShareBasedCompensationArrangementByShareBasedPaymentAwardEquityInstrumentsOtherThanOptionsNonvestedNumber (or taxonomy NonvestedNumber variant appropriate). 5) Gross-variant guard: only allow selection of an 'Options...Gross' variant when (a) instrument-class == options AND (b) either the sentence contains explicit 'gross' / 'before forfeitures' cues (/\\bgross\\b|before\\s+forfeitur(es)?|gross\\s+of\\s+forfeitures/) OR taxonomy definitions require Gross form. Otherwise, do NOT select an options-Gross variant for non-option instruments. 6) Precedence scoring & tie-breaker: compute score = (instrument_class_exact_match? 10 : 0) + (action_verb_grant? 5 : 0) + (token_distance_factor = max(0, 8 - token_distance_to_numeric)). Choose tag with highest score; require chosen tag score >= next_best + 4, else flag 'instrument-class-ambiguous' for review. 7) Examples / unit-tests (atomic): - '8 thousand unit appreciation rights issued' -> 8,000 = ShareBasedCompensationArrangementByShareBasedPaymentAwardEquityInstrumentsOtherThanOptionsGrantsInPeriod. - '5,000 SARs were granted' -> 5,000 = ShareBasedCompensationArrangementByShareBasedPaymentAwardEquityInstrumentsOtherThanOptionsGrantsInPeriod. - '10,000 options were granted' -> 10,000 = OptionsGrantsInPeriodGross (only if 'gross' cue present) else OptionsGrantsInPeriodNet/appropriate variant per taxonomy. - '33 thousand dividend equivalent units outstanding at March 31' -> 33,000 = EquityInstrumentsOtherThanOptionsNonvestedNumber. 8) Ambiguity handling & logging: log instrument-class cue span, action-verb span, chosen tag, competing tag(s) with scores, and rule reason. On low-confidence or ties, label 'instrument-class-ambiguous' and queue for human review; accumulate these cases for retraining. 9) Implementation note: run this rule before any generic 'grants'/'issued' -> options fallback and before applying 'nearest lexical match' to prevent superficial keyword collisions."], "removed_content": []}
{"timestamp": "2026-02-06T11:11:35.304956", "step": 36, "playbook_before_length": 71852, "playbook_after_length": 76699, "lines_before": 167, "lines_after": 199, "added_lines": 32, "removed_lines": 0, "operations_count": 1, "operations": [{"type": "ADD", "section": "CONTEXT CLUES & INDICATORS", "content": "Equity-reserved-vs-plan-authorized disambiguation (atomic rule)\nPurpose: When text contains \"reserved\" + a plan reference, decide whether the numeric is a corporate common-stock reservation (CommonStockCapitalSharesReservedForFutureIssuance) or a plan-authorized/share-based-compensation authorization (ShareBasedCompensationArrangementByShareBasedPaymentAwardNumberOfSharesAuthorized).\nExact lexical cues (case-insensitive):\n- ESPP plan type cues: /\\bESPP\\b|Employee Stock Purchase Plan|Employee Stock Purchase Plan\\b/\n- Common-stock noun cues: /\\bclass\\s+[A-Z]\\s+common\\s+stock\\b|\\bcommon\\s+stock\\b|\\bshares\\s+of\\s+common\\s+stock\\b/ \n- Share-based-compensation award cues: /award(s)?|option(s)?|RSU(s)?|restricted\\s+stock|available\\s+for\\s+grant|available\\s+for\\s+award|available\\s+under\\s+the\\s+Plan|available\\s+for\\s+grant\\b|awards\\s+reserved|reserved\\s+for\\s+future\\s+grant|authorized\\s+to\\s+issue\\s+under\\s+the\\s+Plan/ \n- Generic reserved cue: /\\breserved\\b|reserved\\s+for\\s+future\\s+issuance\\b/\nAssociation windows & antecedent resolution:\n- Require numeric token to be within ±8 tokens of the reserved cue for high-confidence mapping.\n- Allow antecedent resolution to prior sentence (±1 sentence) when 'the Plan' or a named plan appears earlier; antecedent span must be <= 40 tokens across sentence boundary.\nDecision flow (apply in order):\n1) If an ESPP plan-type cue is present in same sentence OR antecedent plan resolved to an ESPP within ±1 sentence -> map numeric -> CommonStockCapitalSharesReservedForFutureIssuance (ESPP reservations are corporate equity reserved-for-issuance disclosures).\n2) Else if a common-stock noun cue ('Class A common stock', 'common stock', 'shares of common stock') co-occurs with reserved-language in same sentence or immediately adjacent sentence (±1) -> map numeric -> CommonStockCapitalSharesReservedForFutureIssuance.\n3) Else if reserved-language co-occurs with explicit award/instrument cues (options, RSUs, awards, 'available for grant', 'available under the Plan') within ±8 tokens OR antecedent plan resolved is clearly a 'stock plan' described as for awards -> map numeric -> ShareBasedCompensationArrangementByShareBasedPaymentAwardNumberOfSharesAuthorized.\n4) Else (reserved + plan but no ESPP/common-stock noun and no award/instrument anchor) -> do NOT auto-assign: flag as 'reserved-plan-ambiguous' and queue for human review; prefer CommonStockCapitalSharesReservedForFutureIssuance only when explicit corporate-equity headings or charter references present.\nTie-breakers & precedence:\n- Give ESPP and explicit 'common stock' noun cues precedence over generic 'plan' anchors and over award-sounding verbs (e.g., 'reserved for issuance under the 2016 ESPP' -> CommonStockCapitalSharesReservedForFutureIssuance).\n- If both award-cues and common-stock noun cues appear, prefer CommonStockCapitalSharesReservedForFutureIssuance only when the sentence stresses issuance of common stock (e.g., 'shares of Class A common stock were initially reserved for issuance under the 2016 ESPP'); else if sentence explicitly frames reserved amount as for awards/grants ('reserved for future grant under the Stock Plan') prefer ShareBasedCompensationArrangement...Authorized.\nConfidence scoring notes:\n- ESPP present: +12 weight for CommonStock tag.\n- 'common stock' noun within ±8 tokens: +10 weight for CommonStock tag.\n- Award/instrument cue within ±8 tokens: +9 weight for ShareBasedComp tag.\n- Require chosen tag score >= next_best + 4 or mark 'reserved-plan-ambiguous' for review.\nLogging & QA:\n- Log which cues were matched (span offsets), antecedent plan name (if resolved), chosen tag, competing tags with scores, and confidence decision.\n- Add any ambiguous cases to 'reserved-plan-ambiguous' queue for annotation and retraining.\nUnit-tests (atomic examples):\n- 'A total of 3,800,000 shares of Class A common stock were initially reserved for issuance under the 2016 ESPP.' -> 3,800,000 => CommonStockCapitalSharesReservedForFutureIssuance.\n- '1,000,000 shares reserved for future issuance under the charter' -> 1,000,000 => CommonStockCapitalSharesReservedForFutureIssuance.\n- 'options to purchase 989,081 shares were authorized and reserved for future grant under the Plan.' -> 989,081 => ShareBasedCompensationArrangementByShareBasedPaymentAwardNumberOfSharesAuthorized.\n- 'The Plan authorizes up to 15,000,000 shares available for grant.' -> 15,000,000 => ShareBasedCompensationArrangementByShareBasedPaymentAwardNumberOfSharesAuthorized.\nImplementation note: insert this rule immediately after ctx-00001 plan-anchor detection and before any generic 'reserved' -> ShareBasedCompensationArrangement... authorized fallback to prevent overgeneralization to plan-authorized tag when the reserved instrument is corporate common stock or when an ESPP is involved."}], "added_content": ["[ctx-00009] helpful=0 harmful=0 :: Equity-reserved-vs-plan-authorized disambiguation (atomic rule)", "Purpose: When text contains \"reserved\" + a plan reference, decide whether the numeric is a corporate common-stock reservation (CommonStockCapitalSharesReservedForFutureIssuance) or a plan-authorized/share-based-compensation authorization (ShareBasedCompensationArrangementByShareBasedPaymentAwardNumberOfSharesAuthorized).", "Exact lexical cues (case-insensitive):", "- ESPP plan type cues: /\\bESPP\\b|Employee Stock Purchase Plan|Employee Stock Purchase Plan\\b/", "- Common-stock noun cues: /\\bclass\\s+[A-Z]\\s+common\\s+stock\\b|\\bcommon\\s+stock\\b|\\bshares\\s+of\\s+common\\s+stock\\b/ "], "removed_content": []}
{"timestamp": "2026-02-06T11:13:18.852256", "step": 37, "playbook_before_length": 76699, "playbook_after_length": 80237, "lines_before": 199, "lines_after": 200, "added_lines": 1, "removed_lines": 0, "operations_count": 1, "operations": [{"type": "ADD", "section": "context_clues_and_indicators", "content": "Atomic heuristic — Temporal-expression disambiguation: map 'years' to vesting vs expiration/term by linking the numeric to its governing noun (semantic-governor-first, not proximity-first). Rules (apply in order): 1) Governing-noun detection (exact cues, case-insensitive): VESTING cues = /\\bvest(?:s|ed|ing)?\\b|vesting\\b|vests?\\s+over\\b|vested\\s+over\\b/; EXPIRATION/TERM cues = /\\bterm\\b|\\bterm\\s+of\\b|\\bexpire(?:s|d|s)?\\b|\\bexpiration\\b|\\bexpire\\s+after\\b|\\bexpires\\s+after\\b/. 2) Strong syntactic patterns (highest-priority): if numeric appears inside or immediately adjacent to prepositional phrase matching patterns -> map accordingly: - /term\\s+of\\s+(?:a\\s+)?(?:\\d+|[A-Za-z\\-]+)(?:\\s*-\\s*\\d+)?\\s*(?:-?year|years?)/i -> assign SharebasedCompensationArrangementBySharebasedPaymentAwardExpirationPeriod. - /(vest|vesting)\\s+(?:over|in)\\s+(?:a\\s+)?(?:\\d+|[A-Za-z\\-]+)(?:\\s*-\\s*\\d+)?\\s*(?:-?year|years?)/i -> assign ShareBasedCompensationArrangementByShareBasedPaymentAwardAwardVestingPeriod1. 3) Dependency / parser signal (secondary-high priority): if dependency parse shows numeric token as numeric modifier (nummod) of a noun that matches VESTING cues -> vesting tag; if numeric is nummod of 'term'/'expiration'/'expire' -> expiration tag. 4) Token-window lexical association (fallback): if no prepositional or dependency match, look for governing-noun tokens within the same clause with token-distance <= 8 tokens and prefer semantic-governor match (term/expire > vest if numeric modifies 'term'); do NOT rely solely on the nearest occurrence of the word 'years'—require link to a governing noun. 5) Tie-breaker precedence: when a numeric is within windows of both vesting and term cues, prefer explicit 'term of X' / 'expire after X' constructs over 'vest' matches (expiration/term > vesting) because 'term'/'expire' indicates legal expiration. 6) Multi-value and hyphenated forms: handle composite forms such as 'three- or four-year' as a vesting-period match when the phrase is anchored to 'vest'; treat ranges 'between A and B years' similarly using the governing noun. 7) Exact tag verification: before finalizing assignment, validate the chosen tag text exactly matches the taxonomy string (examples above). 8) Ambiguity handling & confidence: if no governing-noun match in same clause and both vest/term cues exist in sentence, label as 'temporal-ambiguous' and queue for human review (do NOT auto-assign). 9) Logging: record numeric token span, governing-noun span (matched pattern or dependency relation), chosen tag, confidence score and rule-match type (prepositional-pattern / dependency / token-window). 10) Unit-tests (atomic examples to add): - 'Awards are generally granted for a term of ten years and vest over a three- or four-year period.' -> 10 years = SharebasedCompensationArrangementBySharebasedPaymentAwardExpirationPeriod; 3/4 years = ShareBasedCompensationArrangementByShareBasedPaymentAwardAwardVestingPeriod1. - 'Options vest over a four-year period and expire after ten years.' -> 4 years -> vesting tag; 10 years -> expiration tag. - 'We grant awards with a term of ten years that vest over three years.' -> ten years -> expiration tag (term); three years -> vesting tag. - 'The awards vest in a three- or four-year period; the term is generally ten years.' -> ten years -> expiration tag. Implementation note: run this heuristic before any proximity-only lexical-to-tag mapping; surface all 'temporal-ambiguous' logs to QA to add targeted examples to training data."}], "added_content": ["[ctx-00010] helpful=0 harmful=0 :: Atomic heuristic — Temporal-expression disambiguation: map 'years' to vesting vs expiration/term by linking the numeric to its governing noun (semantic-governor-first, not proximity-first). Rules (apply in order): 1) Governing-noun detection (exact cues, case-insensitive): VESTING cues = /\\bvest(?:s|ed|ing)?\\b|vesting\\b|vests?\\s+over\\b|vested\\s+over\\b/; EXPIRATION/TERM cues = /\\bterm\\b|\\bterm\\s+of\\b|\\bexpire(?:s|d|s)?\\b|\\bexpiration\\b|\\bexpire\\s+after\\b|\\bexpires\\s+after\\b/. 2) Strong syntactic patterns (highest-priority): if numeric appears inside or immediately adjacent to prepositional phrase matching patterns -> map accordingly: - /term\\s+of\\s+(?:a\\s+)?(?:\\d+|[A-Za-z\\-]+)(?:\\s*-\\s*\\d+)?\\s*(?:-?year|years?)/i -> assign SharebasedCompensationArrangementBySharebasedPaymentAwardExpirationPeriod. - /(vest|vesting)\\s+(?:over|in)\\s+(?:a\\s+)?(?:\\d+|[A-Za-z\\-]+)(?:\\s*-\\s*\\d+)?\\s*(?:-?year|years?)/i -> assign ShareBasedCompensationArrangementByShareBasedPaymentAwardAwardVestingPeriod1. 3) Dependency / parser signal (secondary-high priority): if dependency parse shows numeric token as numeric modifier (nummod) of a noun that matches VESTING cues -> vesting tag; if numeric is nummod of 'term'/'expiration'/'expire' -> expiration tag. 4) Token-window lexical association (fallback): if no prepositional or dependency match, look for governing-noun tokens within the same clause with token-distance <= 8 tokens and prefer semantic-governor match (term/expire > vest if numeric modifies 'term'); do NOT rely solely on the nearest occurrence of the word 'years'—require link to a governing noun. 5) Tie-breaker precedence: when a numeric is within windows of both vesting and term cues, prefer explicit 'term of X' / 'expire after X' constructs over 'vest' matches (expiration/term > vesting) because 'term'/'expire' indicates legal expiration. 6) Multi-value and hyphenated forms: handle composite forms such as 'three- or four-year' as a vesting-period match when the phrase is anchored to 'vest'; treat ranges 'between A and B years' similarly using the governing noun. 7) Exact tag verification: before finalizing assignment, validate the chosen tag text exactly matches the taxonomy string (examples above). 8) Ambiguity handling & confidence: if no governing-noun match in same clause and both vest/term cues exist in sentence, label as 'temporal-ambiguous' and queue for human review (do NOT auto-assign). 9) Logging: record numeric token span, governing-noun span (matched pattern or dependency relation), chosen tag, confidence score and rule-match type (prepositional-pattern / dependency / token-window). 10) Unit-tests (atomic examples to add): - 'Awards are generally granted for a term of ten years and vest over a three- or four-year period.' -> 10 years = SharebasedCompensationArrangementBySharebasedPaymentAwardExpirationPeriod; 3/4 years = ShareBasedCompensationArrangementByShareBasedPaymentAwardAwardVestingPeriod1. - 'Options vest over a four-year period and expire after ten years.' -> 4 years -> vesting tag; 10 years -> expiration tag. - 'We grant awards with a term of ten years that vest over three years.' -> ten years -> expiration tag (term); three years -> vesting tag. - 'The awards vest in a three- or four-year period; the term is generally ten years.' -> ten years -> expiration tag. Implementation note: run this heuristic before any proximity-only lexical-to-tag mapping; surface all 'temporal-ambiguous' logs to QA to add targeted examples to training data."], "removed_content": []}
{"timestamp": "2026-02-06T11:14:40.305358", "step": 38, "playbook_before_length": 80237, "playbook_after_length": 85748, "lines_before": 200, "lines_after": 237, "added_lines": 33, "removed_lines": 0, "operations_count": 1, "operations": [{"type": "ADD", "section": "context_clues_and_indicators", "content": "Atomic lexical-to-tag rules for amortization-asset-type and operating-segment-count phrases (exact cues, windows, precedence, negatives, unit-tests):\n\n1) Amortization — Intangible assets acquired -> AmortizationOfIntangibleAssets\n- Exact lexical anchors (case-insensitive): /amortiz(e|ation)\\b/, /intangible\\s+asset(s)?\\b/, /intangible\\s+assets\\s+acquir(ed|ed\\b|ing)\\b/, /acquired\\s+intangible\\s+assets\\b/, /amortization\\s+of\\s+intangible\\s+assets\\b/.\n- Association window: require both an amortization cue and an 'intangible asset' anchor to appear in the same sentence with the numeric token within ±8 tokens of at least one of those anchors; allow antecedent 'acquired intangible assets' in prior sentence ±1 when anaphor ('these assets', 'the intangible assets') is used and antecedent span <= 40 tokens.\n- Precedence: if matched, assign AmortizationOfIntangibleAssets and override any generic AmortizationExpense or AmortizationOfOtherAssets tag.\n- Negative-prevention: do NOT map when amortization is described as 'impairment-related amortization' or when the asset anchor indicates internal R&D capitalization unless text explicitly says 'acquired' or 'purchase' — in such cases flag for review or require additional anchor (e.g., 'acquired', 'purchased in the acquisition').\n- Period-invariance: numeric amounts for different periods (three-month, six-month, annual) that reference the same concept must receive the same taxonomy element; record period metadata separately but do not change tag.\n- Unit-tests (atomic examples):\n  - \"$1,696 of amortization expense related to the intangible assets acquired\" -> $1,696 = AmortizationOfIntangibleAssets.\n  - \"Amortization of intangible assets acquired in the acquisition was $2,500\" -> $2,500 = AmortizationOfIntangibleAssets.\n\n2) Amortization — Deferred contract costs / capitalized contract costs -> CapitalizedContractCostAmortization\n- Exact lexical anchors (case-insensitive): /amortiz(e|ation)\\b/, /deferred\\s+contract\\s+cost(s)?\\b/, /capitalized\\s+contract\\s+cost(s)?\\b/, /amortization\\s+of\\s+deferred\\s+contract\\s+costs\\b/.\n- Association window: require 'amortization' + 'deferred contract costs' or 'capitalized contract costs' in same sentence and numeric token within ±8 tokens of the phrase; allow antecedent antecedent resolution ±1 sentence when anaphor ('these deferred contract costs') used (span <= 40 tokens).\n- Precedence: map to CapitalizedContractCostAmortization and override generic amortization tags.\n- Negative-prevention: do NOT map simply because 'deferred' and 'costs' appear; require explicit 'contract' token (i.e., 'deferred contract costs' or synonym 'capitalized contract costs'). If only 'deferred revenue' or 'deferred costs' without 'contract' present, flag for review.\n- Period-invariance: same as above — period labels do not change tag.\n- Unit-tests (atomic):\n  - \"Amortization expense related to deferred contract costs was $X for the three months and $Y for the six months\" -> map each amount to CapitalizedContractCostAmortization with period metadata.\n  - \"We recorded $3,200 of amortization of capitalized contract costs\" -> $3,200 = CapitalizedContractCostAmortization.\n\n3) Count of business lines -> NumberOfOperatingSegments\n- Exact lexical anchors (case-insensitive): /primary\\s+business\\s+lines\\b/, /business\\s+lines\\s+include\\b/, /operating\\s+segments\\b/, /the\\s+number\\s+of\\s+operating\\s+segments\\b/, /we\\s+have\\s+\\d+\\s+primary\\s+business\\s+lines\\b/.\n- Association window: detect an explicit numeric token (cardinal) within ±6 tokens of 'primary business lines'/'operating segments' or in clause like 'Its four primary business lines include...'; map that numeric to NumberOfOperatingSegments.\n- Normalization & cardinal detection: accept both numerals and words ('four', 'three'); convert words to integer via dictionary mapping before assignment.\n- Period-invariance / scope: counts are structural facts — tag is invariant to reporting period. If sentence pairs count with time qualifiers (e.g., 'as of December 31'), attach date metadata but assign NumberOfOperatingSegments regardless of period length.\n- Negative-prevention: if sentence lists business lines without an explicit numeric (e.g., 'Its primary business lines are A, B and C') do not auto-assign a numeric tag; flag for extraction of count via list-length only if deterministic tokenization is available and confidence threshold met.\n- Unit-tests (atomic):\n  - \"Its four primary business lines include...\" -> 4 = NumberOfOperatingSegments.\n  - \"The Company operates in three operating segments\" -> 3 = NumberOfOperatingSegments.\n\n4) Overarching tie-breaker & implementation notes\n- Specificity precedence order (apply when 'amortization' appears): (1) AmortizationOfIntangibleAssets (if 'intangible' + 'acquired'/'acquisition' present), (2) CapitalizedContractCostAmortization (if 'deferred contract costs' or 'capitalized contract costs' present), (3) other asset-specific amortization tags, (4) generic AmortizationExpense.\n- Apply these rules before any generic 'amortization' -> AmortizationExpense fallback in the pipeline.\n- Logging: for any override of generic amortization, record matched anchor spans, antecedent resolution span (if cross-sentence), chosen tag, and period metadata (three-month/six-month/annual) for QA.\n- Add unit-tests to regression suite covering three- and six-month variants, cross-sentence antecedent cases, and negative cases where 'deferred' appears without 'contract'."}], "added_content": ["[ctx-00011] helpful=0 harmful=0 :: Atomic lexical-to-tag rules for amortization-asset-type and operating-segment-count phrases (exact cues, windows, precedence, negatives, unit-tests):", "1) Amortization — Intangible assets acquired -> AmortizationOfIntangibleAssets", "- Exact lexical anchors (case-insensitive): /amortiz(e|ation)\\b/, /intangible\\s+asset(s)?\\b/, /intangible\\s+assets\\s+acquir(ed|ed\\b|ing)\\b/, /acquired\\s+intangible\\s+assets\\b/, /amortization\\s+of\\s+intangible\\s+assets\\b/.", "- Association window: require both an amortization cue and an 'intangible asset' anchor to appear in the same sentence with the numeric token within ±8 tokens of at least one of those anchors; allow antecedent 'acquired intangible assets' in prior sentence ±1 when anaphor ('these assets', 'the intangible assets') is used and antecedent span <= 40 tokens.", "- Precedence: if matched, assign AmortizationOfIntangibleAssets and override any generic AmortizationExpense or AmortizationOfOtherAssets tag."], "removed_content": []}
{"timestamp": "2026-02-06T11:16:03.063562", "step": 39, "playbook_before_length": 85748, "playbook_after_length": 88894, "lines_before": 237, "lines_after": 256, "added_lines": 19, "removed_lines": 0, "operations_count": 1, "operations": [{"type": "ADD", "section": "context_clues_and_indicators", "content": "Atomic lexical-descriptor precedence: map precise numeric descriptors to the exact debt/credit tag before any classifier or nearest-lexical fallback. Rules (apply in order):\n1) Exact-descriptor detection (case-insensitive regexes, apply exact-match first):\n   - /\\boutstanding\\s+(in|under)?\\s*(letters?\\s+of\\s+credit)\\b|letters?\\s+of\\s+credit\\s+outstanding\\b/ -> LettersOfCreditOutstandingAmount\n   - /(?:notes|note)\\s+(?:issued|issued\\s+at|issued\\s+in)\\b|(?:euro|EUR|€)\\s*[-\\d,\\.]+\\s+notes\\s+issued/ -> DebtInstrumentFaceAmount\n   - /\\b(principal\\s+amount|face\\s+amount|stated\\s+face\\s+amount|principal\\s+of\\s+the\\s+notes)\\b/ -> DebtInstrumentFaceAmount\n   - /\\bestimated\\s+fair\\s+value\\s+of\\s+long-?term\\s+debt\\b|\\bfair\\s+value\\s+of\\s+long-?term\\s+debt\\b/ -> LongTermDebtFairValue\n   - /\\bcarrying\\s+(amount|value)\\s+of\\s+debt\\b|book\\s+value\\s+of\\s+debt\\b/ -> DebtInstrumentCarryingAmount\n2) Token-window: require the descriptor match to co-occur within ±8 tokens of the numeric token or in the same clause; allow antecedent resolution in previous sentence up to ±1 sentence only when anaphoric phrase used (\"the notes\", \"the facility\") and antecedent span <= 40 tokens.\n3) Precedence (if multiple descriptors detected): fair-value descriptors > carrying/book-value descriptors > principal/face/issued descriptors > outstanding/letters-of-credit descriptors (i.e., map to the most semantically specific descriptor present). Implement as ordered checks above so first-match wins.\n4) Override rule: when an exact-descriptor regex matches, it MUST override any generic debt, interest or capacity mapping produced by other heuristics or classifiers; record the override in the log with descriptor span and numeric span.\n5) Ambiguity handling: if no exact-descriptor match found within windows, DO NOT guess between face/carrying/fair-value — fall back to the semantic classifier but tag the result as 'low-confidence-descriptor' and queue for human review. If two conflicting exact-descriptor phrases are matched with equal specificity and cannot be resolved by precedence, mark 'descriptor-conflict' and queue for human review.\n6) Unit-tests (atomic examples to add):\n   - \"$144.5 million outstanding in letters of credit and guarantees\" -> LettersOfCreditOutstandingAmount = $144.5M\n   - \"€300,000 euro-denominated notes issued on March 1\" -> DebtInstrumentFaceAmount = €300,000\n   - \"€600,000 of euro-denominated notes issued\" -> DebtInstrumentFaceAmount = €600,000\n   - \"the estimated fair value of long-term debt was $X\" -> LongTermDebtFairValue = $X\n   - \"carrying amount of the senior notes was $Y\" -> DebtInstrumentCarryingAmount = $Y\n7) Logging & provenance: record descriptor regex span, numeric token span, chosen tag, rule-id ('literal-descriptor-precedence'), and confidence. Any forced-override of classifier must be recorded with reason string (which exact-descriptor matched).\n8) Implementation note: place this rule before generic numeric-to-debt-tag fallbacks, before spread/interest heuristics, and before nearest-lexical-match rules to ensure literal descriptor mapping is always prioritized."}], "added_content": ["[ctx-00012] helpful=0 harmful=0 :: Atomic lexical-descriptor precedence: map precise numeric descriptors to the exact debt/credit tag before any classifier or nearest-lexical fallback. Rules (apply in order):", "1) Exact-descriptor detection (case-insensitive regexes, apply exact-match first):", "   - /\\boutstanding\\s+(in|under)?\\s*(letters?\\s+of\\s+credit)\\b|letters?\\s+of\\s+credit\\s+outstanding\\b/ -> LettersOfCreditOutstandingAmount", "   - /(?:notes|note)\\s+(?:issued|issued\\s+at|issued\\s+in)\\b|(?:euro|EUR|€)\\s*[-\\d,\\.]+\\s+notes\\s+issued/ -> DebtInstrumentFaceAmount", "   - /\\b(principal\\s+amount|face\\s+amount|stated\\s+face\\s+amount|principal\\s+of\\s+the\\s+notes)\\b/ -> DebtInstrumentFaceAmount"], "removed_content": []}
{"timestamp": "2026-02-06T11:19:23.414390", "step": 41, "playbook_before_length": 88894, "playbook_after_length": 95395, "lines_before": 256, "lines_after": 298, "added_lines": 29, "removed_lines": 0, "operations_count": 2, "operations": [{"type": "ADD", "section": "context_clues_and_indicators", "content": "Atomic heuristic: Disambiguate scheduled payments (installments/dates) vs acquisition consideration (required-positive-acquisition-cues) — apply BEFORE misc-00002 and before any generic 'payments -> BusinessCombinationConsiderationTransferred1' fallback.\n\n1) Purpose: avoid mapping plain installment schedules to BusinessCombinationConsiderationTransferred1 unless explicit acquisition lexicon/role is present.\n\n2) Required positive-acquisition cues (case-insensitive regexes). At least one MUST be present in the same sentence OR within ±1 sentence antecedent (antecedent span <= 40 tokens) to tag a payment as BusinessCombinationConsiderationTransferred1: /\\b(acquir(e|ed|ing)|acquisition|purchase(?:d|s| price| price of)?|purchase price|consideration(?: transferred)?|closing(?: date)?|seller\\b|purchase\\s+price\\b|paid\\s+as\\s+consideration|in\\s+consideration\\s+for)\\b/i.\n\n3) Installment-schedule negative/RepaymentsOfDebt cues (case-insensitive). If any of these appear in the same clause/sentence (preferred) map nearest numeric(s) to RepaymentsOfDebt unless positive-acquisition cues (step 2) are present: /\\binstallment(s)?\\b|installment\\s+payments|installments\\s+of|repay(ment|ments)?\\b|principal\\b|note\\b|loan\\b|maturity\\b|due\\s+on\\s|first\\s+payment\\b|second\\s+payment\\b|by\\s+\\w+\\s+\\d{1,2},?\\s+\\d{4}\\b|on\\s+February\\s+14,?\\s+2018\\b|shall\\s+pay(s|able)?\\b|will\\s+make\\s+\\w+\\s+payment(s)?\\b/ i (include generic date-form regex: /\\b(january|february|march|april|may|june|july|august|september|october|november|december)\\s+\\d{1,2},?\\s+\\d{4}\\b/i).\n\n4) Decision flow (apply in order for each numeric currency token in a payment clause):\n  a) If positive-acquisition cue present within window -> allow BusinessCombinationConsiderationTransferred1 mapping but require an explicit composition phrase tying the numerics to consideration (e.g., 'consideration of', 'purchase price includes', 'paid as part of the purchase') within ±12 tokens of the numeric. If that composition phrase is absent, flag as 'acquisition-cue-no-composition' and require human review.\n  b) Else if installment-schedule negative/RepaymentsOfDebt cue present within same clause/sentence (±8 tokens) -> map numeric -> RepaymentsOfDebt (highest precedence).\n  c) Else if only generic 'payments'/'paid' lexical match exists (no acquisition cue and no installment cue) -> prefer RepaymentsOfDebt by default for dated or scheduled forms; otherwise defer to semantic classifier but mark low-confidence and log for review.\n\n5) Conflict / mixed-cues tie-breaker:\n  - If both acquisition-cue and installment-cue appear, prefer BusinessCombinationConsiderationTransferred1 only when acquisition-cue + composition phrase co-occur (see 4a). If acquisition-cue exists but only a generic 'installment' schedule is present and no composition phrase, prefer RepaymentsOfDebt and log as 'installment-with-acquisition-mention-ambiguous'.\n\n6) Token windows & antecedents:\n  - Positive-acquisition cue window: same sentence OR previous sentence (±1 sentence) with antecedent span <= 40 tokens.\n  - Installment-schedule window: same clause/sentence; date proximity within ±6 tokens of numeric strongly signals schedule.\n\n7) Unit-tests / minimal examples to add (atomic):\n  - 'The Company will make four installment payments ... SFG shall make a first payment to Canarc in the amount of $25,000 by February 14, 2018 ...' -> $25,000 (and other installment amounts) => RepaymentsOfDebt.\n  - 'At closing, the purchase price shall be $1,000,000, with $250,000 payable on closing and $750,000 payable in four installments as consideration.' -> both installment amounts linked by 'consideration' -> BusinessCombinationConsiderationTransferred1 (if composition phrase 'as consideration' present).\n  - 'Buyer will pay $100,000 on closing and $50,000 on each anniversary as remaining consideration for the acquisition.' -> mapped to BusinessCombinationConsiderationTransferred1 (positive acquisition cue + composition phrase).\n  - 'The seller will receive four installment payments: $10,000 on March 1, 2018; $10,000 on June 1, 2018' (no acquisition words) -> RepaymentsOfDebt.\n\n8) Logging & QA:\n  - All mappings using this rule must record: matched positive-acquisition cue span (if any), matched installment-schedule cue span (if any), numeric span, chosen tag, decision-branch (4a/4b/4c), and any composition-phrase span. Cases where acquisition-cue existed but composition phrase was missing must be queued 'acquisition-cue-no-composition' for human review and added to retraining set.\n\n9) Implementation note: insert this rule BEFORE misc-00002 micro decision flow and before any generic 'nearest-lexical-match' fallbacks; ensure classifiers respect this explicit rule for payment-schedule contexts."}, {"type": "ADD", "section": "common_mistakes_to_avoid", "content": "Atomic mistake-prevention: Do not default 'payments to external party' -> BusinessCombinationConsiderationTransferred1 without explicit acquisition-composition cues.\n\n1) Anti-pattern: mapping any scheduled or dated payments to an outside counterparty as acquisition consideration simply because the payment is to a third party.\n\n2) Prevention checklist (atomic):\n  - Before assigning BusinessCombinationConsiderationTransferred1 to any numeric in a payment clause, REQUIRE either (A) a positive-acquisition cue (see context_clues_and_indicators rule) AND an explicit composition phrase tying those numerics to consideration/purchase, OR (B) a heading/section context that labels the clause as 'Acquisition', 'Purchase', 'Business combination', or similar within ±2 sentences.\n  - If the sentence contains words 'installment', 'installments', date tokens for multiple scheduled payments, or enumerated first/second/third payments AND acquisition-cues are absent, default to RepaymentsOfDebt.\n  - If acquisition-cue exists but only in the prior section header (more than ±2 sentences away) and no composition phrase present, DO NOT map to BusinessCombinationConsiderationTransferred1 automatically — flag for review.\n\n3) Unit-tests to add to regression: include the example from the reflection and other borderline cases where 'installment' appears without 'purchase/consideration' words to ensure RepaymentsOfDebt wins.\n\n4) Logging requirement: any override where a payment was mapped to BusinessCombinationConsiderationTransferred1 despite the presence of installment-schedule cues must be logged as 'payment-to-party-acquisition-override' and manually inspected for false positives."}], "added_content": ["[err-00014] helpful=0 harmful=0 :: Atomic mistake-prevention: Do not default 'payments to external party' -> BusinessCombinationConsiderationTransferred1 without explicit acquisition-composition cues.", "1) Anti-pattern: mapping any scheduled or dated payments to an outside counterparty as acquisition consideration simply because the payment is to a third party.", "2) Prevention checklist (atomic):", "  - Before assigning BusinessCombinationConsiderationTransferred1 to any numeric in a payment clause, REQUIRE either (A) a positive-acquisition cue (see context_clues_and_indicators rule) AND an explicit composition phrase tying those numerics to consideration/purchase, OR (B) a heading/section context that labels the clause as 'Acquisition', 'Purchase', 'Business combination', or similar within ±2 sentences.", "  - If the sentence contains words 'installment', 'installments', date tokens for multiple scheduled payments, or enumerated first/second/third payments AND acquisition-cues are absent, default to RepaymentsOfDebt."], "removed_content": []}
{"timestamp": "2026-02-06T11:20:47.581280", "step": 42, "playbook_before_length": 95395, "playbook_after_length": 100738, "lines_before": 298, "lines_after": 334, "added_lines": 28, "removed_lines": 0, "operations_count": 1, "operations": [{"type": "ADD", "section": "context_clues_and_indicators", "content": "Delta rule: Depreciable-life & Depreciation atomic mapping\n\nPurpose: deterministically map year-duration tokens that describe asset useful lives -> PropertyPlantAndEquipmentUsefulLife, and monetary tokens labeled as depreciation -> Depreciation. Also enforce exact-tag existence before assignment and safe fallbacks.\n\nExact lexical cues (case-insensitive regexes):\n- Useful-life anchors (must be present to map years): /\\b(depreciable life|depreciable lives|useful life|useful lives|estimated useful life|estimated life|life of (?:the )?(?:asset|assets|building|machinery|equipment|property))\\b/i\n- Year token forms to capture (within allowed window): /\\b\\d{1,3}\\s*(?:-\\s*year|year|years|yrs)\\b|\\b\\d{1,3}\\b(?=\\s+years?)|\\b\\d{1,3}-year\\b/i\n- Depreciation monetary anchors: /\\bdepreciation expense(s)?\\b|\\bdepreciation charge(s)?\\b|\\bdepreciation and amortization\\b|\\bdepreciation\\b/ i\n\nAssociation windows & rules (apply in order):\n1) For any numeric token that matches a year form: require presence of a Useful-life anchor in the same sentence OR within ±1 sentence antecedent (antecedent span <= 40 tokens). Token-distance window for anchor-to-numeric = ±8 tokens in same sentence; cross-sentence allowed only with explicit anaphor ('the useful life', 'these depreciable lives') and antecedent resolution.\n2) If rule 1 satisfied -> before assignment check tag list for exact string 'PropertyPlantAndEquipmentUsefulLife'. If present, assign that exact tag to the numeric (unit = years). If exact tag absent, search tag list for any tag containing substring 'PropertyPlantAndEquipment' AND 'UsefulLife' (literal substring) and prefer the most specific match; if none found, DO NOT auto-map — flag 'useful-life-tag-missing' for human review and record suggested mapping.\n3) Asset-specific disambiguation: if an asset-class token (building, plant, machinery, equipment, leasehold, furniture, fixtures, vehicle, software) appears in same sentence within ±12 tokens of the useful-life anchor, attempt to match a more specific taxonomy tag by looking for exact tag-name that combines asset-class + 'UsefulLife' (literal substring match). If such exact tag exists in tag list, prefer it over the generic PropertyPlantAndEquipmentUsefulLife; otherwise fall back to PropertyPlantAndEquipmentUsefulLife.\n4) Negative-safeguard: do NOT assign when the numeric-year phrase attaches to non-asset governing nouns (e.g., 'term', 'contract', 'license', 'agreement', 'service life of contract') unless text also contains asset/depreciation anchors. If both 'term/expire' and 'useful life' co-occur, prefer the anchor that syntactically governs the numeric (use dependency nummod/governor if available); if ambiguous, flag for review.\n\nDepreciation monetary mapping:\n1) For any currency numeric token in same sentence with Depreciation monetary anchors (within ±12 tokens): check tag list for exact string 'Depreciation'. If present assign that tag to the currency amount and link to any nearby asset anchor if present (token-distance <= 20) for provenance.\n2) If 'depreciation and amortization' present and only combined tag exists (e.g., 'DepreciationAndAmortization' literal in tag list), prefer the combined tag; otherwise map currency to 'Depreciation' and log 'amortization-combined-text' for QA.\n3) If depreciation anchor present but numeric is reported as 'zero', 'none', or negative parentheses, normalize numeric appropriately (0 or negative) and record the negation cue span.\n\nPrecedence & tie-breakers:\n- Useful-life-year mapping (when anchor present) overrides generic numeric->duration fallbacks (e.g., 'years' as tenure/contract) if asset anchor detected.\n- Depreciation monetary mapping overrides generic expense/cost tags when the lexical anchor 'depreciation' is present and an exact 'Depreciation' tag exists.\n\nAmbiguity handling & logging:\n- If exact tag strings required by the rule are absent from provided tag list, do not auto-assign; flag 'exact-tag-missing' and include matched cue spans, numeric span, and suggested exact tag-name (PropertyPlantAndEquipmentUsefulLife or Depreciation) in the review payload.\n- All auto-assignments must log: matched anchor span, numeric token span, chosen tag name (exact), rule-id 'ctx-depr-life-0001', and confidence level.\n\nUnit-tests (atomic examples to add):\n- 'Buildings have a useful life of 20 years' -> 20 years = PropertyPlantAndEquipmentUsefulLife (asset-class 'building' used to prefer building-specific useful-life tag if present).\n- 'Machinery and equipment are depreciable lives of 40 years and 20 years respectively' -> 40 and 20 years = PropertyPlantAndEquipmentUsefulLife with asset-specific preference where available.\n- 'The estimated useful life is three years for certain equipment' -> 3 years = PropertyPlantAndEquipmentUsefulLife.\n- 'Depreciation expense for the year was $467 million' -> $467 million = Depreciation.\n- 'Depreciation and amortization totaled $X' -> assign DepreciationAndAmortization if that exact tag exists, else assign Depreciation and log combined-cue.\n\nImplementation note: place this rule before generic 'years -> duration' fallbacks and before generic currency->expense fallbacks. Ensure exact-string tag lookup is performed atomically and failures are routed to human-review instead of greedy nearest-lexical mapping."}], "added_content": ["[ctx-00015] helpful=0 harmful=0 :: Delta rule: Depreciable-life & Depreciation atomic mapping", "Purpose: deterministically map year-duration tokens that describe asset useful lives -> PropertyPlantAndEquipmentUsefulLife, and monetary tokens labeled as depreciation -> Depreciation. Also enforce exact-tag existence before assignment and safe fallbacks.", "Exact lexical cues (case-insensitive regexes):", "- Useful-life anchors (must be present to map years): /\\b(depreciable life|depreciable lives|useful life|useful lives|estimated useful life|estimated life|life of (?:the )?(?:asset|assets|building|machinery|equipment|property))\\b/i", "- Year token forms to capture (within allowed window): /\\b\\d{1,3}\\s*(?:-\\s*year|year|years|yrs)\\b|\\b\\d{1,3}\\b(?=\\s+years?)|\\b\\d{1,3}-year\\b/i"], "removed_content": []}
{"timestamp": "2026-02-06T11:21:56.291885", "step": 43, "playbook_before_length": 100738, "playbook_after_length": 104658, "lines_before": 334, "lines_after": 352, "added_lines": 17, "removed_lines": 0, "operations_count": 1, "operations": [{"type": "ADD", "section": "context_clues_and_indicators", "content": "ctx-00016 :: Multi-amount interest-charge -> InterestExpenseDebt (atomic heuristic)\n- Purpose: when a clause or sentence contains one interest lexical cue and one instrument-anchor but multiple currency amounts (e.g., amounts for multiple periods or enumerated amounts), assign each currency amount to the instrument-specific InterestExpenseDebt and attach the correct period metadata.\n- Exact lexical cues (case-insensitive): /interest\\s+charge(s)?\\b/, /interest\\s+expense(s)?\\b/, /interest\\s+on\\s+the\\s+(note|notes|loan|term\\s+loan|seller\\s+note|revolver)/i. Instrument-anchor detection: same instrument-name lexicons as ctx-00012 (Seller Notes, Term Loan, Revolver, Senior Notes, etc.) allowing antecedent resolution ±1 sentence and span <=40 tokens.\n- Multi-amount detection & association policy:\n  1) If a sentence/clause contains an interest lexical cue AND an instrument-anchor (same sentence OR antecedent ±1 sentence within 40 tokens) AND contains >=1 currency numeric token, then for EACH currency numeric token in that clause/sentence: assign InterestExpenseDebt linked to the detected instrument id.\n  2) Token-distance windows: primary association window for interest cue -> each currency numeric = ±12 tokens; if a currency falls outside ±12 but remains in the same clause/sentence and only one instrument-anchor/interest-cue exists, still map it to InterestExpenseDebt but mark mapping as 'long-span' and log distances.\n- Period association rules:\n  1) If period-label tokens appear (e.g., 'for the year ended', 'for the six months ended', '2019', '2018', 'three months ended March 31, 2019') associate each currency numeric to the nearest period token within ±10 tokens. For comma-separated lists like \"$A, $B and $C for 2019, 2018 and 2017\" map numerics to years by nearest-year-token order alignment (left-to-right pairing) when explicit year tokens appear; otherwise attach no-period metadata and flag 'multi-amount-no-period'.\n  2) If explicit period tokens are absent but the sentence is a comparative table-like list ('for the year ended 2019, 2018 and 2017: $A, $B, $C'), pair by sequence (left-to-right) and log the heuristic pairing.\n- Zero-normalization: if any numeric is a negation ('no interest', 'none', 'zero') within ±6 tokens of interest cue and instrument-anchor present, normalize to 0 and assign InterestExpenseDebt=0; log negation and anchor spans.\n- Precedence: this multi-amount rule overrides generic InterestExpense mapping and any classifier fallbacks when instrument-anchor present. If instrument-anchor absent, map amounts to generic InterestExpense and flag each numeric with 'interest-amount-no-instrument' for review.\n- Logging & provenance: for each mapped numeric record: numeric span, interest-cue span, instrument-anchor span and instrument id, period token span (if any), token distances, and rule-id 'ctx-00016'. Aggregate 'interest-amount-no-instrument' cases into QA queue.\n- Unit-tests (atomic examples to add):\n  - '$179,507, $160,000, $140,000 and $120,000 of interest charges associated with the Term Loan for the years ended 2019, 2018, 2017 and 2016' -> map each amount to InterestExpenseDebt (Term Loan) with respective years (2019,2018,2017,2016).\n  - '$331,397 of interest expense for the six months ended June 30 and $179,507 for the year ended December 31, related to the Term Loan' -> both amounts -> InterestExpenseDebt (Term Loan) with appropriate period tags.\n  - 'No interest expense was recorded on the Term Loan' -> InterestExpenseDebt = 0 (logged negation).\n  - 'Interest charges of $10, $20 and $30' (no instrument-anchor) -> each -> generic InterestExpense; each flagged 'interest-amount-no-instrument'.\n- Implementation note: run this rule immediately after ctx-00012 detection and before any generic numeric-to-expense fallbacks; require logging for traceability and include test cases in regression suite."}], "added_content": ["[ctx-00016] helpful=0 harmful=0 :: ctx-00016 :: Multi-amount interest-charge -> InterestExpenseDebt (atomic heuristic)", "- Purpose: when a clause or sentence contains one interest lexical cue and one instrument-anchor but multiple currency amounts (e.g., amounts for multiple periods or enumerated amounts), assign each currency amount to the instrument-specific InterestExpenseDebt and attach the correct period metadata.", "- Exact lexical cues (case-insensitive): /interest\\s+charge(s)?\\b/, /interest\\s+expense(s)?\\b/, /interest\\s+on\\s+the\\s+(note|notes|loan|term\\s+loan|seller\\s+note|revolver)/i. Instrument-anchor detection: same instrument-name lexicons as ctx-00012 (Seller Notes, Term Loan, Revolver, Senior Notes, etc.) allowing antecedent resolution ±1 sentence and span <=40 tokens.", "- Multi-amount detection & association policy:", "  1) If a sentence/clause contains an interest lexical cue AND an instrument-anchor (same sentence OR antecedent ±1 sentence within 40 tokens) AND contains >=1 currency numeric token, then for EACH currency numeric token in that clause/sentence: assign InterestExpenseDebt linked to the detected instrument id."], "removed_content": []}
{"timestamp": "2026-02-06T11:23:14.454678", "step": 44, "playbook_before_length": 104658, "playbook_after_length": 109428, "lines_before": 352, "lines_after": 375, "added_lines": 22, "removed_lines": 0, "operations_count": 1, "operations": [{"type": "ADD", "section": "context_clues_and_indicators", "content": "ctx-SBC-00001 :: Share-based-compensation semantic-modifier precedence (atomic heuristic)\nPurpose: deterministically map numeric tokens in share-based compensation clauses to the most specific share-based XBRL element by prioritizing semantic modifiers (intrinsic, exercised, vest/vesting, up to/authorized) and plan anchors.\nRules (apply in order):\n1) Exact-modifier detection (case-insensitive regexes; exact-match first):\n   - INTRINSIC+EXERCISED cues -> /intrinsic\\s+value(?:\\s+of)?\\s+(?:the\\s+)?(?:options|option(s)?)\\s*(?:exercis(ed|ing|es)?)?/i\n   - VESTING-duration cues -> /(vest(?:s|ed|ing)?|vesting)\\b.*?(?:over|in|period|for)?|(?:for\\s+a\\s+period\\s+of)\\s*\\d+/i and year-token forms (see token forms below)\n   - AUTH/MAX/\"up to\" shares cues -> /(?:up\\s+to|maximum\\s+number|authorized\\s+to\\s+issue|may\\s+be\\s+delivered|authorized\\s+and\\s+reserved)\\b/i plus share token\n   - SHARES token -> /\\bshare(s)?\\b|shares\\s+available\\b|shares\\s+authorized\\b/i\n2) Token association windows: require the numeric token to co-occur within ±8 tokens of the detected semantic modifier cue in the same sentence for high-confidence mapping. Allow antecedent plan-anchor resolution from the previous sentence when the phrase 'the Plan' or a named plan is used (±1 sentence, antecedent span <= 40 tokens).\n3) Mapping decisions (highest-specificity-first):\n   a) If INTRINSIC+EXERCISED cue matches near numeric -> assign OptionsExercisesIntrinsicValue (the numeric is the total intrinsic value of options exercised). This mapping MUST override any generic monetary/expense tag.\n   b) Else if VESTING-duration cue matches and numeric is a year-duration token (e.g., 'three', '4', 'three- or four-year', token forms: /\\b\\d{1,3}\\b\\s*(?:-year|years?)|\\b(one|two|three|four|five|six|seven|eight|nine|ten)\\b\\s+years?\\b|\\bthree-\\s*or\\s*four-?year\\b/i) -> assign ShareBasedCompensationArrangementByShareBasedPaymentAwardAwardVestingPeriod1 (vest/vesting duration tag). Link time-unit 'years' metadata.\n   c) Else if AUTH/MAX/'up to' + SHARES cue matches near numeric and plan-anchor present (plan name or 'the Plan' antecedent) -> assign ShareBasedCompensationArrangementByShareBasedPaymentAwardNumberOfSharesAuthorized. If plan-anchor missing but 'up to' + shares present in same sentence and corporate-reserved cues (ESPP/common stock) absent, still assign authorized tag but mark 'no-plan-anchor' in log for QA.\n   d) Fallback: when share-count numeric occurs with plan-anchor and availability-language ('available', 'remain available') -> assign ShareBasedCompensationArrangementByShareBasedPaymentAwardNumberOfSharesAvailableForGrant (including denial-to-zero rules if negation present).\n4) Precedence & tie-breakers: when multiple candidate tags apply, prefer the candidate that encodes BOTH the metric and the semantic modifier (e.g., OptionsExercisesIntrinsicValue beats generic 'monetary amount' or generic 'share-based compensation expense'). Precedence order: INTRINSIC+EXERCISED mapping > VESTING-duration mapping (when duration attached to vest) > AUTH/MAX/'up to' authorized shares > plan-availability mappings > generic share/issuance tags.\n5) Negation and normalization: apply existing negation-to-zero rules (err-00002) for availability/authorized phrases when negation cues (no/none/not available/zero) appear within ±6 tokens of availability nouns and plan-anchor is present.\n6) Unit-tests (atomic examples to add):\n   - 'total intrinsic value of options exercised ... $37 million' -> $37,000,000 => OptionsExercisesIntrinsicValue\n   - 'awards vest over a three to four years period' -> 'three' and 'four' years => ShareBasedCompensationArrangementByShareBasedPaymentAwardAwardVestingPeriod1 (range handling: record as 3-4 years)\n   - 'up to 12.5 million shares ... allows for the grant under the Plan' -> 12,500,000 => ShareBasedCompensationArrangementByShareBasedPaymentAwardNumberOfSharesAuthorized\n   - 'no shares remain available under the 2014 Long Term Incentive Plan' -> 0 => ShareBasedCompensationArrangementByShareBasedPaymentAwardNumberOfSharesAvailableForGrant = 0 (negation logged)\n7) Logging & QA: every mapping must record numeric span, matched semantic-modifier span, plan-anchor span (if any), chosen tag, competing tags with score differences, and rule-id 'ctx-SBC-00001'. If plan-anchor is absent for an 'authorized' mapping or if multiple candidate tags score within threshold, flag 'sbc-modifier-ambiguous' and queue for human review.\n8) Implementation note: run this rule immediately after plan-anchor detection (ctx-00001/ctx-00007) and before generic lexical-to-tag fallbacks to prevent misclassification. Add the unit-tests above to regression suite and surface logged ambiguous cases for targeted retraining."}], "added_content": ["[ctx-00017] helpful=0 harmful=0 :: ctx-SBC-00001 :: Share-based-compensation semantic-modifier precedence (atomic heuristic)", "Purpose: deterministically map numeric tokens in share-based compensation clauses to the most specific share-based XBRL element by prioritizing semantic modifiers (intrinsic, exercised, vest/vesting, up to/authorized) and plan anchors.", "Rules (apply in order):", "1) Exact-modifier detection (case-insensitive regexes; exact-match first):", "   - INTRINSIC+EXERCISED cues -> /intrinsic\\s+value(?:\\s+of)?\\s+(?:the\\s+)?(?:options|option(s)?)\\s*(?:exercis(ed|ing|es)?)?/i"], "removed_content": []}
{"timestamp": "2026-02-06T11:25:39.029195", "step": 45, "playbook_before_length": 109428, "playbook_after_length": 115185, "lines_before": 375, "lines_after": 405, "added_lines": 28, "removed_lines": 0, "operations_count": 2, "operations": [{"type": "ADD", "section": "context_clues_and_indicators", "content": "ctx-DELTA-001 :: Atomic count-disambiguation: 'reportable segments' vs 'operating segments' (prevent over-generalization)\n- Purpose: when a cardinal word/number quantifies segments, prefer the most specific segment noun present in text. Prevent mapping 'reportable segments' counts to NumberOfOperatingSegments.\n- Exact lexical cues (case-insensitive): /reportable\\s+segment(s)?\\b/, /classified\\s+into\\s+reportable\\s+segment(s)?\\b/, /number\\s+of\\s+reportable\\s+segments\\b/, /reportable\\s+operating\\s+segment(s)?\\b/.\n- Association window: if a numeric cardinal token (word or digit) appears within ±8 tokens of any 'reportable' cue in the same sentence, assign NumberOfReportableSegments. Allow antecedent 'the reportable segments' resolved from previous sentence (±1 sentence, antecedent span <= 40 tokens) when anaphor present.\n- Tie-breaker / precedence: when both 'reportable' and 'operating segments' cues appear, prefer NumberOfReportableSegments. More generally, prefer the tag whose lexical noun phrase exactly matches the noun modifier (e.g., 'reportable' is more specific than 'operating').\n- Negative-prevention: do NOT map a count to NumberOfOperatingSegments when 'reportable' is present anywhere in the same clause or sentence. If 'operating segments' appears but 'reportable' appears only in a different clause and antecedent resolution confidence < threshold, flag as 'segment-count-ambiguous' for review instead of auto-mapping.\n- Unit-tests (atomic):\n  - \"The Company is classified into three reportable segments\" -> 3 => NumberOfReportableSegments.\n  - \"We operate in four operating segments; three are reportable\" -> 'three' => NumberOfReportableSegments (three attaches to 'reportable'); 'four' => NumberOfOperatingSegments if explicitly anchored.\n  - \"The number of reportable segments was three as of December 31\" -> 3 => NumberOfReportableSegments.\n- Logging: record matched cue-span ('reportable' span), numeric span, antecedent span (if used), chosen tag and 'ctx-DELTA-001'."}, {"type": "ADD", "section": "context_clues_and_indicators", "content": "ctx-DELTA-002 :: Atomic AOCI-reclassification -> CumulativeEffectOfNewAccountingPrincipleInPeriodOfAdoption (prevent tax-default on reclassifications)\n- Purpose: when a reclassification involving tax effects is described in connection with Accumulated Other Comprehensive Income (AOCI) and adoption/filing language is present, map to a cumulative-effect/adoption tag rather than routine IncomeTaxExpenseBenefit.\n- Strong lexical-conjunction pattern (case-insensitive) — require at least two of the following clusters (one MUST be the 'AOCI' cluster):\n  A) AOCI cluster: /Accumulated\\s+Other\\s+Comprehensive\\s+Income\\b|AOCI\\b|accumulated other comprehensive income/i\n  B) Reclassification cluster: /reclassif(?:y|ication|ied)\\b|reclassification\\s+entry\\b|reclassified\\b|reclassed\\b|reclass\\b/i\n  C) Stranded-tax cluster: /stranded\\s+tax(?:\\s+effect)?s?\\b|stranded\\s+taxes\\b|stranded\\s+tax\\s+effects\\b/i\n  D) Adoption/filing/timing cluster: /in\\s+period\\s+of\\s+adoption\\b|period\\s+of\\s+adoption\\b|on\\s+adoption\\b|adoption\\b|filed\\s+in\\s+the\\s+Annual\\s+Report\\b|Annual\\s+Report|effective\\s+upon\\s+adoption|one-?time\\s+adjustment\\b|cumulative\\s+effect\\b|transition\\b|upon\\s+adoption/i\n- Decision rule (apply in order):\n  1) If AOCI cluster present AND Reclassification cluster present AND (Stranded-tax cluster OR Adoption/filing cluster) present within same sentence OR within ±1 sentence antecedent resolution (antecedent span <= 40 tokens) -> assign CumulativeEffectOfNewAccountingPrincipleInPeriodOfAdoption (or the taxonomy's exact cumulative-adoption tag if available).\n  2) If AOCI + Reclassification present but neither Stranded-tax nor Adoption cues present -> DO NOT default to IncomeTaxExpenseBenefit; instead flag as 'AOCI-reclass-ambiguous' for human review (prefer human review to mis-mapping).\n  3) If AOCI + Reclassification + tax-word only (e.g., 'tax effects') but no adoption/filing signals, prefer CumulativeEffect tag only when explicit one-time/adoption cues (see cluster D) exist; otherwise queue for review.\n- Override of generic tax heuristics: when rule 1 matches, this mapping MUST override any IncomeTaxExpenseBenefit assignment even if 'income tax' or 'tax expense' literal appears near the numeric. Record that lexical 'tax' was observed and that cumulative-adoption override was applied.\n- Association windows: numeric currency token must be within ±12 tokens of at least one of the matched cluster cues; allow period mapping (year/filing note) via nearest-year-token within ±10 tokens.\n- Negative-prevention: do NOT assign IncomeTaxExpenseBenefit by default when 'reclassification' + 'AOCI' are present; instead apply this rule first. If adoption signals absent and ambiguity high, prefer human review rather than tax-expense fallback.\n- Example unit-tests (atomic):\n  - \"A reclassification of $280 of stranded tax effects from Accumulated Other Comprehensive Income was recorded on adoption and disclosed in the Annual Report\" -> $280 => CumulativeEffectOfNewAccountingPrincipleInPeriodOfAdoption.\n  - \"We recorded a reclassification entry in AOCI for stranded tax effects related to the post-retirement plan upon adoption\" -> reclassification amount => CumulativeEffectOfNewAccountingPrincipleInPeriodOfAdoption.\n  - \"AOCI reclassification of $X is reported (see filing)\" -> $X => CumulativeEffectOfNewAccountingPrincipleInPeriodOfAdoption (if filing/adoption signals detected) else flag 'AOCI-reclass-ambiguous'.\n- Logging & QA: record matched cluster spans, numeric span, chosen tag, whether IncomeTaxExpenseBenefit was suppressed, rule-id 'ctx-DELTA-002', and confidence. Queue 'AOCI-reclass-ambiguous' cases for human review and add to regression set."}], "added_content": ["[ctx-00018] helpful=0 harmful=0 :: ctx-DELTA-001 :: Atomic count-disambiguation: 'reportable segments' vs 'operating segments' (prevent over-generalization)", "- Purpose: when a cardinal word/number quantifies segments, prefer the most specific segment noun present in text. Prevent mapping 'reportable segments' counts to NumberOfOperatingSegments.", "- Exact lexical cues (case-insensitive): /reportable\\s+segment(s)?\\b/, /classified\\s+into\\s+reportable\\s+segment(s)?\\b/, /number\\s+of\\s+reportable\\s+segments\\b/, /reportable\\s+operating\\s+segment(s)?\\b/.", "- Association window: if a numeric cardinal token (word or digit) appears within ±8 tokens of any 'reportable' cue in the same sentence, assign NumberOfReportableSegments. Allow antecedent 'the reportable segments' resolved from previous sentence (±1 sentence, antecedent span <= 40 tokens) when anaphor present.", "- Tie-breaker / precedence: when both 'reportable' and 'operating segments' cues appear, prefer NumberOfReportableSegments. More generally, prefer the tag whose lexical noun phrase exactly matches the noun modifier (e.g., 'reportable' is more specific than 'operating')."], "removed_content": []}
{"timestamp": "2026-02-06T11:27:35.712366", "step": 46, "playbook_before_length": 115185, "playbook_after_length": 120022, "lines_before": 405, "lines_after": 435, "added_lines": 20, "removed_lines": 0, "operations_count": 1, "operations": [{"type": "ADD", "section": "context_clues_and_indicators", "content": "Delta rule: Plan-specific 'authorized under' -> ShareBasedCompensation NumberOfSharesAuthorized (atomic heuristic)\n\nPurpose: When a numeric share-count appears with 'authorized'/'authorized to issue'/'authorized to be issued' or the preposition 'under' that directly references a named plan (e.g., 'Dividend Reinvestment Plan', 'Stock Option Plan', 'the Plan'), map to ShareBasedCompensationArrangementByShareBasedPaymentAwardNumberOfSharesAuthorized rather than a generic CommonStockCapitalSharesReservedForFutureIssuance.\n\nExact lexical patterns (case-insensitive regexes; exact-match first):\n- authorized patterns: /\\bauthori(ze|s?ed)\\b(?:\\s+to\\s+(?:issue|be\\s+issued))?/i, /\\bmay\\s+be\\s+delivered\\b/i, /\\bmaximum\\s+number\\s+of\\s+shares\\b/i, /\\bup\\s+to\\b\\s+[0-9,]+\\s+shares\\b/i\n- 'under' plan pattern: /\\bunder\\s+(?:the\\s+)?([A-Z][A-Za-z0-9\\-\\s]{2,60}Plan|Dividend\\s+Reinvestment\\s+Plan|Employee\\s+Stock\\s+Purchase\\s+Plan|ESPP|stock\\s+plan|the\\s+Plan)\\b/i\n- plan-name detection variants: /\\b(Plan|LTIP|Long\\s+Term\\s+Incentive\\s+Plan|Stock\\s+Purchase\\s+Plan|Dividend\\s+Reinvestment\\s+Plan|ESPP)\\b/i\n\nAssociation windows & antecedent resolution:\n- High-confidence: numeric token within ±8 tokens of an 'authorized' cue AND the same clause contains an 'under <PlanName>' match -> assign ShareBasedCompensationArrangementByShareBasedPaymentAwardNumberOfSharesAuthorized.\n- Antecedent resolution: if 'the Plan' appears instead of the explicit name, allow antecedent plan-name resolution from the previous sentence within ±1 sentence (antecedent span <= 40 tokens). If antecedent resolves to a plan-like name, apply the same mapping.\n\nPrecedence / tie-breaker rules (apply before generic 'reserved' mapping):\n1) If ('authorized' OR 'maximum' OR 'up to') + 'under' + plan-anchor -> map to ShareBasedCompensationArrangementByShareBasedPaymentAwardNumberOfSharesAuthorized (force override of CommonStockCapitalSharesReservedForFutureIssuance).\n2) If 'reserved for future issuance' co-occurs with a plan-anchor but the plan-anchor is an ESPP or text explicitly references 'shares of common stock were initially reserved for issuance under the 2016 ESPP' -> map to CommonStockCapitalSharesReservedForFutureIssuance only when plan type is ESPP and language emphasizes corporate charter/issuance under ESPP; otherwise prefer plan-authorized tag when 'authorized' language present.\n3) If only 'reserved' + plan reference present and no 'authorized'/'maximum'/'up to' cues, prefer ShareBasedCompensationArrangementByShareBasedPaymentAwardNumberOfSharesAuthorized when award/instrument cues (option/award/RSU/available for grant) co-occur within ±8 tokens; if common-stock noun ('Class A common stock') or explicit charter/header mention occurs instead, prefer CommonStockCapitalSharesReservedForFutureIssuance.\n\nNegative-safeguard (prevent false-positive):\n- Do NOT map to plan-authorized tag when numeric is adjacent to corporate/charter headings ('under the charter', 'authorized by the certificate of incorporation') and no plan or award words appear within ±12 tokens. In such cases map to CommonStockCapitalSharesReservedForFutureIssuance.\n\nUnit-tests (atomic examples to add):\n- 'The Company is authorized to issue 1,000,000 shares of common stock to stockholders under the Dividend Reinvestment Plan.' -> 1,000,000 = ShareBasedCompensationArrangementByShareBasedPaymentAwardNumberOfSharesAuthorized (match 'authorized' + 'under <PlanName>').\n- 'Maximum number of shares that may be delivered under the Plan is 15,000,000.' -> 15,000,000 = ShareBasedCompensationArrangementByShareBasedPaymentAwardNumberOfSharesAuthorized.\n- 'A total of 3,800,000 shares of Class A common stock were initially reserved for issuance under the 2016 ESPP.' -> 3,800,000 = CommonStockCapitalSharesReservedForFutureIssuance (ESPP + 'Class A common stock' -> charter/ESPP exception).\n- 'Options to purchase 989,081 shares were authorized and reserved for future grant under the Plan.' -> 989,081 = ShareBasedCompensationArrangementByShareBasedPaymentAwardNumberOfSharesAuthorized (award cue + authorized + under Plan).\n\nLogging and QA: For every mapping made by this rule record: numeric span, matched 'authorized' cue span, matched 'under <PlanName>' span (or resolved antecedent), chosen tag, competing tag(s) with score differential, decision branch (precedence clause used), and a flag when an ESPP/charter exception applied. Queue ambiguous reserved+plan cases (no 'authorized' and conflicting cues) under 'reserved-plan-ambiguous' for human review.\n\nImplementation note: Insert this rule immediately after plan-anchor detection (ctx-00001/ctx-00007/ctx-DELTA rules) and BEFORE any generic 'reserved' -> CommonStockCapitalSharesReservedForFutureIssuance fallback to eliminate the misclassification observed in the reflection."}], "added_content": ["[ctx-00020] helpful=0 harmful=0 :: Delta rule: Plan-specific 'authorized under' -> ShareBasedCompensation NumberOfSharesAuthorized (atomic heuristic)", "Purpose: When a numeric share-count appears with 'authorized'/'authorized to issue'/'authorized to be issued' or the preposition 'under' that directly references a named plan (e.g., 'Dividend Reinvestment Plan', 'Stock Option Plan', 'the Plan'), map to ShareBasedCompensationArrangementByShareBasedPaymentAwardNumberOfSharesAuthorized rather than a generic CommonStockCapitalSharesReservedForFutureIssuance.", "Exact lexical patterns (case-insensitive regexes; exact-match first):", "- authorized patterns: /\\bauthori(ze|s?ed)\\b(?:\\s+to\\s+(?:issue|be\\s+issued))?/i, /\\bmay\\s+be\\s+delivered\\b/i, /\\bmaximum\\s+number\\s+of\\s+shares\\b/i, /\\bup\\s+to\\b\\s+[0-9,]+\\s+shares\\b/i", "- 'under' plan pattern: /\\bunder\\s+(?:the\\s+)?([A-Z][A-Za-z0-9\\-\\s]{2,60}Plan|Dividend\\s+Reinvestment\\s+Plan|Employee\\s+Stock\\s+Purchase\\s+Plan|ESPP|stock\\s+plan|the\\s+Plan)\\b/i"], "removed_content": []}
{"timestamp": "2026-02-06T11:29:12.241405", "step": 47, "playbook_before_length": 120022, "playbook_after_length": 123657, "lines_before": 435, "lines_after": 450, "added_lines": 14, "removed_lines": 0, "operations_count": 1, "operations": [{"type": "ADD", "section": "context_clues_and_indicators", "content": "[ctx-00021] helpful=0 harmful=0 :: Atomic heuristic: Map percentage tokens that express an effective income tax rate -> EffectiveIncomeTaxRateContinuingOperations\n- Purpose: deterministically map percents that denote the company's effective income tax rate (including continuing-operations qualifiers and prior-period variants) to the canonical EffectiveIncomeTaxRateContinuingOperations tag and avoid mis-mapping to generic percentage tags.\n- Exact lexical cues (case-insensitive regexes; apply exact-match first): /effective\\s+tax\\s+rate\\b/, /effective\\s+income\\s+tax\\s+rate\\b/, /effective\\s+rate\\s+of\\s+income\\s+tax(es)?\\b/, /income\\s+tax\\s+rate\\b/, /effective\\s+tax\\s+rate\\s+for\\s+continuing\\s+operations\\b/, /effective\\s+rate\\b.*?for\\s+income\\s+tax(es)?/i.\n- Association window: require the percentage token (forms: '\\d+(?:\\.\\d+)?%','\\d+\\.\\d+\\s+percent') to co-occur within ±6 tokens of one of the lexical cues above in the same sentence. Allow antecedent resolution to previous sentence (±1 sentence) only when anaphoric phrases like 'the effective rate'/'the rate' appear and antecedent span <= 40 tokens.\n- Precedence & override: when this rule matches, assign EffectiveIncomeTaxRateContinuingOperations and override any generic percentage-to-percentage-tag fallbacks (e.g., generic 'Percentage' tags) or unrelated percent heuristics (spreads, concentration) even if other percent cues exist. If co-occurring text mentions 'statutory', prefer a statutory-rate-specific tag if that exact taxonomy element exists; otherwise, prefer EffectiveIncomeTaxRateContinuingOperations only when 'effective' cue present.\n- Prior-period and multi-value handling: when sentence lists multiple percentages with period labels (e.g., '22.31%, 23.45% and 24.50% for 2019, 2018 and 2017'), map each percent to EffectiveIncomeTaxRateContinuingOperations with corresponding period metadata by nearest-year-token association (±6 tokens) or left-to-right pairing when explicit years are comma-aligned. Do not change tag by period — use same tag with period attribute.\n- Negative/false-positive prevention: do NOT map a percent to the effective-tax tag when the percent is clearly modifying non-tax nouns (examples to block): '/% of revenue|% of sales|% of our shareholders|percentage of shares outstanding|% owned by/'. Require presence of a tax lexical anchor (one of the regexes above) to map; otherwise do not auto-assign EffectiveIncomeTaxRateContinuingOperations.\n- Unit-tests (atomic examples):\n  - 'The effective tax rate was 22.31% for the year' -> 22.31% => EffectiveIncomeTaxRateContinuingOperations.\n  - 'Effective income tax rate: 22.31% (2019)' -> 22.31% => EffectiveIncomeTaxRateContinuingOperations (attach 2019).\n  - 'The effective rate of income taxes for continuing operations was 22.31%.' -> 22.31% => EffectiveIncomeTaxRateContinuingOperations.\n  - 'Statutory tax rate was 21%' -> do NOT map to EffectiveIncomeTaxRateContinuingOperations; map to StatutoryIncomeTaxRate if present, else flag for review.\n  - '22.31% of our revenues came from X' -> do NOT map (missing tax anchor) and flag/skip.\n- Logging & QA: log percent token span, matched tax-anchor span, chosen tag, period metadata (if any) and rule-id 'ctx-00021'. If antecedent resolution used or if mapping overrode a competing percent heuristic, record 'override-reason' in log. Add any ambiguous/no-anchor percent examples to retraining queue.\n- Implementation note: run this rule before generic percentage fallbacks and after tax-line polarity heuristics (ctx-00003) to ensure tax-rate percents are recognized and tagged consistently."}], "added_content": ["[ctx-00021] helpful=0 harmful=0 :: [ctx-00021] helpful=0 harmful=0 :: Atomic heuristic: Map percentage tokens that express an effective income tax rate -> EffectiveIncomeTaxRateContinuingOperations", "- Purpose: deterministically map percents that denote the company's effective income tax rate (including continuing-operations qualifiers and prior-period variants) to the canonical EffectiveIncomeTaxRateContinuingOperations tag and avoid mis-mapping to generic percentage tags.", "- Exact lexical cues (case-insensitive regexes; apply exact-match first): /effective\\s+tax\\s+rate\\b/, /effective\\s+income\\s+tax\\s+rate\\b/, /effective\\s+rate\\s+of\\s+income\\s+tax(es)?\\b/, /income\\s+tax\\s+rate\\b/, /effective\\s+tax\\s+rate\\s+for\\s+continuing\\s+operations\\b/, /effective\\s+rate\\b.*?for\\s+income\\s+tax(es)?/i.", "- Association window: require the percentage token (forms: '\\d+(?:\\.\\d+)?%','\\d+\\.\\d+\\s+percent') to co-occur within ±6 tokens of one of the lexical cues above in the same sentence. Allow antecedent resolution to previous sentence (±1 sentence) only when anaphoric phrases like 'the effective rate'/'the rate' appear and antecedent span <= 40 tokens.", "- Precedence & override: when this rule matches, assign EffectiveIncomeTaxRateContinuingOperations and override any generic percentage-to-percentage-tag fallbacks (e.g., generic 'Percentage' tags) or unrelated percent heuristics (spreads, concentration) even if other percent cues exist. If co-occurring text mentions 'statutory', prefer a statutory-rate-specific tag if that exact taxonomy element exists; otherwise, prefer EffectiveIncomeTaxRateContinuingOperations only when 'effective' cue present."], "removed_content": []}
{"timestamp": "2026-02-06T11:30:25.398305", "step": 48, "playbook_before_length": 123657, "playbook_after_length": 129290, "lines_before": 450, "lines_after": 475, "added_lines": 25, "removed_lines": 0, "operations_count": 1, "operations": [{"type": "ADD", "section": "context_clues_and_indicators", "content": "Equity numeric-type + class-binding (atomic heuristic): Purpose: deterministically distinguish par/stated-value numbers from share-counts and bind each numeric to the correct equity-class tag (Common vs Preferred) when multiple equity-class mentions occur. Rules (apply in order):\n1) Numeric-type detection (exact lexical + format cues):\n   - Par/stated-value cues: exact lexical patterns (case-insensitive): /par\\s+value(?:\\s+per\\s+share)?/, /stated\\s+value(?:\\s+per\\s+share)?/, /par\\s+value\\s+of\\s+/; also explicit 'per share' or 'per common share' tokens. If such a cue appears in same sentence and a numeric token is within ±8 tokens, map numeric -> ParOrStatedValue tag for the relevant class.\n   - Par-value numeric format: decimals or currency amounts < 1 (e.g., 0.0001, $0.01) or decimals with leading zero are strong par-value signals when 'per share' present. Treat decimals <= 0.01 as HIGH-confidence par values if paired with 'per share' even when $ absent (e.g., '0.0001 par value per share').\n   - Share-count cues: lexical tokens /shares\\b/, /shares\\s+authorized\\b/, /authorized\\s+to\\s+issue\\s+up\\s+to/, /issued\\s+and\\s+outstanding/ within ±8 tokens of numeric; integer formats (no decimal point, may include commas) strongly indicate share counts.\n2) Class-binding (map to class-specific tag):\n   - Class anchors: detect stock-class nouns (case-insensitive) within same clause: /common stock|preferred stock|Class\\s+[A-Z]|Series\\s+[A-Z]|depositary share(s)?|par value per share of common stock/. If a class token appears within same sentence, prefer binding numeric to that class-specific tag variant (e.g., CommonStockParOrStatedValuePerShare, PreferredStockSharesAuthorized).\n   - Locality & precedence: primary association window = same clause / ±8 tokens. If multiple class tokens appear in same sentence, choose the class token with smallest token-distance to the numeric. If distances equal, prefer explicit 'of <class>' or 'shares of <class>' phrasing to bind (scan for /shares\\s+of\\s+(common|preferred)/ within clause). If still tied, use grammatical relation if parser available (numeric nummod attaches to noun phrase); otherwise flag for human review.\n3) Tag assignment mapping (explicit):\n   - If par/stated-value cue matched -> assign <Class>ParOrStatedValuePerShare (e.g., CommonStockParOrStatedValuePerShare or PreferredStockParOrStatedValuePerShare) using class-binding above.\n   - If share-count cue matched and class-binding identifies preferred/common -> assign <Class>SharesAuthorized (if 'authorize'/'authorized' anchor present) or <Class>SharesOutstanding / StockIssuedDuringPeriod... depending on issuance vs authorized cues (respect existing issuance/plan rules). Prefer Authorized tag when 'authorized' or 'authorize us to issue up to' present.\n4) Mixed-clause tie-breakers (multiple numbers + multiple classes):\n   - If a clause contains both a small decimal near 'per share' and a large integer near 'authorized' -> decimal -> ParOrStatedValue tag; integer -> SharesAuthorized tag. Enforce numeric-format sanity-check: decimals map to per-share value; integers map to counts.\n   - If two integers appear and two classes appear but ordering ambiguous, bind each integer to the nearest class token by token-distance; if both integers are identical magnitude or equidistant, prefer explicit class labeling order: when clause enumerates 'preferred stock: X shares; common stock: Y shares' parse label-order pairing left-to-right.\n5) Plan & charter exceptions: if plan-anchor or 'under the Plan' appears and 'authorized' token co-occurs, follow plan-specific authorized-vs-reserved rules (ctx-00007 / ctx-00020) after class-binding; do NOT convert plan-authorized numbers into CommonStockCapitalSharesReservedForFutureIssuance if text explicitly references a Plan-authorized 'shares' count for awards (use plan rules precedence).\n6) Edge/normalization rules:\n   - Accept decimal par values with or without a leading '$'. Normalize numeric to canonical decimal (e.g., '0.0001' -> 0.0001) and record unit 'per share'.\n   - Recognize 'no par value' / 'without par value' phrases: map to a 'NoParValue' flag on the equity instrument (do not assign ParOrStatedValue tag).\n7) Ambiguity & QA handling: when class-binding confidence < threshold (e.g., no class token within ±12 tokens and numeric format ambiguous) -> do NOT auto-assign class-specific tag; flag 'equity-class-binding-ambiguous' with spans for human review. Log both numeric span and nearest class spans and decision reason for traceability.\n8) Minimal unit-tests (atomic examples to add):\n   - 'The par value per share of common stock is $0.0001.' -> 0.0001 => CommonStockParOrStatedValuePerShare.\n   - 'The corporation is authorized to issue up to 10,000,000 shares of preferred stock.' -> 10,000,000 => PreferredStockSharesAuthorized.\n   - 'The Company has authorized 100,000,000 shares of common stock, par value $0.0001 per share.' -> 100,000,000 => CommonStockSharesAuthorized; 0.0001 => CommonStockParOrStatedValuePerShare.\n   - 'Authorized us to issue up to 5,000,000 shares of Series A preferred and 50,000,000 shares of Class A common.' -> 5,000,000 => PreferredStockSharesAuthorized; 50,000,000 => CommonStockSharesAuthorized (left-to-right class-pairing / nearest-binding).\n9) Implementation notes: run this rule early in equity/plan pipeline before generic 'per share' -> SaleOfStockPricePerShare and before nearest-lexical-match fallbacks. Record mapping provenance: numeric span, matched cue span ('par value' or 'shares authorized'), class token span, chosen tag, and confidence score."}], "added_content": ["[ctx-00022] helpful=0 harmful=0 :: Equity numeric-type + class-binding (atomic heuristic): Purpose: deterministically distinguish par/stated-value numbers from share-counts and bind each numeric to the correct equity-class tag (Common vs Preferred) when multiple equity-class mentions occur. Rules (apply in order):", "1) Numeric-type detection (exact lexical + format cues):", "   - Par/stated-value cues: exact lexical patterns (case-insensitive): /par\\s+value(?:\\s+per\\s+share)?/, /stated\\s+value(?:\\s+per\\s+share)?/, /par\\s+value\\s+of\\s+/; also explicit 'per share' or 'per common share' tokens. If such a cue appears in same sentence and a numeric token is within ±8 tokens, map numeric -> ParOrStatedValue tag for the relevant class.", "   - Par-value numeric format: decimals or currency amounts < 1 (e.g., 0.0001, $0.01) or decimals with leading zero are strong par-value signals when 'per share' present. Treat decimals <= 0.01 as HIGH-confidence par values if paired with 'per share' even when $ absent (e.g., '0.0001 par value per share').", "   - Share-count cues: lexical tokens /shares\\b/, /shares\\s+authorized\\b/, /authorized\\s+to\\s+issue\\s+up\\s+to/, /issued\\s+and\\s+outstanding/ within ±8 tokens of numeric; integer formats (no decimal point, may include commas) strongly indicate share counts."], "removed_content": []}
{"timestamp": "2026-02-06T11:32:42.333191", "step": 49, "playbook_before_length": 129290, "playbook_after_length": 135336, "lines_before": 475, "lines_after": 505, "added_lines": 28, "removed_lines": 0, "operations_count": 2, "operations": [{"type": "ADD", "section": "context_clues_and_indicators", "content": "Share-based-compensation exact-lexical override (atomic heuristic):\n- Purpose: choose the literal ShareBasedCompensation taxonomy element when the sentence literally names recognized share-based compensation, and only prefer Allocated/Expense variants if allocation/expense-location qualifiers appear.\n- Exact lexical detection (case-insensitive regexes): /\\bshare-?based\\s+compensation\\b/, /recognized\\s+non-?cash\\s+share-?based\\s+compensation\\b/, /amounts\\s+recognized\\s+for\\s+share-?based\\s+compensation\\b/.\n- Allocation/expense qualifiers (must be present to select Allocated/Expense variant): /\\ballocat(ed|ion)\\b/, /\\bincluded\\s+in\\s+((costs|cost)\\s+of\\s+goods|selling,? general and administrative|operating\\s+expenses|research and development)\\b/, /\\bexpense(?:s)?\\b|compensation\\s+expense|recognized\\s+as\\s+expense/ (±8 tokens of numeric/token).\n- Decision flow (apply in order):\n  1) If share-based lexical detection matches near numeric (±8 tokens) AND taxonomy contains an exact element named 'ShareBasedCompensation' -> assign ShareBasedCompensation.\n  2) Exception: if allocation/expense qualifiers match in same sentence and are within ±12 tokens of numeric, THEN prefer AllocatedShareBasedCompensationExpense (or other 'Allocated/Expense' taxonomy candidate) but only when qualifier lexical match is explicit (see patterns above).\n  3) If both ShareBasedCompensation and an Allocated/Expense candidate exist but no explicit allocation/expense qualifier present -> prefer ShareBasedCompensation (literal-match override).\n- Association & antecedent: allow antecedent resolution ±1 sentence for anaphors ('these amounts','the foregoing compensation') if antecedent contains the share-based lexical cue; require antecedent span <=40 tokens.\n- Logging: record matched lexical spans, chosen tag, competing candidate tags and whether override applied ('literal-sharebased-over-allocated').\n- Unit-tests (atomic):\n  - 'recognized non-cash share compensation of $3.1, $3.6 and $2.9 million' -> each amount = ShareBasedCompensation.\n  - 'Total share-based compensation expense recognized in the period was $5.0 million' -> because 'compensation expense' qualifier present => AllocatedShareBasedCompensationExpense.\n  - 'We recognized $X of share-based compensation included in operating expenses' -> AllocatedShareBasedCompensationExpense (allocation/location present).\n- Implementation note: run this rule immediately after lexical candidate generation and before ctx-00002's blanket income-statement-preference so that literal taxonomy names are preferred unless explicit allocation/expense qualifiers exist."}, {"type": "ADD", "section": "context_clues_and_indicators", "content": "Nonvested-awards instrument-type suffix enforcement (atomic heuristic):\n- Purpose: when mapping 'unrecognized' / 'not yet recognized' compensation (nonvested awards), require matching any instrument-type suffix in taxonomy (e.g., 'ShareBasedAwardsOtherThanOptions') if the sentence lexically indicates awards other than options; otherwise map to the generic nonvested tag.\n- Exact lexical detection (case-insensitive regexes): UNRECOGNIZED cues = /unrecognized\\s+compensation\\s+expense|compensation\\s+not\\s+yet\\s+recognized|total\\s+compensation\\s+cost\\s+not\\s+yet\\s+recognized|compensation\\s+costs\\s+not\\s+yet\\s+recognized/; NON-OPTION INSTRUMENT cues = /other\\s+than\\s+options|awards\\s+other\\s+than\\s+options|restricted\\s+stock\\s+unit(s)?|RSU(s)?|unit\\s+appreciation\\s+right(s)?|UARs?|SARs?|dividend\\s+equivalent\\s+units?/.\n- Decision flow (apply in order):\n  1) If UNRECOGNIZED cue matches near numeric (±8 tokens) AND taxonomy contains a specific nonvested-awards element with suffix 'ShareBasedAwardsOtherThanOptions' (or similar exact string) AND NON-OPTION INSTRUMENT cue matches in same sentence or antecedent (±1 sentence) -> assign the specific element (e.g., EmployeeServiceShareBasedCompensationNonvestedAwardsTotalCompensationCostNotYetRecognizedShareBasedAwardsOtherThanOptions).\n  2) Else if UNRECOGNIZED cue matches but NO non-option instrument lexical cue present -> assign the generic nonvested-awards element (e.g., EmployeeServiceShareBasedCompensationNonvestedAwardsTotalCompensationCostNotYetRecognized) if present.\n  3) Else if NON-OPTION instrument cue present but UNRECOGNIZED cue absent, do not force nonvested mapping — prefer instrument-specific grants/outstanding mapping rules (ctx-00008/ctx-SBC-00001) depending on action verbs.\n- Association & antecedent: allow antecedent instrument-type resolution up to ±1 sentence (antecedent span <=40 tokens) when anaphors like 'these awards' or 'such awards' appear.\n- Tie-breaker: prefer taxonomy element whose suffix exactly matches the instrument-class wording present in text ('OtherThanOptions' exact-match) over generic nonvested tag. If exact-suffix element is present but text only weakly implies non-options (e.g., mentions 'units' without explicit 'other than options'), require instrument cue match within ±5 tokens to choose suffixed element; otherwise choose generic nonvested.\n- Logging & QA: record UNRECOGNIZED cue span, NON-OPTION instrument span, chosen tag and competing tag names, and whether suffix-exact match applied. Flag cases where taxonomy contains suffixed element but no instrument cue matched as 'sbc-suffix-missing-cue' for human review.\n- Unit-tests (atomic):\n  - 'Unrecognized compensation expense related to nonvested awards of $1.0, $1.2 and $2.1 million' with preceding phrase 'awards other than options' -> each amount => EmployeeService...NotYetRecognizedShareBasedAwardsOtherThanOptions.\n  - 'Unrecognized compensation expense of $2.0 for nonvested RSUs' -> $2.0 => use suffixed non-option taxonomy element.\n  - 'Compensation costs not yet recognized for nonvested awards totaled $X' (no instrument-type stated) -> assign generic nonvested-not-yet-recognized element.\n- Implementation note: place this rule after nonvested lexical detection and before any nearest-lexical fallback so taxonomy suffixes are selected when explicitly supported by text."}], "added_content": ["[ctx-00023] helpful=0 harmful=0 :: Share-based-compensation exact-lexical override (atomic heuristic):", "- Purpose: choose the literal ShareBasedCompensation taxonomy element when the sentence literally names recognized share-based compensation, and only prefer Allocated/Expense variants if allocation/expense-location qualifiers appear.", "- Exact lexical detection (case-insensitive regexes): /\\bshare-?based\\s+compensation\\b/, /recognized\\s+non-?cash\\s+share-?based\\s+compensation\\b/, /amounts\\s+recognized\\s+for\\s+share-?based\\s+compensation\\b/.", "- Allocation/expense qualifiers (must be present to select Allocated/Expense variant): /\\ballocat(ed|ion)\\b/, /\\bincluded\\s+in\\s+((costs|cost)\\s+of\\s+goods|selling,? general and administrative|operating\\s+expenses|research and development)\\b/, /\\bexpense(?:s)?\\b|compensation\\s+expense|recognized\\s+as\\s+expense/ (±8 tokens of numeric/token).", "- Decision flow (apply in order):"], "removed_content": []}
{"timestamp": "2026-02-06T11:34:19.232650", "step": 50, "playbook_before_length": 135336, "playbook_after_length": 139999, "lines_before": 505, "lines_after": 538, "added_lines": 23, "removed_lines": 0, "operations_count": 1, "operations": [{"type": "ADD", "section": "context_clues_and_indicators", "content": "ctx-DELTA-FACILITY-INSTRUMENT-ATTACHMENT :: Atomic heuristic — Require head-noun attachment before applying 'capacity' vs 'instrument' numeric mappings.\n\nPurpose: Prevent blanket mapping of surface cues like 'up to $X' to LineOfCreditFacilityMaximumBorrowingCapacity by forcing a syntactic/semantic attachment check to determine whether the amount modifies a facility or a distinct debt instrument/tranche.\n\nExact lexical cue sets (case-insensitive):\n- Facility anchors (map currency -> LineOfCreditFacilityMaximumBorrowingCapacity if the numeric attaches to these): /\\b(revolv(?:ing)?\\s+credit\\s+facilit(?:y|ies)|credit\\s+facility|revolver|line\\s+of\\s+credit|facility\\s+commitment|commitment\\b|in\\s+an\\s+aggregate\\s+principal\\s+amount\\b)/i\n- Instrument/tranche anchors (map currency -> DebtInstrumentFaceAmount if numeric attaches): /\\b(tranche\\b|Tranche\\s+[A-Za-z0-9]|term\\s+loan|loan\\b|note\\b|notes\\b|note\\s+series|senior\\s+notes|seller\\s+note|principal\\s+amount\\s+of\\s+the\\s+loan|loan\\s+facility\\s+tranche)/i\n- 'Up to' / capacity lexical: /\\bup\\s+to\\b|\\bmaximum\\s+amount\\b|\\bin\\s+an\\s+aggregate\\s+principal\\s+amount\\b|commitment\\b/i\n\nAttachment & association procedure (apply in order):\n1) Parse-first: if a dependency parse is available, find the numeric token's syntactic governor (the head noun the numeric modifes). If the governor token matches Facility anchors -> map numeric to LineOfCreditFacilityMaximumBorrowingCapacity. If governor matches Instrument anchors -> map numeric to DebtInstrumentFaceAmount (or the instrument-level tag that best matches taxonomy).\n\n2) Fallback lexical-window (no full parse): search same sentence for nearest noun phrase within ±6 tokens of the numeric that matches either Facility anchors or Instrument anchors. If both anchor types appear within window, choose the anchor with the smallest token-distance to the numeric; if distances equal prefer Instrument anchors only if the noun phrase explicitly contains 'Tranche', 'Loan', 'Note', or 'term loan'; otherwise prefer Facility anchors when the exact phrase 'facility', 'revolver', 'line of credit' is present.\n\n3) Antecedent resolution: allow antecedent anchor in immediately preceding sentence (±1 sentence) when anaphoric phrase (the facility, the agreement, the loan, the Tranche A loan) appears; antecedent span <= 40 tokens. Use antecedent anchor only if no clearer same-sentence anchor found.\n\n4) 'Up to' heuristic gating: only apply 'up to' -> LineOfCreditFacilityMaximumBorrowingCapacity when step (1)-(3) confirms the numeric attaches to a Facility anchor. Do NOT apply 'up to' as an unconditional rule.\n\n5) Precedence & overrides:\n- If governor/nearest anchor == facility: assign LineOfCreditFacilityMaximumBorrowingCapacity (override generic 'outstanding' or 'availability' rules only if lexical evidence indicates cap/commitment). Log anchor span.\n- If governor/nearest anchor == instrument/tranche: assign DebtInstrumentFaceAmount (or instrument-specific face/commitment tag) even if 'up to' or 'aggregate principal amount' appears; log instrument id/phrase.\n- If both anchors present and ambiguity persists after token-distance and anchor-type tie-breakers: do NOT auto-assign; flag 'facility-instrument-attachment-ambiguous' and queue for human review.\n\n6) Token normalization & unit-tests (atomic examples to add):\n- 'a secured revolving credit facility of up to $335.0 million' -> $335.0 = LineOfCreditFacilityMaximumBorrowingCapacity.\n- 'a Tranche A loan of $16.0 million' (or 'Tranche A loan in the amount of $16.0 million') -> $16.0 = DebtInstrumentFaceAmount.\n- 'up to $50.0 million for Tranche B loans' -> $50.0 = DebtInstrumentFaceAmount (Tranche-level) NOT facility capacity.\n- 'the revolver, in an aggregate principal amount of up to $225.0 million' -> $225.0 = LineOfCreditFacilityMaximumBorrowingCapacity.\n- 'the commitment under the facility is up to $X; outstanding letters of credit totaled $Y' -> X->MaxBorrowingCapacity; Y->LettersOfCreditOutstandingAmount.\n\n7) Logging & QA: always record numeric span, chosen anchor span, parse-governor (if used), rule-id 'ctx-DELTA-FACILITY-INSTRUMENT-ATTACHMENT', decision branch, and confidence. Accumulate 'facility-instrument-attachment-ambiguous' cases into a focused annotation set to reduce parser fallback reliance.\n\nImplementation note: insert this rule into the numeric-to-debt/facility mapping stage and run before any unconditional 'up to' -> capacity mapping. Enforce this as a gating rule in rule-based pipelines and as a strong feature in ML classifiers (feature: head-noun-type = facility/instrument) to prevent the overgeneralization observed."}], "added_content": ["[ctx-00025] helpful=0 harmful=0 :: ctx-DELTA-FACILITY-INSTRUMENT-ATTACHMENT :: Atomic heuristic — Require head-noun attachment before applying 'capacity' vs 'instrument' numeric mappings.", "Purpose: Prevent blanket mapping of surface cues like 'up to $X' to LineOfCreditFacilityMaximumBorrowingCapacity by forcing a syntactic/semantic attachment check to determine whether the amount modifies a facility or a distinct debt instrument/tranche.", "Exact lexical cue sets (case-insensitive):", "- Facility anchors (map currency -> LineOfCreditFacilityMaximumBorrowingCapacity if the numeric attaches to these): /\\b(revolv(?:ing)?\\s+credit\\s+facilit(?:y|ies)|credit\\s+facility|revolver|line\\s+of\\s+credit|facility\\s+commitment|commitment\\b|in\\s+an\\s+aggregate\\s+principal\\s+amount\\b)/i", "- Instrument/tranche anchors (map currency -> DebtInstrumentFaceAmount if numeric attaches): /\\b(tranche\\b|Tranche\\s+[A-Za-z0-9]|term\\s+loan|loan\\b|note\\b|notes\\b|note\\s+series|senior\\s+notes|seller\\s+note|principal\\s+amount\\s+of\\s+the\\s+loan|loan\\s+facility\\s+tranche)/i"], "removed_content": []}
{"timestamp": "2026-02-06T11:36:06.622154", "step": 51, "playbook_before_length": 139999, "playbook_after_length": 144055, "lines_before": 538, "lines_after": 562, "added_lines": 16, "removed_lines": 0, "operations_count": 1, "operations": [{"type": "ADD", "section": "context_clues_and_indicators", "content": "[err-00026] helpful=0 harmful=0 :: Atomic rule: 'charged to expense' / 'recognized as expense' -> prefer Cost/Expense taxonomy tags (require exact-tag verification)\n\nPurpose: Prevent mapping expense-recognition lexical cues to contribution/cash tags by forcing exact-tag-name verification and semantic-tie-breakers.\n\nExact lexical expense cues (case-insensitive regexes; match first): /charged\\s+to\\s+expense\\b/, /charged\\s+to\\s+expense\\s+in\\s+continuing\\s+operations\\b/, /recognized\\s+as\\s+expense\\b/, /recognized\\s+as\\s+cost\\b/, /included\\s+in\\s+(operating\\s+expenses|selling,?\\s+general\\s+and\\s+administrative)/i, /expense\\s+recognized\\b/, /amounts\\s+charged\\s+to\\s+expense\\b/.\n\nAssociation window: require the expense cue to co-occur in the same sentence as the numeric token or within ±8 tokens of the numeric. Allow antecedent 'the amount' anaphora across ±1 sentence only if antecedent span <= 40 tokens and explicit 'expense' anchor appears.\n\nTag-selection algorithm (apply in order):\n1) Candidate discovery: from the provided taxonomy list, search for exact tag string 'DefinedContributionPlanCostRecognized' (literal) when the plan anchor 'DefinedContributionPlan' is detected. If present -> assign it.\n2) If exact string not found, search taxonomy candidate tags for ANY tag whose preferred label or definition contains BOTH: a) the plan anchor (e.g., 'DefinedContributionPlan') OR a close plan synonym; AND b) one of the expense-identifiers 'Cost', 'CostRecognized', 'Expense', 'ChargedToExpense', 'RecognizedAsExpense' (case-insensitive substring match). Prefer exact 'CostRecognized' over generic 'Cost' if both exist.\n3) Tie-breaker: if taxonomy contains both a Contributions tag (e.g., DefinedContributionPlanContributionsByEmployer) and a Cost/Expense-tag candidate, and the sentence matched an expense lexical cue (above), select the Cost/Expense-tag. Log the tie-break selection.\n4) Exception (use Contributions tag only): if the sentence explicitly uses contribution language (regexes: /contribution(s)?\\b/, /contributed\\b/, /employer\\s+contribution(s)?\\b/, /contributions\\s+by\\s+the\\s+employer\\b/) within ±8 tokens of the numeric, prefer ContributionsByEmployer tag instead.\n5) Safe-fallback: if no Cost/Expense-tag exists in provided taxonomy and contribution keywords are NOT explicit, DO NOT auto-assign ContributionsByEmployer; instead flag the numeric as 'expense-vs-contribution-missing-cost-tag' and queue for human review (do NOT map to Contributions automatically).\n\nLogging & provenance: record matched expense lexical cue span, matched plan-anchor span (if any), taxonomy search results (exact-match found / candidates list), chosen tag name, decision-branch id (1..5), and reason string. If rule deferred to human review, include suggested tag names and why exact tag was missing.\n\nUnit-tests (atomic examples to add):\n- 'Amounts charged to expense in continuing operations for defined contribution plans totaled $57 million in 2018, $43 million in 2017 and $44 million in 2016.' -> map 57, 43, 44 -> DefinedContributionPlanCostRecognized (exact-tag present). Log matched cue 'charged to expense'.\n- 'Employer contributions to defined contribution plans were $20 in 2019' -> map -> DefinedContributionPlanContributionsByEmployer (explicit 'contributions' cue).\n- 'The amounts were recognized as expense under defined contribution plans: $5.' -> map -> DefinedContributionPlanCostRecognized (expense cue, prefer cost tag).\n- 'The plan had $X of contributions by the employer and $Y charged to expense' -> ensure $Y maps to CostRecognized, $X maps to ContributionsByEmployer.\n\nImplementation notes: run this rule immediately after plan-anchor detection and before any generic semantic-similarity / nearest-lexical-match fallbacks. Enforce exact-string lookup of candidate taxonomy tags; if the preferred Cost/Expense tag is absent, prefer human-review rather than mislabeling as Contributions. Add all logged 'expense-vs-contribution-missing-cost-tag' cases to retraining/regression suite."}], "added_content": ["[ctx-00026] helpful=0 harmful=0 :: [err-00026] helpful=0 harmful=0 :: Atomic rule: 'charged to expense' / 'recognized as expense' -> prefer Cost/Expense taxonomy tags (require exact-tag verification)", "Purpose: Prevent mapping expense-recognition lexical cues to contribution/cash tags by forcing exact-tag-name verification and semantic-tie-breakers.", "Exact lexical expense cues (case-insensitive regexes; match first): /charged\\s+to\\s+expense\\b/, /charged\\s+to\\s+expense\\s+in\\s+continuing\\s+operations\\b/, /recognized\\s+as\\s+expense\\b/, /recognized\\s+as\\s+cost\\b/, /included\\s+in\\s+(operating\\s+expenses|selling,?\\s+general\\s+and\\s+administrative)/i, /expense\\s+recognized\\b/, /amounts\\s+charged\\s+to\\s+expense\\b/.", "Association window: require the expense cue to co-occur in the same sentence as the numeric token or within ±8 tokens of the numeric. Allow antecedent 'the amount' anaphora across ±1 sentence only if antecedent span <= 40 tokens and explicit 'expense' anchor appears.", "Tag-selection algorithm (apply in order):"], "removed_content": []}
{"timestamp": "2026-02-06T11:38:17.499470", "step": 52, "playbook_before_length": 144055, "playbook_after_length": 149230, "lines_before": 562, "lines_after": 595, "added_lines": 23, "removed_lines": 0, "operations_count": 1, "operations": [{"type": "ADD", "section": "context_clues_and_indicators", "content": "id: ctx-DELTA-LEASE-0001 :: Event-driven override: map \"lease charges\" tied to closures/exit/impairment -> RestructuringCharges\n\nPurpose: Prevent blanket mapping of any phrase containing 'lease' or 'lease charge(s)' to OperatingLeaseExpense when the amount is part of closure/exit/restructuring activity or presented together with impairment/exit charges.\n\nExact lexical/event cues (case-insensitive regexes; require at least one closure/exit/impairment cue):\n- Closure/exit cues: /\\bclose[sd]?\\b/, /\\bsubsequently\\s+closed\\b/, /\\bpreviously\\s+closed\\b/, /\\bstore(s)?\\s+clos(e|ing|ures)?\\b/, /\\bclosure(s)?\\b/, /\\bexit\\b|\\bexiting\\b|\\bexit\\s+activities\\b/, /\\bimpair(ment|ed|ing)\\b/, /\\bclosure-related\\b/, /\\brelated\\s+to\\s+previously\\s+closed\\b/, /\\brelated\\s+to\\s+closed\\b/, /\\brestructur(e|ing|ed)\\b/, /\\bexit-related\\b/, /\\bstore\\s+closure\\b/.\n\nExact lexical lease-charge cues (case-insensitive): /lease\\s+charge(s)?\\b/, /other\\s+lease\\s+charge(s)?\\b/, /lease\\s+termination\\s+cost(s)?\\b/, /lease\\s+related\\s+charges\\b/.\n\nAssociation & windows (apply in order):\n1) High-confidence same-clause match: if a currency numeric token is within ±12 tokens of a lease-charge cue AND the same clause/sentence contains ANY closure/exit/impairment cue above -> assign RestructuringCharges for that numeric (event-driven override).\n2) Grouped-phrase rule: if clause contains a grouped phrase pattern like /impairment(s)?\\s+and\\s+other\\s+lease\\s+charge(s)?/i or /impairment\\s+and\\s+lease\\s+charges/ and the clause ties these amounts to closed stores (closure cues present anywhere in clause) -> map ALL enumerated currency amounts in that grouped clause to RestructuringCharges.\n3) Cross-sentence antecedent resolution: if lease-charge cue is present but closure/impairment cue is only in the immediately preceding sentence (±1 sentence) and antecedent span <= 40 tokens (anaphors like 'these charges', 'related to such closures'), allow mapping to RestructuringCharges. Require explicit linkage tokens such as 'related to', 'arising from', 'in connection with', 'resulting from' appearing within ±16 tokens of either the lease-charge cue or the closure cue.\n4) Multi-amount alignment: when multiple currency amounts appear in same grouped clause (e.g., 'Impairment and other lease charges of $A and $B related to closed restaurants'), assign each currency to RestructuringCharges (do not split by lexical 'lease' presence if grouping + closure cues exist).\n\nPrecedence / tie-breakers (apply before any lexical 'lease' -> OperatingLeaseExpense rule):\n- Event-driven override: if rule conditions (1-3) match, RestructuringCharges MUST override OperatingLeaseExpense.\n- Exception: if the sentence explicitly contains a definitive operating-line lexical tag such as 'Operating lease expense', 'rent expense included in operating expenses', or an unambiguous statement mapping the amount to OperatingLeaseExpense (regex: /Operating\\s+lease\\s+expense|rent\\s+expense\\b/ within ±8 tokens of numeric) AND NO closure/impairment cues are present in same or prior sentence, then map to OperatingLeaseExpense as usual.\n- Conflict logging: if both explicit operating-line lexical tag and closure/impairment cues are present, DO NOT auto-assign; flag as 'lease-closure-conflict' for human review.\n\nAmbiguity handling: if lease-charge cue exists and closure/impairment cues are weak (only generic 'costs' or 'other charges' without explicit closure/impairment/related-to-closed phrasing), DO NOT auto-map to RestructuringCharges; instead mark 'lease-charge-ambiguous' and queue for human review.\n\nNormalization & negation: apply negation-to-zero rules when negation cues ('no', 'none', 'no lease charges') co-occur within ±6 tokens of lease-charge/closure phrases and map numeric to 0 for RestructuringCharges when rule matched.\n\nLogging & QA: for every mapping by this rule record: numeric span, lease-charge cue span, matched closure/impairment cue span, grouping-phrase span (if any), antecedent/anonaphor span (if cross-sentence), chosen tag (RestructuringCharges), rule-id 'ctx-DELTA-LEASE-0001' and decision branch. Add 'lease-closure-conflict' and 'lease-charge-ambiguous' cases to targeted human-review queue and regression tests.\n\nMinimal unit-tests (atomic examples):\n- 'Other lease charges of $1.3 million related to previously closed Company-owned restaurants' -> $1.3M => RestructuringCharges.\n- 'Impairment and other lease charges of $0.1 million and $0.2 million related to closures of sixteen restaurants' -> both amounts => RestructuringCharges.\n- 'We recorded $0.5 million of lease charges included in operating lease expense' (no closure/impairment cues) -> $0.5M => OperatingLeaseExpense.\n- 'Lease charges of $X (see note) and related to closed stores' where 'related to closed stores' appears in previous sentence -> $X => RestructuringCharges (cross-sentence antecedent).\n\nImplementation note: place this rule before any lexical-level 'lease' -> OperatingLeaseExpense mapping in the pipeline. Surface all logged cases where event-driven override applied to QA for inclusion in retraining data to reduce future lexical-only misclassification."}], "added_content": ["[ctx-00027] helpful=0 harmful=0 :: id: ctx-DELTA-LEASE-0001 :: Event-driven override: map \"lease charges\" tied to closures/exit/impairment -> RestructuringCharges", "Purpose: Prevent blanket mapping of any phrase containing 'lease' or 'lease charge(s)' to OperatingLeaseExpense when the amount is part of closure/exit/restructuring activity or presented together with impairment/exit charges.", "Exact lexical/event cues (case-insensitive regexes; require at least one closure/exit/impairment cue):", "- Closure/exit cues: /\\bclose[sd]?\\b/, /\\bsubsequently\\s+closed\\b/, /\\bpreviously\\s+closed\\b/, /\\bstore(s)?\\s+clos(e|ing|ures)?\\b/, /\\bclosure(s)?\\b/, /\\bexit\\b|\\bexiting\\b|\\bexit\\s+activities\\b/, /\\bimpair(ment|ed|ing)\\b/, /\\bclosure-related\\b/, /\\brelated\\s+to\\s+previously\\s+closed\\b/, /\\brelated\\s+to\\s+closed\\b/, /\\brestructur(e|ing|ed)\\b/, /\\bexit-related\\b/, /\\bstore\\s+closure\\b/.", "Exact lexical lease-charge cues (case-insensitive): /lease\\s+charge(s)?\\b/, /other\\s+lease\\s+charge(s)?\\b/, /lease\\s+termination\\s+cost(s)?\\b/, /lease\\s+related\\s+charges\\b/."], "removed_content": []}
{"timestamp": "2026-02-06T11:40:11.182031", "step": 53, "playbook_before_length": 149230, "playbook_after_length": 153982, "lines_before": 595, "lines_after": 624, "added_lines": 19, "removed_lines": 0, "operations_count": 1, "operations": [{"type": "ADD", "section": "context_clues_and_indicators", "content": "ctx-DELTA-OUTSTANDING-FACILITY-0001 :: Atomic heuristic — Map 'outstanding/borrowed under the facility/revolver' -> LineOfCredit (facility-level outstanding borrowings)\n\nPurpose: deterministically assign currency amounts that describe borrowings outstanding under a named credit facility/revolver to the facility-level outstanding-balance tag (e.g., LineOfCredit or taxonomy-equivalent) and not to maximum/capacity, spread, or generic debt-face tags.\n\nExact lexical cues (case-insensitive regexes; match-first): /\\b(outstanding\\b|amounts?\\s+outstanding\\b|borrowed\\b|borrowings?\\b|amount\\s+borrowed\\b|principal\\s+outstanding\\b|was\\s+outstanding\\b|are\\s+outstanding\\b)/i and facility anchors: /\\b(revolv(?:ing)?\\s+credit\\s+facilit(?:y|ies)|credit\\s+facility|revolver|line\\s+of\\s+credit|the\\s+facility)\\b/i.\n\nAssociation & windows (apply in order):\n1) High-confidence pattern: if a currency numeric token lies within ±12 tokens of an outstanding/borrowed cue AND the same sentence contains a facility anchor (revolver/credit facility), assign the numeric -> LineOfCredit (facility outstanding) and link to the facility anchor span.\n2) Antecedent resolution: if outstanding/borrowed cue appears but the facility anchor is anaphoric ('the facility', 'the revolver'), allow antecedent in previous sentence (±1 sentence, antecedent span <= 40 tokens). Require confidence threshold for cross-sentence mapping; if antecedent absent or confidence low, flag for review rather than guessing.\n3) Fallback lexical attachment: when both instrument/tranche anchors (term loan, tranche) and facility anchors appear in the sentence, use syntactic governor/head-noun attachment (dependency parse) if available: if numeric's governor == facility-token -> LineOfCredit; if governor == instrument-token -> instrument-face/loan tag. If no parse available, choose the anchor with smallest token-distance; if equal and neither contains explicit 'Tranche'/'Loan' keywords, prefer facility => LineOfCredit and log conflict.\n\nPrecedence rules (apply before capacity/spread fallbacks):\n- If outstanding/borrowed + facility anchor matches per above -> MUST assign facility-level outstanding tag (LineOfCredit) and override any 'up to'/'capacity' mapping.\n- If numeric is percentage or contains 'margin'/'spread' cues -> do NOT map to outstanding; instead apply spread/interest heuristics (ctx-00008/ctx-00011) as usual.\n- If numeric is currency but also contains 'up to' OR 'aggregate principal amount of up to' with explicit capacity/commitment anchors -> capacity mapping may still be applicable but only after verifying attachment: 'up to $X' attached to a facility anchor by governor -> LineOfCreditFacilityMaximumBorrowingCapacity; outstanding cues explicitly present -> outstanding tag wins.\n\nNegation & normalization:\n- Apply err-00002 negation-to-zero rule: if outstanding/borrowed phrase co-occurs with negation cues ('no amounts outstanding', 'none outstanding', 'there were no borrowings under the facility') within ±6 tokens, normalize numeric to 0 and assign LineOfCredit = 0; log negation span and anchor.\n\nUnit-tests (atomic examples to add):\n- 'There was $50 million outstanding under the revolver.' -> $50M => LineOfCredit (facility outstanding).\n- 'An amount outstanding under the credit facility totaled $12.5 million and the amount available under the facility totaled $62.5 million' -> $12.5M => LineOfCredit; $62.5M => LineOfCreditFacilityRemainingBorrowingCapacity.\n- 'Revolving credit facility in an aggregate principal amount of up to $225.0 million; $50.0 million was outstanding under the revolver.' -> $225.0M => LineOfCreditFacilityMaximumBorrowingCapacity; $50.0M => LineOfCredit.\n- 'No amounts were outstanding under the credit facility at March 31' -> 0 => LineOfCredit (negation normalized and logged).\n- 'Tranche A term loan of $16.0 million; $5.0 million outstanding under the revolver' -> $16.0M => DebtInstrumentFaceAmount (Tranche A); $5.0M => LineOfCredit (revolver outstanding).\n\nLogging & QA: record numeric span, matched 'outstanding/borrowed' cue span, matched facility anchor span (or resolved antecedent), parse-governor (if used), chosen tag, rule-id 'ctx-DELTA-OUTSTANDING-FACILITY-0001', and decision confidence. Queue ambiguous head-noun attachment cases as 'facility-vs-instrument-attachment-ambiguous' for targeted human review and retraining.\n\nImplementation note: insert this rule in the debt/facility numeric-to-tag mapping stage and execute it before any unconditional 'availability'/'up to' -> capacity mapping and before generic lexical fallbacks. Integrate 'parse-head' as a strong feature in ML classifiers and treat this rule as a hard override when high-confidence signals are present."}], "added_content": ["[ctx-00028] helpful=0 harmful=0 :: ctx-DELTA-OUTSTANDING-FACILITY-0001 :: Atomic heuristic — Map 'outstanding/borrowed under the facility/revolver' -> LineOfCredit (facility-level outstanding borrowings)", "Purpose: deterministically assign currency amounts that describe borrowings outstanding under a named credit facility/revolver to the facility-level outstanding-balance tag (e.g., LineOfCredit or taxonomy-equivalent) and not to maximum/capacity, spread, or generic debt-face tags.", "Exact lexical cues (case-insensitive regexes; match-first): /\\b(outstanding\\b|amounts?\\s+outstanding\\b|borrowed\\b|borrowings?\\b|amount\\s+borrowed\\b|principal\\s+outstanding\\b|was\\s+outstanding\\b|are\\s+outstanding\\b)/i and facility anchors: /\\b(revolv(?:ing)?\\s+credit\\s+facilit(?:y|ies)|credit\\s+facility|revolver|line\\s+of\\s+credit|the\\s+facility)\\b/i.", "1) High-confidence pattern: if a currency numeric token lies within ±12 tokens of an outstanding/borrowed cue AND the same sentence contains a facility anchor (revolver/credit facility), assign the numeric -> LineOfCredit (facility outstanding) and link to the facility anchor span.", "2) Antecedent resolution: if outstanding/borrowed cue appears but the facility anchor is anaphoric ('the facility', 'the revolver'), allow antecedent in previous sentence (±1 sentence, antecedent span <= 40 tokens). Require confidence threshold for cross-sentence mapping; if antecedent absent or confidence low, flag for review rather than guessing."], "removed_content": []}
{"timestamp": "2026-02-06T11:41:33.189638", "step": 54, "playbook_before_length": 153982, "playbook_after_length": 157871, "lines_before": 624, "lines_after": 647, "added_lines": 21, "removed_lines": 0, "operations_count": 1, "operations": [{"type": "ADD", "section": "context_clues_and_indicators", "content": "ctx-DELTA-INTEREST-PERCENT-INSTRUMENT :: Atomic heuristic: Percent + debt-instrument anchor -> DebtInstrumentInterestRateStatedPercentage (with valuation/spread exceptions)\nPurpose: deterministically map percentage tokens that syntactically/lexically modify a debt instrument noun (note(s), bond(s), loan, term loan, seller note, senior notes, revolver interest rate phrasing) to DebtInstrumentInterestRateStatedPercentage unless explicit valuation, carrying-amount, spread/margin, or effective-rate cues attach to the percent.\nExact instrument-anchor cues (case-insensitive): /\\b(note|notes|bond|bonds|loan|loans|term\\s+loan|seller\\s+note|senior\\s+notes|revolver|debenture)\\b/.\nPercent forms: '\\d+(?:\\.\\d+)?%','\\d+(?:\\.\\d+)? percent' and numeric ranges including percent.\nAssociation windows and syntactic attachment (apply in order):\n 1) Prefer same-noun-phrase attachment: if the percent token occurs within the same noun phrase or within ±3 tokens of an instrument-anchor in the same sentence -> map to DebtInstrumentInterestRateStatedPercentage.\n 2) If instrument-anchor appears elsewhere in sentence but no syntactic parse, require instrument-anchor within ±6 tokens of the percent to apply this rule with medium confidence.\nPrecedence & exceptions (apply after association):\n  - If valuation/carrying cues are present and syntactically attach to the percent within ±5 tokens, DO NOT map to interest-rate. Valuation/carrying cues (case-insensitive): /fair\\s+value|estimated\\s+fair\\s+value|carrying\\s+amount|carrying\\s+value|book\\s+value|measured\\s+at\\s+fair\\s+value|at\\s+fair\\s+value/. Map to the appropriate fair-value/carrying tag instead.\n  - If spread/margin/over-LIBOR cues appear within ±5 tokens of the percent: /spread|margin|over\\s+LIBOR|over\\s+ABR|over\\s+an?\\s+index|plus\\s+LIBOR|LIBOR\\s+plus/, map to DebtInstrumentBasisSpreadOnVariableRate1 (or spread tag) rather than stated-rate.\n  - If effective/yield/APR cues appear within ±5 tokens: /effective\\s+rate|yield|APR|effective\\s+interest\\s+rate|effective\\s+rate\\s+of/, map to the effective-rate taxonomy element (do not force stated-percentage).\n  - If percent attaches to a phrase describing carrying/valuation proportions (e.g., 'represented 5.00% of the carrying amount of the notes') map to a ratio/percentage-of-carrying-amount tag (do not map to interest-rate).\nTie-breaker rules:\n  - If both instrument-anchor and a conflicting cue (valuation/spread/effective) are present, prefer the cue that syntactically governs the percent (syntactic head/governor if available). If syntactic info unavailable, prefer valuation/spread/effective cues only when they are within ±3 tokens of the percent; otherwise prefer DebtInstrumentInterestRateStatedPercentage.\nLogging & QA:\n  - Record: percent token span, instrument-anchor span, any overriding cue span (valuation/spread/effective), decision made and rule-id 'ctx-DELTA-INTEREST-PERCENT-INSTRUMENT'. Flag any conflict cases where both instrument and override cues are within ±3 tokens for human review ('interest-percent-conflict').\nUnit-tests (atomic examples):\n  - '3.88% notes' -> 3.88% = DebtInstrumentInterestRateStatedPercentage.\n  - 'The fair value of the notes was 3.88%' -> 3.88% = DebtInstrumentFairValueAmount (do NOT map to interest-rate).\n  - '5.00% per annum on the Seller Notes' -> 5.00% = DebtInstrumentInterestRateStatedPercentage.\n  - 'The margin ranges from 1.00% to 2.00% in the case of LIBOR loans' -> percents = DebtInstrumentBasisSpreadOnVariableRate1 (do NOT map to stated-rate).\n  - '5.00% of the carrying amount of the notes' -> map to percent-of-carrying-amount tag (do NOT map to interest-rate).\nImplementation note: run this rule early in percent-handling pipeline and before generic percentage-to-spread or percentage-to-valuation fallbacks; enforce attachment windows strictly to avoid overgeneralization."}], "added_content": ["[ctx-00029] helpful=0 harmful=0 :: ctx-DELTA-INTEREST-PERCENT-INSTRUMENT :: Atomic heuristic: Percent + debt-instrument anchor -> DebtInstrumentInterestRateStatedPercentage (with valuation/spread exceptions)", "Purpose: deterministically map percentage tokens that syntactically/lexically modify a debt instrument noun (note(s), bond(s), loan, term loan, seller note, senior notes, revolver interest rate phrasing) to DebtInstrumentInterestRateStatedPercentage unless explicit valuation, carrying-amount, spread/margin, or effective-rate cues attach to the percent.", "Exact instrument-anchor cues (case-insensitive): /\\b(note|notes|bond|bonds|loan|loans|term\\s+loan|seller\\s+note|senior\\s+notes|revolver|debenture)\\b/.", "Percent forms: '\\d+(?:\\.\\d+)?%','\\d+(?:\\.\\d+)? percent' and numeric ranges including percent.", "Association windows and syntactic attachment (apply in order):"], "removed_content": []}
{"timestamp": "2026-02-06T11:43:07.051135", "step": 55, "playbook_before_length": 157871, "playbook_after_length": 162019, "lines_before": 647, "lines_after": 664, "added_lines": 17, "removed_lines": 0, "operations_count": 1, "operations": [{"type": "ADD", "section": "context_clues_and_indicators", "content": "Atomic heuristic — Debt maturity (term) numeric+unit combination and unit-alone prevention\nPurpose: ensure instrument maturity expressions (e.g., \"three years\", \"10-year\") are mapped only when numeric and time-unit are combined into a single DebtInstrumentTerm; prevent mapping the unit token alone to unrelated tags.\nExact lexical/unit tokens (case-insensitive): /year(s)?\\b|yr(s)?\\b|month(s)?\\b|day(s)?\\b|year-?old|year-?term|\\bterm\\b/ as time-unit indicators; numeric forms: digits or spelled-out small-cardinals (one..twenty).\nDecision flow (apply in order for any numeric or unit token candidate):\n1) Numeric+unit immediate-pair rule (highest-precedence): if a numeric token and a time-unit token co-occur within a tight token window (numeric and unit within ±3 tokens OR appear as hyphenated form like '10-year'), assign DebtInstrumentTerm to the combined expression (do NOT create separate tags for the number and for the unit). Example matches: 'three years', '3-year', '10 year term'.\n2) Cross-token antecedent pairing (allow antecedent numeric): if only a unit token ('years') appears in the sentence but an unpaired numeric appears in the immediately preceding sentence (±1 sentence) and an instrument-anchor (note/loan/term loan/revolver) is present in the same sentence or the antecedent sentence, then combine numeric+unit (numeric from previous sentence + unit in current sentence) and assign DebtInstrumentTerm. Require antecedent span <= 40 tokens and flag mapping confidence as medium; log both spans.\n3) Unit-alone safety: if only the unit token appears and there is no antecedent numeric within ±1 sentence or instrument-anchor absent, DO NOT map the unit alone to any numeric/time-duration tag. Instead mark the phrase as 'term-ambiguous-no-numeric' and queue for human review. (This prevents mapping 'years' alone to unrelated tags.)\n4) Precedence & tie-breakers: if numeric could map either to DebtInstrumentTerm (paired with unit) OR to another numeric tag (e.g., number-of-years used as vesting period under share-based rules), resolve by inspecting the nearest instrument-anchor token. If an explicit debt instrument anchor (note|loan|term loan|bond|seller note|senior notes|revolver) is present within ±12 tokens of the numeric/unit pair, prefer DebtInstrumentTerm. If a share/award/vesting anchor is closer, prefer vesting/award-duration mappings (use ctx-00010). Log the anchor used for precedence.\n5) Normalization & range handling: accept ranges/compound forms ('three to five years', '3-5 years', 'three- or four-year') and assign DebtInstrumentTerm with range metadata (3–5 years). When hyphenated ('three-year'), normalize to numeric=3 + unit=years.\n6) Negation/zero handling: if a numeric+unit pair includes negation cues ('no years', 'none remaining' adjacent) treat as ambiguous for term mapping (do not map a period of zero years to a maturity tag without human review) unless the text explicitly states a 0-year term (rare); log and queue for review.\n7) Logging & QA: record numeric span, unit span, instrument-anchor span (if any), chosen tag (DebtInstrumentTerm), rule-id 'ctx-DELTA-DEBT-TERM-0001', token distances, and confidence. Add all 'term-ambiguous-no-numeric' cases and cross-sentence antecedent medium-confidence mappings to the human-review queue for training data.\n8) Minimal unit-tests (atomic):\n   - 'The notes have a term of three years.' -> 'three years' => DebtInstrumentTerm = 3 years.\n   - 'Maturities are three years.' (numeric in prior sentence: 'The debt matures in three.' previous sentence 'three') -> combine => DebtInstrumentTerm = 3 years (antecedent pairing allowed).\n   - 'The instrument has a term of years.' -> do NOT map; flag 'term-ambiguous-no-numeric'.\n   - 'The loans have a 10-year term.' -> '10-year' => DebtInstrumentTerm = 10 years.\nImplementation note: run this rule before any generic numeric-to-duration or unit-only fallbacks and before percentage/interest heuristics; enforce combined numeric+unit mapping as the canonical instrument-term assignment to prevent splitting the numeric and unit into separate, less-specific tags."}], "added_content": ["[ctx-00030] helpful=0 harmful=0 :: Atomic heuristic — Debt maturity (term) numeric+unit combination and unit-alone prevention", "Purpose: ensure instrument maturity expressions (e.g., \"three years\", \"10-year\") are mapped only when numeric and time-unit are combined into a single DebtInstrumentTerm; prevent mapping the unit token alone to unrelated tags.", "Exact lexical/unit tokens (case-insensitive): /year(s)?\\b|yr(s)?\\b|month(s)?\\b|day(s)?\\b|year-?old|year-?term|\\bterm\\b/ as time-unit indicators; numeric forms: digits or spelled-out small-cardinals (one..twenty).", "Decision flow (apply in order for any numeric or unit token candidate):", "1) Numeric+unit immediate-pair rule (highest-precedence): if a numeric token and a time-unit token co-occur within a tight token window (numeric and unit within ±3 tokens OR appear as hyphenated form like '10-year'), assign DebtInstrumentTerm to the combined expression (do NOT create separate tags for the number and for the unit). Example matches: 'three years', '3-year', '10 year term'."], "removed_content": []}
{"timestamp": "2026-02-06T11:44:56.802267", "step": 56, "playbook_before_length": 162019, "playbook_after_length": 166867, "lines_before": 664, "lines_after": 693, "added_lines": 20, "removed_lines": 0, "operations_count": 1, "operations": [{"type": "ADD", "section": "context_clues_and_indicators", "content": "ctx-DELTA-CURRENT-AVAILABILITY :: Atomic heuristic — Map present-tense 'available to borrow' / explicit 'amount available' phrases to LineOfCreditFacilityCurrentBorrowingCapacity (POINT-IN-TIME availability) and prevent blanket borrowing-base -> Remaining mappings.\n\nPurpose: deterministically assign currency amounts that assert an amount \"is available to borrow\" or that explicitly state \"amount available under / available to borrow\" to LineOfCreditFacilityCurrentBorrowingCapacity (the facility's current available borrowing capacity at reporting date). Reserve LineOfCreditFacilityRemainingBorrowingCapacity only for explicit 'remaining'/'left'/'after borrowings/letters of credit' contexts.\n\nExact lexical anchors (case-insensitive regexes; exact-match first):\n- Present-/past-point-in-time availability: /\\b(is|was|were|totaled|totaling|totalled)\\s+(available\\s+(to\\s+borrow|under\\s+the\\s+facility|under\\s+the\\s+borrowing\\s+base|under\\s+the\\s+revolver))\\b/i, /\\b(amount|amounts)\\s+available\\s+(under|to\\s+borrow|under\\s+the)\\b/i, /\\bavailable\\s+to\\s+borrow\\b/i, /\\bwas\\s+available\\s+under\\s+the\\s+facility\\b/i\n\nExplicit-remaining anchors (do NOT map to Current): /\\bremaining\\b|\\bremaining\\s+amount\\b|\\bamount\\s+remaining\\b|\\bleft\\s+under\\b|\\bafter\\s+drawings\\b|\\bafter\\s+borrowings\\b|\\bunused\\s+capacity\\b/i\n\nAssociation & token windows:\n- If a currency numeric token appears within ±8 tokens of any Present-/past-point-in-time availability anchor in the same sentence -> candidate for LineOfCreditFacilityCurrentBorrowingCapacity.\n- Allow antecedent facility anchor (e.g., 'the revolver', 'the facility', 'the borrowing base') in the immediately preceding sentence (±1) when an anaphor ('the facility', 'the borrowing base') is used and antecedent span <= 40 tokens.\n\nDecision flow (apply in order):\n1) If numeric + Present-/past-point-in-time availability anchor matched per above -> assign LineOfCreditFacilityCurrentBorrowingCapacity. Log anchor span and antecedent facility name for provenance. This is a high-priority mapping and MUST override any generic 'borrowing base -> Remaining' rule.\n2) Else if numeric + Explicit-remaining anchor matched -> assign LineOfCreditFacilityRemainingBorrowingCapacity (explicit remaining wording takes precedence for 'remaining').\n3) Else if numeric + only 'borrowing base' or 'borrowing base available' token exists but no explicit availability phrase (e.g., just 'borrowing base' mentioned elsewhere) -> do NOT auto-map to Remaining; treat as AMBIGUOUS and require either: (a) explicit 'amount available under the borrowing base'/'is available to borrow' to map to Current, or (b) explicit 'remaining'/'after borrowings' to map to Remaining. If neither present -> flag 'borrowing-base-ambiguous-availability' and queue for human review.\n4) Tie-breaker / taxonomy-check: when both Current and Remaining candidate tags are plausible (text contains both 'available' and 'remaining'-like tokens or ambiguous phrasing), consult taxonomy gloss/definition strings for both candidate elements. Prefer the element whose definition explicitly mentions 'amount available at the reporting date', 'available to borrow', or 'available under the facility' -> choose Current. If taxonomy glosses are equally vague, prefer Current only when present-tense availability phrasing ('is available', 'was available') is present; otherwise queue for review.\n\nPrecedence & overrides:\n- This rule overrides ctx-00005 (borrowing-base -> Remaining) and any unconditional 'availability -> Remaining' heuristics. Always require the explicit availability vs remaining token to decide; do not rely on single-token heuristics ('available' alone) without phrase context.\n\nUnit-tests / atomic examples to add:\n- ' $618.0 million is available to borrow without adding additional properties to the unencumbered borrowing base of assets.' -> $618.0 => LineOfCreditFacilityCurrentBorrowingCapacity (present-tense 'is available to borrow').\n- 'An amount available under the facility totaled $62.5 million.' -> $62.5 => LineOfCreditFacilityCurrentBorrowingCapacity (explicit 'amount available under the facility totaled').\n- 'The borrowing base is $425.0 million.' -> FLAG 'borrowing-base-ambiguous-availability' (no explicit 'available' amount phrase) — require human review unless further phrase qualifies.\n- 'After letters of credit and borrowings, $50.0 million remained under the facility.' -> $50.0 => LineOfCreditFacilityRemainingBorrowingCapacity (explicit 'remained').\n\nLogging & QA: record numeric span, matched availability/remaining anchor span, antecedent facility span (if used), chosen tag, rule-id 'ctx-DELTA-CURRENT-AVAILABILITY', and whether taxonomy-gloss was consulted. Add all 'borrowing-base-ambiguous-availability' and any taxonomy-override cases to review queue for retraining."}], "added_content": ["[ctx-00031] helpful=0 harmful=0 :: ctx-DELTA-CURRENT-AVAILABILITY :: Atomic heuristic — Map present-tense 'available to borrow' / explicit 'amount available' phrases to LineOfCreditFacilityCurrentBorrowingCapacity (POINT-IN-TIME availability) and prevent blanket borrowing-base -> Remaining mappings.", "Purpose: deterministically assign currency amounts that assert an amount \"is available to borrow\" or that explicitly state \"amount available under / available to borrow\" to LineOfCreditFacilityCurrentBorrowingCapacity (the facility's current available borrowing capacity at reporting date). Reserve LineOfCreditFacilityRemainingBorrowingCapacity only for explicit 'remaining'/'left'/'after borrowings/letters of credit' contexts.", "Exact lexical anchors (case-insensitive regexes; exact-match first):", "- Present-/past-point-in-time availability: /\\b(is|was|were|totaled|totaling|totalled)\\s+(available\\s+(to\\s+borrow|under\\s+the\\s+facility|under\\s+the\\s+borrowing\\s+base|under\\s+the\\s+revolver))\\b/i, /\\b(amount|amounts)\\s+available\\s+(under|to\\s+borrow|under\\s+the)\\b/i, /\\bavailable\\s+to\\s+borrow\\b/i, /\\bwas\\s+available\\s+under\\s+the\\s+facility\\b/i", "Explicit-remaining anchors (do NOT map to Current): /\\bremaining\\b|\\bremaining\\s+amount\\b|\\bamount\\s+remaining\\b|\\bleft\\s+under\\b|\\bafter\\s+drawings\\b|\\bafter\\s+borrowings\\b|\\bunused\\s+capacity\\b/i"], "removed_content": []}
{"timestamp": "2026-02-06T11:47:04.861461", "step": 57, "playbook_before_length": 166867, "playbook_after_length": 173314, "lines_before": 693, "lines_after": 725, "added_lines": 29, "removed_lines": 0, "operations_count": 1, "operations": [{"type": "ADD", "section": "context_clues_and_indicators", "content": "ctx-DELTA-TAGSPEC-0001 :: Exact-or-most-specific-taxonomy-tag-first (atomic heuristic)\n\nPurpose: Prevent selection of a plausible-but-generic taxonomy tag when the provided taxonomy contains an exact or more-specific tag that lexically matches the sentence. Force exact-string verification and deterministic specificity tie-breaking before any semantic/fallback classifier is applied.\n\nRules (apply before any semantic-classifier fallback or nearest-lexical-match):\n1) Lexical-cue extraction (same sentence ±0 tokens): extract key nouns/verbs from the sentence relevant to the numeric (examples: 'rent', 'lease', 'operating lease', 'rental expense', 'right-of-use asset', 'shares reserved', etc.). Normalize tokens (lowercase, remove punctuation). Keep multiword cues as phrases (e.g., 'operating leases', 'rent expense').\n2) Exact-tag lookup (highest priority): search the provided taxonomy list for any tag whose exact tag-name (case-sensitive or case-preserving) contains the exact extracted phrase(s) as contiguous substrings (normalized comparison permitted). If one or more exact-tag-name matches exist, prefer the tag whose name contains the maximal set of lexical cues from the sentence (see scoring in step 4). If an exact-string tag matches (e.g., taxonomy contains OperatingLeasesRentExpenseNet and sentence contains 'rent' + 'operating leases'), immediately select that tag.\n3) Most-specific substring fallback (if no exact contiguous phrase match): build candidate set = taxonomy tags whose names contain any of the lexical cue tokens (token-substring match). Do NOT accept tags with only semantic/definition similarity: require lexical overlap with at least one cue token (e.g., 'rent' or 'operating' or 'lease').\n4) Specificity & scoring tie-breaker (deterministic selection): compute for each candidate tag a specificity score = sum( exact_phrase_bonus + token_overlap_count * 2 + token_order_bonus + token_distance_penalty + name_length_bonus ), where:\n   - exact_phrase_bonus = 10 if taxonomy tag contains a contiguous multiword cue that exactly equals a phrase from the sentence (e.g., 'OperatingLeasesRentExpense').\n   - token_overlap_count = count of distinct cue tokens found in the tag name (e.g., 'operating' + 'lease' + 'rent' -> 3).\n   - token_order_bonus = +2 if the relative order of matched tokens in the tag name mirrors the order in the sentence.\n   - token_distance_penalty = -1 * number_of_nonmatching_tokens_between matched tokens in tag name (penalize scattered matches).\n   - name_length_bonus = +1 for each additional meaningful token beyond 2 in the tag name (prefer more-specific multi-token names).\nSelect tag with highest specificity score. Require score_gap >= 3 vs next-best; if gap < 3, DO NOT auto-assign: flag 'tag-selection-close-tie' for human review.\n5) Exact-string requirement for evaluation grading: always record and output the exact taxonomy tag-name chosen; if the taxonomy candidate set includes the evaluator's ground-truth tag and it was not selected due to tie-threshold, log that case and prioritize it for retraining.\n6) Lexical-cue examples & regexes to seed extractor (case-insensitive):\n   - operating lease(s)? -> /operating\\s+lease(s)?/i\n   - rent( expense|s)? -> /\\b(rent|rent\\s+expense|rental\\s+expense)\\b/i\n   - right[- ]of[- ]use asset(s)? -> /right[- ]of[- ]use\\s+asset(s)?/i\n   - lease liability -> /lease\\s+liabilit(y|ies)/i\n   - sample combined cue: if sentence matches /rent expense for operating lease(s)?/i treat as both cues present.\n7) Application window & consistency: apply this rule for every numeric token in the sentence and enforce consistent tag reuse across all period-linked numerics in the same clause (if multiple rent amounts for different periods are present and the tag chosen is OperatingLeasesRentExpenseNet, assign same tag to each period amount). If differing period contexts require separate tags, treat independently but run the same exact-tag-first logic per numeric.\n8) Provenance & logging: for every mapping using this rule record: sentence text; extracted cues; candidate taxonomy tag list; specificity scores per candidate; chosen tag-name; score gap; and decision reason string. If rule deferred due to tie or missing exact tag, label case 'ctx-DELTA-TAGSPEC-0001-deferred' and queue for human review.\n9) Negative fallback: if no taxonomy tag contains any lexical cue token from the sentence, do NOT expand to near-synonyms; instead run the semantic classifier fallback but tag the output with 'no-lexical-match' and log candidate taxonomy suggestions. Do not accept a generic tag simply because it is semantically close.\n10) Unit-tests (atomic examples to add):\n   - Sentence: 'Rent expense for operating leases was $118 million, $84 million and $74 million for the years 2019, 2018 and 2017.' -> expected tag: OperatingLeasesRentExpenseNet for all three amounts (exact phrase 'rent'+'operating leases' present; taxonomy contains OperatingLeasesRentExpenseNet).\n   - Sentence: 'We recorded $X of operating lease expense for the period.' -> if taxonomy contains both OperatingLeaseExpense and OperatingLeasesRentExpenseNet but sentence includes 'rent' -> choose OperatingLeasesRentExpenseNet; if sentence lacks 'rent' and only 'operating lease expense' appears, choose OperatingLeaseExpense only if OperatingLeasesRentExpenseNet lacks lexical overlap (ensure scoring handles both).\n   - Sentence: 'Lease expense related to operating leases totaled $Y' -> if 'rent' is absent but taxonomy contains OperatingLeasesRentExpenseNet, do NOT force that tag unless token overlap score favors it; prefer exact-match to 'lease expense' tag if present and higher score.\n11) Integration note: insert this rule immediately after lexical candidate generation and before any instrument-specific, amount-to-tag heuristics or ML classifier fallbacks. Make the rule a hard gating check: exact or most-specific lexical-match tags must be chosen when present and score gap threshold is satisfied.\n\nRationale: This atomic rule enforces exact/most-specific taxonomy-tag selection using deterministic lexical overlap metrics and prevents substitution of generic tags when the taxonomy provides a precise label (fixes failures like mapping 'rent expense for operating leases' -> OperatingLeaseExpense instead of OperatingLeasesRentExpenseNet). It also ensures traceability and human-review gating when selector confidence is low."}], "added_content": ["[ctx-00032] helpful=0 harmful=0 :: ctx-DELTA-TAGSPEC-0001 :: Exact-or-most-specific-taxonomy-tag-first (atomic heuristic)", "Purpose: Prevent selection of a plausible-but-generic taxonomy tag when the provided taxonomy contains an exact or more-specific tag that lexically matches the sentence. Force exact-string verification and deterministic specificity tie-breaking before any semantic/fallback classifier is applied.", "Rules (apply before any semantic-classifier fallback or nearest-lexical-match):", "1) Lexical-cue extraction (same sentence ±0 tokens): extract key nouns/verbs from the sentence relevant to the numeric (examples: 'rent', 'lease', 'operating lease', 'rental expense', 'right-of-use asset', 'shares reserved', etc.). Normalize tokens (lowercase, remove punctuation). Keep multiword cues as phrases (e.g., 'operating leases', 'rent expense').", "2) Exact-tag lookup (highest priority): search the provided taxonomy list for any tag whose exact tag-name (case-sensitive or case-preserving) contains the exact extracted phrase(s) as contiguous substrings (normalized comparison permitted). If one or more exact-tag-name matches exist, prefer the tag whose name contains the maximal set of lexical cues from the sentence (see scoring in step 4). If an exact-string tag matches (e.g., taxonomy contains OperatingLeasesRentExpenseNet and sentence contains 'rent' + 'operating leases'), immediately select that tag."], "removed_content": []}
{"timestamp": "2026-02-06T11:48:50.736853", "step": 58, "playbook_before_length": 173314, "playbook_after_length": 179390, "lines_before": 725, "lines_after": 762, "added_lines": 27, "removed_lines": 0, "operations_count": 1, "operations": [{"type": "ADD", "section": "context_clues_and_indicators", "content": "ctx-DELTA-TAX-NUMERIC-TYPE :: Atomic heuristic: Tax lexical-anchor + numeric-type + balance/period detection -> deterministic tax-tag mapping\n\nPurpose: Prevent confusion between tax-rate percents, income-tax provision currency amounts, and balance-sheet unrecognized-tax-benefit balances; prefer the most specific taxonomy element that matches both lexical concept and numeric type.\n\nExact lexical cues (case-insensitive regexes):\n- Effective-rate anchors: /effective\\s+(income\\s+)?tax\\s+rate\\b|effective\\s+rate\\s+of\\s+income\\s+tax(es)?\\b|effective\\s+tax\\s+rate\\b/i\n- Provision/expense anchors: /income\\s+tax\\s+provision\\b|provision\\s+for\\s+income\\s+tax(es)?\\b|income\\s+tax\\s+expense\\b|income\\s+tax\\b.*\\bprovision\\b/i\n- Unrecognized-benefit anchors: /unrecognized\\s+tax\\s+benefit(s)?\\b|unrecognized\\s+tax\\s+positions?\\b|uncertain\\s+tax\\s+positions?\\b/i\n- Impact-on-rate lexical connector (for unrecognized benefits variant): /(would|could|may|if\\s+recognized)\\s+(reduce|decrease)\\s+our\\s+effective\\s+tax\\s+rate|impact\\s+our\\s+effective\\s+tax\\s+rate|affect\\s+the\\s+effective\\s+tax\\s+rate/i\n\nNumeric-type detection (canonical forms):\n- Percent token: /\\b\\d+(?:\\.\\d+)?%\\b|\\b\\d+(?:\\.\\d+)?\\s+percent\\b/ (treat as percent)\n- Currency token: presence of currency symbol or currency-word: /\\$|dollars|EUR|€|£/ within token span (treat as currency)\n- Balance indicator (balance-like phrases): /balance\\s+of|as\\s+of|at\\s+\\w+\\s+\\d{1,2},?\\s*\\d{4}|comparative\\s+balance|the\\s+balance\\s+at\\b/i\n\nAssociation windows & precedence (apply in order):\n1) Percent + Effective-rate anchor (high-priority): if a percent token appears within ±6 tokens of an effective-rate anchor in the same sentence -> assign EffectiveIncomeTaxRateContinuingOperations. For multi-year lists (\"22.3%, 23.4% for 2019, 2018\") pair by nearest-year-token or left-to-right sequence.\n2) Currency + Provision/expense anchor (high-priority): if a currency token appears within ±8 tokens of a provision/expense anchor (\"income tax provision\", \"provision for income taxes\", \"income tax expense\") -> assign IncomeTaxExpenseBenefit (note polarity rule: consult tax-polarity heuristic for expense vs benefit; if explicit 'benefit' or negative numeric sign then choose IncomeTaxExpenseBenefit with benefit polarity). Record instrument/period metadata.\n3) Currency + Unrecognized-benefit anchor + Impact-on-rate connector (high-priority specific): if a currency token or a balance-token appears within ±12 tokens of an Unrecognized-benefit anchor AND the sentence (or immediately preceding sentence ±1) contains an Impact-on-rate connector -> assign UnrecognizedTaxBenefitsThatWouldImpactEffectiveTaxRate (link to balance if balance indicators present). If only 'unrecognized tax benefits' appears without an explicit impact-on-rate connector but with balance indicators -> assign UnrecognizedTaxBenefits (generic balance tag) and flag 'no-rate-impact-phrase'.\n4) Balance detection overrides period provision: when a numeric appears with a balance indicator and Unrecognized-benefit anchor -> treat as balance-line (UnrecognizedTaxBenefits...); do NOT map balance amounts to IncomeTaxExpenseBenefit even if a provision/expense word appears elsewhere in surrounding sentences — require explicit composition phrase tying them.\n5) Tie-breakers when conflicting anchors present:\n   - If both Effective-rate anchor and Provision anchor appear but the numeric is a percent -> pick EffectiveIncomeTaxRateContinuingOperations.\n   - If numeric is currency and both Provision and Unrecognized-benefit anchors present: prefer UnrecognizedTaxBenefitsThatWouldImpactEffectiveTaxRate only if balance indicator or impact-on-rate connector present; otherwise prefer IncomeTaxExpenseBenefit when the phrase explicitly says 'provision' or 'expense'.\n   - If conflicting and no numeric-type resolves (e.g., text says 'the effective tax rate resulting from a $X provision') -> require composition phrase; if composition phrase ties the dollar amount to a provision that changes the rate, annotate mapping as IncomeTaxExpenseBenefit linked to a derived effect on EffectiveIncomeTaxRateContinuingOperations and flag for human-review for downstream linkage.\n\nPolarity & normalization: reuse tax-line polarity rules (explicit 'benefit' words or negative parentheses -> benefit). Always normalize explicit 'zero'/'none' near tax anchors to 0 per negation rules and log span.\n\nLogging & QA: for every assignment log numeric span, numeric type (percent vs currency vs balance), matched anchor spans (effective-rate / provision / unrecognized), chosen tag-name, rule-id 'ctx-DELTA-TAX-NUMERIC-TYPE', and reason string (which cue+type drove decision). If mapping assigned UnrecognizedTaxBenefitsThatWouldImpactEffectiveTaxRate only because antecedent impact phrase was in prior sentence (±1), record antecedent span and mark confidence=medium.\n\nUnit-tests (atomic examples):\n- 'The effective tax rate was 20.8%.' -> 20.8% => EffectiveIncomeTaxRateContinuingOperations.\n- 'Income tax provision of $35 was recorded' -> $35 => IncomeTaxExpenseBenefit.\n- 'Unrecognized tax benefits of $126 at December 31, 2019; $130 at December 31, 2018; which if ultimately recognized will reduce our effective tax rate' -> $126 and $130 => UnrecognizedTaxBenefitsThatWouldImpactEffectiveTaxRate (balances, period-tagged).\n- 'A $50 adjustment resulted in an effective tax rate of 18%' -> 18% => EffectiveIncomeTaxRateContinuingOperations; $50 => IncomeTaxExpenseBenefit only if text ties amount to provision; otherwise log for review.\n- 'The provision for income taxes (benefit) was $(5.0)' -> $(5.0) => IncomeTaxExpenseBenefit (benefit via parentheses).\n\nImplementation note: insert this rule immediately after tax-lexical anchor detection and before generic numeric-to-tag fallbacks. This atomic delta ensures numeric-type gating prevents misassigning dollar amounts to percent tax-rate tags and picks the 'UnrecognizedTaxBenefitsThatWouldImpactEffectiveTaxRate' variant only when the text explicitly links recognition to the effective rate."}], "added_content": ["[ctx-00033] helpful=0 harmful=0 :: ctx-DELTA-TAX-NUMERIC-TYPE :: Atomic heuristic: Tax lexical-anchor + numeric-type + balance/period detection -> deterministic tax-tag mapping", "Purpose: Prevent confusion between tax-rate percents, income-tax provision currency amounts, and balance-sheet unrecognized-tax-benefit balances; prefer the most specific taxonomy element that matches both lexical concept and numeric type.", "- Effective-rate anchors: /effective\\s+(income\\s+)?tax\\s+rate\\b|effective\\s+rate\\s+of\\s+income\\s+tax(es)?\\b|effective\\s+tax\\s+rate\\b/i", "- Provision/expense anchors: /income\\s+tax\\s+provision\\b|provision\\s+for\\s+income\\s+tax(es)?\\b|income\\s+tax\\s+expense\\b|income\\s+tax\\b.*\\bprovision\\b/i", "- Unrecognized-benefit anchors: /unrecognized\\s+tax\\s+benefit(s)?\\b|unrecognized\\s+tax\\s+positions?\\b|uncertain\\s+tax\\s+positions?\\b/i"], "removed_content": []}
{"timestamp": "2026-02-06T11:50:20.671103", "step": 59, "playbook_before_length": 179390, "playbook_after_length": 182539, "lines_before": 762, "lines_after": 775, "added_lines": 13, "removed_lines": 0, "operations_count": 1, "operations": [{"type": "ADD", "section": "COMMON MISTAKES TO AVOID", "content": "[err-00035] helpful=0 harmful=0 :: Anti-pattern prevention: Do NOT map any plain 'amortization' lexical cue to AmortizationOfIntangibleAssets unless an explicit 'intangible asset' anchor (or high-confidence antecedent) is present.\nConcrete prevention (atomic rules):\n1) Required anchors: before assigning AmortizationOfIntangibleAssets require at least one of the following anchors in the same sentence OR an antecedent in the immediately preceding sentence (±1 sentence, antecedent span <= 40 tokens): /intangible\\s+asset(s)?\\b/, /acquired\\s+intangible\\s+asset(s)?\\b/, /goodwill\\s+and\\s+intangible\\s+assets\\b/, /amortization\\s+of\\s+the\\s+intangible\\s+assets\\b/ (case-insensitive).\n2) Token association window: numeric token must be within ±8 tokens of either the amortization cue OR the intangible-anchor; if anchor is in prior sentence allow cross-sentence mapping only when anaphors ('these assets', 'the intangible assets') tie them (confidence medium; otherwise flag for review).\n3) Fallback mapping: if amortization cue present but no intangible anchor/antecedent found within windows, map to generic AmortizationExpense (or asset-class-specific amortization only if that asset-anchor is detected, e.g., 'deferred contract costs' -> CapitalizedContractCostAmortization). Do NOT force AmortizationOfIntangibleAssets by default.\n4) Precedence: this rule must override any lexical-first fallback that maps 'amortization' -> AmortizationOfIntangibleAssets. Specificity precedence: Intangible-anchor + amortization -> AmortizationOfIntangibleAssets > Deferred-contract-cost cue -> CapitalizedContractCostAmortization > other asset-specific amortization tags > generic AmortizationExpense.\n5) Negation and zero-handling: if negation cues ('no amortization', 'none', 'zero') appear within ±6 tokens with an intangible anchor, normalize to 0 and assign AmortizationOfIntangibleAssets=0 (log negation span); if negation present but no anchor, prefer generic handling and flag for review.\n6) Logging & QA: every mapping decision must log: amortization-cue span, matched anchor span (or 'none' if absent), numeric span, chosen tag, rule-id 'err-00035', and confidence. Any auto-assignment to AmortizationOfIntangibleAssets when anchor was antecedent-cross-sentence must be marked 'antecedent-mapped' and queued for audit sampling.\n7) Unit-tests (atomic examples to add):\n   - 'Amortization expense related to the intangible assets acquired was $1,696.' -> $1,696 = AmortizationOfIntangibleAssets (anchor present).\n   - 'Amortization expense of $2,500 was recorded.' (no 'intangible' or other asset anchor) -> $2,500 = AmortizationExpense (generic); DO NOT assign AmortizationOfIntangibleAssets; flag for human review if classifier has high-confidence intangible mapping.\n   - 'Amortization expense related to deferred contract costs was $3,200.' -> $3,200 = CapitalizedContractCostAmortization (deferred-contract anchor overrides generic-intangible mapping).\nRationale: enforces the explicit 'cue + anchor' pairing (amortization cue + intangible anchor) and prevents overgeneralization from the amortization cue alone."}], "added_content": ["[err-00034] helpful=0 harmful=0 :: [err-00035] helpful=0 harmful=0 :: Anti-pattern prevention: Do NOT map any plain 'amortization' lexical cue to AmortizationOfIntangibleAssets unless an explicit 'intangible asset' anchor (or high-confidence antecedent) is present.", "Concrete prevention (atomic rules):", "1) Required anchors: before assigning AmortizationOfIntangibleAssets require at least one of the following anchors in the same sentence OR an antecedent in the immediately preceding sentence (±1 sentence, antecedent span <= 40 tokens): /intangible\\s+asset(s)?\\b/, /acquired\\s+intangible\\s+asset(s)?\\b/, /goodwill\\s+and\\s+intangible\\s+assets\\b/, /amortization\\s+of\\s+the\\s+intangible\\s+assets\\b/ (case-insensitive).", "2) Token association window: numeric token must be within ±8 tokens of either the amortization cue OR the intangible-anchor; if anchor is in prior sentence allow cross-sentence mapping only when anaphors ('these assets', 'the intangible assets') tie them (confidence medium; otherwise flag for review).", "3) Fallback mapping: if amortization cue present but no intangible anchor/antecedent found within windows, map to generic AmortizationExpense (or asset-class-specific amortization only if that asset-anchor is detected, e.g., 'deferred contract costs' -> CapitalizedContractCostAmortization). Do NOT force AmortizationOfIntangibleAssets by default."], "removed_content": []}
{"timestamp": "2026-02-06T18:21:49.055731", "step": 60, "playbook_before_length": 38622, "playbook_after_length": 42496, "lines_before": 138, "lines_after": 157, "added_lines": 19, "removed_lines": 0, "operations_count": 1, "operations": [{"type": "ADD", "section": "context_clues_and_indicators", "content": "Atomic rule: map 'designated' / 'authorized' -> SharesAuthorized by security class and resolve multiple share counts by class-anchor + verb.\n- Exact lexical cues (case-insensitive regexes): /\\bdesignated\\b/, /\\bauthorized\\b/, /authorized\\s+to\\s+issue\\b/, /designated\\s+as\\s+series\\b/, /series\\s+[A-Z0-9]+/i, /\\bpreferred\\s+stock\\b/, /\\bcommon\\s+stock\\b/, /\\bpreferred\\b/, /\\bcommon\\b/.\n- Association window: for a numeric token, require a controlling verb cue ('designated' or 'authorized') within ±8 tokens OR a class-anchor ('Series X', 'preferred', 'common') within ±8 tokens. If both verb and class-anchor exist, require numeric to be within ±10 tokens of at least one and prefer the pair whose combined token-distance to numeric is smallest (distance_sum = dist(verb, numeric)+dist(class_anchor, numeric)).\n- Tag mapping rules (apply in order):\n  1) If verb cue ∈ {designated, authorized} AND class-anchor contains 'preferred' or 'Series <id>' -> assign PreferredStockSharesAuthorized (for the named series if taxonomy allows series-specific tag; otherwise generic PreferredStockSharesAuthorized). Include series id in link metadata if present.\n  2) If verb cue ∈ {designated, authorized} AND class-anchor contains 'common' or phrase 'authorized to issue X shares' referencing common stock -> assign CommonStockSharesAuthorized.\n  3) If verb cue ∈ {designated, authorized} but no explicit class-anchor in same sentence, attempt antecedent resolution to previous sentence up to ±1 sentence (allow up to 40 tokens across boundary). If antecedent resolves to a plan/class, map accordingly; otherwise assign SharesAuthorized_Generic and flag for review.\n- Disambiguation when multiple numeric tokens present in same sentence:\n  - Detect all class-anchor spans and controlling-verb spans. For each numeric, compute nearest (verb+class) pair by token-distance; assign numeric to that class's SharesAuthorized tag. If two pairs tie, break tie by class specificity: Preferred (series-specified) > Preferred (unspecified) > Common > Generic SharesAuthorized.\n- Conflict vs issued/outstanding:\n  - If the same numeric token has 'issued'/'issued and outstanding'/'outstanding' within ±6 tokens, do NOT map to SharesAuthorized; instead map to issued/outstanding tags per existing rules. 'issued'/'outstanding' cues override 'authorized'/'designated' when they are nearer to the numeric (distance threshold 6 tokens).\n- Negation and zero handling: if 'no'/'none'/'zero' appears within ±6 tokens of 'designated'/'authorized' + class-anchor, assign numeric=0 to SharesAuthorized tag for that class and log negation span.\n- Precedence: apply this rule before generic 'shares' or 'per share' fallbacks and before plan-specific availability rules unless a plan-anchor is detected (see ctx-00001); when a plan-anchor and 'designated/authorized' both present, prefer plan-specific authorized tag only when the class-anchor refers to plan shares.\n- Minimal unit-tests (atomic examples):\n  - 'The Board designated 1,000,000 shares as Series A Preferred Stock.' -> 1,000,000 = PreferredStockSharesAuthorized (Series A).\n  - 'The Company has designated 10,000 shares of preferred stock and authorized to issue 300,000,000 shares of common stock.' -> 10,000 = PreferredStockSharesAuthorized; 300,000,000 = CommonStockSharesAuthorized.\n  - 'No shares were designated for the 2018 Series; none remain designated.' -> 0 = PreferredStockSharesAuthorized (series-specific), log negation span.\n  - '5,000 shares were issued and 10,000 were authorized.' -> 5,000 -> SharesIssued tag (issued override); 10,000 -> SharesAuthorized tag.\n- Logging & QA: record verb span, class-anchor span, numeric span, distance scores, and any antecedent resolution used for each mapping; flag cases where antecedent resolution was required or tie-breakers applied for manual review."}], "added_content": ["[ctx-00001] helpful=0 harmful=0 :: Atomic rule: map 'designated' / 'authorized' -> SharesAuthorized by security class and resolve multiple share counts by class-anchor + verb.", "- Exact lexical cues (case-insensitive regexes): /\\bdesignated\\b/, /\\bauthorized\\b/, /authorized\\s+to\\s+issue\\b/, /designated\\s+as\\s+series\\b/, /series\\s+[A-Z0-9]+/i, /\\bpreferred\\s+stock\\b/, /\\bcommon\\s+stock\\b/, /\\bpreferred\\b/, /\\bcommon\\b/.", "- Association window: for a numeric token, require a controlling verb cue ('designated' or 'authorized') within ±8 tokens OR a class-anchor ('Series X', 'preferred', 'common') within ±8 tokens. If both verb and class-anchor exist, require numeric to be within ±10 tokens of at least one and prefer the pair whose combined token-distance to numeric is smallest (distance_sum = dist(verb, numeric)+dist(class_anchor, numeric)).", "- Tag mapping rules (apply in order):", "  1) If verb cue ∈ {designated, authorized} AND class-anchor contains 'preferred' or 'Series <id>' -> assign PreferredStockSharesAuthorized (for the named series if taxonomy allows series-specific tag; otherwise generic PreferredStockSharesAuthorized). Include series id in link metadata if present."], "removed_content": []}
{"timestamp": "2026-02-06T18:23:49.578585", "step": 61, "playbook_before_length": 42496, "playbook_after_length": 46720, "lines_before": 157, "lines_after": 179, "added_lines": 21, "removed_lines": 0, "operations_count": 1, "operations": [{"type": "ADD", "section": "common_mistakes_to_avoid", "content": "err-000XX :: Lexical-first precedence for line-item expense labels (atomic rule to prevent overapplication of header/context inference):\n- Purpose (atomic): When a disclosure line explicitly uses a canonical line-item label (e.g., 'rent expense', 'lease and rental expense'), prefer the canonical line-item tag (LeaseAndRentalExpense) over a more specific context-derived tag (OperatingLeasesRentExpenseNet) unless the text itself explicitly signals the narrower concept.\n- Exact lexical cues (case-insensitive regex): /\\b(?:rent\\s+expense|lease(?:s)?\\s+and\\s+rental\\s+expense|lease\\s+and\\s+rental\\s+expense)\\b/i. Apply only when the cue appears in the same sentence or the same table/row label as the numeric token.\n- Association window: numeric token must be within ±8 tokens of the lexical cue OR the numeric is the value in the same table row/line that contains the lexical cue. Treat row/line membership as a strong local association (overrides paragraph-level header proximity).\n- Exception rules (allow OperatingLeasesRentExpenseNet only if ANY of the following explicit conditions are met):\n  1) Explicit adjacency: the phrase 'operating lease(s)' and 'rent expense' co-occur within a narrow adjacency window (e.g., within ±6 tokens) in the same sentence or row. Regex examples: /\\boperating\\s+lease(?:s)?\\b.*?\\brent\\s+expense\\b|\\brent\\s+expense\\b.*?\\boperating\\s+lease(?:s)?\\b/i.\n  2) Explicit labelled row/header coupling: the line/row label itself reads like 'Operating lease rent expense', 'Operating leases — rent expense', 'Operating lease expense — rent', or a table header/column title pairs 'Operating Leases' + row label 'Rent expense' where the parser can detect header->row binding (structured table indicator or hyphen/colon/row delimiter). Pattern to detect: /(?:Operating\\s+Leases?|NOTE\\s+\\d+\\s*-\\s*OPERATING\\s+LEASES?)\\b/ present AND row label contains 'rent' + 'expense' directly (no >2-token gap).\n  3) Document-level canonical mapping override: if the training/ground-truth mapping for this issuer consistently maps the specific phrase 'Operating lease rent expense' to OperatingLeasesRentExpenseNet and the disclosure line contains that full canonical phrase verbatim, allow specific tag.\n- Precedence decision (apply in order):\n  1) If lexical cue match (rent expense...) in same row/sentence -> assign LeaseAndRentalExpense.\n  2) Else if any Exception rule above is met -> assign OperatingLeasesRentExpenseNet (and link to instrument/context as required).\n  3) Else if lexical cue absent but only header 'OPERATING LEASES' exists and the line label says 'rent expense' (no explicit 'operating' adjacency), still assign LeaseAndRentalExpense (header-alone does NOT override explicit line-item lexical match).\n- Ambiguity handling & logging: if both mappings are plausibly matched (e.g., header present and short-distance 'operating' within previous sentence but not within the narrow adjacency windows), choose LeaseAndRentalExpense (canonical lexical) and log the example as 'header-overrule-avoided' with spans for: line-item lexical cue, header span, numeric span, chosen tag, rejected specific tag. Add logged cases to retraining queue.\n- Unit-tests (atomic examples to add):\n  - 'Rent expense was $1.3 million in 2017, $1.3 million in 2016, and $1.2 million in 2015.' -> LeaseAndRentalExpense.\n  - 'NOTE 11 - OPERATING LEASES. Rent expense was $1.3 million.' -> LeaseAndRentalExpense (header alone does not override line label).\n  - 'Operating lease rent expense — net was $1.0 million for the year.' -> OperatingLeasesRentExpenseNet (explicit adjacency/labeling).\n  - 'For operating leases, rent expense was $X' -> OperatingLeasesRentExpenseNet (explicit instrument context + adjacency).\n- Implementation notes (atomic):\n  - Apply this lexical-first rule before any header/context-scoring that boosts instrument-specific tags.\n  - Use token-distance thresholds and explicit row/line membership detection rather than document-level header presence to decide exception applicability.\n  - Record decision metadata (matched regex, token distances, header presence flag, chosen tag, rejected candidate) for each mapping to enable targeted QA and rule tuning."}], "added_content": ["[err-00002] helpful=0 harmful=0 :: err-000XX :: Lexical-first precedence for line-item expense labels (atomic rule to prevent overapplication of header/context inference):", "- Purpose (atomic): When a disclosure line explicitly uses a canonical line-item label (e.g., 'rent expense', 'lease and rental expense'), prefer the canonical line-item tag (LeaseAndRentalExpense) over a more specific context-derived tag (OperatingLeasesRentExpenseNet) unless the text itself explicitly signals the narrower concept.", "- Exact lexical cues (case-insensitive regex): /\\b(?:rent\\s+expense|lease(?:s)?\\s+and\\s+rental\\s+expense|lease\\s+and\\s+rental\\s+expense)\\b/i. Apply only when the cue appears in the same sentence or the same table/row label as the numeric token.", "- Association window: numeric token must be within ±8 tokens of the lexical cue OR the numeric is the value in the same table row/line that contains the lexical cue. Treat row/line membership as a strong local association (overrides paragraph-level header proximity).", "- Exception rules (allow OperatingLeasesRentExpenseNet only if ANY of the following explicit conditions are met):"], "removed_content": []}
{"timestamp": "2026-02-06T18:25:51.612161", "step": 62, "playbook_before_length": 46720, "playbook_after_length": 51398, "lines_before": 179, "lines_after": 203, "added_lines": 24, "removed_lines": 0, "operations_count": 1, "operations": [{"type": "ADD", "section": "context_clues_and_indicators", "content": "[ctx-000XX] Atomic rule: map 'exercise price' contingent on conversion -> DebtInstrumentConvertibleConversionPrice1\n- Purpose: prevent mis-mapping of 'exercise price' phrases to warrant/right tags when the exercisability or exercise-price clause is explicitly tied to conversion of a specific convertible debt instrument.\n- Exact lexical cues (case-insensitive regex examples):\n  - Conversion-link cues: /\\b(?:when and if|when\\s+if|when\\s+converted|upon\\s+conversion|upon\\s+conversion\\s+of|if\\s+the\\s+[0-9]{4}\\s+Notes\\s+are\\s+converted|contingent\\s+on\\s+conversion|tied\\s+to\\s+the\\s+Notes|exercisable\\s+when\\s+and\\s+if)\\b/i\n  - Exercise-price cue: /\\bexercise\\s+price\\b|\\bexercisable\\b|\\bexercise\\s+at\\b/i\n  - Convertible-instrument anchors: /\\bconvertible\\b|\\bNotes\\b|\\bthe\\s+[0-9]{4}\\s+Notes\\b|\\bconvertible\\s+notes\\b|\\bconvertible\\s+bond(s)?\\b/ i\n  - Warrant/right cues (to detect true warrant contexts): /\\bwarrant(?:s)?\\b|\\bright(?:s)?\\b|\\bclass\\s+of\\s+warrant(?:s)?\\b|\\bseries\\s+of\\s+warrants\\b/i\n- Association & antecedent resolution:\n  1) Primary case (same sentence): If an 'exercise price' numeric token appears in the same sentence as BOTH an exercise-price cue and a conversion-link cue OR a convertible-instrument anchor co-occurring with an exercise-price cue within the sentence, map numeric -> DebtInstrumentConvertibleConversionPrice1.\n  2) Cross-sentence antecedent: If an exercise-price numeric appears in a sentence containing an exercise-price cue and the immediately preceding sentence (±1 sentence) contains a convertible-instrument anchor with a conversion-linking phrase (e.g., 'when converted', 'upon conversion of the Notes'), allow antecedent resolution (span <= 40 tokens across sentence boundary) and map to DebtInstrumentConvertibleConversionPrice1.\n  3) Token-distance windows: require exercise-price numeric token to be within ±12 tokens of the exercise-price lexical cue; require conversion-link / convertible anchor to be within the same sentence OR previous sentence and within a combined span <= 40 tokens for cross-sentence resolution.\n- Precedence / tie-breaker rules:\n  1) If conversion-link present per above -> assign DebtInstrumentConvertibleConversionPrice1 (highest precedence).\n  2) Else if explicit warrant/right lexical cue is present near the numeric (within ±8 tokens) AND no conversion-link is detected -> assign ClassOfWarrantOrRightExercisePriceOfWarrantsOrRights1.\n  3) If both warrant cue and conversion-link are present, conversion-link wins (map to DebtInstrumentConvertibleConversionPrice1) but log as 'warrant-vs-conversion-conflict' for QA.\n  4) If exercise-price phrase occurs but instrument anchor absent and no warrant/right cue present, flag as ambiguous for human review instead of defaulting to warrant mapping.\n- Consistency propagation rule (atomic): If the same numeric value has been confidently mapped elsewhere in the document to DebtInstrumentConvertibleConversionPrice1 (confidence threshold met), propagate that mapping to other instances of the identical numeric token and exact-unit phrase (e.g., '$248.48 per share') unless a later sentence contains an explicit warrant/right class indicator that meets the warrant cue threshold. Record propagated mappings in decision metadata.\n- Logging & QA: record spans for exercise-price cue, conversion-link cue, instrument-anchor, numeric token, chosen tag, and which rule (same-sentence vs antecedent) applied. Log all 'warrant-vs-conversion-conflict' and 'propagation-overruled' cases for manual review.\n- Unit-tests (atomic examples):\n  1) 'The convertible bond hedges have an exercise price of $248.48 per share and are exercisable when and if the 2023 Notes are converted.' -> $248.48 = DebtInstrumentConvertibleConversionPrice1.\n  2) 'The warrants have an exercise price of $5.00 per share and are exercisable at any time prior to expiration.' -> $5.00 = ClassOfWarrantOrRightExercisePriceOfWarrantsOrRights1.\n  3) 'The exercise price is $1.25 per share. Upon conversion of the 2022 Convertible Notes, holders may exchange into common shares.' (exercise-price sentence separated; prior sentence anchors conversion) -> $1.25 = DebtInstrumentConvertibleConversionPrice1.\n  4) 'We issued warrants with an exercise price of $10.00 per share tied to the conversion of the Notes.' (both cues present) -> $10.00 = DebtInstrumentConvertibleConversionPrice1 (conversion-link precedence); log conflict.\n- Implementation note: insert this rule before any lexical fallback that maps 'exercise price' to a warrant/right tag. Add the unit-tests above to the regression suite and ensure decision metadata is stored for traceability."}], "added_content": ["[ctx-00003] helpful=0 harmful=0 :: [ctx-000XX] Atomic rule: map 'exercise price' contingent on conversion -> DebtInstrumentConvertibleConversionPrice1", "- Purpose: prevent mis-mapping of 'exercise price' phrases to warrant/right tags when the exercisability or exercise-price clause is explicitly tied to conversion of a specific convertible debt instrument.", "- Exact lexical cues (case-insensitive regex examples):", "  - Conversion-link cues: /\\b(?:when and if|when\\s+if|when\\s+converted|upon\\s+conversion|upon\\s+conversion\\s+of|if\\s+the\\s+[0-9]{4}\\s+Notes\\s+are\\s+converted|contingent\\s+on\\s+conversion|tied\\s+to\\s+the\\s+Notes|exercisable\\s+when\\s+and\\s+if)\\b/i", "  - Exercise-price cue: /\\bexercise\\s+price\\b|\\bexercisable\\b|\\bexercise\\s+at\\b/i"], "removed_content": []}
{"timestamp": "2026-02-06T18:27:32.141364", "step": 63, "playbook_before_length": 51398, "playbook_after_length": 56052, "lines_before": 203, "lines_after": 226, "added_lines": 21, "removed_lines": 0, "operations_count": 2, "operations": [{"type": "ADD", "section": "context_clues_and_indicators", "content": "Atomic rule: Percent directly qualifying a named debt instrument -> DebtInstrumentInterestRateStatedPercentage\n- Purpose: map percentage tokens that directly modify/narrow a named debt instrument to DebtInstrumentInterestRateStatedPercentage even if 'per annum' is absent. \n- Exact lexical anchors (case-insensitive): /\\b(note|notes|loan|loans|seller\\s+note|senior\\s+notes|term\\s+loan|revolver|debt|senior\\s+note)\\b/, coupon/interest qualifiers: /coupon|coupon\\s+rate|interest\\s+rate|rate\\b|yield\\b/.\n- Percentage detection: token containing '%' or word 'percent' or forms like '2.25%' or '2.250%'.\n- Association windows: same-sentence adjacency: percentage within ±6 tokens of an instrument-anchor OR within ≤3 tokens when percent immediately follows/precedes instrument name (e.g., 'Senior Notes, 2.250%'). Allow antecedent instrument-anchor in previous sentence when instrument name resolves to 'the Notes'/'such notes' etc. (±1 sentence and combined span <=40 tokens).\n- Precedence & conflicts: prefer DebtInstrumentInterestRateStatedPercentage over spread/basis tags unless a clear spread-matching pattern (e.g., 'LIBOR plus', 'margin over LIBOR', 'spread over') exists within ±3 tokens of the percentage—then map to DebtInstrumentBasisSpreadOnVariableRate1. If both 'margin/spread' and instrument-anchor + direct adjacency exist, prefer spread only when explicit spread/margin lexemes are present; otherwise prefer stated-rate. Log 'rate-vs-spread-conflict' when both cues are nearby.\n- Linking: when instrument-anchor present, link assigned rate to instrument identifier (store anchor span + numeric span).\n- Unit-tests (atomic examples):\n  - 'Senior Notes bearing interest at 2.250%' -> 2.250% = DebtInstrumentInterestRateStatedPercentage (Senior Notes).\n  - 'The 3.250% Senior Notes, aggregate principal amount €500 million' -> 3.250% = DebtInstrumentInterestRateStatedPercentage; €500 million = DebtInstrumentFaceAmount.\n  - 'margin ranges from 1.00% to 2.00% in the case of LIBOR loans' -> map to DebtInstrumentBasisSpreadOnVariableRate1 (spread precedence).\n- Logging: record percent token span, instrument-anchor span, chosen tag, and which precedence rule applied."}, {"type": "ADD", "section": "context_clues_and_indicators", "content": "Atomic rule: 'aggregate principal amount' / 'principal amount' lexical-first -> DebtInstrumentFaceAmount\n- Purpose: deterministically map currency amounts described as the instrument's aggregate/face principal to DebtInstrumentFaceAmount (aggregate principal/face amount of a debt issuance).\n- Exact lexical cues (case-insensitive regexes): /\\baggregate\\s+principal\\s+amount\\b/, /\\bin\\s+an\\s+aggregate\\s+principal\\s+amount\\s+of\\b/, /\\baggregate\\s+principal\\b/, /\\bprincipal\\s+amount\\b/ when used with instrument-anchor in same clause/sentence.\n- Association window: currency numeric token (symbol or currency word) within ±8 tokens of the cue in same sentence. If instrument-anchor appears in same sentence or immediately preceding sentence (±1 sentence and combined span <=40 tokens), link numeric -> specific debt instrument face amount. If no explicit instrument anchor but the phrase 'aggregate principal amount' is present, still map to DebtInstrumentFaceAmount (general) and flag 'face-amount-no-anchor' for review.\n- Precedence & conflicts: this mapping overrides generic facility-capacity/availability or maximum-borrowing heuristics when cue explicitly includes 'aggregate principal amount' and an instrument anchor exists. Do NOT map 'aggregate principal' that is clearly part of facility-capacity language (e.g., 'revolving credit facility in an aggregate principal amount of up to $X') to DebtInstrumentFaceAmount; in that case prefer LineOfCreditFacilityMaximumBorrowingCapacity (apply facility heuristics). Use token-level detection of 'revolving/credit/facility/revolver' to pick facility-capacity instead.\n- Normalization: accept currencies with symbols ($, €, GBP) and words (dollars, euros); support 'in the aggregate principal amount of €500 million' variants.\n- Unit-tests (atomic examples):\n  - '€500 million aggregate principal amount of Senior Notes' -> €500M = DebtInstrumentFaceAmount (linked to Senior Notes).\n  - 'aggregate principal amount of $500 million' (no instrument name in sentence) -> $500M = DebtInstrumentFaceAmount (general), log 'face-amount-no-anchor'.\n  - 'revolving credit facility in an aggregate principal amount of up to $225.0 million' -> map to LineOfCreditFacilityMaximumBorrowingCapacity (facility-capacity override).\n- Logging: record cue span, numeric span, instrument-anchor span (if any), chosen tag, and whether a facility-capacity override applied."}], "added_content": ["[ctx-00004] helpful=0 harmful=0 :: Atomic rule: Percent directly qualifying a named debt instrument -> DebtInstrumentInterestRateStatedPercentage", "- Purpose: map percentage tokens that directly modify/narrow a named debt instrument to DebtInstrumentInterestRateStatedPercentage even if 'per annum' is absent. ", "- Exact lexical anchors (case-insensitive): /\\b(note|notes|loan|loans|seller\\s+note|senior\\s+notes|term\\s+loan|revolver|debt|senior\\s+note)\\b/, coupon/interest qualifiers: /coupon|coupon\\s+rate|interest\\s+rate|rate\\b|yield\\b/.", "- Percentage detection: token containing '%' or word 'percent' or forms like '2.25%' or '2.250%'.", "- Association windows: same-sentence adjacency: percentage within ±6 tokens of an instrument-anchor OR within ≤3 tokens when percent immediately follows/precedes instrument name (e.g., 'Senior Notes, 2.250%'). Allow antecedent instrument-anchor in previous sentence when instrument name resolves to 'the Notes'/'such notes' etc. (±1 sentence and combined span <=40 tokens)."], "removed_content": []}
{"timestamp": "2026-02-06T18:29:37.933901", "step": 64, "playbook_before_length": 56052, "playbook_after_length": 59686, "lines_before": 226, "lines_after": 245, "added_lines": 18, "removed_lines": 0, "operations_count": 1, "operations": [{"type": "ADD", "section": "context_clues_and_indicators", "content": "Atomic rule: Map bare benchmark/index level percentages (e.g., 'LIBOR', 'one‑month LIBOR', 'EURIBOR', 'SOFR') -> DebtInstrumentBasisSpreadOnVariableRate1.\n- Purpose: capture numeric index levels referenced in prose (not spreads) as variable-benchmark values per ground-truth mapping.\n- Exact index lexical patterns (case-insensitive regex examples): /\\b(?:LIBOR|one[- ]month\\s+LIBOR|three[- ]month\\s+LIBOR|EURIBOR|SOFR|prime\\s+rate|ABR|an?\\s+index)\\b/i. Accept short forms (\"LIBOR\") and adjectival qualifiers (\"one month\", \"three month\").\n- Index-level qualifiers (strong signals): /\\bwas approximately\\b|\\bwas\\s+approximately\\b|\\bwas\\s+about\\b|\\bas\\s+of\\s+[A-Za-z0-9,]+\\b|\\bon\\s+[A-Za-z0-9,]+\\b|\\bat\\s+\\b|\\bstood\\s+at\\b|\\bregistered\\s+at\\b/i. Presence of these within ±6 tokens of numeric greatly increases confidence this is an index level.\n- Numeric detection: percentages with '%' or 'percent' or numeric forms like '2.51%'. Require percentage token present.\n- Token association window: map a percentage to basis-spread when an index lexical match occurs within ±6 tokens of the percent OR the sentence explicitly names the index (anywhere in same sentence) and a proximity qualifier like 'was approximately'/'as of' is present within ±12 tokens of the percent.\n- Precedence rules (apply in order):\n  1) If percentage token co-occurs with an index name per patterns above -> assign DebtInstrumentBasisSpreadOnVariableRate1.\n  2) Exception: if the same percentage has explicit instrument-anchor (note/loan/term loan/senior notes) in the same sentence AND an explicit stated-rate cue ('per annum', 'per year', 'coupon', 'interest rate', 'yield') appears within ±3 tokens of the percentage -> assign DebtInstrumentInterestRateStatedPercentage instead. Log as 'index-vs-stated-exception'.\n  3) If both index and 'plus/margin/spread' cues present (e.g., 'LIBOR plus 1.70%') -> existing 'LIBOR plus X%' rule (DebtInstrumentBasisSpreadOnVariableRate1) applies; ensure priority is consistent.\n- Conflict handling & logging: when index-name and instrument-anchor + per-annum cues are both present but not within the tight exception windows above, prefer basis-spread mapping (index wins) and log the example as 'index-precedence-chosen' with spans for percent, index-name, and instrument-anchor for QA.\n- Edge cases: do NOT map non-benchmark uses of index words (e.g., 'the LIBOR-based covenant was amended' with no percent nearby) to any numeric tag; require numeric percent proximity. If percent appears but no index or instrument cues present, mark ambiguous and queue for review.\n- Minimal unit-tests to add (atomic examples):\n  - 'One month LIBOR as of June 30, 2019 was approximately 2.51%' -> 2.51% = DebtInstrumentBasisSpreadOnVariableRate1.\n  - 'LIBOR was 2.51% on December 31' -> 2.51% = DebtInstrumentBasisSpreadOnVariableRate1.\n  - 'the margin ranges from 1.00% to 2.00% in the case of LIBOR loans' -> both percents = DebtInstrumentBasisSpreadOnVariableRate1 (existing behavior).\n  - 'The interest rate is 5.00% per annum on the term loan' -> 5.00% = DebtInstrumentInterestRateStatedPercentage (exception: instrument-anchor + per‑annum wins).\n  - 'One month LIBOR was 2.51% and the notes bear interest at 5.00% per annum' -> 2.51% = DebtInstrumentBasisSpreadOnVariableRate1; 5.00% = DebtInstrumentInterestRateStatedPercentage.\n- Implementation notes: insert this rule before generic percentage-to-interest fallbacks and alongside ctx-00003 and ctx-00008; record decision metadata (index span, percent span, which precedence branch used) for each mapping to enable targeted QA and retraining."}], "added_content": ["[ctx-00006] helpful=0 harmful=0 :: Atomic rule: Map bare benchmark/index level percentages (e.g., 'LIBOR', 'one‑month LIBOR', 'EURIBOR', 'SOFR') -> DebtInstrumentBasisSpreadOnVariableRate1.", "- Purpose: capture numeric index levels referenced in prose (not spreads) as variable-benchmark values per ground-truth mapping.", "- Exact index lexical patterns (case-insensitive regex examples): /\\b(?:LIBOR|one[- ]month\\s+LIBOR|three[- ]month\\s+LIBOR|EURIBOR|SOFR|prime\\s+rate|ABR|an?\\s+index)\\b/i. Accept short forms (\"LIBOR\") and adjectival qualifiers (\"one month\", \"three month\").", "- Index-level qualifiers (strong signals): /\\bwas approximately\\b|\\bwas\\s+approximately\\b|\\bwas\\s+about\\b|\\bas\\s+of\\s+[A-Za-z0-9,]+\\b|\\bon\\s+[A-Za-z0-9,]+\\b|\\bat\\s+\\b|\\bstood\\s+at\\b|\\bregistered\\s+at\\b/i. Presence of these within ±6 tokens of numeric greatly increases confidence this is an index level.", "- Numeric detection: percentages with '%' or 'percent' or numeric forms like '2.51%'. Require percentage token present."], "removed_content": []}
{"timestamp": "2026-02-06T18:30:56.379542", "step": 65, "playbook_before_length": 59686, "playbook_after_length": 63383, "lines_before": 245, "lines_after": 267, "added_lines": 22, "removed_lines": 0, "operations_count": 1, "operations": [{"type": "ADD", "section": "common_mistakes_to_avoid", "content": "Taxonomy-existence + instrument-specificity fallback (atomic rule):\n1) Purpose: ensure issuance/issuance-price/share mappings preserve instrument-class specificity and cause taxonomy-enrichment when a more precise tag is missing.\n2) Precondition checks (apply BEFORE finalizing any issuance-related tag):\n   a) Detect instrument-class cues in same sentence OR ±1 sentence antecedent (token-window <= 40 tokens): regexes (case-insensitive): /\\bpreferred\\s+stock\\b/, /\\bcommon\\s+stock\\b/, /\\bSeries\\s+[A-Z0-9]+\\b/, /\\bconvertible\\b/, /\\bdepositary\\s+share(s)?\\b/, /\\bmandatory\\s+convertible\\b/.\n   b) Confirm numeric unit is 'shares' OR the phrase contains 'shares' / 'issued' / 'issued X shares' within ±8 tokens.\n3) Taxonomy existence check:\n   - If a candidate instrument-specific tag exists in the provided taxonomy (e.g., PreferredStockSharesIssued / PreferredStockDividendRatePercentage / DebtInstrumentConvertibleConversionPrice1), assign that specific tag (highest precedence).\n   - If candidate instrument-specific tag DOES NOT exist but instrument-class cues are present, DO NOT silently accept a generic issuance tag without metadata. Instead apply the fallback below.\n4) Fallback mapping (when specific tag missing):\n   a) Assign the most precise available tag from taxonomy (e.g., StockIssuedDuringPeriodSharesNewIssues) only as a technical mapping, AND attach structured metadata to the mapping result: { instrument_class: (preferred|common|convertible|other), instrument_series: <series-id if present>, cue_span: <text span>, rule: 'specific-tag-missing-fallback' }.\n   b) Immediately enqueue a taxonomy_enrichment item with payload: { sentence_text, numeric_value, instrument_class, suggested_preferred_tag_name, mapping_id } for human review and possible taxonomy addition.\n5) Logging & QA: for every fallback case log an entry with: chosen_tag, missing_specific_tag_candidates (list), instrument_class_span, numeric_span, filename/doc-id, and unique mapping id. Count these and surface in QA dashboard (threshold alert if >N per issuer or per run).\n6) Unit-tests (atomic examples to add):\n   - 'we issued 800,000 shares of common stock' -> if Preferred-specific tag absent then: map -> StockIssuedDuringPeriodSharesNewIssues + metadata {instrument_class: common}; flag taxonomy_enrichment=false (common tag typically present). If specific common tag exists, assign it.\n   - 'we issued 500,000 shares of the Convertible Preferred Stock' -> if PreferredStockSharesIssued tag missing: map -> StockIssuedDuringPeriodSharesNewIssues + metadata {instrument_class: preferred, series: 'Convertible Preferred'}; enqueue taxonomy_enrichment (preferred-issuance-tag).\n   - 'issued 250,000 shares of Series A Preferred Stock' -> same behavior; record series id in metadata.\n7) Precedence & tie-breakers: instrument-class detection outranks nearest-lexical generic match. Only choose a generic issuance tag without metadata when no instrument-class cue is detected.\n8) Implementation notes (atomic):\n   - Implement taxonomy-existence check as a deterministic lookup step after candidate-tag scoring but before final commit.\n   - Store metadata fields in the mapping output schema so downstream consumers retain instrument specificity even if taxonomy lacks a dedicated tag.\n   - Add automated QA job that aggregates all 'specific-tag-missing-fallback' logs weekly and auto-generates suggested taxonomy entries for human curators.\n9) Rationale: preserves signal (instrument class, series) when taxonomy incomplete, prevents silent context-collapse, enables targeted taxonomy improvements and avoids loss of granularity that would otherwise impede training/QA."}], "added_content": ["[err-00007] helpful=0 harmful=0 :: Taxonomy-existence + instrument-specificity fallback (atomic rule):", "1) Purpose: ensure issuance/issuance-price/share mappings preserve instrument-class specificity and cause taxonomy-enrichment when a more precise tag is missing.", "2) Precondition checks (apply BEFORE finalizing any issuance-related tag):", "   a) Detect instrument-class cues in same sentence OR ±1 sentence antecedent (token-window <= 40 tokens): regexes (case-insensitive): /\\bpreferred\\s+stock\\b/, /\\bcommon\\s+stock\\b/, /\\bSeries\\s+[A-Z0-9]+\\b/, /\\bconvertible\\b/, /\\bdepositary\\s+share(s)?\\b/, /\\bmandatory\\s+convertible\\b/.", "   b) Confirm numeric unit is 'shares' OR the phrase contains 'shares' / 'issued' / 'issued X shares' within ±8 tokens."], "removed_content": []}
{"timestamp": "2026-02-06T18:33:11.291929", "step": 66, "playbook_before_length": 63383, "playbook_after_length": 68107, "lines_before": 267, "lines_after": 268, "added_lines": 1, "removed_lines": 0, "operations_count": 1, "operations": [{"type": "ADD", "section": "context_clues_and_indicators", "content": "Atomic rule: Map 'borrowings/borrowed/amounts outstanding/amount outstanding under the [facility]' -> debt-balance tag (prefer LongTermDebt by default) (apply BEFORE facility-capacity/availability mapping). - Purpose: avoid lexical-collapse where presence of the word 'facility' causes selection of facility-capacity tags (LineOfCredit*) rather than the debt balance tag the numeric actually represents. - Exact lexical cues (case-insensitive regexes): /\\bborrowings\\b/, /\\bborrowed\\b/, /\\bamounts?\\s+outstanding\\b/, /\\boutstanding\\b.*?under\\s+the\\s+/, /\\bbalance\\s+of\\s+borrowings\\b/, /\\bprincipal\\s+outstanding\\b/, /\\bamount\\s+outstanding\\s+under\\b/. - Association window: require a currency numeric token within ±8 tokens of one of the borrowings/outstanding cues in the same sentence; allow antecedent facility anchor (e.g., 'ABL Facility', 'revolver', 'credit facility') in same sentence or previous sentence (±1 sentence, span <= 40 tokens) to link the debt to a specific facility/instrument. - Precedence & decision flow (apply in order): 1) If numeric is currency AND a borrowings/outstanding/borrowed cue matches within ±8 tokens -> classify as a debt-balance tag (debt-carrying/face/balance). 2) If instrument-specific debt tag exists and an instrument-anchor (e.g., 'Term Loan', 'Senior Notes', named facility with instrument id) is present in sentence/antecedent, prefer the instrument-specific balance tag (DebtInstrumentCarryingAmount / DebtInstrumentFaceAmount) and link mapping to that instrument. 3) Else if no instrument-specific tag exists or anchor absent, default to LongTermDebt (prefer LongTermDebt when no explicit short-term/current qualifier present). 4) Only map to LineOfCreditFacilityMaximumBorrowingCapacity / RemainingBorrowingCapacity / LineOfCredit* when explicit capacity/commitment/availability lexical cues appear (e.g., 'up to', 'maximum', 'availability', 'amount available', 'commitment', 'borrowing base') within the capacity windows defined in existing facility rules. - Short-term vs long-term resolution: if the same sentence contains short-term/time qualifiers within ±6 tokens (regex: /\\bcurrent\\b|\\bshort[- ]term\\b|\\bdue\\s+within\\s+12\\s+months\\b|\\bwithin\\s+one\\s+year\\b|\\bnext\\s+12\\s+months\\b/), map to the appropriate current/short-term debt tag (e.g., CurrentPortionOfLongTermDebt or ShortTermDebt) instead of LongTermDebt. - Conflict / tie-breaker: if both borrowings/outstanding cues AND capacity/availability cues appear for the same numeric, prefer the borrowings/outstanding -> debt-balance mapping (because the numeric quantifies an outstanding balance) and log as 'borrowings-vs-capacity-conflict' for QA. If capacity wording is dominant and numeric explicitly labeled 'available'/'available under' then capacity mapping overrides. - Instrument-link fallback: when instrument-anchor resolution yields a named debt instrument and taxonomy contains DebtInstrumentCarryingAmount for that instrument, prefer that tag over generic LongTermDebt and include anchor span in mapping metadata. - Unit-tests (atomic examples to add): 1) '$58.0 million of borrowings under the ABL Facility' -> $58.0M = LongTermDebt (linked to ABL Facility instrument anchor if available). 2) '$50 million outstanding under the revolver' -> $50.0M = DebtInstrumentCarryingAmount or LongTermDebt (not LineOfCreditFacilityMaximumBorrowingCapacity). 3) 'The amount outstanding under the facility totaled $12.5 million and the amount available under the facility totaled $62.5 million' -> $12.5M = DebtBalance (LettersOfCreditOutstandingAmount / OutstandingBorrowings); $62.5M = LineOfCreditFacilityRemainingBorrowingCapacity (explicit 'available' maps to remaining). 4) 'Short-term borrowings under the credit facility were $15 million' -> $15.0M = ShortTermDebt / CurrentPortion (use short-term tag). 5) 'Revolving credit facility in an aggregate principal amount of up to $225.0 million; borrowings outstanding were $30.0 million' -> $225.0M = LineOfCreditFacilityMaximumBorrowingCapacity; $30.0M = DebtBalance (LongTermDebt/DebtInstrumentCarryingAmount). - Logging & QA: record chosen mapping, matched cue span (borrowings/outstanding), any instrument/facility anchor span, whether a short-term qualifier was detected, and if a borrowings-vs-capacity conflict occurred. Add conflicts to retraining queue and surface for manual review when count > threshold. - Implementation note: insert this rule into the pipeline before generic facility-capacity heuristics (ctx-00008, ctx-00009) and before lexical-only 'facility' -> LineOfCredit fallbacks so numeric tokens with borrowings/outstanding cues are correctly mapped to debt-balance tags rather than facility tags."}], "added_content": ["[ctx-00008] helpful=0 harmful=0 :: Atomic rule: Map 'borrowings/borrowed/amounts outstanding/amount outstanding under the [facility]' -> debt-balance tag (prefer LongTermDebt by default) (apply BEFORE facility-capacity/availability mapping). - Purpose: avoid lexical-collapse where presence of the word 'facility' causes selection of facility-capacity tags (LineOfCredit*) rather than the debt balance tag the numeric actually represents. - Exact lexical cues (case-insensitive regexes): /\\bborrowings\\b/, /\\bborrowed\\b/, /\\bamounts?\\s+outstanding\\b/, /\\boutstanding\\b.*?under\\s+the\\s+/, /\\bbalance\\s+of\\s+borrowings\\b/, /\\bprincipal\\s+outstanding\\b/, /\\bamount\\s+outstanding\\s+under\\b/. - Association window: require a currency numeric token within ±8 tokens of one of the borrowings/outstanding cues in the same sentence; allow antecedent facility anchor (e.g., 'ABL Facility', 'revolver', 'credit facility') in same sentence or previous sentence (±1 sentence, span <= 40 tokens) to link the debt to a specific facility/instrument. - Precedence & decision flow (apply in order): 1) If numeric is currency AND a borrowings/outstanding/borrowed cue matches within ±8 tokens -> classify as a debt-balance tag (debt-carrying/face/balance). 2) If instrument-specific debt tag exists and an instrument-anchor (e.g., 'Term Loan', 'Senior Notes', named facility with instrument id) is present in sentence/antecedent, prefer the instrument-specific balance tag (DebtInstrumentCarryingAmount / DebtInstrumentFaceAmount) and link mapping to that instrument. 3) Else if no instrument-specific tag exists or anchor absent, default to LongTermDebt (prefer LongTermDebt when no explicit short-term/current qualifier present). 4) Only map to LineOfCreditFacilityMaximumBorrowingCapacity / RemainingBorrowingCapacity / LineOfCredit* when explicit capacity/commitment/availability lexical cues appear (e.g., 'up to', 'maximum', 'availability', 'amount available', 'commitment', 'borrowing base') within the capacity windows defined in existing facility rules. - Short-term vs long-term resolution: if the same sentence contains short-term/time qualifiers within ±6 tokens (regex: /\\bcurrent\\b|\\bshort[- ]term\\b|\\bdue\\s+within\\s+12\\s+months\\b|\\bwithin\\s+one\\s+year\\b|\\bnext\\s+12\\s+months\\b/), map to the appropriate current/short-term debt tag (e.g., CurrentPortionOfLongTermDebt or ShortTermDebt) instead of LongTermDebt. - Conflict / tie-breaker: if both borrowings/outstanding cues AND capacity/availability cues appear for the same numeric, prefer the borrowings/outstanding -> debt-balance mapping (because the numeric quantifies an outstanding balance) and log as 'borrowings-vs-capacity-conflict' for QA. If capacity wording is dominant and numeric explicitly labeled 'available'/'available under' then capacity mapping overrides. - Instrument-link fallback: when instrument-anchor resolution yields a named debt instrument and taxonomy contains DebtInstrumentCarryingAmount for that instrument, prefer that tag over generic LongTermDebt and include anchor span in mapping metadata. - Unit-tests (atomic examples to add): 1) '$58.0 million of borrowings under the ABL Facility' -> $58.0M = LongTermDebt (linked to ABL Facility instrument anchor if available). 2) '$50 million outstanding under the revolver' -> $50.0M = DebtInstrumentCarryingAmount or LongTermDebt (not LineOfCreditFacilityMaximumBorrowingCapacity). 3) 'The amount outstanding under the facility totaled $12.5 million and the amount available under the facility totaled $62.5 million' -> $12.5M = DebtBalance (LettersOfCreditOutstandingAmount / OutstandingBorrowings); $62.5M = LineOfCreditFacilityRemainingBorrowingCapacity (explicit 'available' maps to remaining). 4) 'Short-term borrowings under the credit facility were $15 million' -> $15.0M = ShortTermDebt / CurrentPortion (use short-term tag). 5) 'Revolving credit facility in an aggregate principal amount of up to $225.0 million; borrowings outstanding were $30.0 million' -> $225.0M = LineOfCreditFacilityMaximumBorrowingCapacity; $30.0M = DebtBalance (LongTermDebt/DebtInstrumentCarryingAmount). - Logging & QA: record chosen mapping, matched cue span (borrowings/outstanding), any instrument/facility anchor span, whether a short-term qualifier was detected, and if a borrowings-vs-capacity conflict occurred. Add conflicts to retraining queue and surface for manual review when count > threshold. - Implementation note: insert this rule into the pipeline before generic facility-capacity heuristics (ctx-00008, ctx-00009) and before lexical-only 'facility' -> LineOfCredit fallbacks so numeric tokens with borrowings/outstanding cues are correctly mapped to debt-balance tags rather than facility tags."], "removed_content": []}
{"timestamp": "2026-02-06T18:35:03.329819", "step": 67, "playbook_before_length": 68107, "playbook_after_length": 72584, "lines_before": 268, "lines_after": 293, "added_lines": 24, "removed_lines": 0, "operations_count": 1, "operations": [{"type": "ADD", "section": "context_clues_and_indicators", "content": "Atomic rule A: map equity-affiliate investment currency amounts -> EquityMethodInvestments\n- Purpose: deterministically map currency amounts described as investments in unconsolidated/equity-method affiliates to EquityMethodInvestments rather than to generic Investment or Monetary tags.\n- Exact lexical cues (case-insensitive regex examples): /investments?\\s+in\\s+(?:unconsolidated\\s+)?(?:equity\\s+)?affiliat(?:e|es)\\b/, /investment\\s+in\\s+equity\\s+affiliat(?:e|es)\\b/, /equity-method\\s+investments?/i.\n- Association window: require a currency numeric token within ±12 tokens of one of the cues in the same sentence. Allow antecedent resolution to previous sentence (±1 sentence) when anaphors like 'such affiliates'/'these equity affiliates' appear; combined cross-sentence span <= 40 tokens.\n- Precedence: this mapping overrides any generic 'investments' or 'other-investments' tag. If both an equity-affiliate cue and a consolidation/ownership disclosure cue (e.g., 'unconsolidated', 'equity method', 'our share of') are present, raise confidence and map to EquityMethodInvestments; if only 'affiliate' appears without equity/consolidation cue, attach metadata {confidence: low, cue_span} and flag for review.\n- Normalization: capture currency tokens (with $ or currency words) and normalize to numeric value; store instrument-anchor span = affiliate phrase for downstream linking.\n- Unit-tests (atomic):\n  - 'investments in unconsolidated equity affiliates of $190,964' -> $190,964 = EquityMethodInvestments (anchor: 'unconsolidated equity affiliates').\n  - 'our investment in equity affiliates amounted to $2,500' -> $2,500 = EquityMethodInvestments.\n  - 'investments in affiliates — $1,000' (no 'equity'/'unconsolidated' cue) -> map with metadata {confidence: low} and queue for review.\n- Logging: record cue span, numeric span, antecedent resolution if used, chosen tag, and confidence.\n\nAtomic rule B: map 'useful life' integers -> PropertyPlantAndEquipmentUsefulLife\n- Purpose: map numeric tokens that express asset useful lives (years) for classes of property, plant and equipment to PropertyPlantAndEquipmentUsefulLife instead of generic numeric/quantity tags.\n- Exact lexical cues (case-insensitive regex examples): /useful\\s+life(s)?\\b/, /estimated\\s+useful\\s+life(s)?\\b/, /estimated\\s+useful\\s+lives\\b/, /have\\s+useful\\s+lives\\b/, /useful\\s+life\\s+of\\s+\\d+\\s+year(s)?/i. Also capture class anchors: /buildings\\b/, /furniture\\b/, /fixtures\\b/, /equipment\\b/, /leasehold\\s+improvements\\b/, /machinery\\b/.\n- Numeric detection & units: prefer integer tokens representing years (e.g., 3, 10, 30) optionally followed by 'year(s)' or 'yrs' within ±3 tokens. If unit 'years' is absent but lexical phrase 'useful life' is present, allow integer-only mapping (years implied) but attach confidence flag if ambiguous.\n- Association window: require numeric token within ±8 tokens of 'useful life' cue OR within ±6 tokens of the class-anchor when 'useful life' occurs in adjacent clause; allow antecedent class-anchor in previous sentence (±1 sentence) when phrase 'such assets'/'these assets' refers back; combined span <= 40 tokens.\n- Precedence & tie-breaker: map to PropertyPlantAndEquipmentUsefulLife (highest) over generic numeric tags or over depreciation/expense tags. If same numeric also appears adjacent to monetary cues (e.g., $ amounts) prefer monetary mapping for currency tokens and useful-life mapping only for the integer token representing years.\n- Normalization: store integer as whole-year count; if range expressed (e.g., '10 to 30 years') capture as two PropertyPlantAndEquipmentUsefulLife entries with {min:, max:} metadata or as separate tags per class if classes differ.\n- Unit-tests (atomic):\n  - 'Buildings — useful lives are 10 to 40 years' -> 10 & 40 = PropertyPlantAndEquipmentUsefulLife (class anchor: Buildings) with range metadata.\n  - 'Furniture, fixtures and equipment — useful lives are 3 years' -> 3 = PropertyPlantAndEquipmentUsefulLife (class anchor: furniture, fixtures and equipment).\n  - 'The buildings have useful lives of 30 years' -> 30 = PropertyPlantAndEquipmentUsefulLife.\n- Ambiguity handling: if numeric has no 'year' unit and no explicit 'useful life' cue, do not auto-map; flag for review. If a percentage appears near 'useful life', treat as unrelated and flag.\n- Logging: record cue span, numeric span, class-anchor span, chosen tag, and whether unit ('years') was explicit or inferred."}], "added_content": ["[ctx-00009] helpful=0 harmful=0 :: Atomic rule A: map equity-affiliate investment currency amounts -> EquityMethodInvestments", "- Purpose: deterministically map currency amounts described as investments in unconsolidated/equity-method affiliates to EquityMethodInvestments rather than to generic Investment or Monetary tags.", "- Exact lexical cues (case-insensitive regex examples): /investments?\\s+in\\s+(?:unconsolidated\\s+)?(?:equity\\s+)?affiliat(?:e|es)\\b/, /investment\\s+in\\s+equity\\s+affiliat(?:e|es)\\b/, /equity-method\\s+investments?/i.", "- Association window: require a currency numeric token within ±12 tokens of one of the cues in the same sentence. Allow antecedent resolution to previous sentence (±1 sentence) when anaphors like 'such affiliates'/'these equity affiliates' appear; combined cross-sentence span <= 40 tokens.", "- Precedence: this mapping overrides any generic 'investments' or 'other-investments' tag. If both an equity-affiliate cue and a consolidation/ownership disclosure cue (e.g., 'unconsolidated', 'equity method', 'our share of') are present, raise confidence and map to EquityMethodInvestments; if only 'affiliate' appears without equity/consolidation cue, attach metadata {confidence: low, cue_span} and flag for review."], "removed_content": []}
{"timestamp": "2026-02-06T18:36:52.783223", "step": 68, "playbook_before_length": 72584, "playbook_after_length": 80493, "lines_before": 293, "lines_after": 330, "added_lines": 34, "removed_lines": 0, "operations_count": 4, "operations": [{"type": "ADD", "section": "context_clues_and_indicators", "content": "Atomic rule: map 'granted' + 'award(s)' -> ShareBasedCompensationArrangementByShareBasedPaymentAwardEquityInstrumentsOtherThanOptionsGrantsInPeriod\n- Purpose: detect explicit grant events and map numeric share counts to the grants-in-period tag rather than issuance/settlement or outstanding tags.\n- Exact lexical cues (case-insensitive regexes): /\\bgrant(?:ed|s)?\\b/, /\\baward(?:s|ed)?\\b/, /performance\\s+share(?:s)?\\b/, /restricted\\s+stock\\s+award(?:s)?\\b/, /RSU(?:s)?\\b/.\n- Association window: numeric-token must lie within ±8 tokens of any grant/award cue in same sentence OR numeric appears in same clause containing 'granted'/'awarded'. Allow antecedent plan/instrument anchor ('the Plan', named plan) in previous sentence (±1 sentence, combined span <= 40 tokens).\n- Precedence: if grant/award cues present -> assign ShareBasedCompensationArrangementByShareBasedPaymentAwardEquityInstrumentsOtherThanOptionsGrantsInPeriod. This overrides generic 'shares issued', 'sold', or plan-availability fallbacks unless explicit 'issued and delivered', 'vested and settled', or 'sold on the market' cues appear nearer the numeric (distance threshold: issued/settled cues must be within 6 tokens of numeric to override).\n- Conflict handling: if both 'granted' and 'issued' appear, choose 'granted' mapping when 'granted' is the verb linked to 'award' (e.g., 'granted performance share awards of 366,500 shares'); choose 'issued' mapping when numeric is described as 'were issued', 'issued and outstanding', 'sold' with underwriter cues.\n- Unit-tests (atomic):\n  - 'granted performance share awards of 366,500 shares' -> 366,500 = ShareBasedCompensationArrangementByShareBasedPaymentAwardEquityInstrumentsOtherThanOptionsGrantsInPeriod\n  - 'We issued 366,500 shares under the offering' -> 366,500 = StockIssuedDuringPeriodSharesNewIssues (issued wins when 'issued' is the direct verb)\n- Logging: record matched cue spans ('granted' span and 'award' span) and numeric span for QA and traceability."}, {"type": "ADD", "section": "context_clues_and_indicators", "content": "Atomic rule: map 'weighted-average fair value $X per share' -> ShareBasedCompensationArrangementByShareBasedPaymentAwardEquityInstrumentsOtherThanOptionsGrantsInPeriodWeightedAverageGrantDateFairValue\n- Purpose: detect grant-date weighted-average fair value statements and avoid mapping them to generic price-per-share tags.\n- Exact lexical cues (case-insensitive regexes): /weighted[- ]?average\\s+fair\\s+value\\b/, /weighted[- ]?average\\s+grant[- ]?date\\s+fair\\s+value\\b/, /average\\s+grant[- ]date\\s+fair\\s+value\\b/.\n- Numeric pattern: currency token followed by unit 'per share' / 'per common share' / 'per share of common stock' within ±6 tokens.\n- Association window: weighted-average cue and currency-per-share must co-occur in same sentence; antecedent 'granted'/'award' within ±1 sentence increases confidence but is not required.\n- Precedence: this mapping takes precedence over generic 'SaleOfStockPricePerShare' or other per-share price tags. Exception: if the sentence also contains convertible-specific conversion-link cues (see convertible rule) that explicitly tie the per-share dollar to conversion of a debt instrument (e.g., 'upon conversion the conversion price will be $X per share'), then DebtInstrumentConvertibleConversionPrice1 wins.\n- Unit-tests (atomic):\n  - 'weighted-average fair value of $8.05 per share' -> $8.05 = ShareBasedCompensationArrangementByShareBasedPaymentAwardEquityInstrumentsOtherThanOptionsGrantsInPeriodWeightedAverageGrantDateFairValue\n  - 'The weighted average grant-date fair value was $2.50 per share' -> $2.50 = same tag\n- Logging: store cue span and whether a 'granted' anchor was present for confidence scoring."}, {"type": "ADD", "section": "context_clues_and_indicators", "content": "Atomic rule: map 'convertible ... at $X per share' / 'conversion price' / 'upon conversion' -> DebtInstrumentConvertibleConversionPrice1\n- Purpose: deterministically map per‑share dollar amounts that represent a convertible debt instrument's conversion/exchange price to the convertible-conversion-price tag instead of generic per-share price or warrant-exercise tags.\n- Exact lexical cues (case-insensitive regexes): /\\bconvertible\\b/, /\\bconversion\\s+price\\b/, /\\bconvert(?:ible)?\\s+into\\b/, /\\bupon\\s+conversion\\b/, /\\bwhen\\s+converted\\b/, /\\bat\\s+\\$?\\d+[\\d,]*(?:\\.\\d+)?\\s+per\\s+share\\b/.\n- Association window: numeric-per-share must be within ±12 tokens of either 'convertible' or 'conversion' cues in same sentence OR numeric-per-share appears in a sentence with an exercise-price cue and the immediately preceding sentence contains convertible-anchor + conversion-linking phrase (±1 sentence, combined span <= 40 tokens).\n- Precedence: when convertible/conversion cues are satisfied -> assign DebtInstrumentConvertibleConversionPrice1. This overrides generic 'SaleOfStockPricePerShare', 'ClassOfWarrantOrRightExercisePriceOfWarrantsOrRights1', and grant fair-value tags. Tie-breaker: if both 'weighted-average fair value' and convertible 'conversion price' cues are present for the same numeric, prefer conversion-price mapping only when conversion-link language explicitly ties the dollar amount to conversion (e.g., 'convertible at $X per share', 'conversion price of $X per share', 'upon conversion holders will receive common stock at $X per share'). Otherwise prefer the weighted-average-grant mapping when 'weighted-average fair value' is explicit and no conversion-link exists.\n- Cross-sentence propagation: if the identical per-share numeric has already been mapped with high confidence to DebtInstrumentConvertibleConversionPrice1 elsewhere in the document, propagate that tag to repeated identical-form instances unless an explicit contradictory cue appears nearer the repeated occurrence.\n- Unit-tests (atomic):\n  - 'convertible at $0.50 per share' -> $0.50 = DebtInstrumentConvertibleConversionPrice1\n  - 'The conversion price was $0.50 per share' -> $0.50 = DebtInstrumentConvertibleConversionPrice1\n  - 'An exercise price of $10.00 per share was set for warrants' -> $10.00 = ClassOfWarrantOrRightExercisePriceOfWarrantsOrRights1 (warrant cue wins when no conversion-link present)\n- Logging: record conversion-anchor span, numeric-per-share span, and any cross-sentence antecedent used."}, {"type": "ADD", "section": "common_mistakes_to_avoid", "content": "Anti-pattern: conflating 'granted awards' with 'issued' or conflating 'weighted-average fair value' with generic per-share prices or convertible conversion-price. Prevention checklist (atomic):\n1) Lexical-first check: if 'granted' OR 'award' present within ±8 tokens of a share-count numeric -> do NOT map that numeric to issuance/sale/outstanding tags; map to grants-in-period tag unless 'issued'/'sold'/'vested and settled' appear within ±6 tokens and are the direct verb of the numeric.\n2) Fair-value vs conversion-price: if 'weighted-average fair value' appears with currency-per-share -> map to weighted-average grant-date fair value tag. Only consider converting this to a conversion-price tag when convertible/conversion-link cues co-occur (same sentence or antecedent sentence, see convertible rule).\n3) Per-share tie-breaker: always apply instrument-type detection (convertible/preferred/award/warrant) before assigning generic SaleOfStockPricePerShare. Instrument-specific signals must override generic per-share price mappings.\n4) Add unit-tests that pair the ambiguous surface forms to ensure the specific mapping wins: include examples where 'weighted-average fair value' co-occurs with 'convertible' (should prefer conversion only when explicit conversion-link exists) and where 'granted awards' co-occur with 'issued' (issued wins only when it is the syntactic verb tied to the numeric).\n5) Logging: any automatic override where a generic per-share mapping would have been assigned but an instrument-specific mapping was chosen must be logged with cue spans and chosen vs rejected tag for QA."}], "added_content": ["[err-00013] helpful=0 harmful=0 :: Anti-pattern: conflating 'granted awards' with 'issued' or conflating 'weighted-average fair value' with generic per-share prices or convertible conversion-price. Prevention checklist (atomic):", "1) Lexical-first check: if 'granted' OR 'award' present within ±8 tokens of a share-count numeric -> do NOT map that numeric to issuance/sale/outstanding tags; map to grants-in-period tag unless 'issued'/'sold'/'vested and settled' appear within ±6 tokens and are the direct verb of the numeric.", "2) Fair-value vs conversion-price: if 'weighted-average fair value' appears with currency-per-share -> map to weighted-average grant-date fair value tag. Only consider converting this to a conversion-price tag when convertible/conversion-link cues co-occur (same sentence or antecedent sentence, see convertible rule).", "3) Per-share tie-breaker: always apply instrument-type detection (convertible/preferred/award/warrant) before assigning generic SaleOfStockPricePerShare. Instrument-specific signals must override generic per-share price mappings.", "4) Add unit-tests that pair the ambiguous surface forms to ensure the specific mapping wins: include examples where 'weighted-average fair value' co-occurs with 'convertible' (should prefer conversion only when explicit conversion-link exists) and where 'granted awards' co-occur with 'issued' (issued wins only when it is the syntactic verb tied to the numeric)."], "removed_content": []}
{"timestamp": "2026-02-06T18:38:27.491974", "step": 69, "playbook_before_length": 80493, "playbook_after_length": 85685, "lines_before": 330, "lines_after": 367, "added_lines": 30, "removed_lines": 0, "operations_count": 1, "operations": [{"type": "ADD", "section": "problem-solving_heuristics", "content": "Atomic rule: Transaction-direction disambiguation (lexical match + contextual validation). Purpose: prevent mis-mapping of ambiguous consideration phrases (e.g., 'purchase price', 'consideration') by requiring a direction/actor check before final tag assignment.\n\nExact actor-direction lexical cues (case-insensitive regex lists):\n- OUTGOING (entity paid / acquisition): /\\bwe\\s+paid\\b/, /\\bpaid\\b/, /\\bcash\\s+consideration(?:\\s+paid)?\\b/, /\\bcash\\s+paid\\b/, /\\bconsideration\\s+paid\\b/, /\\bwe\\s+issued\\b/, /\\bwe\\s+acquired\\b/, /we\\s+completed\\s+the\\s+acquisition\\b/, /was\\s+paid\\s+by\\b/.\n- INCOMING (entity received / sale/disposal): /\\bwe\\s+received\\b/, /\\breceived\\s+net\\s+cash\\s+proceeds\\b/, /\\bnet\\s+cash\\s+proceeds\\b/, /\\bproceeds\\s+from\\s+(?:the\\s+)?sale\\b/, /\\bsold\\b/, /\\bdisposal\\b/, /\\bwe\\s+sold\\b/, /\\bwe\\s+received\\s+consideration\\b/.\n- AMBIGUITY cues (neutral lexical tokens that require direction check): /\\bpurchase\\s+price\\b/, /\\btotal(ed)?\\s+purchase\\s+price\\b/, /\\bconsideration\\b/, /\\baggregate\\s+purchase\\s+price\\b/.\n\nAssociation & windows:\n- Apply direction cue search to the same sentence first; if not found, search ±1 surrounding sentence (antecedent resolution) and allow combined span <= 40 tokens.\n- Token-distance thresholds: treat a direction cue as 'local' if within ±12 tokens of the numeric amount or within the same clause; treat it as 'document-antecedent' if in adjacent sentence but within 40-token span.\n\nDecision flow (to be inserted directly after any lexical-to-tag match for acquisition/disposal phrases):\n1) Lexical match identifies candidate tags (e.g., 'purchase price' → PaymentsToAcquireBusinessesGross). Do NOT commit tag yet.\n2) Run direction-check: search for OUTGOING and INCOMING cues per association windows.\n3) If OUTGOING cue found and OUTGOING score > INCOMING score → finalize acquisition-related tag (PaymentsToAcquireBusinessesGross or BusinessCombinationConsiderationTransferred1 depending on lexical subtype).\n4) If INCOMING cue found and INCOMING score > OUTGOING score → override lexical acquisition tag and assign disposal-related tag (DisposalGroupIncludingDiscontinuedOperationConsideration or Sale/Proceeds tags as appropriate).\n   - Specific override rule: when phrase 'purchase price' co-occurs with INCOMING cues like 'we received' or 'net cash proceeds', map consideration amounts to DisposalGroupIncludingDiscontinuedOperationConsideration instead of PaymentsToAcquireBusinessesGross.\n5) If both cue types found with equal strength or no direction cues found → do NOT prefer acquisition by lexical default; mark mapping as 'ambiguous-direction' and either (a) defer to secondary semantic classifier with low-confidence flag, or (b) route to human review. Do not auto-commit acquisition tag solely on 'purchase price' in absence of corroborating outgoing cues.\n\nScoring & precedence:\n- Presence in same sentence within ±12 tokens = +10 points; presence in adjacent sentence within 40-token span = +5 points; proximity inverse-weight (1/(1+token_distance)) adds up to +3.\n- INCOMING/OUTGOING score difference threshold to auto-decide = 4 points; below threshold -> ambiguous.\n- Direction check overrides lexical-specific precedence (i.e., even if 'purchase price' ranked highest lexically, an INCOMING direction cue wins).\n\nUnit-tests (atomic examples to add):\n- 'Cash consideration of $637 million was paid at closing.' -> $637M = PaymentsToAcquireBusinessesGross (OUTGOING).\n- 'Total consideration of $2.5 billion was transferred as part of the acquisition.' -> $2.5B = BusinessCombinationConsiderationTransferred1 (OUTGOING consideration lexical + outgoing cue).\n- 'We recognized $1.3 billion of goodwill from the acquisition.' -> $1.3B = Goodwill (not applicable to direction rule but sanity-check).\n- 'The purchase price totaled $1.2 billion, and we received $1.0 billion of net cash proceeds, after consideration of customary adjustments, at closing.' -> $1.2B = DisposalGroupIncludingDiscontinuedOperationConsideration (INCOMING 'we received' + 'net cash proceeds' overrides 'purchase price' lexical acquisition mapping).\n- 'The purchase price was $1.2 billion and the acquirer paid $1.0 billion in cash.' -> $1.2B = PaymentsToAcquireBusinessesGross (OUTGOING cues present).\n\nImplementation notes & logging:\n- Insert this rule as a mandatory contextual-validation step into existing acquisition micro-decision flow (misc-00002) and any lexical-to-tag mapping that involves 'purchase/consideration/price' surface forms.\n- For every override or ambiguous-direction case, log: numeric span, lexical cue span, direction cue spans, chosen tag, scoring breakdown, and whether mapping was overridden or flagged. Aggregate 'ambiguous-direction' cases for retraining if frequency > threshold.\n- If downstream pipeline supports confidence propagation, reduce confidence for mappings decided by lexical match without direction corroboration.\n\nRationale: preserves lexical signal but prevents lexical-collapse by enforcing semantic actor/direction validation; addresses the exact root cause in the reflection where 'purchase price' was misinterpreted because the rule lacked a direction check."}], "added_content": ["[ph-00014] helpful=0 harmful=0 :: Atomic rule: Transaction-direction disambiguation (lexical match + contextual validation). Purpose: prevent mis-mapping of ambiguous consideration phrases (e.g., 'purchase price', 'consideration') by requiring a direction/actor check before final tag assignment.", "Exact actor-direction lexical cues (case-insensitive regex lists):", "- OUTGOING (entity paid / acquisition): /\\bwe\\s+paid\\b/, /\\bpaid\\b/, /\\bcash\\s+consideration(?:\\s+paid)?\\b/, /\\bcash\\s+paid\\b/, /\\bconsideration\\s+paid\\b/, /\\bwe\\s+issued\\b/, /\\bwe\\s+acquired\\b/, /we\\s+completed\\s+the\\s+acquisition\\b/, /was\\s+paid\\s+by\\b/.", "- INCOMING (entity received / sale/disposal): /\\bwe\\s+received\\b/, /\\breceived\\s+net\\s+cash\\s+proceeds\\b/, /\\bnet\\s+cash\\s+proceeds\\b/, /\\bproceeds\\s+from\\s+(?:the\\s+)?sale\\b/, /\\bsold\\b/, /\\bdisposal\\b/, /\\bwe\\s+sold\\b/, /\\bwe\\s+received\\s+consideration\\b/.", "- AMBIGUITY cues (neutral lexical tokens that require direction check): /\\bpurchase\\s+price\\b/, /\\btotal(ed)?\\s+purchase\\s+price\\b/, /\\bconsideration\\b/, /\\baggregate\\s+purchase\\s+price\\b/."], "removed_content": []}
{"timestamp": "2026-02-06T18:40:35.845145", "step": 70, "playbook_before_length": 85685, "playbook_after_length": 90167, "lines_before": 367, "lines_after": 385, "added_lines": 18, "removed_lines": 0, "operations_count": 1, "operations": [{"type": "ADD", "section": "CONTEXT CLUES & INDICATORS", "content": "Atomic rule: Notes-payable / balance-sheet-listing context → prefer debt-balance tags (LongTermDebt / CurrentPortion) over DebtInstrumentFaceAmount.\n- Purpose (atomic): When a numeric currency amount appears inside a 'notes payable' / 'long-term debt' disclosure listing or an enumerated balance-sheet note, treat it as a balance-sheet liability classification (LongTermDebt / CurrentPortion) unless explicit issuance context outside the listing is proven.\n- Exact header/list lexical cues (case-insensitive regexes): /\\bnotes\\s+payable\\b/, /\\bnotes\\s+payable\\s*(?:consisted\\s+of|:|—|-)\\b/, /\\blong[- ]term\\s+debt\\b/, /\\bnotes\\s+payable\\s+consisted\\s+of\\b/, /\\bconsisted\\s+of\\s+the\\s+following\\b/, paragraph headers like /^NOTE\\s+\\d+\\b.*NOTES?\\s+PAYABLE/i.\n- Enumerated/list detection heuristics (apply in order):\n  1) If a header-match occurs and the numeric appears in the same paragraph or within the next 1–2 sentences separated by a colon or list markers (lines starting with dates, bullets, or 'On [Month] [DD], [YYYY]'), mark the numeric as 'in-notes-list' (list context window = header sentence + following up to 3 sentences or until next header/blank line).\n  2) If the sentence contains the phrase 'consisted of the following', 'consists of the following', 'was as follows', or '(in thousands)' immediately after a notes/long-term-debt header, treat subsequent sentences in that block as enumerated balance-sheet items.\n- Decision flow & precedence (apply in order):\n  1) If numeric is currency and 'in-notes-list' == true -> map to LongTermDebt by default.\n  2) Short-term/current resolution: within the same sentence or the enumerated item, if short-term qualifiers appear within ±12 tokens (regex: /\\b(current portion|current|short[- ]term|due within (?:twelve|12) months|due within one year)\\b/), map to CurrentPortionOfLongTermDebt or ShortTermDebt accordingly instead of LongTermDebt.\n  3) Override rule: this notes-list mapping MUST override any DebtInstrumentFaceAmount / aggregate-principal lexical mapping when 'in-notes-list' is true. Log an 'notes-list-overrode-face-amount' event with header span and numeric span.\n  4) Exception (allow DebtInstrumentFaceAmount only when issuance narrative proven): if the sentence contains strong issuance-only cues (same-sentence verbs: /\\bissued\\b/, /\\bwas issued\\b/, /\\bissued a promissory note\\b/, /\\bin the amount of\\b/) AND there is NO notes-payable header/consisted-of anchor in the same paragraph/block (no 'in-notes-list'), then permit mapping to DebtInstrumentFaceAmount. If both issuance cues and notes-list header are present in the same block, prefer notes-list mapping (balance-sheet) unless the sentence explicitly signals an issuance event separate from the listing (explicit temporal separation, e.g., a separate paragraph beginning 'On [date] we issued...')—require explicit paragraph separation to allow DebtInstrumentFaceAmount.\n- Token windows & antecedent resolution: header can be up to 2 sentences before the numeric and still anchor the numeric to the list; allow antecedent span <= 60 tokens across sentence boundary for header->item resolution. List block ends at next top-level header or blank-line/section break.\n- Examples / unit-tests (atomic):\n  - 'At September 30, 2017 and December 31, 2016, notes payable consisted of the following (in thousands): On November 13, 2014 ... issued a promissory note ... in the amount of $65.1 million ...' -> $65.1M = LongTermDebt (NOT DebtInstrumentFaceAmount).\n  - 'NOTE 7 - NOTES PAYABLE. The outstanding balances consisted of: Term Loan — $50,000.' -> $50,000 = LongTermDebt (or CurrentPortion if qualifier present).\n  - 'On November 13, 2014, the Company issued a promissory note in the amount of $65.1 million.' (separate issuance paragraph, no notes-payable header in same block) -> $65.1M = DebtInstrumentFaceAmount.\n- Logging & QA: for every mapping where notes-list rule applied, record header span, numeric span, decision (LongTermDebt vs CurrentPortion), and whether a DebtInstrumentFaceAmount candidate was suppressed. Flag and aggregate any cases where both issuance verbs and notes-list cues are present for manual review ('notes-list-issuance-overlap').\n- Rationale: preserves disclosure-scope signal and prevents lexical-collapse where issuance lexical cues inside a balance-sheet enumeration would otherwise produce instrument-face-amount tags instead of the expected statement-line debt classification."}], "added_content": ["[ctx-00015] helpful=0 harmful=0 :: Atomic rule: Notes-payable / balance-sheet-listing context → prefer debt-balance tags (LongTermDebt / CurrentPortion) over DebtInstrumentFaceAmount.", "- Purpose (atomic): When a numeric currency amount appears inside a 'notes payable' / 'long-term debt' disclosure listing or an enumerated balance-sheet note, treat it as a balance-sheet liability classification (LongTermDebt / CurrentPortion) unless explicit issuance context outside the listing is proven.", "- Exact header/list lexical cues (case-insensitive regexes): /\\bnotes\\s+payable\\b/, /\\bnotes\\s+payable\\s*(?:consisted\\s+of|:|—|-)\\b/, /\\blong[- ]term\\s+debt\\b/, /\\bnotes\\s+payable\\s+consisted\\s+of\\b/, /\\bconsisted\\s+of\\s+the\\s+following\\b/, paragraph headers like /^NOTE\\s+\\d+\\b.*NOTES?\\s+PAYABLE/i.", "- Enumerated/list detection heuristics (apply in order):", "  1) If a header-match occurs and the numeric appears in the same paragraph or within the next 1–2 sentences separated by a colon or list markers (lines starting with dates, bullets, or 'On [Month] [DD], [YYYY]'), mark the numeric as 'in-notes-list' (list context window = header sentence + following up to 3 sentences or until next header/blank line)."], "removed_content": []}
{"timestamp": "2026-02-06T18:43:14.378425", "step": 71, "playbook_before_length": 90167, "playbook_after_length": 95362, "lines_before": 385, "lines_after": 412, "added_lines": 25, "removed_lines": 0, "operations_count": 2, "operations": [{"type": "ADD", "section": "context_clues_and_indicators", "content": "Tax-reconciliation-to-federal-statutory-rate (atomic heuristic):\n- Purpose: map any mention that ties an effective income tax rate to the U.S. federal statutory rate to EffectiveIncomeTaxRateReconciliationAtFederalStatutoryIncomeTaxRate instead of a generic effective-tax-rate tag.\n- Exact lexical cues (case-insensitive regex): /\\b(U\\.?S\\.?|United States|U\\.S\\.)?\\s*(federal\\s+)?statutory\\s+rate\\b/, /\\bstatutory\\s+rate\\b/, /\\breconcil(?:e|iation|ed)\\b/, /\\breconciles?\\s+to\\b/, /\\bcompared\\s+to\\s+the\\s+statutory\\s+rate\\b/, /\\bat\\s+the\\s+time\\s+of\\s+[0-9]+(?:\\.[0-9]+)?\\s*%/i.\n- Trigger conditions (apply in order):\n  1) If the sentence (or immediately adjacent sentence ±1) contains ANY tax lexical cue (e.g., 'effective tax rate', 'income tax rate') AND ANY of the statutory/reconciliation cues above within a token window of ±12 tokens of the numeric or tax phrase -> assign EffectiveIncomeTaxRateReconciliationAtFederalStatutoryIncomeTaxRate.\n  2) If the sentence contains an explicit numeric percent (e.g., '35%') inside a phrase matching /at the time of [0-9]+(?:\\.[0-9]+)?%/ or immediately follows 'statutory rate' anchor -> treat numeric as the statutory reconciliation percent and map accordingly.\n- Precedence: this reconciliation tag MUST override EffectiveIncomeTaxRateContinuingOperations and other general effective-rate tags.\n- Edge-cases: if 'effective tax rate' appears with no statutory/reconciliation cues -> keep existing EffectiveIncomeTaxRateContinuingOperations mapping. If both 'statutory' and a different jurisdiction (non-U.S.) appear explicitly (e.g., 'the German statutory rate of 30%') then only map to the reconciliation tag when text explicitly references 'U.S.'/'United States'/'federal' or when taxonomy contains jurisdiction-scoped reconciliation tags; otherwise, map to a jurisdiction-agnostic reconciliation tag if available or flag for review.\n- Unit-tests (atomic):\n  - 'our effective tax rate was lower than the U.S. federal statutory rate at the time of 35%' -> EffectiveIncomeTaxRateReconciliationAtFederalStatutoryIncomeTaxRate = 35%.\n  - 'the effective tax rate for continuing operations was 25%' (no 'statutory'/'reconciliation') -> EffectiveIncomeTaxRateContinuingOperations = 25%.\n  - 'reconciled to the federal statutory rate of 35%' -> reconciliation tag = 35%.\n- Logging: record matched statutory/reconciliation cue span, numeric span, sentence-id, chosen tag, and confidence. Flag ambiguous cross-sentence antecedent cases for human review with 'tax-recon-antecedent' label."}, {"type": "ADD", "section": "context_clues_and_indicators", "content": "Operating-vs-reportable-segment count disambiguation (atomic heuristic):\n- Purpose: deterministically choose NumberOfOperatingSegments when the disclosure text contains 'operating segments' even if 'reportable' also appears (e.g., 'two operating and reportable segments'), and reserve NumberOfReportableSegments for cases that explicitly and solely quantify reportable segments.\n- Exact lexical cues (case-insensitive regex): /\\boperating\\s+segment(?:s)?\\b/, /\\breportable\\s+segment(?:s)?\\b/, /\\boperating\\s+and\\s+reportable\\s+segment(?:s)?\\b/, /\\bnumber\\s+of\\s+(?:operating|reportable)\\s+segments\\b/, /\\bwe\\s+operate\\s+through\\s+\\d+\\s+operating\\s+segments\\b/.\n- Decision flow (apply in order):\n  1) If numeric token is within ±6 tokens of 'operating segment(s)' -> assign NumberOfOperatingSegments.\n  2) If numeric token is within ±6 tokens of the exact phrase 'operating and reportable segments' or 'operating & reportable segments' -> assign NumberOfOperatingSegments (treat 'operating' as the canonical class).\n  3) Only assign NumberOfReportableSegments when the sentence explicitly quantifies 'reportable segments' without 'operating' present (e.g., 'The number of reportable segments was two') OR when the numeric is adjacent to a lexical construction that restricts count to 'reportable' (clauses like 'for reporting purposes, the number of reportable segments is').\n  4) If a sentence contains two distinct numeric counts with explicit labels for each (e.g., 'two operating segments and three reportable segments'), assign each numeric to the nearest matching tag by token-distance.\n- Precedence: NumberOfOperatingSegments > NumberOfReportableSegments when 'operating' appears in the same clause/sentence; this must override any generic 'reportable' lexical-first heuristics.\n- Unit-tests (atomic):\n  - 'The company's internal structure includes two operating and reportable segments.' -> 2 = NumberOfOperatingSegments.\n  - 'We have three reportable segments for financial reporting purposes.' -> 3 = NumberOfReportableSegments.\n  - 'We have two operating segments and three reportable segments' -> 2 = NumberOfOperatingSegments; 3 = NumberOfReportableSegments (nearest-number tie-breaker).\n- Ambiguity handling & logging: if 'reportable' appears and antecedent context suggests a difference between operational and reporting definitions but no clear numeric locality exists, flag as 'segment-count-ambiguous' and record spans for manual review. Log every override where NumberOfOperatingSegments was chosen despite presence of 'reportable' with spans and reason code 'operating-present'."}], "added_content": ["[ctx-00016] helpful=0 harmful=0 :: Tax-reconciliation-to-federal-statutory-rate (atomic heuristic):", "- Purpose: map any mention that ties an effective income tax rate to the U.S. federal statutory rate to EffectiveIncomeTaxRateReconciliationAtFederalStatutoryIncomeTaxRate instead of a generic effective-tax-rate tag.", "- Exact lexical cues (case-insensitive regex): /\\b(U\\.?S\\.?|United States|U\\.S\\.)?\\s*(federal\\s+)?statutory\\s+rate\\b/, /\\bstatutory\\s+rate\\b/, /\\breconcil(?:e|iation|ed)\\b/, /\\breconciles?\\s+to\\b/, /\\bcompared\\s+to\\s+the\\s+statutory\\s+rate\\b/, /\\bat\\s+the\\s+time\\s+of\\s+[0-9]+(?:\\.[0-9]+)?\\s*%/i.", "- Trigger conditions (apply in order):", "  1) If the sentence (or immediately adjacent sentence ±1) contains ANY tax lexical cue (e.g., 'effective tax rate', 'income tax rate') AND ANY of the statutory/reconciliation cues above within a token window of ±12 tokens of the numeric or tax phrase -> assign EffectiveIncomeTaxRateReconciliationAtFederalStatutoryIncomeTaxRate."], "removed_content": []}
{"timestamp": "2026-02-06T18:45:26.364709", "step": 72, "playbook_before_length": 95362, "playbook_after_length": 100793, "lines_before": 412, "lines_after": 450, "added_lines": 29, "removed_lines": 0, "operations_count": 1, "operations": [{"type": "ADD", "section": "context_clues_and_indicators", "content": "Atomic rule: Transaction-verb disambiguation for numeric ownership percentages (map ownership-percentage + action-verb → transaction tag)\n\nPurpose: Ensure percentages that quantify ownership (\"% ownership interest\", \"% stake\", \"% of voting interest\") are mapped to transaction/acquisition/disposition tags when the sentence contains a transaction verb (acquired/sold/issued/repurchased/etc.), instead of mapping them to static ownership tags.\n\nExact lexical anchors (case-insensitive regexes):\n- Ownership nouns: /(?:ownership\\s+interest|ownership|voting\\s+interest|stake|interest\\s+in\\s+the\\s+company|percentage\\s+interest|percent\\s+interest)\\b/i\n- Acquisition verbs (acquiring actions → acquisition tag): /\\b(acquir(?:e|ed|ing)|acquired\\s+an?|indirectly\\s+acquired|purchas(?:e|ed|ing)|purchased|obtained|assumed|took\\s+acquisition\\b|completed\\s+the\\s+acquisition|we\\s+acquired|we\\s+purchased)\\b/i\n- Disposition/sale verbs (disposition tags): /\\b(sold|disposed|divested|transferred\\s+to|we\\s+sold|we\\s+disposed)\\b/i\n- Issuance/repurchase verbs (other transaction tags): /\\b(issued|repurchased|redeemed|exchanged|contributed)\\b/i\n\nAssociation & token-window policy:\n- A numeric percentage token (e.g., '40%', '40 percent', or numeric with % omitted but immediately preceded/followed by 'percent'/'%') that co-occurs with an Ownership noun within ±8 tokens is an ownership-percentage candidate.\n- Search for any transaction verb anchors in the same sentence first; if none found, search the immediately adjacent sentence (±1 sentence) allowing combined span <= 40 tokens.\n- A transaction verb within ±12 tokens of the numeric OR within the same clause (commas/parenthesis-bound clause) is considered 'local' and decisive.\n\nDecision flow & precedence (apply in order):\n1) If numeric is ownership-percentage candidate AND an Acquisition verb anchor matches per windows above → assign BusinessAcquisitionPercentageOfVotingInterestsAcquired (or the most specific acquisition-percentage tag available). Link mapping metadata: { verb_span, ownership_noun_span, numeric_span, antecedent_sentence_id }.\n2) Else if numeric is ownership-percentage candidate AND a Disposition/Sale verb anchor matches → assign the appropriate disposition/sale percentage tag (e.g., BusinessDispositionPercentageOfVotingInterestsDisposed or SaleOfStockNumberOfSharesIssuedInTransaction if shares count present) with same metadata.\n3) Else if numeric is ownership-percentage candidate AND Issuance/Repurchase verb matches (issued/repurchased) → assign instrument-specific issuance/repurchase tag (e.g., StockIssuedDuringPeriodSharesNewIssues or StockRepurchasedNumberOfSharesRepurchased) as appropriate.\n4) Else (no transaction verb found within windows) → fall back to static ownership mapping (e.g., MinorityInterestOwnershipPercentageByNoncontrollingOwners or OwnershipPercentageOutstanding) but mark mapping with 'no-transaction-verb' flag.\n\nTie-breakers & conflict rules:\n- If both acquisition and disposition verbs appear with conflicting directions, choose the verb with the smallest token-distance to the numeric; if distances equal, mark 'ambiguous-direction' and route to human review (do not auto-commit a static ownership tag in ambiguous cases).\n- Passive voice variants allowed (e.g., 'was acquired', 'was sold'): match acquisition/disposition regexes that include passive forms; treat as equivalent to active forms for precedence.\n- If a transaction verb is present but ownership noun is generic (e.g., 'we acquired an interest' with no percent in same clause), require numeric and ownership noun to be within ±12 tokens to auto-map; otherwise queue for review.\n\nLogging & QA:\n- For every mapping triggered by this rule, log: numeric_span, ownership_noun_span, verb_span, chosen_tag, token_distance_scores, sentence_id, and whether antecedent resolution was used.\n- Log 'no-transaction-verb' fallback cases for retraining; aggregate 'ambiguous-direction' cases for manual curation.\n\nUnit-tests (atomic examples to add):\n- 'AES indirectly acquired the 40% ownership interest of the noncontrolling shareholder for a de minimis payment' -> 40% = BusinessAcquisitionPercentageOfVotingInterestsAcquired (verb 'acquired' within window).\n- 'The company sold a 12% ownership interest to an outside investor' -> 12% = BusinessDispositionPercentageOfVotingInterestsDisposed (verb 'sold').\n- 'We issued a 6.7% interest to the counterparty' -> 6.7% = StockIssuedDuringPeriodSharesNewIssues (issued → issuance tag) or instrument-specific issuance tag if available.\n- 'The noncontrolling owners hold a 40% ownership interest' -> 40% = MinorityInterestOwnershipPercentageByNoncontrollingOwners (no transaction verb → static ownership mapping).\n- 'The company acquired a 10% stake and now holds 60% ownership' -> 10% = BusinessAcquisitionPercentageOfVotingInterestsAcquired; 60% = MinorityInterestOwnershipPercentageByNoncontrollingOwners or ControllingOwnerPercentage as applicable depending on lexical anchor and clause separation.\n\nImplementation note: Insert this rule as a mandatory validation step in the acquisition/disposition micro-decision flow (misc-00002 / ph-00006). This rule must override any pure-lexical noun-first mapping of percentage-of-ownership to static ownership tags when a transaction verb is present. Ensure the mapping output includes verb_span and ownership_noun_span in metadata for traceability."}], "added_content": ["[ctx-00018] helpful=0 harmful=0 :: Atomic rule: Transaction-verb disambiguation for numeric ownership percentages (map ownership-percentage + action-verb → transaction tag)", "Purpose: Ensure percentages that quantify ownership (\"% ownership interest\", \"% stake\", \"% of voting interest\") are mapped to transaction/acquisition/disposition tags when the sentence contains a transaction verb (acquired/sold/issued/repurchased/etc.), instead of mapping them to static ownership tags.", "Exact lexical anchors (case-insensitive regexes):", "- Ownership nouns: /(?:ownership\\s+interest|ownership|voting\\s+interest|stake|interest\\s+in\\s+the\\s+company|percentage\\s+interest|percent\\s+interest)\\b/i", "- Acquisition verbs (acquiring actions → acquisition tag): /\\b(acquir(?:e|ed|ing)|acquired\\s+an?|indirectly\\s+acquired|purchas(?:e|ed|ing)|purchased|obtained|assumed|took\\s+acquisition\\b|completed\\s+the\\s+acquisition|we\\s+acquired|we\\s+purchased)\\b/i"], "removed_content": []}
{"timestamp": "2026-02-06T18:47:03.712697", "step": 73, "playbook_before_length": 100793, "playbook_after_length": 108725, "lines_before": 450, "lines_after": 483, "added_lines": 30, "removed_lines": 0, "operations_count": 3, "operations": [{"type": "ADD", "section": "context_clues_and_indicators", "content": "Atomic rule: map 'amortization' + intangible-anchor -> AmortizationOfIntangibleAssets\n- Purpose: deterministically map currency amounts labeled as amortization of intangibles (including lease-related intangible assets) to AmortizationOfIntangibleAssets rather than generic expense/depreciation/lease-expense tags.\n- Exact lexical cues (case-insensitive regex examples): /amortization\\s+expense\\b/, /amortization\\s+of\\b/, /amortization\\s+related\\s+to\\b/, /amortization\\s+charge(s)?\\b/.\n- Intangible/asset anchors (case-insensitive): /lease\\s+intangibles\\b/, /intangible\\s+assets\\b/, /intangible\\s+asset\\b/, /definite-lived\\s+intangible(s)?\\b/, /acquired\\s+intangible(s)?\\b/, /customer\\s+relationships\\b/, /trademark(s)?\\b/, /goodwill\\s+amortization\\b/ (use as caution: goodwill rarely amortized under US GAAP; prefer Goodwill tag if 'goodwill' and 'amortization' co-occur only when taxonomy requires it).\n- Association window: require currency numeric token within ±10 tokens of an amortization lexical cue AND an intangible-anchor in same sentence OR previous sentence (±1 sentence) with combined span <= 40 tokens.\n- Precedence/tie-breaker: if rule conditions met -> assign AmortizationOfIntangibleAssets. This mapping overrides (a) LeaseAndRentalExpense / OperatingLeasesRentExpenseNet (do NOT map to lease expense when 'amortization' + intangible-anchor present), (b) DepreciationOfPropertyPlantAndEquipment (do NOT map to depreciation if 'intangible' anchor present), and (c) generic 'Expense' tags. If 'amortization' appears but anchor is ambiguous (no 'intangible' anchor within windows), do NOT auto-assign AmortizationOfIntangibleAssets; flag for review or apply semantic classifier.\n- Conflict handling: if both 'amortization' and 'rent/lease expense' appear explicitly adjacent (e.g., 'amortization and rent expense'), map each numeric to nearest lexical cue by token-distance; if single numeric and both cues co-occur equally, prefer AmortizationOfIntangibleAssets only if intangible-anchor explicit; otherwise flag ambiguous.\n- Unit-tests (atomic examples):\n  - 'Amortization expense of lease intangibles was $3.4 million for the year.' -> $3.4M = AmortizationOfIntangibleAssets.\n  - 'Amortization expense related to definite-lived intangible assets totaled $1.2 million.' -> $1.2M = AmortizationOfIntangibleAssets.\n  - 'Rent expense was $1.3 million; amortization expense of intangibles was $0.4 million.' -> map each to respective tags; amortization -> AmortizationOfIntangibleAssets.\n- Logging: record amortization cue span and intangible-anchor span and chosen tag; log ambiguous/no-anchor cases to retraining queue."}, {"type": "ADD", "section": "context_clues_and_indicators", "content": "Atomic rule: map 'weighted average interest rate' on debt -> DebtWeightedAverageInterestRate\n- Purpose: map percentages explicitly described as weighted-average interest rates on a portfolio of debt to DebtWeightedAverageInterestRate and avoid mis-mapping to per-instrument interest-rate tags.\n- Exact lexical cues (case-insensitive regex examples): /weighted[- ]?average\\s+interest\\s+rate\\b/, /weighted[- ]?average\\s+rate\\b/, /weighted[- ]?average\\s+interest\\s+of\\b/.\n- Debt portfolio anchors (case-insensitive): /debt\\s+outstanding\\b/, /total\\s+debt\\b/, /debt\\b/, /our\\s+outstanding\\s+debt\\b/, /aggregate\\s+debt\\b/, /of\\s+debt\\s+outstanding\\b/.\n- Association window: require a percentage token (e.g., '2.72%' or '2.72 percent') within ±6 tokens of a 'weighted average' cue OR percentage anywhere in same sentence where 'weighted average interest rate' phrase exists. Also require a debt-portfolio anchor in same sentence OR previous sentence (±1 sentence) within combined span <= 40 tokens; if 'weighted average interest rate' phrase itself includes 'of debt outstanding' or 'on the Company's outstanding debt', anchor requirement satisfied.\n- Precedence/tie-breaker: if conditions met -> assign DebtWeightedAverageInterestRate. This mapping has precedence over instrument-level DebtInstrumentInterestRateStatedPercentage for that percentage token. Exception: if the phrase explicitly qualifies a per-instrument context (e.g., 'weighted average interest rate of our term loans was X for the period, and the XYZ note bears 3.5% per annum') still map the explicit 'weighted average' percent to DebtWeightedAverageInterestRate; map explicit per-instrument rates separately. If a single percent token is labeled both 'weighted average' and immediately bound to a single instrument name (e.g., 'weighted average interest rate on the Term Loan of 3.5%') treat as DebtWeightedAverageInterestRate (phrase mirrors 'weighted average') unless text explicitly states 'the interest rate on [InstrumentName] was 3.5% (not a weighted average)'.\n- Conflict handling: if both 'weighted average' and instrument-specific 'per annum' cues are present for the same percent token and the text is ambiguous which scope applies, prefer DebtWeightedAverageInterestRate only when 'weighted average' matches the percent within ±6 tokens; otherwise flag 'rate-scope-ambiguous' for review.\n- Unit-tests (atomic examples):\n  - 'The weighted average interest rate on debt outstanding was 2.72% and 2.63% for the periods.' -> 2.72% & 2.63% = DebtWeightedAverageInterestRate.\n  - 'Our weighted-average interest rate on outstanding debt was 3.1% for the year.' -> 3.1% = DebtWeightedAverageInterestRate.\n  - 'The Term Loan interest rate was 5.00% per annum; the weighted average interest rate on all debt outstanding was 3.2%.' -> 5.00% = DebtInstrumentInterestRateStatedPercentage (term loan); 3.2% = DebtWeightedAverageInterestRate.\n- Logging: record weighted-average cue span, percent span, debt-anchor span, and chosen tag; aggregate 'rate-scope-ambiguous' cases for QA."}, {"type": "ADD", "section": "problem-solving_heuristics", "content": "Atomic heuristic: 'metric-verb + scope' precedence (exact-phrase mirroring tie-breaker)\n- Purpose: when choosing between competing tags, prefer the tag that mirrors both the explicit metric verb/noun (e.g., 'amortization', 'depreciation', 'weighted average interest rate', 'fair value') AND the explicit scope/anchor (e.g., 'intangible assets', 'debt outstanding', 'grant-date', 'lease intangibles'). This prevents generic or collapsed mappings when the sentence explicitly names metric and scope.\n- Decision flow (apply immediately after lexical-match candidates are generated):\n  1) Identify metric-verb/noun cue (examples: amortization, depreciation, weighted average, effective tax rate, grant-date fair value, exercise price). 2) Identify scope-anchor noun phrase (examples: intangible assets, lease intangibles, debt outstanding, continuing operations, grant-date). 3) If a taxonomy tag exists that explicitly maps metric-verb + scope-anchor combination, prefer that tag and mark decision as 'exact-phrase-mirroring'. 4) If no exact tag exists, but the metric-verb clearly restricts meaning (e.g., 'amortization' vs 'depreciation'), prefer the tag matching the metric-verb's domain (e.g., amortization -> intangible amortization) and attach metadata {fallback_reason: 'no-exact-tag'}; enqueue taxonomy enrichment if granularity is repeatedly missing.\n- Windows & confidence: require metric-verb within ±8 tokens of numeric and scope-anchor within same sentence OR previous sentence (antecedent <= 40 tokens). If either cue is absent, do not force mirroring — allow fallback classifier but flag low-confidence.\n- Unit-tests (atomic examples):\n  - 'Amortization expense of lease intangibles was $X' -> prefer AmortizationOfIntangibleAssets (metric-verb=amortization, scope=intangibles).\n  - 'Weighted average interest rate of debt outstanding was Y%' -> prefer DebtWeightedAverageInterestRate (metric-verb=weighted average, scope=debt outstanding).\n- Logging: annotate each mapping with 'exact-phrase-mirroring' and the spans used; add counters for cases where mirroring selected a fallback tag due to missing taxonomy to drive taxonomy additions."}], "added_content": ["[ph-00021] helpful=0 harmful=0 :: Atomic heuristic: 'metric-verb + scope' precedence (exact-phrase mirroring tie-breaker)", "- Purpose: when choosing between competing tags, prefer the tag that mirrors both the explicit metric verb/noun (e.g., 'amortization', 'depreciation', 'weighted average interest rate', 'fair value') AND the explicit scope/anchor (e.g., 'intangible assets', 'debt outstanding', 'grant-date', 'lease intangibles'). This prevents generic or collapsed mappings when the sentence explicitly names metric and scope.", "- Decision flow (apply immediately after lexical-match candidates are generated):", "  1) Identify metric-verb/noun cue (examples: amortization, depreciation, weighted average, effective tax rate, grant-date fair value, exercise price). 2) Identify scope-anchor noun phrase (examples: intangible assets, lease intangibles, debt outstanding, continuing operations, grant-date). 3) If a taxonomy tag exists that explicitly maps metric-verb + scope-anchor combination, prefer that tag and mark decision as 'exact-phrase-mirroring'. 4) If no exact tag exists, but the metric-verb clearly restricts meaning (e.g., 'amortization' vs 'depreciation'), prefer the tag matching the metric-verb's domain (e.g., amortization -> intangible amortization) and attach metadata {fallback_reason: 'no-exact-tag'}; enqueue taxonomy enrichment if granularity is repeatedly missing.", "- Windows & confidence: require metric-verb within ±8 tokens of numeric and scope-anchor within same sentence OR previous sentence (antecedent <= 40 tokens). If either cue is absent, do not force mirroring — allow fallback classifier but flag low-confidence."], "removed_content": []}
{"timestamp": "2026-02-06T18:49:06.464402", "step": 74, "playbook_before_length": 108725, "playbook_after_length": 114717, "lines_before": 483, "lines_after": 505, "added_lines": 22, "removed_lines": 0, "operations_count": 2, "operations": [{"type": "ADD", "section": "COMMON_MISTAKES_TO_AVOID", "content": "[err-000XX-stockcomp] helpful=0 harmful=0 :: Prevent lexical-collapse on 'stock‑based compensation' by validating 'recognized/allocated per‑period' intent before choosing tag. Purpose: prefer AllocatedShareBasedCompensationExpense when the sentence reports amounts 'recognized' in the period or 'allocated' to functions/expense lines; otherwise use generic ShareBasedCompensation only for conceptual/aggregate disclosures.\nRules (atomic):\n1) Exact lexical cues (case-insensitive regex): /(recogniz(?:ed|es|ing)\\b|recognized\\s+expense|expense\\s+recognized|allocated|attributable\\s+to\\s+employee|allocated\\s+to\\s+function|for\\s+the\\s+period|during\\s+the\\s+period|in\\s+the\\s+period)\\b/; also capture verbs 'was recognized', 'were recognized', 'is recognized'.\n2) Association window: require any of these cues to co-occur within ±12 tokens of the currency amount OR in the same sentence. Allow antecedent resolution: if 'the amount recognized' appears and the plan/award anchor is in the previous sentence, allow ±1 sentence (combined span <= 40 tokens).\n3) Decision flow: when lexical surface match (\"stock-based compensation\" etc.) yields both candidate tags (AllocatedShareBasedCompensationExpense and ShareBasedCompensation), apply this validation: if any recognized/allocated/per‑period cue present per windows -> assign AllocatedShareBasedCompensationExpense (specific). Else if text is descriptive/conceptual (e.g., 'stock‑based compensation is a significant part of our compensation') with NO recognized/allocated/per‑period cue -> assign ShareBasedCompensation.\n4) Tie-breaker: if recognized/allocated cue is present but ambiguous (e.g., 'stock‑based compensation expense, which may be allocated...'), require explicit finite verb 'was recognized'/'was charged'/'was allocated' within ±12 tokens; otherwise flag 'stockcomp-ambiguous-allocated' and route to human review rather than defaulting to generic tag.\n5) Unit-tests (atomic):\n   - 'Stock-based compensation expense was $65.7 million recognized for the year.' -> AllocatedShareBasedCompensationExpense = 65.7M.\n   - 'Stock-based compensation expense totaled $28.4 million during the period and was allocated to cost of revenue and selling expenses.' -> AllocatedShareBasedCompensationExpense = 28.4M.\n   - 'We discuss our stock-based compensation program and its features.' -> ShareBasedCompensation (no allocated tag).\n6) Logging: always record matched cue span, numeric span, chosen tag, and which cue triggered allocated mapping. Log ambiguous cases ('stockcomp-ambiguous-allocated') with spans for QA and retraining."}, {"type": "ADD", "section": "COMMON_MISTAKES_TO_AVOID", "content": "[err-000XX-taxrate] helpful=0 harmful=0 :: Prevent over‑mapping effective tax rates to reconciliation tag by requiring explicit reconciliation structure/intent before selecting EffectiveIncomeTaxRateReconciliationAtFederalStatutoryIncomeTaxRate. Purpose: use EffectiveIncomeTaxRateContinuingOperations for plain reported effective rates; reserve reconciliation-to-federal-statute tag for explicit reconciliation language/tables/stepwise comparisons to the statutory rate.\nRules (atomic):\n1) Exact reconciliation lexical cues (case-insensitive regexes): /\\b(reconcili(?:e|ation|es|ed)|reconciles?|reconciling|reconciliation\\s+to|reconciled\\s+to|reconciles\\s+to\\s+the\\s+statutory\\s+rate|statutory\\s+rate\\s+of)\\b/ and statutory anchors: /\\b(federal\\s+statutory|U\\.?S\\.?\\s+federal\\s+statutory|U\\.?S\\.?\\s+statutory\\s+rate|federal\\s+statutory\\s+rate)\\b/; also capture explicit table/line cues: /\\bthe\\s+following\\s+reconciliation|the\\s+table\\s+below\\s+reconciles\\b|the\\s+reconciliation\\s+is\\s+as\\s+follows\\b/.\n2) Association window: require (a) a percent token or tax-rate phrase within ±12 tokens of a reconciliation/statutory cue in the same sentence OR (b) a reconciliation/statutory cue in same sentence and percent in adjacent sentence (±1 sentence antecedent) with combined span <= 40 tokens. If only 'statutory' appears but no 'reconcili*' / 'table' / 'line items' cues, do NOT select reconciliation tag automatically.\n3) Decision flow: if effective-tax-rate lexical match occurs (\"effective tax rate\", \"tax rate for continuing operations\", percent numeric reported) AND reconciliation+statutory cues are present per windows -> assign EffectiveIncomeTaxRateReconciliationAtFederalStatutoryIncomeTaxRate. Else if percent is used to report effective tax rate(s) for periods without explicit reconciliation structure -> assign EffectiveIncomeTaxRateContinuingOperations.\n4) Tie-breaker: when both 'statutory' and simple comparative phrasing exist (e.g., 'our effective tax rate was 18%, lower than the federal statutory rate of 35%') but no 'reconcile'/'reconciliation'/'table' language, prefer EffectiveIncomeTaxRateContinuingOperations and log as 'taxrate-statutorily-compared-but-not-reconciliation' (do NOT pick reconciliation tag). Only choose reconciliation tag when 'reconcil*' or explicit reconciliation table/line item phrasing is present.\n5) Unit-tests (atomic):\n   - 'The effective income tax rate for continuing operations was 16% for the year.' -> EffectiveIncomeTaxRateContinuingOperations = 16%.\n   - 'The effective income tax rates were 18% and 16% respectively, lower than the U.S. federal statutory rate of 35%.' -> EffectiveIncomeTaxRateContinuingOperations = 18% and 16% (log 'statutory-compare-no-recon').\n   - 'The following table reconciles the U.S. federal statutory rate of 35% to the Company's effective income tax rate: statutory rate 35%; state taxes (x%); permanent differences (y%); resulting effective rate 18%.' -> EffectiveIncomeTaxRateReconciliationAtFederalStatutoryIncomeTaxRate = reconciliation lines (map line items and overall reconciled percent).\n6) Logging: record reconciliation cue spans, statutory anchor spans, percent spans, chosen tag, and reason code ('explicit-reconciliation' vs 'statutory-compare-only'). Flag 'statutory-compare-no-recon' examples for QA and potential training adjustments."}], "added_content": ["[err-00022] helpful=0 harmful=0 :: [err-000XX-stockcomp] helpful=0 harmful=0 :: Prevent lexical-collapse on 'stock‑based compensation' by validating 'recognized/allocated per‑period' intent before choosing tag. Purpose: prefer AllocatedShareBasedCompensationExpense when the sentence reports amounts 'recognized' in the period or 'allocated' to functions/expense lines; otherwise use generic ShareBasedCompensation only for conceptual/aggregate disclosures.", "Rules (atomic):", "1) Exact lexical cues (case-insensitive regex): /(recogniz(?:ed|es|ing)\\b|recognized\\s+expense|expense\\s+recognized|allocated|attributable\\s+to\\s+employee|allocated\\s+to\\s+function|for\\s+the\\s+period|during\\s+the\\s+period|in\\s+the\\s+period)\\b/; also capture verbs 'was recognized', 'were recognized', 'is recognized'.", "2) Association window: require any of these cues to co-occur within ±12 tokens of the currency amount OR in the same sentence. Allow antecedent resolution: if 'the amount recognized' appears and the plan/award anchor is in the previous sentence, allow ±1 sentence (combined span <= 40 tokens).", "3) Decision flow: when lexical surface match (\"stock-based compensation\" etc.) yields both candidate tags (AllocatedShareBasedCompensationExpense and ShareBasedCompensation), apply this validation: if any recognized/allocated/per‑period cue present per windows -> assign AllocatedShareBasedCompensationExpense (specific). Else if text is descriptive/conceptual (e.g., 'stock‑based compensation is a significant part of our compensation') with NO recognized/allocated/per‑period cue -> assign ShareBasedCompensation."], "removed_content": []}
{"timestamp": "2026-02-06T18:53:19.790702", "step": 76, "playbook_before_length": 114717, "playbook_after_length": 119391, "lines_before": 505, "lines_after": 548, "added_lines": 31, "removed_lines": 0, "operations_count": 1, "operations": [{"type": "ADD", "section": "context_clues_and_indicators", "content": "Atomic rule: Distinguish AwardVestingPeriod vs AwardExpirationPeriod for numeric time expressions (years/months/days)\n\nPurpose: prevent blanket mapping of any numeric+unit near 'vest' to vesting-period; map anchored time-to-event expressions (\"from the grant date\", \"from issuance\", \"on the grant date\", \"by the grant date\", \"after grant date\") to the award-expiration/term tag.\n\nExact lexical patterns (case-insensitive regex examples):\n- Anchored time-to-event patterns (map numeric -> SharebasedCompensationArrangementBySharebasedPaymentAwardExpirationPeriod):\n  - /\\b(?:from|from the|from the date of|after|after the|on|by)\\s+(?:the\\s+)?(?:grant|grant date|date of grant|issuance|issue date|grant\\s+date|date\\s+of\\s+grant)\\b/i\n  - /\\bexpires?\\s+(?:in|after|from)\\s+\\d+\\s*(?:month|months|year|years|day|days)\\b/i\n  - /\\bvesting\\s+\\d+\\s*(?:month|months|year|years)\\s+from\\b/i\n  - /\\bvests?\\s+on\\s+the\\s+grant\\s+date\\b/i\n\n- Vesting-schedule patterns (map numeric -> ShareBasedCompensationArrangementByShareBasedPaymentAwardAwardVestingPeriod1):\n  - /\\b(vest(?:s|ing)?(?:\\s+schedule)?|cliff\\s+vesting|vests?\\s+ratably|vests?\\s+over|vests?\\s+in)\\b/i\n  - boundary examples: /\\bthree[- ]year(?:s)?\\s+cliff\\s+vesting\\b/, /\\bvests?\\s+over\\s+\\d+\\s+year(?:s)?\\b/, /\\b\\d+\\s+year(?:s)?\\b(\\s+cliff)?(?=\\s+vesting)/i\n\nAssociation & token-window policy:\n- Primary: apply patterns within the same sentence. Numeric token must be within ±12 tokens of the matched anchor phrase.\n- Antecedent resolution: allow anchored phrases in the immediately preceding sentence (±1 sentence) when anaphors refer to 'the award'/'the Plan' and combined span <= 40 tokens.\n\nDecision flow & precedence (apply in order):\n1) If anchored time-to-event pattern matches (any anchored regex above) and numeric+unit is in the pattern window -> assign SharebasedCompensationArrangementBySharebasedPaymentAwardExpirationPeriod and link mapping metadata { anchor_span, numeric_span, matched_pattern }.\n2) Else if vesting-schedule pattern matches (vesting-schedule regexes) and numeric+unit is in that window -> assign ShareBasedCompensationArrangementByShareBasedPaymentAwardAwardVestingPeriod1.\n3) If BOTH patterns co-occur in same clause/sentence (e.g., 'three-year cliff vesting' AND 'vesting 36 months from the grant date') -> map schedule numeric(s) to AwardVestingPeriod and map anchored numeric(s) (the '... from the grant date' expression) to AwardExpirationPeriod (explicit split rule). Do NOT collapse into a single vesting-period tag.\n4) Tie-breaker: when a numeric appears in proximity to both a generic 'vest' verb and an anchored 'from the grant date' prepositional phrase, favor anchored-expiration mapping when the numeric is syntactically tied to the prepositional phrase (token-distance to preposition < token-distance to generic 'vest' verb) OR if the preposition 'from/on/by/after' immediately precedes the date-anchor phrase.\n\nEdge-case rules:\n- If sentence reads like 'vests immediately; fully vested after X months from grant date' apply anchored-expiration mapping to the 'after X months' numeric.\n- If numeric lacks explicit 'from/on/after/by' anchor but context contains 'vests in X years' without date anchoring -> treat as AwardVestingPeriod.\n\nExamples / unit-tests (atomic):\n- 'with the entire award vesting 36 months from the grant date.' -> 36 months = SharebasedCompensationArrangementBySharebasedPaymentAwardExpirationPeriod (NOT AwardVestingPeriod).\n- 'three-year cliff vesting' -> 'three' & 'year' = ShareBasedCompensationArrangementByShareBasedPaymentAwardAwardVestingPeriod1.\n- 'vests over three years and fully vests 36 months from the grant date' -> three years -> AwardVestingPeriod; 36 months -> AwardExpirationPeriod.\n- 'award vests 24 months after issuance' -> 24 months = AwardExpirationPeriod (anchored 'after issuance').\n- 'vesting schedule: 25% each year for four years' -> four years = AwardVestingPeriod (schedule form).\n\nLogging & QA:\n- Record anchor_span, numeric_span, matched_regex, token_distances to both 'vest' and 'from' anchors, chosen_tag, and decision_reason (e.g., 'anchored-expiration' or 'schedule-match').\n- Flag for review any mapping where token-distance difference between anchored anchor and vest-schedule anchor is <=2 tokens (ambiguous proximity) with label 'vesting-expiration-proximity-ambiguous'.\n\nImplementation notes:\n- Insert this rule as a mandatory validation step after any generic 'numeric+unit -> vesting' candidate assignment but before final commit of vesting tags.\n- Make outputs carry metadata so downstream QA/training can detect repeated anchored-expiration patterns for taxonomy improvements."}], "added_content": ["[ctx-00024] helpful=0 harmful=0 :: Atomic rule: Distinguish AwardVestingPeriod vs AwardExpirationPeriod for numeric time expressions (years/months/days)", "Purpose: prevent blanket mapping of any numeric+unit near 'vest' to vesting-period; map anchored time-to-event expressions (\"from the grant date\", \"from issuance\", \"on the grant date\", \"by the grant date\", \"after grant date\") to the award-expiration/term tag.", "Exact lexical patterns (case-insensitive regex examples):", "- Anchored time-to-event patterns (map numeric -> SharebasedCompensationArrangementBySharebasedPaymentAwardExpirationPeriod):", "  - /\\b(?:from|from the|from the date of|after|after the|on|by)\\s+(?:the\\s+)?(?:grant|grant date|date of grant|issuance|issue date|grant\\s+date|date\\s+of\\s+grant)\\b/i"], "removed_content": []}
{"timestamp": "2026-02-09T14:34:01.433297", "step": 77, "playbook_before_length": 38622, "playbook_after_length": 44237, "lines_before": 138, "lines_after": 167, "added_lines": 29, "removed_lines": 0, "operations_count": 2, "operations": [{"type": "ADD", "section": "context_clues_and_indicators", "content": "Atomic heuristic: Distinguish 'Level X' mentions from explicit fair-value measurements; prefer carrying/balance tags for point-in-time VIE/note balances.\n- Purpose: avoid mis-mapping numeric tokens adjacent to 'Level 3' (or Level 1/2) to DebtInstrumentFairValue unless the sentence explicitly states a fair-value measurement. Prefer DebtInstrumentCarryingAmount when amounts are presented as balances, as-of/date snapshots, or VIE/note balance listings.\n- Exact lexical cues (case-insensitive):\n  - Fair-value explicit cues (require one to justify DebtInstrumentFairValue): /fair value\\b/, /measured at fair value\\b/, /carried at fair value\\b/, /estimated fair value\\b/, /fair-value measurement\\b/, /at fair value\\b/.\n  - Level-hierarchy cues (do NOT by themselves imply fair value): /level\\s*[123]\\b/, /level\\s+3\\b/, /level\\s+1\\b/, /level\\s+2\\b/.\n  - Balance / carrying cues (favor DebtInstrumentCarryingAmount): /as of\\s+[A-Za-z0-9,]+/, /at\\s+(?:December|September|June|March|March|\\d{1,2},\\s*\\d{4})/, /at\\s+[A-Za-z0-9\\-]+\\b/, /at\\s+September\\s+30,?\\s+\\d{4}/i, /the\\s+balance(s)?\\s+as\\s+of\\b/, /included\\s+at\\s+/, /comprised\\s+of\\b/, /carrying\\s+amount\\b/, /carried\\s+amount\\b/, /balance\\s+sheet\\s+balance\\b/, /at\\s+the\\s+end\\s+of\\s+the\\s+period\\b/.\n  - VIE / note-listing cues (favor CarryingAmount when present): /variable\\s+interest\\s+entity\\b/, /VIE\\b/, /vies?\\b/, /consolidated\\s+v?ie\\b/, /nonconsolidated\\s+v?ie\\b/, /the\\s+following\\s+table\\s+shows\\b/, /the\\s+following\\s+balances\\b/, /included\\s+in\\s+the\\s+consolidated\\s+balance\\s+sheet\\b/.\n- Association & token-window policy:\n  - Require existence of an explicit fair-value cue within ±8 tokens of the numeric token (same sentence) to map to DebtInstrumentFairValue when a Level-X cue also appears; Level-X alone must NOT trigger fair-value mapping.\n  - If a balance/date cue or a VIE/note-listing cue appears in the same sentence or within the immediately preceding sentence (±1 sentence antecedent resolution allowed, span <= 40 tokens), then treat the numeric token as a carrying/balance amount and map to DebtInstrumentCarryingAmount.\n  - If both fair-value explicit cue and carrying/date/VIE-listing cue co-occur, prefer explicit fair-value language for DebtInstrumentFairValue, but log as 'fairvalue-vs-carrying-conflict' (include spans).\n- Precedence (apply in order):\n  1) If fair-value explicit cue present (±8 tokens) -> DebtInstrumentFairValue.\n  2) Else if balance/date cue OR VIE/note-listing cue present (same sentence OR previous sentence antecedent within span limit) -> DebtInstrumentCarryingAmount.\n  3) Else if only Level-X present without fair-value explicit cue -> DO NOT map to DebtInstrumentFairValue; mark as 'level-only-ambiguous' and either map conservatively to DebtInstrumentCarryingAmount if other carrying-structure words exist (e.g., 'balances', 'as of') or flag for human review.\n- Ambiguity handling & logging:\n  - Any mapping decision where 'Level' appears but no explicit fair-value cue should be logged with label 'level-only-ambiguous' including numeric span, 'Level' span, and surrounding sentence for QA and training.\n  - Any mapping where both explicit fair-value cues and balance/date cues appear must be logged as 'fairvalue-vs-carrying-conflict' with spans.\n- Unit-tests / minimal examples to add (atomic):\n  - \"At September 30, 2017, the variable interest entity had assets of $297 and $305 included in 'Level 3 instruments'.\" -> $297, $305 = DebtInstrumentCarryingAmount (note-listing + as-of date cues), NOT DebtInstrumentFairValue.\n  - \"The fair value of the instruments, which are Level 3, was $297 at September 30, 2017.\" -> $297 = DebtInstrumentFairValue (explicit 'fair value' present).\n  - \"Level 3 instruments included amounts of $10 and $12.\" -> flag 'level-only-ambiguous' for review (do not auto-assign DebtInstrumentFairValue); if surrounding sentence shows 'included in the balance sheet as of' map to CarryingAmount.\n  - \"For VIEs, carrying amounts as of December 31 were $X and $Y\" -> map to DebtInstrumentCarryingAmount.\n- Implementation notes: place this rule before any blanket 'Level X -> fair value' fallback; ensure classifier/regression tests penalize mapping to DebtInstrumentFairValue unless explicit fair-value cues are present. Record all 'level-only-ambiguous' examples into a retraining dataset."}, {"type": "ADD", "section": "common_mistakes_to_avoid", "content": "[err-XXXXX] helpful=0 harmful=0 :: Anti-pattern: mapping any mention of 'Level 3' (or fair-value hierarchy) to DebtInstrumentFairValue without verifying explicit fair-value language or balance/date/VIE-listing context. Prevention checklist (atomic):\n1) Do NOT assign DebtInstrumentFairValue solely because the phrase 'Level 3' or 'Level 2' appears. Require an explicit fair-value cue ('fair value', 'measured at fair value', 'at fair value') within ±8 tokens to justify a fair-value tag.\n2) If numeric amounts are shown with date anchors ('as of', 'at [date]') or in table/note listing context or adjacent to 'VIE'/'variable interest entity' language, prefer DebtInstrumentCarryingAmount unless explicit fair-value language is present.\n3) If 'Level X' and 'fair value' both appear, map to DebtInstrumentFairValue; if 'Level X' appears with 'as of'/'included'/'carrying' map to DebtInstrumentCarryingAmount; if both classes of cues are present, log and flag for human review under 'fairvalue-vs-carrying-conflict'.\n4) Add unit-tests covering each anti-pattern and expected mapping (include the $297/$305 VIE example). 5) Log all 'level-only-ambiguous' mappings for manual QA and include them in retraining batches."}], "added_content": ["[err-00002] helpful=0 harmful=0 :: [err-XXXXX] helpful=0 harmful=0 :: Anti-pattern: mapping any mention of 'Level 3' (or fair-value hierarchy) to DebtInstrumentFairValue without verifying explicit fair-value language or balance/date/VIE-listing context. Prevention checklist (atomic):", "1) Do NOT assign DebtInstrumentFairValue solely because the phrase 'Level 3' or 'Level 2' appears. Require an explicit fair-value cue ('fair value', 'measured at fair value', 'at fair value') within ±8 tokens to justify a fair-value tag.", "2) If numeric amounts are shown with date anchors ('as of', 'at [date]') or in table/note listing context or adjacent to 'VIE'/'variable interest entity' language, prefer DebtInstrumentCarryingAmount unless explicit fair-value language is present.", "3) If 'Level X' and 'fair value' both appear, map to DebtInstrumentFairValue; if 'Level X' appears with 'as of'/'included'/'carrying' map to DebtInstrumentCarryingAmount; if both classes of cues are present, log and flag for human review under 'fairvalue-vs-carrying-conflict'.", "4) Add unit-tests covering each anti-pattern and expected mapping (include the $297/$305 VIE example). 5) Log all 'level-only-ambiguous' mappings for manual QA and include them in retraining batches."], "removed_content": []}
{"timestamp": "2026-02-09T14:35:51.101249", "step": 78, "playbook_before_length": 44237, "playbook_after_length": 47772, "lines_before": 167, "lines_after": 194, "added_lines": 19, "removed_lines": 0, "operations_count": 1, "operations": [{"type": "ADD", "section": "context_clues_and_indicators", "content": "Atomic rule: map 'letters of credit' currency phrases -> LettersOfCreditOutstandingAmount (override facility-capacity fallbacks)\n\nPurpose: deterministically map currency amounts that quantify letters of credit (available / outstanding / aggregate) to LettersOfCreditOutstandingAmount (or the taxonomy's letters-of-credit outstanding/available tag) and avoid mis-mapping them to LineOfCreditFacilityMaximumBorrowingCapacity or RemainingBorrowingCapacity.\n\nExact lexical cues (case-insensitive regexes and phrase forms): /letters?\\s+of\\s+credit\\b/, /letters?\\s+of\\s+credit\\s+in\\s+an\\s+aggregate\\s+amount\\s+of\\s+up\\s+to\\b/, /letters?\\s+of\\s+credit\\s+outstanding\\b/, /are\\s+available\\s+.*letters?\\s+of\\s+credit\\b/, /available\\s+letters?\\s+of\\s+credit\\b/.\n\nAssociation & token-window policy:\n- Primary association window: numeric currency token must lie within ±8 tokens of a 'letters of credit' cue in the same sentence.\n- Antecedent resolution: allow the named facility or 'the facility' antecedent in the immediately preceding sentence (±1 sentence) only for linking facility anchors but do NOT allow that antecedent to override the letters-of-credit mapping.\n\nPrecedence & decision flow (apply before generic 'availability' -> remaining/capacity fallbacks):\n1) If numeric is currency AND a 'letters of credit' cue matches (primary window) -> assign LettersOfCreditOutstandingAmount (treat currency as letters-of-credit outstanding/available amount).\n2) This mapping overrides any generic facility-capacity mapping (LineOfCreditFacilityMaximumBorrowingCapacity) or generic availability mapping (LineOfCreditFacilityRemainingBorrowingCapacity) when the 'letters of credit' cue is present and within the association window.\n3) If the same sentence contains both a facility-capacity cue (e.g., 'in an aggregate principal amount of up to $X') and a separate 'letters of credit' cue with a different numeric, map each numeric to the adjacent cue by token-distance. If a single numeric token is within distance of both cues, prefer the 'letters of credit' mapping and log the conflict as 'letters-credit-vs-facility-conflict'.\n\nConflict handling & ambiguity:\n- If 'letters of credit' appears but no currency numeric within ±8 tokens, flag 'letters-credit-no-amount' for review (do not infer amount from facility cap).\n- If the sentence says 'amount available under the facility totaled $X' and separately lists 'letters of credit outstanding totaled $Y', map X -> RemainingBorrowingCapacity and Y -> LettersOfCreditOutstandingAmount per cues.\n\nUnit-tests / minimal examples to add (atomic):\n- \"Letters of credit in an aggregate amount of up to $30 million are also available...\" -> $30,000,000 = LettersOfCreditOutstandingAmount.\n- \"allow borrowings of up to $750 million under the revolver\" -> $750,000,000 = LineOfCreditFacilityMaximumBorrowingCapacity (existing rules); ensure no cross-mapping when both phrases present.\n- \"An outstanding letter of credit under the credit facility totaled $12.5 million\" -> $12,500,000 = LettersOfCreditOutstandingAmount.\n\nLogging & QA: every automatic letters-of-credit mapping must be logged with label 'letters-credit-mapped' including cue span, numeric span, sentence index, and any preceding facility-anchor span; conflicts logged as 'letters-credit-vs-facility-conflict'.\n\nImplementation note: insert this rule into the pipeline before the generic availability/capacity rules (ctx-00009 / ctx-00008) so that explicit 'letters of credit' cues win deterministically."}], "added_content": ["[ctx-00003] helpful=0 harmful=0 :: Atomic rule: map 'letters of credit' currency phrases -> LettersOfCreditOutstandingAmount (override facility-capacity fallbacks)", "Purpose: deterministically map currency amounts that quantify letters of credit (available / outstanding / aggregate) to LettersOfCreditOutstandingAmount (or the taxonomy's letters-of-credit outstanding/available tag) and avoid mis-mapping them to LineOfCreditFacilityMaximumBorrowingCapacity or RemainingBorrowingCapacity.", "Exact lexical cues (case-insensitive regexes and phrase forms): /letters?\\s+of\\s+credit\\b/, /letters?\\s+of\\s+credit\\s+in\\s+an\\s+aggregate\\s+amount\\s+of\\s+up\\s+to\\b/, /letters?\\s+of\\s+credit\\s+outstanding\\b/, /are\\s+available\\s+.*letters?\\s+of\\s+credit\\b/, /available\\s+letters?\\s+of\\s+credit\\b/.", "Association & token-window policy:", "- Primary association window: numeric currency token must lie within ±8 tokens of a 'letters of credit' cue in the same sentence."], "removed_content": []}
{"timestamp": "2026-02-09T14:37:13.991536", "step": 79, "playbook_before_length": 47772, "playbook_after_length": 53676, "lines_before": 194, "lines_after": 223, "added_lines": 29, "removed_lines": 0, "operations_count": 3, "operations": [{"type": "ADD", "section": "context_clues_and_indicators", "content": "Atomic lexical-to-tag rule: map 'useful life(s)' / 'depreciable assets' -> PropertyPlantAndEquipmentUsefulLife\n- Exact lexical cues (case-insensitive regex examples): /useful\\s+life(s)?\\b/, /estimated\\s+useful\\s+life(s)?\\b/, /depreciable\\s+asset(s)?\\b/, /depreciable\\s+life(s)?\\b/, /useful\\s+lives\\s+of\\s+our\\s+depreciable\\s+assets\\b/. \n- Association window: numeric token (years) must co-occur in the same sentence within ±8 tokens of a cue; allow numeric ranges (e.g., 'range from 3 to 7 years' capture both endpoints). Recognize 'years' or 'yrs' and plain integers when context indicates time units. \n- Precedence: this mapping overrides any generic 'asset life' or 'term' tags and overrides generic percentage/amount heuristics. If multiple numeric years are present, map each numeric endpoint to PropertyPlantAndEquipmentUsefulLife (create two annotations if taxonomy allows ranges). \n- Antecedent resolution: allow plan/instrument mention in previous sentence if the current sentence uses anaphora ('those depreciable assets', 'these assets'); allow antecedent span across ±1 sentence up to 40 tokens only if anaphor present. \n- Ambiguity handling: if 'life' appears but no unit (years) or no explicit 'depreciable'/'asset' anchor, flag as 'useful-life-no-unit' for review rather than assigning numeric tag. \n- Unit-tests/examples: \n  - 'The estimated useful lives of our depreciable assets range from 3 to 7 years.' -> 3, 7 = PropertyPlantAndEquipmentUsefulLife.\n  - 'We depreciate equipment over useful lives of five years.' -> 5 = PropertyPlantAndEquipmentUsefulLife.\n- Logging: record anchor span, numeric span, and whether mapping was range/single-year for QA."}, {"type": "ADD", "section": "context_clues_and_indicators", "content": "Atomic instrument-specific exercise-price rule: map 'exercise price' + warrant/right -> ClassOfWarrantOrRightExercisePriceOfWarrantsOrRights1 (and disambiguate from options/generic per-share price)\n- Exact lexical cues (case-insensitive regex examples): /exercise\\s+price\\b/, /exercise\\s+price\\s+per\\s+share\\b/, /exercise\\s+price\\s+of\\s+the\\s+warrant(s)?\\b/, /warrant(s)?\\b/, /right(s)?\\s+to\\s+purchase\\b/, /rights?\\s+to\\s+acquire\\b/, /Class\\s+of\\s+Warrant/i. \n- Association window: require 'warrant'/'right' anchor in same sentence OR antecedent in previous sentence (±1 sentence, span <= 40 tokens) and a numeric currency token within ±8 tokens of the 'exercise price' phrase. Accept both '$X.XX' and bare numeric price tokens when 'per share' or 'per depositary share' present. \n- Disambiguation: if the instrument anchor is 'option' (\\boption(s)?\\b) map to the option-specific exercise-price tag if present in taxonomy; if taxonomy lacks an option tag, flag for human review but do NOT map to the warrant-specific tag. \n- Precedence/tie-breaker: when 'exercise price' + 'per share' co-occurs with a warrant/right anchor, prefer ClassOfWarrantOrRightExercisePriceOfWarrantsOrRights1 over any generic SaleOfStockPricePerShare or PricePerShare tag. Instrument-anchor detection must run before generic per-share mapping. \n- Antecedent resolution rules: if the sentence contains anaphora ('the warrants', 'these rights') and previous sentence defined 'warrants' or 'rights', allow cross-sentence mapping under same ±1-sentence rule. \n- Ambiguity handling: if 'exercise price' + 'per share' appears but no explicit instrument anchor (no 'warrant'/'right'/'option' word in ±1 sentence), do NOT auto-assign a warrant-specific tag; instead mark as 'exercise-price-no-instrument' for human review or apply semantic classifier with low confidence threshold. \n- Unit-tests/examples: \n  - 'The exercise price of the warrants is $5.00 per share.' -> $5.00 = ClassOfWarrantOrRightExercisePriceOfWarrantsOrRights1.\n  - 'Rights to purchase common stock have an exercise price of $2.50 per share.' -> $2.50 = ClassOfWarrantOrRightExercisePriceOfWarrantsOrRights1.\n  - 'We issued options with an exercise price of $1.20 per share' -> map to option-exercise-price tag (or flag if option tag missing). \n- Logging: record instrument-anchor span, 'exercise price' span, numeric span, antecedent sentence index and mapping decision (including 'declined-to-map' when anchor absent)."}, {"type": "ADD", "section": "common_mistakes_to_avoid", "content": "Anti-pattern prevention: Do NOT map any 'exercise price' + 'per share' phrase to generic price-per-share/sale tags without first checking instrument-anchor (atomic checklist):\n1) Before assigning SaleOfStockPricePerShare or generic PricePerShare: search same sentence ±1 sentence for instrument-anchor tokens: /warrant(s)?\\b/, /right(s)?\\s+to\\s+purchase\\b/, /option(s)?\\b/, /convertible\\b/. If found, prefer instrument-specific exercise-price tag (warrant/option/convertible-conversion-price) that matches anchor. \n2) If anchor == 'warrant' or 'right' -> assign ClassOfWarrantOrRightExercisePriceOfWarrantsOrRights1. If anchor == 'option' -> assign option-exercise-price tag. If anchor == 'convertible' -> assign convertible-conversion price tag. \n3) If multiple anchors (e.g., 'warrants and options') use nearest-token distance to numeric; if tie, prefer the anchor explicitly adjacent to the phrase 'exercise price' or the most-specific named instrument in sentence. \n4) If no anchor found within ±1 sentence -> DO NOT auto-assign instrument-specific tag; either (a) map to generic SaleOfStockPricePerShare only if offering/sale language strongly indicates a sale-price (e.g., 'offering price', 'issued at'), otherwise (b) flag 'exercise-price-no-instrument' for human review. \n5) Add unit-tests to cover: warrant-exercise-price, option-exercise-price, convertible-conversion-price, and exercise-price with absent instrument anchor to ensure generic-sale tags do not win by default.\n6) Logging: every time the anti-pattern would have applied (generic mapping prevented), log 'prevented-generic-exercise-price-mapping' with spans and chosen mapping reason for QA."}], "added_content": ["[err-00006] helpful=0 harmful=0 :: Anti-pattern prevention: Do NOT map any 'exercise price' + 'per share' phrase to generic price-per-share/sale tags without first checking instrument-anchor (atomic checklist):", "1) Before assigning SaleOfStockPricePerShare or generic PricePerShare: search same sentence ±1 sentence for instrument-anchor tokens: /warrant(s)?\\b/, /right(s)?\\s+to\\s+purchase\\b/, /option(s)?\\b/, /convertible\\b/. If found, prefer instrument-specific exercise-price tag (warrant/option/convertible-conversion-price) that matches anchor. ", "2) If anchor == 'warrant' or 'right' -> assign ClassOfWarrantOrRightExercisePriceOfWarrantsOrRights1. If anchor == 'option' -> assign option-exercise-price tag. If anchor == 'convertible' -> assign convertible-conversion price tag. ", "3) If multiple anchors (e.g., 'warrants and options') use nearest-token distance to numeric; if tie, prefer the anchor explicitly adjacent to the phrase 'exercise price' or the most-specific named instrument in sentence. ", "4) If no anchor found within ±1 sentence -> DO NOT auto-assign instrument-specific tag; either (a) map to generic SaleOfStockPricePerShare only if offering/sale language strongly indicates a sale-price (e.g., 'offering price', 'issued at'), otherwise (b) flag 'exercise-price-no-instrument' for human review. "], "removed_content": []}
{"timestamp": "2026-02-09T14:38:34.860029", "step": 80, "playbook_before_length": 53676, "playbook_after_length": 58372, "lines_before": 223, "lines_after": 264, "added_lines": 31, "removed_lines": 0, "operations_count": 1, "operations": [{"type": "ADD", "section": "context_clues_and_indicators", "content": "Atomic heuristic: Specificity-first mapping for contract/customer revenues -> RevenueFromContractWithCustomerExcludingAssessedTax\n\nPurpose: Prevent blanket-mapping of any 'revenues' phrase to the generic Revenues tag when the phrase actually denotes revenue arising from contracts with customers (excluding assessed tax), e.g., 'reimbursable revenues', 'customer revenues', 'segment revenues', or construction/contract billing amounts.\n\nExact lexical cues (case-insensitive regexes and variants):\n- /\\breimbursable\\s+revenue(s)?\\b/\n- /\\brevenue(s)?\\s+from\\s+(?:contracts?\\s+with\\s+customers|customers?)\\b/\n- /(?:revenue|revenues)\\s+from\\s+customers?\\b/\n- /(?:customer|contract|segment|segmental)\\s+revenue(s)?\\b/\n- /constitut(?:e|ed)\\s+approximately\\s+\\d{1,3}(?:\\.\\d+)?%\\s+of\\s+our\\s+total\\s+consolidated\\s+revenues/  (composition anchor)\n- /excluding\\s+assessed\\s+tax/i (explicit 'excluding' qualifier)\n\nAssociation & token-window policy:\n- Primary association window: match lexical cue within the same sentence and associate the nearest currency numeric token that lies within ±8 tokens of the cue or within the same clause.\n- Antecedent resolution: allow antecedent anchor in the immediately preceding sentence (±1 sentence) when anaphora such as 'these revenues', 'such revenues', or 'the reimbursable amounts' is used; cross-sentence span limited to <= 40 tokens and require explicit referential pronoun/anchor.\n- Percentage confirmation: if a percentage token describing composition (e.g., 'constituted approximately 23.6 percent of our total consolidated revenues') appears in the same sentence and a currency token is also present, use the composition anchor to link the currency amount to customer/contract revenue tag.\n\nPrecedence and tie-breakers (apply in order):\n1) If any of the contract/customer lexical cues match within window -> assign RevenueFromContractWithCustomerExcludingAssessedTax (or the most specific contract-customer revenue tag available) to the nearest currency numeric token.\n2) If the sentence contains both a contract/customer cue and a generic 'revenues' cue, prefer the contract/customer tag.\n3) If multiple contract-customer-like tags are possible (e.g., both 'segment revenue' and a narrower 'RevenueFromContractWithCustomerExcludingAssessedTax' exist), prefer the most specific taxonomy tag that explicitly mentions 'contract' or 'customer' and/or includes 'excluding assessed tax' when 'excluding' present.\n4) Only fallback to generic Revenues when NO contract/customer cue is present within the association windows and no antecedent resolution links the numeric to a contract/customer anchor.\n\nConflict & ambiguity handling:\n- If both a contract/customer cue and an unrelated revenue-like cue (e.g., 'non-operating revenues') are within window, prefer contract/customer mapping only when token-distance score (1/(1+distance)) + specificity bonus exceeds the other cue's score; otherwise flag as 'revenue-cue-conflict' for human review.\n- If 'reimbursable' appears but no currency numeric within ±8 tokens, flag 'reimbursable-no-amount' for review (do not infer amount from nearby generic 'revenues' tokens across long spans).\n\nLogging & QA:\n- Log every automatic assignment to RevenueFromContractWithCustomerExcludingAssessedTax with spans for the lexical cue, numeric token, and any percent-composition token used to confirm mapping.\n- Add 'revenue-specificity-fallback' entries when fallback to generic Revenues occurs despite presence of ambiguous cues, to be included in retraining batches.\n\nUnit-tests / minimal examples to add (atomic):\n1) 'Excluding reimbursable revenues of $39.9 million, ENL constituted approximately 23.6 percent of our total consolidated revenues...' -> $39.9M = RevenueFromContractWithCustomerExcludingAssessedTax; 23.6% = ConcentrationRiskPercentage1.\n2) 'Reimbursable revenues of $12.5 million were billed to the customer under the contract.' -> $12.5M = RevenueFromContractWithCustomerExcludingAssessedTax.\n3) 'Segment revenues from our European customers totaled $45 million.' -> $45M = RevenueFromContractWithCustomerExcludingAssessedTax (segment + customer anchor).\n4) 'Total revenues were $1.2 billion; other operating income was $5 million.' -> $1.2B = Revenues (generic) (no contract/customer cue present).\n\nImplementation notes:\n- Insert this rule prior to any generic 'revenues' -> Revenues lexical fallback.\n- Ensure the regexes and association windows are applied before coarse classifier decisions that prefer generic tags.\n- Capture mapping decisions as structured logs for traceability and to generate counterexamples for retraining when false positives/negatives are found."}], "added_content": ["[ctx-00007] helpful=0 harmful=0 :: Atomic heuristic: Specificity-first mapping for contract/customer revenues -> RevenueFromContractWithCustomerExcludingAssessedTax", "Purpose: Prevent blanket-mapping of any 'revenues' phrase to the generic Revenues tag when the phrase actually denotes revenue arising from contracts with customers (excluding assessed tax), e.g., 'reimbursable revenues', 'customer revenues', 'segment revenues', or construction/contract billing amounts.", "Exact lexical cues (case-insensitive regexes and variants):", "- /\\breimbursable\\s+revenue(s)?\\b/", "- /\\brevenue(s)?\\s+from\\s+(?:contracts?\\s+with\\s+customers|customers?)\\b/"], "removed_content": []}
{"timestamp": "2026-02-09T14:39:52.225154", "step": 81, "playbook_before_length": 58372, "playbook_after_length": 63728, "lines_before": 264, "lines_after": 280, "added_lines": 16, "removed_lines": 0, "operations_count": 2, "operations": [{"type": "ADD", "section": "context_clues_and_indicators", "content": "Atomic unit-driven disambiguation: share-count vs monetary-amount mapping (repurchases & issuance contexts)\n- Purpose: when a sentence contains both a shares-count token and a currency token, deterministically map the shares-count numeric to a shares-count tag and the currency numeric to a monetary tag; avoid conflation. \n- Exact lexical/unit cues (case-insensitive regexes): /\\bshare(s)?\\b/, /\\bcommon\\s+share(s)?\\b/, /\\bordinary\\s+share(s)?\\b/, /\\bmillion\\s+shares\\b/, /\\bthousand\\s+shares\\b/. Currency detection: /\\$|dollars|EUR|£|USD|\\bmillion\\b|\\bbillion\\b/. Repurchase cues: /repurchas(e|ed|ing)|purchas(e|ed|ing)\\s+(back)|repurchase\\s+program|bought\\s+back/i. \n- Association windows: primary window = ±8 tokens around each numeric token to detect unit anchors; sentence-level scan to find both share-unit and currency-unit occurrences. \n- Precedence & decision flow (apply in order): 1) If a numeric token has a nearby share-unit cue -> assign share-count tag appropriate to transaction context (e.g., StockRepurchasedDuringPeriodShares or StockIssuedDuringPeriodSharesNewIssues if issuance/underwriter cues present). 2) If a different numeric token in same sentence has a nearby currency cue -> assign the monetary variant (e.g., StockRepurchasedDuringPeriodAmount or PaymentsToAcquireBusinessesGross). 3) If a single numeric token is adjacent to both a share-unit and currency token (ambiguous forms like '1.9 million Common Shares ($381 million)') -> split mapping: assign the numeric with 'shares' unit to shares-count tag; assign the adjacent currency numeric to monetary tag. 4) If classifier suggests mapping a currency numeric to a shares-count tag solely because 'share' appears elsewhere in sentence, override classifier and prefer unit-specific mapping; log override. \n- Tie-breaker: instrument/transaction anchors (repurchase/underwriter/offer) can escalate which shares-tag to choose (repurchase -> StockRepurchasedDuringPeriodShares; offering/underwriter -> StockIssuedDuringPeriodSharesNewIssues). \n- Unit-tests/examples to add:  - 'The company purchased 1.9 million Common Shares for $381 million under the repurchase program.' -> 1.9M = StockRepurchasedDuringPeriodShares; $381M = StockRepurchasedDuringPeriodAmount.  - 'We issued 5,000,000 shares at $10 per share in the offering' -> 5,000,000 = StockIssuedDuringPeriodSharesNewIssues; $10 (per share) = IssuancePrice/PricePerShare tag.  - 'Purchased 2 million shares' (no currency) -> 2M = StockRepurchasedDuringPeriodShares. \n- Logging: record unit spans (share-word span and currency span), numeric-token ids, mapping chosen, and any classifier-vs-rule overrides under 'unit-disambiguation-override'."}, {"type": "ADD", "section": "common_mistakes_to_avoid", "content": "Prevent misclassification of defined-contribution plan costs vs defined-benefit disclosures (atomic heuristic)\n- Purpose: ensure sentences describing 'net cost' or 'net contribution' of DC/defined contribution plans map to DefinedContributionPlanCostRecognized (expense/contribution) and are not misclassified as defined-benefit pension items or generic pension-note amounts. \n- Exact lexical cues/patterns (case-insensitive regexes): /\\bdefined\\s+contribution\\b|\\bDC\\s+plan(s)?\\b|\\bdefined\\s+contribution\\s+plans?\\b/, net-cost cues: /\\bnet\\s+cost\\b|\\bnet\\s+contribution\\b|\\bemployer'?s?\\s+required\\s+contribution\\b|\\bwas\\s+\\$?[0-9,.]+\\b|\\bcontribution\\s+required\\b|\\bcontributed\\b/, explanatory equality cues: /=|equals|was\\s+the\\s+employer'?s?\\s+required\\s+contribution|which\\s+equals/i. \n- Association windows: require both a DC anchor and a currency numeric token in same sentence OR DC anchor in previous sentence (±1 sentence antecedent resolution allowed, span <= 40 tokens). Primary numeric-distance window = ±12 tokens around numeric for mapping. \n- Precedence & decision flow: 1) If sentence contains DC anchor + 'net cost'/'net contribution' + currency numeric -> assign DefinedContributionPlanCostRecognized and link numeric to DC plan identity if present. 2) If 'net cost' appears but anchor ambiguous between DC and DB (defined benefit), prefer DC mapping only when explicit 'defined contribution'/'DC' or 'employer's required contribution' tied to contribution semantics is present; otherwise flag for human review rather than auto-mapping to DB tags. 3) If the sentence states 'net cost of the DC plans was $X and equals employer's required contribution' -> deterministically map to DefinedContributionPlanCostRecognized = $X. \n- Anti-pattern prevention: do NOT assign DefinedBenefitPlanCost or pension actuarial tags when 'defined contribution' lexical cue present; do not rely on generic 'pension'/'benefit' words without explicit 'defined benefit' anchor. \n- Unit-tests/examples to add:  - 'The net cost of the DC plans for the year was $9 million, which equals the employer's required contribution.' -> $9M = DefinedContributionPlanCostRecognized.  - 'Employer contributions to our defined contribution plan were $4.2M' -> $4.2M = DefinedContributionPlanCostRecognized.  - 'Net pension cost for defined benefit plans was $2M' -> map to DefinedBenefitPlanCost (do not conflate). \n- Logging: record DC-anchor span, net-cost phrase span, numeric span and mapping decision; flag any auto-mapped DC cost where 'pension' or 'benefit' words also appear nearby as 'dc-vs-db-proximity' for QA."}], "added_content": ["[err-00009] helpful=0 harmful=0 :: Prevent misclassification of defined-contribution plan costs vs defined-benefit disclosures (atomic heuristic)", "- Purpose: ensure sentences describing 'net cost' or 'net contribution' of DC/defined contribution plans map to DefinedContributionPlanCostRecognized (expense/contribution) and are not misclassified as defined-benefit pension items or generic pension-note amounts. ", "- Exact lexical cues/patterns (case-insensitive regexes): /\\bdefined\\s+contribution\\b|\\bDC\\s+plan(s)?\\b|\\bdefined\\s+contribution\\s+plans?\\b/, net-cost cues: /\\bnet\\s+cost\\b|\\bnet\\s+contribution\\b|\\bemployer'?s?\\s+required\\s+contribution\\b|\\bwas\\s+\\$?[0-9,.]+\\b|\\bcontribution\\s+required\\b|\\bcontributed\\b/, explanatory equality cues: /=|equals|was\\s+the\\s+employer'?s?\\s+required\\s+contribution|which\\s+equals/i. ", "- Association windows: require both a DC anchor and a currency numeric token in same sentence OR DC anchor in previous sentence (±1 sentence antecedent resolution allowed, span <= 40 tokens). Primary numeric-distance window = ±12 tokens around numeric for mapping. ", "- Precedence & decision flow: 1) If sentence contains DC anchor + 'net cost'/'net contribution' + currency numeric -> assign DefinedContributionPlanCostRecognized and link numeric to DC plan identity if present. 2) If 'net cost' appears but anchor ambiguous between DC and DB (defined benefit), prefer DC mapping only when explicit 'defined contribution'/'DC' or 'employer's required contribution' tied to contribution semantics is present; otherwise flag for human review rather than auto-mapping to DB tags. 3) If the sentence states 'net cost of the DC plans was $X and equals employer's required contribution' -> deterministically map to DefinedContributionPlanCostRecognized = $X. "], "removed_content": []}
{"timestamp": "2026-02-09T14:41:25.665216", "step": 82, "playbook_before_length": 63728, "playbook_after_length": 68437, "lines_before": 280, "lines_after": 317, "added_lines": 25, "removed_lines": 0, "operations_count": 1, "operations": [{"type": "ADD", "section": "context_clues_and_indicators", "content": "Atomic heuristic: Prefer generic Revenues for headline income-statement amounts; reserve RevenueFromContractWithCustomer... for explicit contract-accounting contexts.\n\nPurpose: Prevent overapplication of contract-specific revenue tags when amounts are presented as top-line/period-line items in condensed/consolidated statements of income or in table rows that function as headline revenue lines.\n\nExact positive headline cues (case-insensitive regexes):\n- /\\bcondensed consolidated statement of (income|operations)\\b/;\n- /\\bfor the (three|six|nine|twelve) months? (and|ended|ended\\s+on)\\b/;  // period-ended row context\n- /\\b(total|totaled|totalled|total revenues|net revenues|revenues were|revenues of)\\b/;\n- row/table header patterns: /\\b(revenues|total revenue|net revenue|sales)\\b/ appearing in a table-row/line-item context (same sentence or immediately preceding heading sentence).\n\nContract-accounting explicit cues (require at least one to permit contract-specific mapping):\n- /contract(s?) with customer(s?)|revenue(s?) recognized? from contracts?|performance obligation(s)?|contract asset(s)?|contract liability|deferred revenue|transaction price|recognized in accordance with ASC\\s*606|under ASC 606|under Topic 606|amounts recognized on contract(s)?/i\n\nAssociation & token-window policy:\n1) If a currency numeric token appears in a sentence that matches any positive headline cue OR in a table/row context whose header contains 'revenues' or 'total revenues' (allow antecedent heading in previous sentence within ±1 sentence), then mark that numeric as a headline-revenue candidate.\n2) If numeric is a headline-revenue candidate and no contract-accounting explicit cues are present within the same sentence or the immediately preceding sentence (±1 sentence, span <= 40 tokens), assign tag = Revenues.\n3) If both headline cues and contract-accounting explicit cues co-occur, prefer contract-specific tag only when an explicit contract-accounting cue is within ±8 tokens of numeric OR the sentence includes technical contract-accounting verbs (\"recognized\", \"deferred\", \"recognized from contracts\", \"performance obligations\"). Otherwise assign Revenues and log as 'headline-overrode-contract-specific'.\n\nPrecedence / Tie-breaker:\n- Apply this rule before any contract-specific revenue lexical mapping (e.g., ctx-00007). Precedence: Headline-Revenues rule (this) > Contract-specific mapping unless explicit contract-accounting cue(s) present and proximal to numeric.\n\nNegative / exception list (do NOT map to generic Revenues when any of these are present proximate to numeric):\n- presence of contract-accounting explicit cues (see list above) within ±8 tokens; or explicit phrase 'reimbursable revenues' when accompanied by contract accounting language (map to RevenueFromContractWithCustomer... if the phrase is used in the context of contract recognition guidance);\n- sentences explicitly describing revenue recognition method (\"recognized on a percentage-of-completion basis\", \"accounted for under ASC 606\", \"transaction price allocated to performance obligations\").\n\nUnit-tests / minimal examples to add:\n- 'Includes revenues of $X and $Y for the three months and nine months ended September 30, 2017 from Pet Partners.' -> $X, $Y = Revenues (headline rule applies; 'from Pet Partners' alone is insufficient for contract-specific tag).\n- 'Total revenues were $1,234 for the year ended Dec 31, 2017.' -> $1,234 = Revenues.\n- 'We recognized $12.0 million of revenue from contracts with customers in the quarter under ASC 606' -> $12.0M = RevenueFromContractWithCustomerExcludingAssessedTax (contract-accounting explicit cue present).\n- 'Reimbursable revenues of $39.9 million, ENL constituted approximately 23.6 percent of our total consolidated revenues' -> $39.9M = RevenueFromContractWithCustomerExcludingAssessedTax (use explicit reimbursable cue + proximate contract/accounting context); 23.6% = ConcentrationRiskPercentage1.\n\nLogging & QA:\n- Log every automatic assignment where headline rule applied but a customer/source anchor exists (label 'headline-revenues-applied'); include numeric span, headline cue span (heading or phrase), customer/source span, and whether any contract-accounting cues were present and their spans.\n- Log any case where contract-specific mapping is chosen despite headline cues with label 'contract-specific-chosen-over-headline' with justification spans.\n\nImplementation notes:\n- Insert this rule prior to ctx-00007 and any generic \"revenues\" -> Revenues fallback. Ensure rule is used by both rule-based regex pipeline and as a high-priority feature in statistical classifiers (feature: headline-revenue-candidate boolean)."}], "added_content": ["[ctx-00010] helpful=0 harmful=0 :: Atomic heuristic: Prefer generic Revenues for headline income-statement amounts; reserve RevenueFromContractWithCustomer... for explicit contract-accounting contexts.", "Purpose: Prevent overapplication of contract-specific revenue tags when amounts are presented as top-line/period-line items in condensed/consolidated statements of income or in table rows that function as headline revenue lines.", "Exact positive headline cues (case-insensitive regexes):", "- /\\bcondensed consolidated statement of (income|operations)\\b/;", "- /\\bfor the (three|six|nine|twelve) months? (and|ended|ended\\s+on)\\b/;  // period-ended row context"], "removed_content": []}
{"timestamp": "2026-02-09T14:45:20.747661", "step": 84, "playbook_before_length": 68437, "playbook_after_length": 74007, "lines_before": 317, "lines_after": 319, "added_lines": 2, "removed_lines": 0, "operations_count": 2, "operations": [{"type": "ADD", "section": "context_clues_and_indicators", "content": "Atomic heuristic: Appositive and clarifier numeric resolution (handle 'or $X', 'i.e., $X', 'which equals $X'). Rules (apply before lexical-tag fallbacks): 1) Detect appositive clarifiers using patterns (case-insensitive) within the same clause: /,\\s*or\\s+\\$?[0-9,]+(?:\\.\\d+)?/, /\\bor\\s+\\$?[0-9,]+(?:\\.\\d+)?\\b/, /\\bi\\.e\\.?\\s*\\$?[0-9,]+(?:\\.\\d+)?\\b/, /which\\s+is\\s+\\$?[0-9,]+(?:\\.\\d+)?/. 2) Locate the head noun/phrase the appositive modifies by scanning left within the clause up to the nearest punctuation boundary (comma/semicolon) for candidate nouns: 'difference', 'remainder', 'amount available', 'amount available under', 'amount drawn', 'fee', 'charge', 'cost', 'spread', 'margin'. 3) Decision mapping (deterministic): - If head noun ∈ {difference, remainder, undrawn, remaining, amount available, borrowing base, amount available under the facility} -> map appositive numeric -> LineOfCreditFacilityRemainingBorrowingCapacity (or facility-specific remaining-capacity tag). - If head noun ∈ {fee, charge, commission, premium, cost} AND appositive follows a phrase that quantifies the fee (\"a fee of $X was charged\", \"we paid $X in fees\") -> map to InterestExpenseDebt (or fee-specific currency tag). - If head noun == 'difference between A and B' or 'difference' and clause references a cap or drawn amount (e.g., 'difference between $A and the amount drawn') -> map appositive numeric to the arithmetic residual semantics -> RemainingBorrowingCapacity. - If head noun ambiguous (e.g., 'amount' with no modifier) -> do not auto-map; flag 'appositive-ambiguous' for review. 4) Token-window & antecedent resolution: allow antecedent noun in previous clause/sentence only when anaphora is explicit ('the difference', 'that amount', 'that difference') within ±1 sentence and span <= 40 tokens. 5) Fee-base disambiguation rule: when sentence contains 'fee of X%' or 'fee of X% applied to [BASE]' -> the percentage maps to a fee-percent tag (if available) and the BASE numeric (including any appositive) maps to capacity/principal/remaining-capacity tag as per base semantics; do NOT map the BASE to InterestExpenseDebt merely because 'fee' appears. 6) Precedence: this appositive resolution overrides shallow lexical heuristics that map nearest numeric to 'fee' or generic expense. 7) Unit-tests / examples to add: - \"a fee of 1% was applied to the difference between $20.0 million and the amount drawn, or $0.2 million\" -> $0.2M = LineOfCreditFacilityRemainingBorrowingCapacity; 1% = fee-percent (not a currency InterestExpenseDebt). - \"the amount drawn, or $5.0 million, was recorded\" -> $5.0M -> tag determined by head noun 'amount drawn' (outstanding/borrowed tag). - \"the fee, or $0.3 million, was charged\" -> $0.3M = InterestExpenseDebt. 8) Logging: record appositive span, resolved head noun span, chosen tag, and antecedent resolution confidence for QA."}, {"type": "ADD", "section": "common_mistakes_to_avoid", "content": "Atomic prevention rule: Debt-amount tag consistency and 'face' vs 'carrying' precedence in amendment/borrowing disclosures. Purpose: avoid mis-tagging contractually discussed loan amounts as 'face' when the dataset maps loan disclosures to carrying/book values. Rules (apply before generic 'principal' heuristics): 1) Detect amendment/borrowing/availability disclosure contexts by lexical anchors in same sentence OR ±1 sentence: /(amend(ed|ment)|as amended|available to borrow|availability under the (?:credit )?facility|in an aggregate principal amount of up to|revolv(?:ing)? credit facility|term loan|we may borrow|commitment)/i. 2) If anchor present and numeric token denotes the instrument's stated amount in that disclosure context -> prefer DebtInstrumentCarryingAmount. 3) Enforce cross-mention consistency: when two or more numeric mentions co-refer to the same instrument within ±1 sentence (match via instrument-name tokens, identical numeric value, or explicit anaphora 'the loan', 'the facility' referencing prior anchor), assign same tag to all mentions; if any prior mention was tagged CarryingAmount, propagate CarryingAmount to subsequent mentions unless an explicit 'face', 'original principal', 'originally issued' lexical cue appears. 4) Explicit cues forcing FaceAmount: map to DebtInstrumentFaceAmount ONLY if proximate lexical cues present within ±8 tokens: /face amount|original principal|stated principal|original principal amount|originally issued|originally issued principal|principal amount at issuance|original issue amount/. 5) Anti-pattern prevention: do NOT map any loan-mention currency to DebtInstrumentFaceAmount by default merely because it is a principal-like dollar figure; require either explicit 'face' cues OR absence of amendment/availability/disclosure anchors AND presence of issuance/origination language. 6) Fee/currency disambiguation: if the same numeric appears both as the instrument amount and as part of a fee calculation elsewhere, do not change instrument mapping — keep instrument mapping consistent; instead map fee amounts/percents per appositive/fee-base rules. 7) Unit-tests / examples to add: - \"$20.0 million term loan (as amended)\" -> $20.0M = DebtInstrumentCarryingAmount. - Repeated mentions of '$20.0 million' in adjacent sentences describing the same facility -> both = DebtInstrumentCarryingAmount. - 'original principal amount of $100M' -> $100M = DebtInstrumentFaceAmount (explicit face cue). 8) Logging: record instrument-anchor span, mapping decision, and whether mapping was propagated to co-referent mentions; flag 'inconsistent-instrument-tag' cases for review."}], "added_content": ["[err-00012] helpful=0 harmful=0 :: Atomic prevention rule: Debt-amount tag consistency and 'face' vs 'carrying' precedence in amendment/borrowing disclosures. Purpose: avoid mis-tagging contractually discussed loan amounts as 'face' when the dataset maps loan disclosures to carrying/book values. Rules (apply before generic 'principal' heuristics): 1) Detect amendment/borrowing/availability disclosure contexts by lexical anchors in same sentence OR ±1 sentence: /(amend(ed|ment)|as amended|available to borrow|availability under the (?:credit )?facility|in an aggregate principal amount of up to|revolv(?:ing)? credit facility|term loan|we may borrow|commitment)/i. 2) If anchor present and numeric token denotes the instrument's stated amount in that disclosure context -> prefer DebtInstrumentCarryingAmount. 3) Enforce cross-mention consistency: when two or more numeric mentions co-refer to the same instrument within ±1 sentence (match via instrument-name tokens, identical numeric value, or explicit anaphora 'the loan', 'the facility' referencing prior anchor), assign same tag to all mentions; if any prior mention was tagged CarryingAmount, propagate CarryingAmount to subsequent mentions unless an explicit 'face', 'original principal', 'originally issued' lexical cue appears. 4) Explicit cues forcing FaceAmount: map to DebtInstrumentFaceAmount ONLY if proximate lexical cues present within ±8 tokens: /face amount|original principal|stated principal|original principal amount|originally issued|originally issued principal|principal amount at issuance|original issue amount/. 5) Anti-pattern prevention: do NOT map any loan-mention currency to DebtInstrumentFaceAmount by default merely because it is a principal-like dollar figure; require either explicit 'face' cues OR absence of amendment/availability/disclosure anchors AND presence of issuance/origination language. 6) Fee/currency disambiguation: if the same numeric appears both as the instrument amount and as part of a fee calculation elsewhere, do not change instrument mapping — keep instrument mapping consistent; instead map fee amounts/percents per appositive/fee-base rules. 7) Unit-tests / examples to add: - \"$20.0 million term loan (as amended)\" -> $20.0M = DebtInstrumentCarryingAmount. - Repeated mentions of '$20.0 million' in adjacent sentences describing the same facility -> both = DebtInstrumentCarryingAmount. - 'original principal amount of $100M' -> $100M = DebtInstrumentFaceAmount (explicit face cue). 8) Logging: record instrument-anchor span, mapping decision, and whether mapping was propagated to co-referent mentions; flag 'inconsistent-instrument-tag' cases for review.", "[ctx-00011] helpful=0 harmful=0 :: Atomic heuristic: Appositive and clarifier numeric resolution (handle 'or $X', 'i.e., $X', 'which equals $X'). Rules (apply before lexical-tag fallbacks): 1) Detect appositive clarifiers using patterns (case-insensitive) within the same clause: /,\\s*or\\s+\\$?[0-9,]+(?:\\.\\d+)?/, /\\bor\\s+\\$?[0-9,]+(?:\\.\\d+)?\\b/, /\\bi\\.e\\.?\\s*\\$?[0-9,]+(?:\\.\\d+)?\\b/, /which\\s+is\\s+\\$?[0-9,]+(?:\\.\\d+)?/. 2) Locate the head noun/phrase the appositive modifies by scanning left within the clause up to the nearest punctuation boundary (comma/semicolon) for candidate nouns: 'difference', 'remainder', 'amount available', 'amount available under', 'amount drawn', 'fee', 'charge', 'cost', 'spread', 'margin'. 3) Decision mapping (deterministic): - If head noun ∈ {difference, remainder, undrawn, remaining, amount available, borrowing base, amount available under the facility} -> map appositive numeric -> LineOfCreditFacilityRemainingBorrowingCapacity (or facility-specific remaining-capacity tag). - If head noun ∈ {fee, charge, commission, premium, cost} AND appositive follows a phrase that quantifies the fee (\"a fee of $X was charged\", \"we paid $X in fees\") -> map to InterestExpenseDebt (or fee-specific currency tag). - If head noun == 'difference between A and B' or 'difference' and clause references a cap or drawn amount (e.g., 'difference between $A and the amount drawn') -> map appositive numeric to the arithmetic residual semantics -> RemainingBorrowingCapacity. - If head noun ambiguous (e.g., 'amount' with no modifier) -> do not auto-map; flag 'appositive-ambiguous' for review. 4) Token-window & antecedent resolution: allow antecedent noun in previous clause/sentence only when anaphora is explicit ('the difference', 'that amount', 'that difference') within ±1 sentence and span <= 40 tokens. 5) Fee-base disambiguation rule: when sentence contains 'fee of X%' or 'fee of X% applied to [BASE]' -> the percentage maps to a fee-percent tag (if available) and the BASE numeric (including any appositive) maps to capacity/principal/remaining-capacity tag as per base semantics; do NOT map the BASE to InterestExpenseDebt merely because 'fee' appears. 6) Precedence: this appositive resolution overrides shallow lexical heuristics that map nearest numeric to 'fee' or generic expense. 7) Unit-tests / examples to add: - \"a fee of 1% was applied to the difference between $20.0 million and the amount drawn, or $0.2 million\" -> $0.2M = LineOfCreditFacilityRemainingBorrowingCapacity; 1% = fee-percent (not a currency InterestExpenseDebt). - \"the amount drawn, or $5.0 million, was recorded\" -> $5.0M -> tag determined by head noun 'amount drawn' (outstanding/borrowed tag). - \"the fee, or $0.3 million, was charged\" -> $0.3M = InterestExpenseDebt. 8) Logging: record appositive span, resolved head noun span, chosen tag, and antecedent resolution confidence for QA."], "removed_content": []}
{"timestamp": "2026-02-09T14:46:42.730508", "step": 85, "playbook_before_length": 74007, "playbook_after_length": 77511, "lines_before": 319, "lines_after": 351, "added_lines": 22, "removed_lines": 0, "operations_count": 1, "operations": [{"type": "ADD", "section": "CONTEXT CLUES & INDICATORS", "content": "[ctx-000XX] helpful=0 harmful=0 :: Atomic rule: Map percentages that quantify portions of risk/exposure (ceded/retained/assumed) -> ConcentrationRiskPercentage1\n\nPurpose: deterministically map percentage tokens that express a share/portion of risk, exposure, or ceded/retained/assumed amounts to the concentration/exposure-percent tag rather than generic percent tags.\n\nExact lexical cues (case-insensitive regexes and phrase forms):\n- /\\bceded\\b/, /\\bceding\\b/, /\\bportion\\s+of\\s+risk\\b/, /\\bportion\\s+of\\s+exposure\\b/, /\\bpercent(?:age)?\\s+ceded\\b/, /\\bwas\\s+ceded\\b/, /\\bwe\\s+ceded\\b/, /\\bretained\\b|\\bretaining\\b/, /\\bassumed\\b|\\bassuming\\b/, /\\bof\\s+the\\s+exposure\\b/, /\\bof\\s+the\\s+risk\\b/, /\\bportion\\s+ceded\\b/.\n\nPercentage detection:\n- Recognize percent forms: '\\\\d+(?:\\\\.\\\\d+)?%','\\\\d+(?:\\\\.\\\\d+)? percent', numeric ranges 'from X% to Y%'.\n\nAssociation & token-window policy:\n- Primary association window: require a percentage token to occur within ±8 tokens of any ceded/retained/assumed/exposure/risk cue in the same sentence.\n- If the cue is in the previous sentence, allow antecedent resolution (±1 sentence) only when anaphora links are present ('that risk', 'such exposure', 'that portion') and total span <= 40 tokens; otherwise require same-sentence proximity.\n\nDecision flow & precedence (apply before generic percent tag fallbacks):\n1) If numeric is a percentage AND a ceded/retained/assumed/exposure/risk cue matches within window -> assign ConcentrationRiskPercentage1.\n2) If the percentage also contains other percent-candidate cues (interest, spread, stated-rate), prefer the tag whose lexical cue is nearest in token distance; if 'per annum'/'interest' cues exist within ±3 tokens prefer interest-rate tags and log 'rate-vs-exposure-conflict' for QA.\n3) If both 'customer'/'revenue' and 'ceded' cues co-occur and percent quantifies portion of revenue attributable to a customer, still map to ConcentrationRiskPercentage1 (customer concentration semantics); if ambiguity remains (no 'of revenue'/'of customers'/'of exposure' anchor) flag for human review.\n\nNormalization & examples (unit-tests to add):\n- '35% of the risk was ceded to reinsurers.' -> 35% = ConcentrationRiskPercentage1.\n- 'We ceded 65% of our exposure under the program.' -> 65% = ConcentrationRiskPercentage1.\n- 'The two largest customers accounted for approximately 44% of our revenues' -> 44% = ConcentrationRiskPercentage1 (customer-concentration path).\n- 'Interest rate of 4.15% per annum and a margin of LIBOR plus 1.25%.' -> 4.15% = DebtInstrumentInterestRateStatedPercentage; 1.25% = DebtInstrumentBasisSpreadOnVariableRate1 (rate-vs-exposure-conflict rule ensures no false mapping).\n\nAmbiguity handling & logging:\n- If no ceded/retained/assumed/exposure/risk cue found within window, do NOT auto-assign ConcentrationRiskPercentage1; fall back to other percent heuristics.\n- Log every auto-assignment with label 'exposure-percent-mapped' including numeric span, matched cue span, sentence index, and antecedent resolution info for QA and retraining.\n\nImplementation notes:\n- Insert this rule at high priority before generic '%' -> generic-percentage tag fallbacks and before conflicting rules that map 'percent' to interest/spread unless those interest cues are closer/proximate.\n- Add unit-tests and training examples capturing 'ceded', 'retained', 'assumed', 'portion of risk/exposure', and customer-concentration contexts to avoid collapse into generic percent tags."}], "added_content": ["[ctx-00013] helpful=0 harmful=0 :: [ctx-000XX] helpful=0 harmful=0 :: Atomic rule: Map percentages that quantify portions of risk/exposure (ceded/retained/assumed) -> ConcentrationRiskPercentage1", "Purpose: deterministically map percentage tokens that express a share/portion of risk, exposure, or ceded/retained/assumed amounts to the concentration/exposure-percent tag rather than generic percent tags.", "Exact lexical cues (case-insensitive regexes and phrase forms):", "- /\\bceded\\b/, /\\bceding\\b/, /\\bportion\\s+of\\s+risk\\b/, /\\bportion\\s+of\\s+exposure\\b/, /\\bpercent(?:age)?\\s+ceded\\b/, /\\bwas\\s+ceded\\b/, /\\bwe\\s+ceded\\b/, /\\bretained\\b|\\bretaining\\b/, /\\bassumed\\b|\\bassuming\\b/, /\\bof\\s+the\\s+exposure\\b/, /\\bof\\s+the\\s+risk\\b/, /\\bportion\\s+ceded\\b/.", "Percentage detection:"], "removed_content": []}
{"timestamp": "2026-02-09T14:48:20.964699", "step": 86, "playbook_before_length": 77511, "playbook_after_length": 81991, "lines_before": 351, "lines_after": 385, "added_lines": 24, "removed_lines": 0, "operations_count": 1, "operations": [{"type": "ADD", "section": "context_clues_and_indicators", "content": "Delta rule: Repurchase-program monetary vs treasury-stock-cost disambiguation\n\nPurpose: deterministically map monetary amounts that describe (a) repurchase-authorizations (caps) and (b) amounts repurchased under a share repurchase program to StockRepurchaseProgramAuthorizedAmount1; reserve TreasuryStockValueAcquiredCostMethod for explicit accounting-cost statements about treasury stock.\n\nExact lexical anchors (case-insensitive):\n- Repurchase-program anchors (map currency -> StockRepurchaseProgramAuthorizedAmount1): /repurchas(e|ed|ing)\\b/, /share repurchase(?:\\s+authorization|\\s+program)?\\b/, /authorized to repurchase up to\\b/, /previously announced \\$?[0-9,.]+ share repurchase authorization/, /under the (?:share )?repurchase (?:program|authorization)/, /authorization (?:to repurchase|expired)\\b/, /was repurchased (?:under|pursuant to) the (?:repurchase|authorization)/i\n- Treasury-stock cost anchors (map currency -> TreasuryStockValueAcquiredCostMethod only): /treasury stock[,\\s]+at cost\\b/, /treasury stock (?:acquired )?at an? average cost of\\b/, /treasury shares (?:at cost|recorded at)\\b/, /treasury stock, at cost\\b/, /cost method for treasury stock\\b/\n\nAssociation & token-window policy:\n1) Primary window: if a currency numeric appears within ±8 tokens of any repurchase-program anchor in the same sentence -> assign StockRepurchaseProgramAuthorizedAmount1 and link numeric to program identity if present.\n2) Antecedent resolution: if repurchase-program anchor appears in the immediately preceding sentence (±1 sentence) and anaphora like 'the program', 'the authorization' occurs in current sentence, allow linking (max span 40 tokens) -> still map to StockRepurchaseProgramAuthorizedAmount1.\n3) Treasury-stock cost mapping requires explicit treasury-stock-cost anchors within ±8 tokens of the numeric. Do NOT map to TreasuryStockValueAcquiredCostMethod solely because 'repurchased' or 'repurchase' appears.\n\nPrecedence & tie-breaker (apply before any generic monetary-to-treasury fallbacks):\n- If repurchase-program anchor present (per rules above) -> StockRepurchaseProgramAuthorizedAmount1 (this covers both authorization caps and amounts repurchased under that authorization).\n- Else if treasury-stock-cost anchor present -> TreasuryStockValueAcquiredCostMethod.\n- If both anchor-classes appear (rare), prefer the anchor that is lexically closer to the numeric; if equidistant, prefer explicit 'repurchased under the authorization' language -> StockRepurchaseProgramAuthorizedAmount1; otherwise log for manual review.\n\nUnit-tests / minimal examples (atomic):\n- 'We repurchased approximately $234.6 million of the Company’s previously announced $275.0 million share repurchase authorization.' -> $234.6, $275.0 = StockRepurchaseProgramAuthorizedAmount1.\n- 'The Board authorized a new repurchase program of $100.0 million' -> $100.0 = StockRepurchaseProgramAuthorizedAmount1.\n- 'Treasury stock, at cost, totaled $45.0 million as of December 31' -> $45.0 = TreasuryStockValueAcquiredCostMethod.\n- 'We repurchased $5.0 million under the program and held treasury stock at an average cost of $2.00 per share' -> $5.0 = StockRepurchaseProgramAuthorizedAmount1; $2.00 (per share, average cost) -> TreasuryStockValueAcquiredCostMethod (or related per-share treasury-cost tag if present).\n\nEdge cases & additional guidance:\n- Share-count caps (e.g., '16.3 million shares authorized under the plan') should continue to map to share-based-compensation-number-of-shares-authorized tags — do NOT map share-counts to monetary repurchase tags.\n- Phrases like 'authorized to repurchase up to $X' and 'previously announced $X share repurchase authorization' are canonical cap expressions and always map to StockRepurchaseProgramAuthorizedAmount1 even if described in comparative clauses.\n\nLogging & QA:\n- Log every repurchase-program mapping with label 'repurchase-program-mapped' including numeric span, repurchase-anchor span, antecedent span (if used), chosen tag, and confidence.\n- Log cases where a numeric is within windows for both repurchase-program and treasury-stock-cost anchors as 'repurchase-vs-treasury-conflict' with spans for manual review and addition to retraining data.\n\nImplementation note:\n- Insert this rule before any generic 'currency near \"treasury\" -> TreasuryStockValueAcquiredCostMethod' fallback and before unit-driven share-vs-currency disambiguation that might bias mapping to treasury-stock by default."}], "added_content": ["[ctx-00014] helpful=0 harmful=0 :: Delta rule: Repurchase-program monetary vs treasury-stock-cost disambiguation", "Purpose: deterministically map monetary amounts that describe (a) repurchase-authorizations (caps) and (b) amounts repurchased under a share repurchase program to StockRepurchaseProgramAuthorizedAmount1; reserve TreasuryStockValueAcquiredCostMethod for explicit accounting-cost statements about treasury stock.", "Exact lexical anchors (case-insensitive):", "- Repurchase-program anchors (map currency -> StockRepurchaseProgramAuthorizedAmount1): /repurchas(e|ed|ing)\\b/, /share repurchase(?:\\s+authorization|\\s+program)?\\b/, /authorized to repurchase up to\\b/, /previously announced \\$?[0-9,.]+ share repurchase authorization/, /under the (?:share )?repurchase (?:program|authorization)/, /authorization (?:to repurchase|expired)\\b/, /was repurchased (?:under|pursuant to) the (?:repurchase|authorization)/i", "- Treasury-stock cost anchors (map currency -> TreasuryStockValueAcquiredCostMethod only): /treasury stock[,\\s]+at cost\\b/, /treasury stock (?:acquired )?at an? average cost of\\b/, /treasury shares (?:at cost|recorded at)\\b/, /treasury stock, at cost\\b/, /cost method for treasury stock\\b/"], "removed_content": []}
{"timestamp": "2026-02-09T14:49:25.831956", "step": 87, "playbook_before_length": 81991, "playbook_after_length": 87686, "lines_before": 385, "lines_after": 414, "added_lines": 26, "removed_lines": 0, "operations_count": 1, "operations": [{"type": "ADD", "section": "context_clues_and_indicators", "content": "Title: Map amortization-of-intangible and regulatory-requested-rate revenue-impact amounts (atomic heuristics)\n\n1) Amortization of Intangible Assets -> AmortizationOfIntangibleAssets\n- Purpose: deterministically map currency numeric tokens that are explicitly described as amortization expense of intangible or amortizable intangible assets to AmortizationOfIntangibleAssets instead of generic Expense or Amortization tags.\n- Exact lexical cues (case-insensitive regex examples): /amortization\\s+expense(s)?\\b/, /amortization\\s+of\\s+(?:intangible|amortizable)\\s+asset(s)?\\b/, /amortizable\\s+intangible\\s+assets?\\b/, /amortization\\s+related\\s+to\\s+intangible\\s+assets?\\b/, /amortization\\s+expense\\s+for\\s+intangible\\s+assets\\b/.\n- Association window: currency numeric token must occur within ±8 tokens of a matching cue in the same sentence or in the same clause. Allow antecedent anaphora (e.g., 'such amortization') from previous sentence only when explicit referential link exists (±1 sentence, span <= 40 tokens).\n- Precedence: If an amortization-intangible cue matches, assign AmortizationOfIntangibleAssets and override any generic Expense/Amortization/OperatingExpense/OtherExpense tag candidates.\n- Normalization: if phrase contains 'was $X' or 'totaled $X' map numeric to currency amount value; if phrase contains 'no amortization'/'none' normalize to zero and assign AmortizationOfIntangibleAssets = 0 (log negation span).\n- Tie-breaker: if simultaneously 'amortization' and another instrument-specific expense anchor appear (rare), prefer the anchor explicitly mentioning 'intangible' for AmortizationOfIntangibleAssets; otherwise flag for review.\n- Unit-tests (atomic examples):\n  - 'Amortization expense for amortizable intangible assets for the year was $400,000.' -> $400,000 = AmortizationOfIntangibleAssets.\n  - 'The amortization of intangible assets totaled $600,000 during the period.' -> $600,000 = AmortizationOfIntangibleAssets.\n- Logging: record cue span, numeric span, antecedent span (if used), and mapping decision label 'amortization-intangible-mapped'.\n\n2) Regulatory tariff / requested-rate revenue-impact -> PublicUtilitiesRequestedRateIncreaseDecreaseAmount\n- Purpose: deterministically map numeric amounts described as the change in revenues resulting from regulatory tariff filings or requested rate changes filed with public utility commissions to PublicUtilitiesRequestedRateIncreaseDecreaseAmount instead of generic Revenues.\n- Exact lexical cues (case-insensitive regex examples): /(requested\\s+rate(?:s)?|requested\\s+increase|requested\\s+decrease|requested\\s+rate\\s+increase|requested\\s+rate\\s+decrease)\\b/, /regulatory\\s+tariff(s)?\\b/, /filed\\s+with\\s+the\\s+public\\s+utility\\s+commission(s)?\\b/, /filed\\s+with\\s+the\\s+commission\\b/, /resulting\\s+in\\s+an?\\s+(?:increase|decrease)\\s+in\\s+revenues\\b/, /annual\\s+change\\s+in\\s+revenues\\s+resulting\\s+from\\b/. Also capture variants: /tariff\\s+filing(s)?/, /rate\\s+filing(s)?/, /requested\\s+rate\\s+change(s)?/.\n- Association window: currency numeric token must appear in the same sentence and within ±12 tokens of a matching cue, or in the same clause if comma-separated. If the sentence text is a short appositive or parenthetical ('($5.0 million)') allow ±16 tokens but require a clear regulatory cue in sentence.\n- Precedence: When regulatory/requested-rate cues match, assign PublicUtilitiesRequestedRateIncreaseDecreaseAmount and override generic Revenues, RevenueFromContractWithCustomer..., or other revenue tags. If the sentence explicitly frames the amount as 'impact', 'increase' or 'decrease' of revenues due to a rate filing, map here regardless of presence of 'revenues' word.\n- Sign handling: detect lexical polarity words near cue within ±6 tokens: /increase(s)?|rise|up|benefit/ => positive impact; /decrease(s)?|decline|reduction|down|adverse/ => negative impact. Store sign metadata (positive/negative/unspecified) for downstream numeric normalization (if taxonomy supports signed values); if ambiguity exists, mark 'reg-rate-impact-ambiguous-sign'.\n- Tie-breaker: if a regulatory-request cue and a generic 'total revenues' headline cue both appear, the regulatory-request cue wins only if proximate (≤12 tokens) and explicitly links the numeric to 'resulting from'/'due to' language; otherwise treat as headline Revenues (log as 'reg-vs-headline-conflict').\n- Unit-tests (atomic examples):\n  - 'The annual change in revenues resulting from regulatory tariff filings was $5.0 million.' -> $5.0M = PublicUtilitiesRequestedRateIncreaseDecreaseAmount (positive by 'change' neutral; if sentence includes 'increase' set positive).\n  - 'The annual change in revenues resulting from requested rate changes filed with public utility commissions was $2.8 million.' -> $2.8M = PublicUtilitiesRequestedRateIncreaseDecreaseAmount.\n  - 'We filed requested rate increases with the commission; the change in annual revenues is expected to be $1.2 million (increase).' -> $1.2M = PublicUtilitiesRequestedRateIncreaseDecreaseAmount, sign=positive.\n- Ambiguity handling & logging: if regulator/revenue cue exists but no numeric within window -> flag 'reg-rate-no-amount' for review. Log each automatic assignment with label 'reg-rate-impact-mapped' including cue span, numeric span, sign metadata, and whether the mapping overrode a generic Revenues candidate.\n\nImplementation notes (both rules):\n- Insert these rules into the regex/heuristic pipeline before any generic 'revenues' or 'expense' fallbacks and before statistical classifier tie-breakers. Ensure unit-tests are added to the regression suite. Record all prevented-generic mappings with spans for QA and retraining."}], "added_content": ["[ctx-00015] helpful=0 harmful=0 :: Title: Map amortization-of-intangible and regulatory-requested-rate revenue-impact amounts (atomic heuristics)", "1) Amortization of Intangible Assets -> AmortizationOfIntangibleAssets", "- Purpose: deterministically map currency numeric tokens that are explicitly described as amortization expense of intangible or amortizable intangible assets to AmortizationOfIntangibleAssets instead of generic Expense or Amortization tags.", "- Exact lexical cues (case-insensitive regex examples): /amortization\\s+expense(s)?\\b/, /amortization\\s+of\\s+(?:intangible|amortizable)\\s+asset(s)?\\b/, /amortizable\\s+intangible\\s+assets?\\b/, /amortization\\s+related\\s+to\\s+intangible\\s+assets?\\b/, /amortization\\s+expense\\s+for\\s+intangible\\s+assets\\b/.", "- Association window: currency numeric token must occur within ±8 tokens of a matching cue in the same sentence or in the same clause. Allow antecedent anaphora (e.g., 'such amortization') from previous sentence only when explicit referential link exists (±1 sentence, span <= 40 tokens)."], "removed_content": []}
